import React, { useState, useEffect, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { 
    getAuth, 
    signInAnonymously, 
    signInWithCustomToken, 
    onAuthStateChanged,
    GoogleAuthProvider, 
    signInWithPopup,
    signOut 
} from 'firebase/auth';
import { 
    getFirestore, 
    doc, 
    setDoc, 
    collection, 
    query, 
    onSnapshot, 
    runTransaction,
    writeBatch,
    deleteDoc,
    updateDoc
} from 'firebase/firestore';

// âš ï¸ ã€é‡è¦ï¼šéƒ¨ç½²æ™‚è«‹åœ¨æ­¤è™•æ›¿æ›ç‚ºæ‚¨çš„ Firebase é…ç½®ã€‘ âš ï¸
// åœ¨ GitHub å°ˆæ¡ˆä¸­ï¼Œæ‚¨å¯ä»¥å°‡æ­¤è³‡è¨Šå­˜æ”¾åœ¨ .env æ–‡ä»¶ä¸­ä¸¦ä½¿ç”¨ Vite/CRA è¼‰å…¥ã€‚
// é€™è£¡æˆ‘å€‘ç›´æ¥ç¡¬ç·¨ç¢¼ï¼Œä½†åœ¨å¯¦éš›å°ˆæ¡ˆä¸­è«‹ä½¿ç”¨ç’°å¢ƒè®Šæ•¸ä¾†ä¿è­·æ‚¨çš„ apiKeyã€‚
const FIREBASE_CONFIG = {
    apiKey: "YOUR_API_KEY", // <-- è«‹æ›¿æ›
    authDomain: "YOUR_AUTH_DOMAIN", // <-- è«‹æ›¿æ›
    projectId: "YOUR_PROJECT_ID",   // <-- è«‹æ›¿æ›
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
    appId: "YOUR_FIREBASE_APP_ID"
};

// ç”±æ–¼ Canvas ç’°å¢ƒçš„å…¨åŸŸè®Šæ•¸ï¼ˆå¦‚ __app_idï¼‰åœ¨éƒ¨ç½²å¾Œä¸å­˜åœ¨ï¼Œ
// æˆ‘å€‘å°‡ä½¿ç”¨ FIREBASE_CONFIG.projectId ä½œç‚ºä¸€å€‹å›ºå®šçš„ appIdï¼Œé€™åœ¨ Firebase ä¸­æ˜¯å”¯ä¸€çš„ã€‚
const DEPLOY_APP_ID = FIREBASE_CONFIG.projectId || 'deployed-attendance-app';

// åˆå§‹åŒ– Firebase å¯¦ä¾‹
let app;
let db;
let auth;

// é»åç‹€æ…‹å®šç¾©
const STATUS_MAP = {
    'N/A': { code: 'N/A', name: 'æœªé»å', color: 'bg-gray-200 text-gray-700 hover:bg-gray-300' },
    'P': { code: 'P', name: 'å‡ºå¸­', color: 'bg-green-500 text-white hover:bg-green-600' },
    'L': { code: 'L', name: 'é²åˆ°', color: 'bg-yellow-400 text-yellow-900 hover:bg-yellow-500' },
    'A': { code: 'A', name: 'ç¼ºå¸­', color: 'bg-red-500 text-white hover:bg-red-600' },
};
const STATUS_ORDER = ['N/A', 'P', 'L', 'A'];

// é è¨­å­¸ç”Ÿåå–® (åœ¨æ²’æœ‰è³‡æ–™æ™‚è¼‰å…¥)
const DEFAULT_STUDENTS = [
    { id: 'S001', name: 'ç‹å°æ˜', email: '' },
    { id: 'S002', name: 'é™³å¤§è¯', email: '' },
    { id: 'S003', name: 'æç¾ç²', email: '' },
    { id: 'S004', name: 'å¼µå¿—è±ª', email: '' },
    { id: 'S005', name: 'æ—é›…é›¯', email: '' },
];

// ç²å–å°ç£æ™‚å€ (UTC+8) çš„æ—¥æœŸ YYYY-MM-DD
const getTaiwanDate = () => {
    const now = new Date();
    // è¨ˆç®— UTC æ™‚é–“ (æ¯«ç§’)
    const utcTime = now.getTime() + (now.getTimezoneOffset() * 60000);
    // åŠ ä¸Š UTC+8 åç§»é‡ (8 å°æ™‚)
    const twTime = new Date(utcTime + (3600000 * 8));
    return twTime.toISOString().split('T')[0];
};

/**
 * å­¸ç”Ÿç®¡ç† Modal/è¡¨å–®å…ƒä»¶
 */
const StudentManagerModal = ({ isOpen, onClose, student, onSave, onRemove }) => {
    const [id, setId] = useState(student ? student.id : '');
    const [name, setName] = useState(student ? student.name : '');
    const [email, setEmail] = useState(student ? student.email : '');
    
    useEffect(() => {
        if (student) {
            setId(student.id);
            setName(student.name);
            setEmail(student.email);
        } else {
            setId('');
            setName('');
            setEmail('');
        }
    }, [student]);

    const handleSubmit = (e) => {
        e.preventDefault();
        // æª¢æŸ¥æ˜¯å¦æœ‰åŒåå­¸ç”Ÿï¼Œé€™è£¡åªæª¢æŸ¥ ID å’Œ Name
        if (!id || !name) return;
        onSave({ id: id.trim(), name: name.trim(), email: email.trim() });
    };

    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
                <h2 className="text-2xl font-bold text-indigo-700 mb-4">{student ? 'ç·¨è¼¯å­¸ç”Ÿè³‡è¨Š' : 'æ–°å¢å­¸ç”Ÿ'}</h2>
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label className="block text-sm font-medium text-gray-700">å­¸è™Ÿ (ID)</label>
                        <input
                            type="text"
                            value={id}
                            onChange={(e) => setId(e.target.value.toUpperCase())}
                            readOnly={!!student} // ç·¨è¼¯æ™‚å­¸è™Ÿä¸å¯æ”¹
                            required
                            className={`mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 ${student ? 'bg-gray-100' : 'border'}`}
                        />
                        {student && <p className="text-xs text-red-500 mt-1">å­¸è™Ÿä¸å¯æ›´æ”¹</p>}
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700">å§“å</label>
                        <input
                            type="text"
                            value={name}
                            onChange={(e) => setName(e.target.value)}
                            required
                            className="mt-1 block w-full rounded-md border border-gray-300 shadow-sm p-2"
                        />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700">Email (é¸å¡«)</label>
                        <input
                            type="email"
                            value={email}
                            onChange={(e) => setEmail(e.target.value)}
                            className="mt-1 block w-full rounded-md border border-gray-300 shadow-sm p-2"
                        />
                    </div>
                    
                    <div className="flex justify-between pt-4">
                        <button
                            type="button"
                            onClick={onClose}
                            className="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 transition"
                        >
                            å–æ¶ˆ
                        </button>
                        <div className="space-x-3">
                            {student && (
                                <button
                                    type="button"
                                    onClick={() => onRemove(student.firebaseId)}
                                    className="py-2 px-4 bg-red-600 text-white rounded-md shadow-sm text-sm font-medium hover:bg-red-700 transition"
                                >
                                    åˆªé™¤
                                </button>
                            )}
                            <button
                                type="submit"
                                className="py-2 px-4 bg-indigo-600 text-white rounded-md shadow-sm text-sm font-medium hover:bg-indigo-700 transition"
                            >
                                å„²å­˜
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    );
};

/**
 * çµ±è¨ˆå ±è¡¨æª¢è¦–å…ƒä»¶
 */
const StatsView = ({ students, allTimeStats }) => {
    // æå–æ‰€æœ‰é»åå¤©æ•¸ (ç”¨æ–¼è¨ˆç®—åˆ†æ¯)
    const allDays = new Set();
    Object.values(allTimeStats).forEach(stats => {
        stats.days.forEach(day => allDays.add(day));
    });
    const totalDaysCount = allDays.size;

    const statsList = students.map(student => {
        const stats = allTimeStats[student.id] || { A: 0, L: 0, totalDays: 0 };
        // ç¼ºå‹¤ç‡è¨ˆç®—: (ç¼ºå¸­ + é²åˆ°) / ç¸½é»åå¤©æ•¸
        const absenceRate = totalDaysCount > 0 
            ? ((stats.A + stats.L) / totalDaysCount) * 100 
            : 0;

        return {
            ...student,
            ...stats,
            absenceRate: absenceRate.toFixed(1), // ä¿ç•™ä¸€ä½å°æ•¸
        };
    }).sort((a, b) => b.absenceRate - a.absenceRate); // æŒ‰ç¼ºå‹¤ç‡é™åºæ’åˆ—

    return (
        <div className="p-4">
            <h2 className="text-2xl font-bold text-gray-800 mb-4">ç¸½å‡ºç¼ºå‹¤çµ±è¨ˆ ({totalDaysCount} ç¸½å ‚èª²)</h2>
            <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50">
                        <tr>
                            <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                å­¸ç”Ÿ
                            </th>
                            <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                å­¸è™Ÿ
                            </th>
                            <th className="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ç¼ºå¸­ (A)
                            </th>
                            <th className="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                é²åˆ° (L)
                            </th>
                            <th className="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider text-red-600">
                                ç¼ºå‹¤ç‡ (%)
                            </th>
                        </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                        {statsList.map((s) => (
                            <tr key={s.id} className={s.absenceRate > 10 ? 'bg-red-50/50' : ''}>
                                <td className="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">
                                    {s.name}
                                </td>
                                <td className="px-3 py-2 whitespace-nowrap text-sm text-gray-500">
                                    {s.id}
                                </td>
                                <td className="px-3 py-2 whitespace-nowrap text-sm text-right text-red-500 font-bold">
                                    {s.A || 0}
                                </td>
                                <td className="px-3 py-2 whitespace-nowrap text-sm text-right text-yellow-600 font-bold">
                                    {s.L || 0}
                                </td>
                                <td className={`px-3 py-2 whitespace-nowrap text-sm text-right font-extrabold ${s.absenceRate > 10 ? 'text-red-700' : 'text-gray-700'}`}>
                                    {s.absenceRate}%
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
            <p className="mt-4 text-xs text-gray-500">
                è¨»ï¼šç¼ºå‹¤ç‡ = (ç¼ºå¸­æ¬¡æ•¸ + é²åˆ°æ¬¡æ•¸) / ç¸½é»åå¤©æ•¸ã€‚è¡¨æ ¼æŒ‰ç¼ºå‹¤ç‡é™åºæ’åˆ—ã€‚
            </p>
        </div>
    );
};


/**
 * ä¸»è¦æ‡‰ç”¨ç¨‹å¼å…ƒä»¶
 */
const App = () => {
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [students, setStudents] = useState([]);
    const [todayAttendance, setTodayAttendance] = useState({});
    const [allTimeStats, setAllTimeStats] = useState({});
    const [date, setDate] = useState(getTaiwanDate()); // å°ç£æ™‚å€æ—¥æœŸ
    const [isLoading, setIsLoading] = useState(true);
    const [isSaving, setIsSaving] = useState(false);
    const [currentUser, setCurrentUser] = useState(null);
    const [currentView, setCurrentView] = useState('attendance'); // 'attendance', 'stats', 'manage'
    const [isManageModalOpen, setIsManageModalOpen] = useState(false);
    const [editingStudent, setEditingStudent] = useState(null);

    // 1. Firebase åˆå§‹åŒ–å’Œèªè­‰
    useEffect(() => {
        // æª¢æŸ¥é…ç½®æ˜¯å¦æœ‰æ•ˆ
        if (!FIREBASE_CONFIG.apiKey || FIREBASE_CONFIG.apiKey === "YOUR_API_KEY") {
            console.error("Firebase Configuration is missing or using default values. Please replace YOUR_API_KEY, YOUR_AUTH_DOMAIN, and YOUR_PROJECT_ID in the code.");
            // åœ¨æ²’æœ‰é…ç½®çš„æƒ…æ³ä¸‹ï¼Œæˆ‘å€‘ä»ç„¶å¯ä»¥æ¨¡æ“¬é‹è¡Œï¼Œä½†ä¸èƒ½é€£æ¥åˆ° Firebase
            setIsAuthReady(true);
            setIsLoading(false);
            return;
        }

        try {
            app = initializeApp(FIREBASE_CONFIG);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // ç›£è½èªè­‰ç‹€æ…‹
            const unsubscribe = onAuthStateChanged(auth, (user) => {
                if (user) {
                    setUserId(user.uid);
                    setCurrentUser(user);
                    console.log("Authenticated with UID:", user.uid);
                } else {
                    setUserId(null);
                    setCurrentUser(null);
                }
                setIsAuthReady(true);
                setIsLoading(false); // èªè­‰ç‹€æ…‹ç¢ºå®šå¾Œå³å¯è§£é™¤è¼‰å…¥ç‹€æ…‹
            });
            
            // ç”±æ–¼æ²’æœ‰ Canvas çš„ custom tokenï¼Œæˆ‘å€‘è®“ç”¨æˆ¶å¿…é ˆæ‰‹å‹•ç™»å…¥ã€‚
            // é¦–æ¬¡è¼‰å…¥æ™‚ä¸è‡ªå‹•åŸ·è¡ŒåŒ¿åç™»å…¥ï¼Œé™¤é Google ç™»å…¥å¤±æ•—ã€‚

            return () => unsubscribe();
        } catch (e) {
            console.error("Error initializing Firebase:", e);
            setIsLoading(false);
        }
    }, []);

    // Google ç™»å…¥è™•ç†
    const handleGoogleSignIn = async () => {
        if (!auth) return;
        const provider = new GoogleAuthProvider();
        try {
            // é€™è£¡å¯ä»¥é¸æ“‡æ€§åœ°ä½¿ç”¨ `prompt: 'select_account'` å¼·åˆ¶é¸æ“‡å¸³è™Ÿ
            provider.setCustomParameters({ prompt: 'select_account' });
            await signInWithPopup(auth, provider);
        } catch (error) {
            console.error("Google Sign-In failed:", error.message);
            // å¦‚æœ Google ç™»å…¥å¤±æ•—ï¼Œå˜—è©¦åŒ¿åç™»å…¥ä½œç‚º fallback
            try {
                await signInAnonymously(auth);
                console.log("Fallback: Signed in anonymously.");
            } catch(anonError) {
                 console.error("Anonymous sign-in failed:", anonError);
            }
        }
    };
    
    // ç™»å‡ºè™•ç†
    const handleSignOut = async () => {
        if (!auth) return;
        try {
            await signOut(auth);
            // ç™»å‡ºå¾Œï¼Œç”¨æˆ¶éœ€è¦å†æ¬¡æ‰‹å‹•ç™»å…¥
        } catch (error) {
            console.error("Sign Out failed:", error.message);
        }
    };

    // 2. æ•¸æ“šè·¯å¾‘å»ºæ§‹å‡½å¼ (ç§äººè³‡æ–™)
    const getPrivateCollectionPath = (collectionName) => {
        if (!userId) return null;
        // ä½¿ç”¨éƒ¨ç½²æ™‚çš„å›ºå®š APP ID
        return `artifacts/${DEPLOY_APP_ID}/users/${userId}/${collectionName}`; 
    };
    
    // 3. ç²å–å­¸ç”Ÿåå–®
    const fetchStudents = useCallback(() => {
        if (!db) return;
        const studentPath = getPrivateCollectionPath('students');
        if (!studentPath) return;

        // è¼‰å…¥æˆ–åˆå§‹åŒ–å­¸ç”Ÿåå–®
        const q = collection(db, studentPath);
        const unsubscribe = onSnapshot(q, (snapshot) => {
            const studentList = [];
            snapshot.forEach((doc) => {
                studentList.push({ ...doc.data(), firebaseId: doc.id });
            });
            
            if (studentList.length === 0) {
                // å¦‚æœæ²’æœ‰è³‡æ–™ï¼Œä¸”æ˜¯é¦–æ¬¡è¼‰å…¥ï¼Œå¯«å…¥é è¨­åå–®
                if (students.length === 0 && userId) { // ç¢ºä¿ç”¨æˆ¶å·²ç™»å…¥
                    console.log("No student data found, initializing default list.");
                    const batch = writeBatch(db);
                    DEFAULT_STUDENTS.forEach(student => {
                        // ä½¿ç”¨ ID ä½œç‚º Firestore æ–‡æª” ID
                        const studentRef = doc(q, student.id);
                        batch.set(studentRef, student);
                    });
                    batch.commit().catch(e => console.error("Error writing default students:", e));
                    setStudents(DEFAULT_STUDENTS.map(s => ({ ...s, firebaseId: s.id })));
                } else {
                    setStudents([]);
                }
            } else {
                // æ’åºï¼šå…ˆæŒ‰ ID æ’åºï¼Œç„¶å¾Œæ›´æ–° State
                setStudents(studentList.sort((a, b) => a.id.localeCompare(b.id)));
            }
        }, (error) => {
            console.error("Error fetching students:", error);
        });

        return unsubscribe;
    }, [userId, db]);

    // 4. ç²å–ç•¶æ—¥é»åè¨˜éŒ„
    const fetchTodayAttendance = useCallback(() => {
        if (!db) return;
        const attendancePath = getPrivateCollectionPath('attendance');
        if (!attendancePath || !date) return;
        
        // æ¯æ—¥é»åè¨˜éŒ„çš„æ–‡ä»¶ ID å°±æ˜¯æ—¥æœŸ (YYYY-MM-DD)
        const docRef = doc(db, attendancePath, date);

        const unsubscribe = onSnapshot(docRef, (docSnap) => {
            if (docSnap.exists()) {
                setTodayAttendance(docSnap.data().records || {});
            } else {
                setTodayAttendance({});
            }
            setIsLoading(false);
        }, (error) => {
            console.error("Error fetching today's attendance:", error);
            setIsLoading(false);
        });

        return unsubscribe;
    }, [userId, date, db]);

    // 5. ç²å–ç¸½é«”çµ±è¨ˆ (æ‰€æœ‰é»åæ¬¡æ•¸)
    const fetchAllTimeStats = useCallback(() => {
        if (!db) return;
        const attendancePath = getPrivateCollectionPath('attendance');
        if (!attendancePath) return;

        const q = collection(db, attendancePath);
        const unsubscribe = onSnapshot(q, (snapshot) => {
            const stats = {};
            snapshot.forEach((docSnap) => {
                const dateKey = docSnap.id;
                const records = docSnap.data().records || {};
                
                // éæ­·ç•¶æ—¥è¨˜éŒ„
                Object.entries(records).forEach(([studentId, status]) => {
                    if (!stats[studentId]) {
                        stats[studentId] = { A: 0, L: 0, days: new Set() };
                    }

                    // åƒ…è¨ˆç®—å·²é»åç‹€æ…‹çš„ç¸½æ¬¡æ•¸
                    if (status === 'A' || status === 'L' || status === 'P') {
                        stats[studentId].days.add(dateKey); // è¨˜éŒ„é»åå¤©æ•¸
                        if (status === 'A') stats[studentId].A += 1;
                        if (status === 'L') stats[studentId].L += 1;
                    }
                });
            });
            // è½‰æ› Set ç‚ºé™£åˆ—æˆ–è¨ˆæ•¸ï¼Œæ–¹ä¾¿å‚³éçµ¦å­å…ƒä»¶
            const finalStats = {};
            Object.entries(stats).forEach(([id, s]) => {
                finalStats[id] = { 
                    A: s.A, 
                    L: s.L, 
                    totalDays: s.days.size, 
                    days: Array.from(s.days)
                };
            });
            setAllTimeStats(finalStats);
        }, (error) => {
            console.error("Error fetching all time stats:", error);
        });

        return unsubscribe;
    }, [userId, db]);

    // 6. ä¸» Effect - èªè­‰å®Œæˆå¾Œï¼Œé–‹å§‹è¼‰å…¥è³‡æ–™
    useEffect(() => {
        if (isAuthReady && userId && db) {
            setIsLoading(true);
            const unsubscribeStudents = fetchStudents();
            const unsubscribeToday = fetchTodayAttendance();
            const unsubscribeStats = fetchAllTimeStats();

            return () => {
                unsubscribeStudents && unsubscribeStudents();
                unsubscribeToday && unsubscribeToday();
                unsubscribeStats && unsubscribeStats();
            };
        } else if (isAuthReady && !userId) {
             // å¦‚æœèªè­‰å®Œæˆä½†æ²’æœ‰ userId (æœªç™»å…¥ç‹€æ…‹)ï¼Œåªé¡¯ç¤º UIï¼Œä¸å˜—è©¦è¼‰å…¥æ•¸æ“š
             setIsLoading(false);
             setStudents([]);
             setTodayAttendance({});
             setAllTimeStats({});
        }
    }, [isAuthReady, userId, db, date, fetchStudents, fetchTodayAttendance, fetchAllTimeStats]);


    // 7. é»åç‹€æ…‹åˆ‡æ›é‚è¼¯ (æ ¸å¿ƒåŠŸèƒ½)
    const toggleAttendance = async (studentId) => {
        if (isSaving || !userId || !db) return;
        setIsSaving(true);
        
        const attendancePath = getPrivateCollectionPath('attendance');
        
        const currentStatus = todayAttendance[studentId] || 'N/A';
        const currentIndex = STATUS_ORDER.indexOf(currentStatus);
        const nextIndex = (currentIndex + 1) % STATUS_ORDER.length;
        const newStatus = STATUS_ORDER[nextIndex];
        
        const docRef = doc(db, attendancePath, date);

        try {
            await runTransaction(db, async (transaction) => {
                const docSnap = await transaction.get(docRef);
                const records = docSnap.exists() ? docSnap.data().records : {};

                records[studentId] = newStatus;
                transaction.set(docRef, { date, records }, { merge: true });
            });
        } catch (e) {
            console.error("Transaction failed: ", e);
        } finally {
            setIsSaving(false);
        }
    };
    
    // 8. ä¸€éµé»åå…¨å‡ºå¸­
    const markAllPresent = async () => {
        if (isSaving || students.length === 0 || !userId || !db) return;
        
        // é¡¯ç¤ºç¢ºèªæ¡† (æ›¿ä»£ alert())
        if (!window.confirm(`ç¢ºå®šè¦å°‡ ${date} æ‰€æœ‰çš„ ${students.length} ä½å­¸ç”Ÿéƒ½æ¨™è¨˜ç‚ºã€Œå‡ºå¸­ (P)ã€å—ï¼Ÿ`)) {
            return;
        }

        setIsSaving(true);
        const attendancePath = getPrivateCollectionPath('attendance');
        const docRef = doc(db, attendancePath, date);
        
        try {
            await runTransaction(db, async (transaction) => {
                const docSnap = await transaction.get(docRef);
                const records = docSnap.exists() ? docSnap.data().records : {};

                students.forEach(student => {
                    records[student.id] = 'P'; // è¨­å®šç‚ºå‡ºå¸­
                });

                transaction.set(docRef, { date, records }, { merge: true });
            });
        } catch (e) {
            console.error("Transaction failed during Mark All Present: ", e);
        } finally {
            setIsSaving(false);
        }
    };

    // 9. å­¸ç”Ÿç®¡ç† CRUD é‚è¼¯
    const saveStudent = async (studentData) => {
        if (!userId || !db) return;
        setIsSaving(true);
        const studentPath = getPrivateCollectionPath('students');
        // ä½¿ç”¨å­¸è™Ÿä½œç‚ºæ–‡ä»¶ ID
        const docRef = doc(db, studentPath, studentData.id); 

        try {
            await setDoc(docRef, studentData, { merge: true });
            setIsManageModalOpen(false);
        } catch (e) {
            console.error("Error saving student:", e);
        } finally {
            setIsSaving(false);
        }
    };

    const deleteStudent = async (firebaseId) => {
        if (!userId || !db) return;
        // é¡¯ç¤ºç¢ºèªæ¡† (æ›¿ä»£ alert())
        if (!window.confirm(`ç¢ºå®šè¦åˆªé™¤å­¸è™Ÿ ${firebaseId} çš„å­¸ç”Ÿå—ï¼Ÿé€™å°‡ç„¡æ³•æ¢å¾©ã€‚`)) {
            return;
        }

        setIsSaving(true);
        const studentPath = getPrivateCollectionPath('students');
        const docRef = doc(db, studentPath, firebaseId); 

        try {
            await deleteDoc(docRef);
            setIsManageModalOpen(false);
            setEditingStudent(null);
        } catch (e) {
            console.error("Error deleting student:", e);
        } finally {
            setIsSaving(false);
        }
    };

    // æ¸²æŸ“å‡½å¼
    const renderStudentRow = (student) => {
        const studentId = student.id;
        const status = todayAttendance[studentId] || 'N/A';
        const statusData = STATUS_MAP[status];
        const stats = allTimeStats[studentId] || { A: 0, L: 0, totalDays: 0 };
        
        // ç¸½ç¼ºå‹¤æ¬¡æ•¸ (A + L)
        const totalAbsences = stats.A + stats.L;

        return (
            <li key={studentId} className="flex items-center justify-between p-3 border-b hover:bg-gray-50 transition duration-150 ease-in-out">
                {/* å­¸ç”Ÿè³‡è¨Š */}
                <div className="flex-1 min-w-0" onClick={() => {
                    if(!userId) return;
                    setEditingStudent(student);
                    setIsManageModalOpen(true);
                }}>
                    <p className="text-sm font-semibold text-gray-800 truncate cursor-pointer hover:text-indigo-600">
                        {student.name} ({student.id})
                    </p>
                    <p className="text-xs text-gray-500">
                        ç¸½ç¼ºå‹¤/é²åˆ°: <span className="font-mono font-bold text-red-600">{totalAbsences}</span> æ¬¡
                        <span className="ml-2 text-gray-400">({stats.totalDays} ç¸½é»åå¤©æ•¸)</span>
                    </p>
                </div>

                {/* ç‹€æ…‹åˆ‡æ›æŒ‰éˆ• */}
                <button
                    onClick={() => toggleAttendance(studentId)}
                    disabled={isSaving || isLoading || !userId}
                    className={`ml-4 w-28 py-2 px-3 text-sm font-medium rounded-full shadow-md transform transition duration-150 ease-in-out 
                                ${statusData.color} 
                                ${isSaving || isLoading || !userId ? 'opacity-50 cursor-not-allowed' : 'active:scale-95'}`}
                >
                    {statusData.name} ({statusData.code})
                </button>
            </li>
        );
    };

    // æ¸²æŸ“ç•¶å‰ä¸»è¦è¦–åœ–
    const renderCurrentView = () => {
        if (!userId) {
            return (
                 <div className="p-10 text-center text-gray-600">
                    <p className="text-lg font-semibold mb-4">è«‹å…ˆç™»å…¥ä»¥å­˜å–æ‚¨çš„å­¸ç”Ÿåå–®å’Œé»åæ•¸æ“šã€‚</p>
                    <p className="text-sm">é»æ“Šä¸Šæ–¹çš„ **ä½¿ç”¨ Google ç™»å…¥ (æ¨è–¦)** é–‹å§‹ä½¿ç”¨ã€‚</p>
                </div>
            )
        }
        
        if (currentView === 'stats') {
            return <StatsView students={students} allTimeStats={allTimeStats} />;
        }
        
        // é è¨­ç‚ºé»å ('attendance') è¦–åœ–
        return (
            <>
                <div className="p-4 border-b bg-indigo-50 flex flex-col sm:flex-row items-center justify-between space-y-3 sm:space-y-0">
                    <div className="flex items-center space-x-2">
                        <label htmlFor="attendance-date" className="text-sm font-medium text-indigo-700 whitespace-nowrap">
                            é»åæ—¥æœŸ (UTC+8):
                        </label>
                        <input
                            type="date"
                            id="attendance-date"
                            value={date}
                            onChange={(e) => {
                                setDate(e.target.value);
                                setIsLoading(true); // åˆ‡æ›æ—¥æœŸæ™‚é‡æ–°è¼‰å…¥
                            }}
                            className="p-2 border border-indigo-300 rounded-lg text-sm shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                        />
                    </div>
                    
                    <button
                        onClick={markAllPresent}
                        disabled={isSaving || isLoading || students.length === 0}
                        className="py-2 px-4 bg-purple-600 text-white rounded-lg shadow-md hover:bg-purple-700 transition duration-150 text-sm font-medium disabled:opacity-50"
                    >
                        {isSaving ? 'å„²å­˜ä¸­...' : 'ä¸€éµé»åå…¨å‡ºå¸­'}
                    </button>
                </div>
                
                {/* å­¸ç”Ÿåˆ—è¡¨ */}
                <div className="max-h-[60vh] overflow-y-auto">
                    {isLoading ? (
                         <div className="p-10 text-center text-indigo-600 flex justify-center items-center space-x-2">
                            <svg className="animate-spin h-5 w-5" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" fill="none" viewBox="0 0 24 24">
                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span className="text-sm">è³‡æ–™è¼‰å…¥ä¸­...</span>
                        </div>
                    ) : students.length > 0 ? (
                        <ul className="divide-y divide-gray-100">
                            {students.map(renderStudentRow)}
                        </ul>
                    ) : (
                        <div className="p-10 text-center text-gray-500">
                            <p>å­¸ç”Ÿåå–®ç‚ºç©ºã€‚è«‹é»æ“Šä¸Šæ–¹ã€Œç®¡ç†å­¸ç”Ÿã€æŒ‰éˆ•æ–°å¢å­¸ç”Ÿã€‚</p>
                        </div>
                    )}
                </div>
            </>
        );
    };

    return (
        <div className="min-h-screen bg-gray-100 p-4 sm:p-8 font-sans">
            
            {/* é ‚éƒ¨æ¨™é ­å’Œå°èˆª */}
            <header className="max-w-xl mx-auto mb-6">
                <h1 className="text-3xl font-extrabold text-indigo-700 text-center mb-1">
                    å­¸ç”Ÿå¿«æ·é»åç³»çµ±
                </h1>
                
                <div className="flex justify-center space-x-4 mt-3">
                    <button
                        onClick={() => setCurrentView('attendance')}
                        className={`py-1 px-3 text-sm font-medium rounded-full transition ${currentView === 'attendance' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white text-indigo-600 border border-indigo-300'}`}
                        disabled={!userId}
                    >
                        ğŸ“ é»åæ¨¡å¼
                    </button>
                    <button
                        onClick={() => setCurrentView('stats')}
                        className={`py-1 px-3 text-sm font-medium rounded-full transition ${currentView === 'stats' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white text-indigo-600 border border-indigo-300'}`}
                        disabled={!userId}
                    >
                        ğŸ“Š æœŸæœ«çµ±è¨ˆ
                    </button>
                    <button
                        onClick={() => {
                            if(!userId) return;
                            setEditingStudent(null); // æ¸…é™¤æ­£åœ¨ç·¨è¼¯çš„å­¸ç”Ÿ
                            setIsManageModalOpen(true);
                        }}
                        className={`py-1 px-3 text-sm font-medium rounded-full transition bg-white text-gray-600 border border-gray-300 hover:bg-gray-100 disabled:opacity-50`}
                        disabled={!userId}
                    >
                        ğŸ‘¨â€ğŸ“ ç®¡ç†å­¸ç”Ÿ
                    </button>
                </div>
            </header>

            {/* èªè­‰ç‹€æ…‹å€ */}
            <div className="max-w-xl mx-auto text-center mb-4 p-3 bg-white rounded-lg shadow-md">
                {currentUser && currentUser.isAnonymous === false ? (
                    <div className="text-sm text-gray-700">
                        <p>æ­¡è¿, <span className="font-semibold text-indigo-600">{currentUser.displayName || currentUser.email || 'è€å¸«'}</span></p>
                        <p className="text-xs text-gray-500 mt-1">
                            ç”¨æˆ¶ ID: <span className="font-mono text-xs break-all">{userId}</span>
                        </p>
                        <button onClick={handleSignOut} className="mt-2 text-red-500 hover:text-red-700 text-xs">
                            ç™»å‡º
                        </button>
                    </div>
                ) : (
                    <button 
                        onClick={handleGoogleSignIn} 
                        disabled={!isAuthReady}
                        className="flex items-center justify-center mx-auto py-2 px-4 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 transition disabled:opacity-50"
                    >
                        <svg className="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="currentColor" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h6.01c-.26 1.34-1.03 2.53-2.22 3.3l3.57 2.76c2.09-1.93 3.3-4.75 3.3-8.07z" fill="#4285F4"/><path d="M12 23c3.08 0 5.67-1.02 7.56-2.76l-3.57-2.76c-.98.67-2.23 1.06-3.99 1.06-3.08 0-5.71-2.07-6.65-4.99H2.86l-3.79 2.93c1.88 3.75 5.74 6.34 10.93 6.34z" fill="#34A853"/><path d="M5.35 14.84c-.21-.63-.33-1.3-.33-2.03s.12-1.4.33-2.03V7.88L1.56 4.95C.85 6.45.5 8.16.5 10c0 1.84.35 3.55 1.06 5.05L5.35 14.84z" fill="#FBBC05"/><path d="M12 4.19c1.72 0 3.31.59 4.54 1.76l3.18-3.18C17.67 1.25 15.08.19 12 .19 6.81.19 2.95 2.78 1.06 6.53L5.35 9.46c.94-2.92 3.57-4.99 6.65-4.99z" fill="#EA4335"/></svg>
                        ä½¿ç”¨ Google ç™»å…¥ (æ¨è–¦)
                    </button>
                )}
                {!isAuthReady && <p className="text-xs text-gray-400 mt-2">é€£ç·šé©—è­‰ä¸­...</p>}
            </div>


            {/* ä¸»è¦å…§å®¹å€å¡Š */}
            <main className="max-w-xl mx-auto bg-white rounded-xl shadow-2xl overflow-hidden">
                {renderCurrentView()}
            </main>
            
            {/* ç‹€æ…‹èªªæ˜ */}
            <footer className="max-w-xl mx-auto mt-6 p-4 bg-white rounded-xl shadow-md">
                <h3 className="text-lg font-bold text-gray-700 mb-2">é»åç‹€æ…‹èªªæ˜ï¼š</h3>
                <div className="grid grid-cols-2 gap-2 text-sm">
                    {Object.values(STATUS_MAP).map(status => (
                        <div key={status.code} className="flex items-center">
                            <span className={`inline-block w-4 h-4 rounded-full mr-2 ${status.color.split(' ')[0]} ${status.color.includes('white') ? '' : 'border border-gray-300'}`}></span>
                            <span className="text-gray-600">{status.name} ({status.code})</span>
                        </div>
                    ))}
                    <div className="col-span-2 mt-2 pt-2 border-t text-gray-500">
                        <p>ğŸ’¡ **å¿«æ·æ“ä½œï¼š** é»æ“Šå­¸ç”Ÿçš„**å§“åæˆ–å­¸è™Ÿ**å¯ä»¥å¿«é€Ÿé€²å…¥ç·¨è¼¯å­¸ç”Ÿè³‡è¨Šçš„æ¨¡å¼ã€‚</p>
                        <p>âš ï¸ **æ³¨æ„ï¼š** éƒ¨ç½²æ™‚è«‹å‹™å¿…åœ¨ç¨‹å¼ç¢¼ä¸­æ›¿æ› **FIREBASE_CONFIG** çš„å€¼ï¼</p>
                    </div>
                </div>
            </footer>
            
            {/* å­¸ç”Ÿç®¡ç† Modal */}
            <StudentManagerModal 
                isOpen={isManageModalOpen}
                onClose={() => {
                    setIsManageModalOpen(false);
                    setEditingStudent(null);
                }}
                student={editingStudent}
                onSave={saveStudent}
                onRemove={deleteStudent}
            />
        </div>
    );
};

export default App;
