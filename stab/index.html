import React, { useState, useEffect, useCallback, ChangeEvent, FormEvent } from 'react';
import { initializeApp, FirebaseApp } from 'firebase/app';
import { 
    getAuth, 
    onAuthStateChanged,
    GoogleAuthProvider, 
    signInWithPopup,
    signOut,
    Auth,
    User
} from 'firebase/auth';
import { 
    getFirestore, 
    doc, 
    setDoc, 
    collection, 
    onSnapshot, 
    runTransaction,
    writeBatch,
    deleteDoc,
    Firestore,
    DocumentData,
    QuerySnapshot,
    DocumentSnapshot
} from 'firebase/firestore';

// ====================================================================
// 1. é¡å‹å®šç¾© (TypeScript Interfaces)
// ====================================================================

// å­¸ç”Ÿè³‡æ–™ä»‹é¢
interface Student {
    id: string; // å­¸è™Ÿï¼ŒåŒæ™‚ä½œç‚º Firestore Document ID
    name: string;
    email: string;
    firebaseId?: string; // å¦‚æœ Firestore Document ID èˆ‡ id ä¸åŒæ™‚ä½¿ç”¨
}

// é»åç‹€æ…‹ä»‹é¢
interface AttendanceStatus {
    code: 'N/A' | 'P' | 'L' | 'A';
    name: string;
    color: string;
}

// ä»Šæ—¥é»åè¨˜éŒ„ (ä»¥å­¸è™Ÿç‚ºéµ)
type TodayAttendanceRecords = {
    [studentId: string]: 'N/A' | 'P' | 'L' | 'A';
};

// æ­·å²çµ±è¨ˆè³‡æ–™ (ä»¥å­¸è™Ÿç‚ºéµ)
interface StudentStats {
    A: number; // Absences (ç¼ºå¸­)
    L: number; // Late (é²åˆ°)
    totalDays: number; // ç¸½é»åå¤©æ•¸
    days: string[]; // é»åæ—¥æœŸåˆ—è¡¨ (ç”¨æ–¼è¨ˆç®—ç¸½å¤©æ•¸)
}

type AllTimeStats = {
    [studentId: string]: StudentStats;
}

// ====================================================================
// 2. å›ºå®šé…ç½®èˆ‡å·¥å…·å‡½å¼
// ====================================================================

// âš ï¸ ã€é‡è¦ï¼šéƒ¨ç½²æ™‚è«‹åœ¨æ­¤è™•æ›¿æ›ç‚ºæ‚¨çš„ Firebase é…ç½®ã€‘ âš ï¸
const FIREBASE_CONFIG = {
    apiKey: "YOUR_API_KEY", // <-- è«‹æ›¿æ›
    authDomain: "YOUR_AUTH_DOMAIN", // <-- è«‹æ›¿æ›
    projectId: "YOUR_PROJECT_ID",   // <-- è«‹æ›¿æ›
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
    appId: "YOUR_FIREBASE_APP_ID"
};

const DEPLOY_APP_ID = FIREBASE_CONFIG.projectId || 'deployed-attendance-app';

// åˆå§‹åŒ– Firebase å¯¦ä¾‹ (æœƒåœ¨ useEffect ä¸­åˆå§‹åŒ–)
let app: FirebaseApp | null = null;
let db: Firestore | null = null;
let auth: Auth | null = null;

// é»åç‹€æ…‹å®šç¾©
const STATUS_MAP: { [key: string]: AttendanceStatus } = {
    'N/A': { code: 'N/A', name: 'æœªé»å', color: 'bg-gray-200 text-gray-700 hover:bg-gray-300' },
    'P': { code: 'P', name: 'å‡ºå¸­', color: 'bg-green-500 text-white hover:bg-green-600' },
    'L': { code: 'L', name: 'é²åˆ°', color: 'bg-yellow-400 text-yellow-900 hover:bg-yellow-500' },
    'A': { code: 'A', name: 'ç¼ºå¸­', color: 'bg-red-500 text-white hover:bg-red-600' },
};
const STATUS_ORDER: ('N/A' | 'P' | 'L' | 'A')[] = ['N/A', 'P', 'L', 'A'];

// é è¨­å­¸ç”Ÿåå–®
const DEFAULT_STUDENTS: Student[] = [
    { id: 'S001', name: 'ç‹å°æ˜', email: '' },
    { id: 'S002', name: 'é™³å¤§è¯', email: '' },
    { id: 'S003', name: 'æç¾ç²', email: '' },
    { id: 'S004', name: 'å¼µå¿—è±ª', email: '' },
    { id: 'S005', name: 'æ—é›…é›¯', email: '' },
];

// ç²å–å°ç£æ™‚å€ (UTC+8) çš„æ—¥æœŸ YYYY-MM-DD
const getTaiwanDate = (): string => {
    const now = new Date();
    const utcTime = now.getTime() + (now.getTimezoneOffset() * 60000);
    const twTime = new Date(utcTime + (3600000 * 8));
    return twTime.toISOString().split('T')[0];
};

// ====================================================================
// 3. å…ƒä»¶ï¼šå­¸ç”Ÿç®¡ç† Modal
// ====================================================================

interface StudentManagerModalProps {
    isOpen: boolean;
    onClose: () => void;
    student: Student | null;
    onSave: (student: Student) => void;
    onRemove: (firebaseId: string) => void;
}

const StudentManagerModal: React.FC<StudentManagerModalProps> = ({ isOpen, onClose, student, onSave, onRemove }) => {
    // ä½¿ç”¨ student.id ä½œç‚ºåˆå§‹ IDï¼Œå¦‚æœ student ç‚º nullï¼Œå‰‡ ID ç‚ºç©ºå­—ä¸²
    const [id, setId] = useState(student ? student.id : ''); 
    const [name, setName] = useState(student ? student.name : '');
    const [email, setEmail] = useState(student ? student.email : '');
    
    useEffect(() => {
        if (student) {
            setId(student.id);
            setName(student.name);
            setEmail(student.email);
        } else {
            setId('');
            setName('');
            setEmail('');
        }
    }, [student]);

    const handleSubmit = (e: FormEvent) => {
        e.preventDefault();
        if (!id || !name) return;
        
        const studentData: Student = { 
            id: id.trim(), 
            name: name.trim(), 
            email: email.trim() 
        };
        
        onSave(studentData);
    };
    
    // æª¢æŸ¥ firebaseId æ˜¯å¦å­˜åœ¨ï¼Œä»¥ä¾¿åœ¨ç·¨è¼¯æ¨¡å¼ä¸‹å•Ÿç”¨åˆªé™¤
    const studentFirebaseId = student?.firebaseId;

    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
                <h2 className="text-2xl font-bold text-indigo-700 mb-4">{student ? 'ç·¨è¼¯å­¸ç”Ÿè³‡è¨Š' : 'æ–°å¢å­¸ç”Ÿ'}</h2>
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label className="block text-sm font-medium text-gray-700">å­¸è™Ÿ (ID)</label>
                        <input
                            type="text"
                            value={id}
                            onChange={(e: ChangeEvent<HTMLInputElement>) => setId(e.target.value.toUpperCase())}
                            readOnly={!!student} // ç·¨è¼¯æ™‚å­¸è™Ÿä¸å¯æ”¹
                            required
                            className={`mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 ${student ? 'bg-gray-100' : 'border'}`}
                        />
                        {student && <p className="text-xs text-red-500 mt-1">å­¸è™Ÿä¸å¯æ›´æ”¹</p>}
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700">å§“å</label>
                        <input
                            type="text"
                            value={name}
                            onChange={(e: ChangeEvent<HTMLInputElement>) => setName(e.target.value)}
                            required
                            className="mt-1 block w-full rounded-md border border-gray-300 shadow-sm p-2"
                        />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700">Email (é¸å¡«)</label>
                        <input
                            type="email"
                            value={email}
                            onChange={(e: ChangeEvent<HTMLInputElement>) => setEmail(e.target.value)}
                            className="mt-1 block w-full rounded-md border border-gray-300 shadow-sm p-2"
                        />
                    </div>
                    
                    <div className="flex justify-between pt-4">
                        <button
                            type="button"
                            onClick={onClose}
                            className="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 transition"
                        >
                            å–æ¶ˆ
                        </button>
                        <div className="space-x-3">
                            {studentFirebaseId && (
                                <button
                                    type="button"
                                    onClick={() => onRemove(studentFirebaseId)}
                                    className="py-2 px-4 bg-red-600 text-white rounded-md shadow-sm text-sm font-medium hover:bg-red-700 transition"
                                >
                                    åˆªé™¤
                                </button>
                            )}
                            <button
                                type="submit"
                                className="py-2 px-4 bg-indigo-600 text-white rounded-md shadow-sm text-sm font-medium hover:bg-indigo-700 transition"
                            >
                                å„²å­˜
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    );
};


// ====================================================================
// 4. å…ƒä»¶ï¼šçµ±è¨ˆå ±è¡¨æª¢è¦–
// ====================================================================

interface StatsViewProps {
    students: Student[];
    allTimeStats: AllTimeStats;
}

const StatsView: React.FC<StatsViewProps> = ({ students, allTimeStats }) => {
    // æå–æ‰€æœ‰é»åå¤©æ•¸ (ç”¨æ–¼è¨ˆç®—åˆ†æ¯)
    const allDays = new Set<string>();
    Object.values(allTimeStats).forEach(stats => {
        stats.days.forEach(day => allDays.add(day));
    });
    const totalDaysCount = allDays.size;

    const statsList = students.map(student => {
        const stats = allTimeStats[student.id] || { A: 0, L: 0, totalDays: 0, days: [] };
        // ç¼ºå‹¤ç‡è¨ˆç®—: (ç¼ºå¸­ + é²åˆ°) / ç¸½é»åå¤©æ•¸
        const absenceRate = totalDaysCount > 0 
            ? ((stats.A + stats.L) / totalDaysCount) * 100 
            : 0;

        return {
            ...student,
            ...stats,
            absenceRate: absenceRate.toFixed(1), // ä¿ç•™ä¸€ä½å°æ•¸
        };
    }).sort((a, b) => parseFloat(b.absenceRate) - parseFloat(a.absenceRate)); // æŒ‰ç¼ºå‹¤ç‡é™åºæ’åˆ—

    return (
        <div className="p-4">
            <h2 className="text-2xl font-bold text-gray-800 mb-4">ç¸½å‡ºç¼ºå‹¤çµ±è¨ˆ ({totalDaysCount} ç¸½å ‚èª²)</h2>
            <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50">
                        <tr>
                            <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                å­¸ç”Ÿ
                            </th>
                            <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                å­¸è™Ÿ
                            </th>
                            <th className="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ç¼ºå¸­ (A)
                            </th>
                            <th className="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                é²åˆ° (L)
                            </th>
                            <th className="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider text-red-600">
                                ç¼ºå‹¤ç‡ (%)
                            </th>
                        </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                        {statsList.map((s) => (
                            <tr key={s.id} className={parseFloat(s.absenceRate) > 10 ? 'bg-red-50/50' : ''}>
                                <td className="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">
                                    {s.name}
                                </td>
                                <td className="px-3 py-2 whitespace-nowrap text-sm text-gray-500">
                                    {s.id}
                                </td>
                                <td className="px-3 py-2 whitespace-nowrap text-sm text-right text-red-500 font-bold">
                                    {s.A || 0}
                                </td>
                                <td className="px-3 py-2 whitespace-nowrap text-sm text-right text-yellow-600 font-bold">
                                    {s.L || 0}
                                </td>
                                <td className={`px-3 py-2 whitespace-nowrap text-sm text-right font-extrabold ${parseFloat(s.absenceRate) > 10 ? 'text-red-700' : 'text-gray-700'}`}>
                                    {s.absenceRate}%
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
            <p className="mt-4 text-xs text-gray-500">
                è¨»ï¼šç¼ºå‹¤ç‡ = (ç¼ºå¸­æ¬¡æ•¸ + é²åˆ°æ¬¡æ•¸) / ç¸½é»åå¤©æ•¸ã€‚è¡¨æ ¼æŒ‰ç¼ºå‹¤ç‡é™åºæ’åˆ—ã€‚
            </p>
        </div>
    );
};


// ====================================================================
// 5. ä¸»è¦æ‡‰ç”¨ç¨‹å¼å…ƒä»¶
// ====================================================================

const App: React.FC = () => {
    const [userId, setUserId] = useState<string | null>(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [students, setStudents] = useState<Student[]>([]);
    const [todayAttendance, setTodayAttendance] = useState<TodayAttendanceRecords>({});
    const [allTimeStats, setAllTimeStats] = useState<AllTimeStats>({});
    const [date, setDate] = useState<string>(getTaiwanDate()); 
    const [isLoading, setIsLoading] = useState(true);
    const [isSaving, setIsSaving] = useState(false);
    const [currentUser, setCurrentUser] = useState<User | null>(null);
    const [currentView, setCurrentView] = useState<'attendance' | 'stats' | 'manage'>('attendance'); 
    const [isManageModalOpen, setIsManageModalOpen] = useState(false);
    const [editingStudent, setEditingStudent] = useState<Student | null>(null);

    // 1. Firebase åˆå§‹åŒ–å’Œèªè­‰
    useEffect(() => {
        if (!FIREBASE_CONFIG.apiKey || FIREBASE_CONFIG.apiKey === "YOUR_API_KEY") {
            console.error("Firebase Configuration is missing or using default values.");
            setIsAuthReady(true);
            setIsLoading(false);
            return;
        }

        try {
            app = initializeApp(FIREBASE_CONFIG);
            db = getFirestore(app);
            auth = getAuth(app);
            
            const unsubscribe = onAuthStateChanged(auth, (user: User | null) => {
                if (user) {
                    setUserId(user.uid);
                    setCurrentUser(user);
                } else {
                    setUserId(null);
                    setCurrentUser(null);
                }
                setIsAuthReady(true);
                setIsLoading(false);
            });
            
            return () => unsubscribe();
        } catch (e) {
            console.error("Error initializing Firebase:", e);
            setIsLoading(false);
        }
    }, []);

    // Google ç™»å…¥è™•ç†
    const handleGoogleSignIn = async () => {
        if (!auth) return;
        const provider = new GoogleAuthProvider();
        try {
            provider.setCustomParameters({ prompt: 'select_account' });
            await signInWithPopup(auth, provider);
        } catch (error) {
            console.error("Google Sign-In failed:", (error as Error).message);
        }
    };
    
    // ç™»å‡ºè™•ç†
    const handleSignOut = async () => {
        if (!auth) return;
        try {
            await signOut(auth);
        } catch (error) {
            console.error("Sign Out failed:", (error as Error).message);
        }
    };

    // 2. æ•¸æ“šè·¯å¾‘å»ºæ§‹å‡½å¼ (ç§äººè³‡æ–™)
    const getPrivateCollectionPath = (collectionName: string): string | null => {
        if (!userId) return null;
        return `artifacts/${DEPLOY_APP_ID}/users/${userId}/${collectionName}`; 
    };
    
    // 3. ç²å–å­¸ç”Ÿåå–®
    const fetchStudents = useCallback(() => {
        if (!db || !userId) return () => {};
        const studentPath = getPrivateCollectionPath('students');
        if (!studentPath) return () => {};

        const q = collection(db, studentPath);
        const unsubscribe = onSnapshot(q, (snapshot: QuerySnapshot<DocumentData>) => {
            const studentList: Student[] = [];
            snapshot.forEach((doc) => {
                studentList.push({ ...(doc.data() as Student), firebaseId: doc.id });
            });
            
            if (studentList.length === 0) {
                if (students.length === 0 && userId) { 
                    // åˆå§‹åŒ–é è¨­åå–®
                    const batch = writeBatch(db);
                    DEFAULT_STUDENTS.forEach(student => {
                        const studentRef = doc(q, student.id);
                        batch.set(studentRef, student);
                    });
                    batch.commit().catch(e => console.error("Error writing default students:", e));
                    setStudents(DEFAULT_STUDENTS.map(s => ({ ...s, firebaseId: s.id })));
                } else {
                    setStudents([]);
                }
            } else {
                setStudents(studentList.sort((a, b) => a.id.localeCompare(b.id)));
            }
        }, (error) => {
            console.error("Error fetching students:", error);
        });

        return unsubscribe;
    }, [userId, students.length]);

    // 4. ç²å–ç•¶æ—¥é»åè¨˜éŒ„
    const fetchTodayAttendance = useCallback(() => {
        if (!db || !userId || !date) return () => {};
        const attendancePath = getPrivateCollectionPath('attendance');
        if (!attendancePath) return () => {};
        
        const docRef = doc(db, attendancePath, date);

        const unsubscribe = onSnapshot(docRef, (docSnap: DocumentSnapshot<DocumentData>) => {
            if (docSnap.exists()) {
                // TypeScript æ–·è¨€ records çš„é¡å‹
                setTodayAttendance(docSnap.data().records as TodayAttendanceRecords || {});
            } else {
                setTodayAttendance({});
            }
            setIsLoading(false);
        }, (error) => {
            console.error("Error fetching today's attendance:", error);
            setIsLoading(false);
        });

        return unsubscribe;
    }, [userId, date]);

    // 5. ç²å–ç¸½é«”çµ±è¨ˆ
    const fetchAllTimeStats = useCallback(() => {
        if (!db || !userId) return () => {};
        const attendancePath = getPrivateCollectionPath('attendance');
        if (!attendancePath) return () => {};

        const q = collection(db, attendancePath);
        const unsubscribe = onSnapshot(q, (snapshot: QuerySnapshot<DocumentData>) => {
            const stats: { [studentId: string]: { A: number, L: number, days: Set<string> } } = {};
            
            snapshot.forEach((docSnap) => {
                const dateKey = docSnap.id;
                const records = docSnap.data().records as TodayAttendanceRecords || {};
                
                Object.entries(records).forEach(([studentId, status]) => {
                    if (!stats[studentId]) {
                        stats[studentId] = { A: 0, L: 0, days: new Set() };
                    }

                    if (status === 'A' || status === 'L' || status === 'P') {
                        stats[studentId].days.add(dateKey); 
                        if (status === 'A') stats[studentId].A += 1;
                        if (status === 'L') stats[studentId].L += 1;
                    }
                });
            });
            
            const finalStats: AllTimeStats = {};
            Object.entries(stats).forEach(([id, s]) => {
                finalStats[id] = { 
                    A: s.A, 
                    L: s.L, 
                    totalDays: s.days.size, 
                    days: Array.from(s.days)
                };
            });
            setAllTimeStats(finalStats);
        }, (error) => {
            console.error("Error fetching all time stats:", error);
        });

        return unsubscribe;
    }, [userId]);

    // 6. ä¸» Effect - èªè­‰å®Œæˆå¾Œï¼Œé–‹å§‹è¼‰å…¥è³‡æ–™
    useEffect(() => {
        if (isAuthReady && userId && db) {
            setIsLoading(true);
            const unsubscribeStudents = fetchStudents();
            const unsubscribeToday = fetchTodayAttendance();
            const unsubscribeStats = fetchAllTimeStats();

            return () => {
                unsubscribeStudents();
                unsubscribeToday();
                unsubscribeStats();
            };
        } else if (isAuthReady && !userId) {
             setIsLoading(false);
             setStudents([]);
             setTodayAttendance({});
             setAllTimeStats({});
        }
    }, [isAuthReady, userId, date, fetchStudents, fetchTodayAttendance, fetchAllTimeStats]);


    // 7. é»åç‹€æ…‹åˆ‡æ›é‚è¼¯ (æ ¸å¿ƒåŠŸèƒ½)
    const toggleAttendance = async (studentId: string) => {
        if (isSaving || !userId || !db) return;
        setIsSaving(true);
        
        const attendancePath = getPrivateCollectionPath('attendance');
        if (!attendancePath) return;

        const currentStatus = todayAttendance[studentId] || 'N/A';
        const currentIndex = STATUS_ORDER.indexOf(currentStatus as 'N/A' | 'P' | 'L' | 'A');
        const nextIndex = (currentIndex + 1) % STATUS_ORDER.length;
        const newStatus = STATUS_ORDER[nextIndex];
        
        const docRef = doc(db, attendancePath, date);

        try {
            await runTransaction(db, async (transaction) => {
                const docSnap = await transaction.get(docRef);
                const records: TodayAttendanceRecords = docSnap.exists() ? docSnap.data().records as TodayAttendanceRecords : {};

                records[studentId] = newStatus;
                transaction.set(docRef, { date, records }, { merge: true });
            });
        } catch (e) {
            console.error("Transaction failed: ", e);
        } finally {
            setIsSaving(false);
        }
    };
    
    // 8. ä¸€éµé»åå…¨å‡ºå¸­
    const markAllPresent = async () => {
        if (isSaving || students.length === 0 || !userId || !db) return;
        
        if (!window.confirm(`ç¢ºå®šè¦å°‡ ${date} æ‰€æœ‰çš„ ${students.length} ä½å­¸ç”Ÿéƒ½æ¨™è¨˜ç‚ºã€Œå‡ºå¸­ (P)ã€å—ï¼Ÿ`)) {
            return;
        }

        setIsSaving(true);
        const attendancePath = getPrivateCollectionPath('attendance');
        if (!attendancePath) return;
        const docRef = doc(db, attendancePath, date);
        
        try {
            await runTransaction(db, async (transaction) => {
                const docSnap = await transaction.get(docRef);
                const records: TodayAttendanceRecords = docSnap.exists() ? docSnap.data().records as TodayAttendanceRecords : {};

                students.forEach(student => {
                    records[student.id] = 'P'; 
                });

                transaction.set(docRef, { date, records }, { merge: true });
            });
        } catch (e) {
            console.error("Transaction failed during Mark All Present: ", e);
        } finally {
            setIsSaving(false);
        }
    };

    // 9. å­¸ç”Ÿç®¡ç† CRUD é‚è¼¯
    const saveStudent = async (studentData: Student) => {
        if (!userId || !db) return;
        setIsSaving(true);
        const studentPath = getPrivateCollectionPath('students');
        if (!studentPath) return;
        
        // ç¢ºä¿ studentData ä¸­æ²’æœ‰ firebaseId å­—æ®µï¼Œå¦å‰‡ Firestore æœƒå ±éŒ¯ (é™¤éä½¿ç”¨ setDoc(docRef, studentData))
        const { firebaseId, ...dataToSave } = studentData; 
        
        const docRef = doc(db, studentPath, dataToSave.id); 

        try {
            await setDoc(docRef, dataToSave, { merge: true });
            setIsManageModalOpen(false);
        } catch (e) {
            console.error("Error saving student:", e);
        } finally {
            setIsSaving(false);
        }
    };

    const deleteStudent = async (firebaseId: string) => {
        if (!userId || !db) return;
        
        if (!window.confirm(`ç¢ºå®šè¦åˆªé™¤å­¸è™Ÿ ${firebaseId} çš„å­¸ç”Ÿå—ï¼Ÿé€™å°‡ç„¡æ³•æ¢å¾©ã€‚`)) {
            return;
        }

        setIsSaving(true);
        const studentPath = getPrivateCollectionPath('students');
        if (!studentPath) return;
        const docRef = doc(db, studentPath, firebaseId); 

        try {
            await deleteDoc(docRef);
            setIsManageModalOpen(false);
            setEditingStudent(null);
        } catch (e) {
            console.error("Error deleting student:", e);
        } finally {
            setIsSaving(false);
        }
    };

    // æ¸²æŸ“å‡½å¼
    const renderStudentRow = (student: Student) => {
        const studentId = student.id;
        const status = todayAttendance[studentId] || 'N/A';
        const statusData = STATUS_MAP[status];
        const stats = allTimeStats[studentId] || { A: 0, L: 0, totalDays: 0, days: [] };
        
        const totalAbsences = stats.A + stats.L;

        return (
            <li key={studentId} className="flex items-center justify-between p-3 border-b hover:bg-gray-50 transition duration-150 ease-in-out">
                {/* å­¸ç”Ÿè³‡è¨Š */}
                <div className="flex-1 min-w-0" onClick={() => {
                    if(!userId) return;
                    setEditingStudent(student);
                    setIsManageModalOpen(true);
                }}>
                    <p className="text-sm font-semibold text-gray-800 truncate cursor-pointer hover:text-indigo-600">
                        {student.name} ({student.id})
                    </p>
                    <p className="text-xs text-gray-500">
                        ç¸½ç¼ºå‹¤/é²åˆ°: <span className="font-mono font-bold text-red-600">{totalAbsences}</span> æ¬¡
                        <span className="ml-2 text-gray-400">({stats.totalDays} ç¸½é»åå¤©æ•¸)</span>
                    </p>
                </div>

                {/* ç‹€æ…‹åˆ‡æ›æŒ‰éˆ• */}
                <button
                    onClick={() => toggleAttendance(studentId)}
                    disabled={isSaving || isLoading || !userId}
                    className={`ml-4 w-28 py-2 px-3 text-sm font-medium rounded-full shadow-md transform transition duration-150 ease-in-out 
                                ${statusData.color} 
                                ${isSaving || isLoading || !userId ? 'opacity-50 cursor-not-allowed' : 'active:scale-95'}`}
                >
                    {statusData.name} ({statusData.code})
                </button>
            </li>
        );
    };

    // æ¸²æŸ“ç•¶å‰ä¸»è¦è¦–åœ–
    const renderCurrentView = () => {
        if (!userId) {
            return (
                 <div className="p-10 text-center text-gray-600">
                    <p className="text-lg font-semibold mb-4">è«‹å…ˆç™»å…¥ä»¥å­˜å–æ‚¨çš„å­¸ç”Ÿåå–®å’Œé»åæ•¸æ“šã€‚</p>
                    <p className="text-sm">é»æ“Šä¸Šæ–¹çš„ **ä½¿ç”¨ Google ç™»å…¥ (æ¨è–¦)** é–‹å§‹ä½¿ç”¨ã€‚</p>
                </div>
            )
        }
        
        if (currentView === 'stats') {
            return <StatsView students={students} allTimeStats={allTimeStats} />;
        }
        
        // é è¨­ç‚ºé»å ('attendance') è¦–åœ–
        return (
            <>
                <div className="p-4 border-b bg-indigo-50 flex flex-col sm:flex-row items-center justify-between space-y-3 sm:space-y-0">
                    <div className="flex items-center space-x-2">
                        <label htmlFor="attendance-date" className="text-sm font-medium text-indigo-700 whitespace-nowrap">
                            é»åæ—¥æœŸ (UTC+8):
                        </label>
                        <input
                            type="date"
                            id="attendance-date"
                            value={date}
                            onChange={(e: ChangeEvent<HTMLInputElement>) => {
                                setDate(e.target.value);
                                setIsLoading(true); 
                            }}
                            className="p-2 border border-indigo-300 rounded-lg text-sm shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                        />
                    </div>
                    
                    <button
                        onClick={markAllPresent}
                        disabled={isSaving || isLoading || students.length === 0}
                        className="py-2 px-4 bg-purple-600 text-white rounded-lg shadow-md hover:bg-purple-700 transition duration-150 text-sm font-medium disabled:opacity-50"
                    >
                        {isSaving ? 'å„²å­˜ä¸­...' : 'ä¸€éµé»åå…¨å‡ºå¸­'}
                    </button>
                </div>
                
                {/* å­¸ç”Ÿåˆ—è¡¨ */}
                <div className="max-h-[60vh] overflow-y-auto">
                    {isLoading ? (
                         <div className="p-10 text-center text-indigo-600 flex justify-center items-center space-x-2">
                            <svg className="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span className="text-sm">è³‡æ–™è¼‰å…¥ä¸­...</span>
                        </div>
                    ) : students.length > 0 ? (
                        <ul className="divide-y divide-gray-100">
                            {students.map(renderStudentRow)}
                        </ul>
                    ) : (
                        <div className="p-10 text-center text-gray-500">
                            <p>å­¸ç”Ÿåå–®ç‚ºç©ºã€‚è«‹é»æ“Šä¸Šæ–¹ã€Œç®¡ç†å­¸ç”Ÿã€æŒ‰éˆ•æ–°å¢å­¸ç”Ÿã€‚</p>
                        </div>
                    )}
                </div>
            </>
        );
    };

    return (
        <div className="min-h-screen bg-gray-100 p-4 sm:p-8 font-sans">
            
            {/* é ‚éƒ¨æ¨™é ­å’Œå°èˆª */}
            <header className="max-w-xl mx-auto mb-6">
                <h1 className="text-3xl font-extrabold text-indigo-700 text-center mb-1">
                    å­¸ç”Ÿå¿«æ·é»åç³»çµ±
                </h1>
                
                <div className="flex justify-center space-x-4 mt-3">
                    <button
                        onClick={() => setCurrentView('attendance')}
                        className={`py-1 px-3 text-sm font-medium rounded-full transition ${currentView === 'attendance' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white text-indigo-600 border border-indigo-300'}`}
                        disabled={!userId}
                    >
                        ğŸ“ é»åæ¨¡å¼
                    </button>
                    <button
                        onClick={() => setCurrentView('stats')}
                        className={`py-1 px-3 text-sm font-medium rounded-full transition ${currentView === 'stats' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white text-indigo-600 border border-indigo-300'}`}
                        disabled={!userId}
                    >
                        ğŸ“Š æœŸæœ«çµ±è¨ˆ
                    </button>
                    <button
                        onClick={() => {
                            if(!userId) return;
                            setEditingStudent(null);
                            setIsManageModalOpen(true);
                        }}
                        className={`py-1 px-3 text-sm font-medium rounded-full transition bg-white text-gray-600 border border-gray-300 hover:bg-gray-100 disabled:opacity-50`}
                        disabled={!userId}
                    >
                        ğŸ‘¨â€ğŸ“ ç®¡ç†å­¸ç”Ÿ
                    </button>
                </div>
            </header>

            {/* èªè­‰ç‹€æ…‹å€ */}
            <div className="max-w-xl mx-auto text-center mb-4 p-3 bg-white rounded-lg shadow-md">
                {currentUser ? (
                    <div className="text-sm text-gray-700">
                        <p>æ­¡è¿, <span className="font-semibold text-indigo-600">{currentUser.displayName || currentUser.email || 'è€å¸«'}</span></p>
                        <p className="text-xs text-gray-500 mt-1">
                            ç”¨æˆ¶ ID: <span className="font-mono text-xs break-all">{userId}</span>
                        </p>
                        <button onClick={handleSignOut} className="mt-2 text-red-500 hover:text-red-700 text-xs">
                            ç™»å‡º
                        </button>
                    </div>
                ) : (
                    <button 
                        onClick={handleGoogleSignIn} 
                        disabled={!isAuthReady}
                        className="flex items-center justify-center mx-auto py-2 px-4 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 transition disabled:opacity-50"
                    >
                        <svg className="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h6.01c-.26 1.34-1.03 2.53-2.22 3.3l3.57 2.76c2.09-1.93 3.3-4.75 3.3-8.07z" fill="#4285F4"/><path d="M12 23c3.08 0 5.67-1.02 7.56-2.76l-3.57-2.76c-.98.67-2.23 1.06-3.99 1.06-3.08 0-5.71-2.07-6.65-4.99H2.86l-3.79 2.93c1.88 3.75 5.74 6.34 10.93 6.34z" fill="#34A853"/><path d="M5.35 14.84c-.21-.63-.33-1.3-.33-2.03s.12-1.4.33-2.03V7.88L1.56 4.95C.85 6.45.5 8.16.5 10c0 1.84.35 3.55 1.06 5.05L5.35 14.84z" fill="#FBBC05"/><path d="M12 4.19c1.72 0 3.31.59 4.54 1.76l3.18-3.18C17.67 1.25 15.08.19 12 .19 6.81.19 2.95 2.78 1.06 6.53L5.35 9.46c.94-2.92 3.57-4.99 6.65-4.99z" fill="#EA4335"/></svg>
                        ä½¿ç”¨ Google ç™»å…¥ (æ¨è–¦)
                    </button>
                )}
                {!isAuthReady && <p className="text-xs text-gray-400 mt-2">é€£ç·šé©—è­‰ä¸­...</p>}
            </div>


            {/* ä¸»è¦å…§å®¹å€å¡Š */}
            <main className="max-w-xl mx-auto bg-white rounded-xl shadow-2xl overflow-hidden">
                {renderCurrentView()}
            </main>
            
            {/* ç‹€æ…‹èªªæ˜ */}
            <footer className="max-w-xl mx-auto mt-6 p-4 bg-white rounded-xl shadow-md">
                <h3 className="text-lg font-bold text-gray-700 mb-2">é»åç‹€æ…‹èªªæ˜ï¼š</h3>
                <div className="grid grid-cols-2 gap-2 text-sm">
                    {Object.values(STATUS_MAP).map(status => (
                        <div key={status.code} className="flex items-center">
                            <span className={`inline-block w-4 h-4 rounded-full mr-2 ${status.color.split(' ')[0]} ${status.color.includes('white') ? '' : 'border border-gray-300'}`}></span>
                            <span className="text-gray-600">{status.name} ({status.code})</span>
                        </div>
                    ))}
                    <div className="col-span-2 mt-2 pt-2 border-t text-gray-500">
                        <p>ğŸ’¡ **å¿«æ·æ“ä½œï¼š** é»æ“Šå­¸ç”Ÿçš„**å§“åæˆ–å­¸è™Ÿ**å¯ä»¥å¿«é€Ÿé€²å…¥ç·¨è¼¯å­¸ç”Ÿè³‡è¨Šçš„æ¨¡å¼ã€‚</p>
                        <p>âš ï¸ **æ³¨æ„ï¼š** éƒ¨ç½²æ™‚è«‹å‹™å¿…åœ¨ç¨‹å¼ç¢¼ä¸­æ›¿æ› **FIREBASE_CONFIG** çš„å€¼ï¼</p>
                    </div>
                </div>
            </footer>
            
            {/* å­¸ç”Ÿç®¡ç† Modal */}
            <StudentManagerModal 
                isOpen={isManageModalOpen}
                onClose={() => {
                    setIsManageModalOpen(false);
                    setEditingStudent(null);
                }}
                student={editingStudent}
                onSave={saveStudent}
                onRemove={deleteStudent}
            />
        </div>
    );
};

export default App;
