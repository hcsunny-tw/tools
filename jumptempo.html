<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>跳跳 Tempo</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 React 和 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- 引入 Babel 用於解析 JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- 引入 SheetJS 用於解析 Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <style>
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; }
        /* 自定義動畫類別 */
        .animate-in { animation: fadeIn 0.5s ease-out; }
        .slide-in-from-bottom { animation: slideUp 0.5s ease-out; }
        .zoom-in { animation: zoomIn 0.5s ease-out; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="bg-slate-50 overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 圖示組件 (SVG) ---
        const IconBase = ({ children, size = 24, className = "", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                {children}
            </svg>
        );

        const Play = (props) => <IconBase {...props}><polygon points="5 3 19 12 5 21 5 3"></polygon></IconBase>;
        const Pause = (props) => <IconBase {...props}><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></IconBase>;
        const PlayCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"></circle><polygon points="10 8 16 12 10 16 10 8"></polygon></IconBase>;
        const RotateCcw = (props) => <IconBase {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></IconBase>;
        const ArrowRight = (props) => <IconBase {...props}><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></IconBase>;
        const CheckCircle = (props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></IconBase>;
        const XCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></IconBase>;
        
        // 修正後的 Timer 圖示：改為標準的圓形錶面加指針，解決破圖問題
        const Timer = (props) => <IconBase {...props}><line x1="10" x2="14" y1="2" y2="2"></line><line x1="12" x2="15" y1="14" y2="11"></line><circle cx="12" cy="14" r="8"></circle></IconBase>;
        
        const Volume2 = (props) => <IconBase {...props}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></IconBase>;
        const VolumeX = (props) => <IconBase {...props}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></IconBase>;
        const Settings = (props) => <IconBase {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></IconBase>;
        const Plus = (props) => <IconBase {...props}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></IconBase>;
        const Save = (props) => <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></IconBase>;
        const Download = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></IconBase>;
        const Upload = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></IconBase>;
        const FileSpreadsheet = (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M8 13h2"></path><path d="M8 17h2"></path><path d="M14 13h2"></path><path d="M14 17h2"></path></IconBase>;
        const Home = (props) => <IconBase {...props}><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></IconBase>;
        const SkipForward = (props) => <IconBase {...props}><polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19"></line></IconBase>;

        // --- 預設資料 ---
        const DEFAULT_QUESTIONS = [
            { id: 1, text: "三角形有 3 個角，也有 3 個邊。", answer: "O", explanation: "這是三角形的基本定義。" },
            { id: 2, text: "8 加 7 的答案是 16。", answer: "X", explanation: "8 + 7 = 15。" },
            { id: 3, text: "分針走一小格是1分鐘。", answer: "O", explanation: "這是時鐘的知識。" },
            { id: 4, text: "時鐘上的「長針」是時針。", answer: "X", explanation: "長針是分針，短針才是時針。" },
            { id: 5, text: "正方形的 4 個邊都一樣長。", answer: "O", explanation: "這是正方形的特性。" },
        ];

        const DEFAULT_GAME_TIME = 8;

        // --- 音效處理 ---
        const playSynthSound = (type, isMuted) => {
            if (isMuted) return;
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            
            const ctx = new AudioContext();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            
            const now = ctx.currentTime;

            if (type === 'tick') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            } else if (type === 'timeUp') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.setValueAtTime(800, now + 0.1);
                osc.frequency.setValueAtTime(0, now + 0.15); 
                osc.frequency.setValueAtTime(800, now + 0.2);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.6);
                osc.start(now);
                osc.stop(now + 0.6);
            } else if (type === 'O') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(523.25, now);
                osc.frequency.setValueAtTime(659.25, now + 0.1);
                osc.frequency.setValueAtTime(783.99, now + 0.2);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0.3, now + 0.2);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 1.2);
                osc.start(now);
                osc.stop(now + 1.2);
            } else if (type === 'X') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(100, now + 0.4);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.linearRampToValueAtTime(0.01, now + 0.4);
                osc.start(now);
                osc.stop(now + 0.4);
            }
        };

        // --- 主應用程式 ---
        function App() {
            const [gameState, setGameState] = useState('welcome');
            const [questions, setQuestions] = useState(DEFAULT_QUESTIONS);
            const [gameTime, setGameTime] = useState(DEFAULT_GAME_TIME);
            
            const [currentQIndex, setCurrentQIndex] = useState(0);
            const [timeLeft, setTimeLeft] = useState(gameTime);
            const [isPaused, setIsPaused] = useState(false);
            const [isMuted, setIsMuted] = useState(false);
            const [showHomeConfirm, setShowHomeConfirm] = useState(false); // 新增：控制回首頁確認視窗

            // 新增題目表單狀態
            const [newQText, setNewQText] = useState("");
            const [newQAns, setNewQAns] = useState("O");
            const [newQExp, setNewQExp] = useState("");

            const fileInputRef = useRef(null);

            useEffect(() => {
                let timer;
                if (gameState === 'playing' && timeLeft > 0 && !isPaused) {
                timer = setInterval(() => {
                    setTimeLeft((prev) => {
                        const newTime = prev - 1;
                        if (newTime <= 3 && newTime >= 0) {
                            playSynthSound('tick', isMuted);
                        }
                        return newTime;
                    });
                }, 1000);
                } else if (timeLeft === 0 && gameState === 'playing') {
                playSynthSound('timeUp', isMuted);
                setGameState('timeUp');
                }
                return () => clearInterval(timer);
            }, [gameState, timeLeft, isPaused, isMuted]);

            const startGame = () => {
                if (questions.length === 0) {
                    alert("題庫為空，請先到設定新增題目！");
                    return;
                }
                playSynthSound('tick', isMuted); 
                setGameState('playing');
                setCurrentQIndex(0);
                setTimeLeft(gameTime);
                setIsPaused(false);
            };

            const nextQuestion = () => {
                if (currentQIndex < questions.length - 1) {
                setCurrentQIndex((prev) => prev + 1);
                setTimeLeft(gameTime);
                setGameState('playing');
                setIsPaused(false);
                } else {
                setGameState('finished');
                playSynthSound('O', isMuted);
                }
            };

            const revealAnswer = () => {
                const currentAns = questions[currentQIndex].answer;
                playSynthSound(currentAns, isMuted);
                setGameState('revealed');
            };

            const togglePause = () => {
                setIsPaused(!isPaused);
            };

            // --- 新增功能：回到首頁與跳過題目 ---
            
            const goHome = () => {
                // 改用自製 Modal，避免 window.confirm 被瀏覽器阻擋
                setShowHomeConfirm(true);
            };

            const confirmGoHome = () => {
                setGameState('welcome');
                setCurrentQIndex(0);
                setIsPaused(false);
                setShowHomeConfirm(false);
            };

            const skipQuestion = () => {
                // 直接跳到下一題的邏輯，不顯示答案
                if (currentQIndex < questions.length - 1) {
                    setCurrentQIndex((prev) => prev + 1);
                    setTimeLeft(gameTime);
                    setGameState('playing');
                    setIsPaused(false);
                } else {
                    setGameState('finished');
                }
            };

            // --- 設定功能 ---
            const handleAddQuestion = () => {
                if (!newQText.trim()) return;
                const newId = questions.length > 0 ? Math.max(...questions.map(q => q.id)) + 1 : 1;
                const newQuestion = {
                    id: newId,
                    text: newQText,
                    answer: newQAns,
                    explanation: newQExp || "無解析"
                };
                setQuestions([...questions, newQuestion]);
                setNewQText("");
                setNewQAns("O");
                setNewQExp("");
            };

            const handleDeleteQuestion = (id) => {
                setQuestions(questions.filter(q => q.id !== id));
            };

            const handleResetDefaults = () => {
                if(window.confirm("確定要重置回預設的題目嗎？目前的自訂題目將會消失。")) {
                    setQuestions(DEFAULT_QUESTIONS);
                    setGameTime(DEFAULT_GAME_TIME);
                }
            };

            // --- Excel 匯入/匯出功能 ---
            
            const handleDownloadTemplate = () => {
                const templateData = [
                    ["題目", "答案", "解析"],
                    ["地球是圓的", "O", "這是常識"],
                    ["1+1=3", "X", "數學事實"],
                    ["太陽從西邊升起", "X", "太陽從東邊升起"]
                ];
                
                const ws = XLSX.utils.aoa_to_sheet(templateData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "題庫範本");
                XLSX.writeFile(wb, "跳跳Tempo題庫範本.xlsx");
            };

            const handleImportExcel = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const data = evt.target.result;
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const sheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(sheet);

                        if (jsonData.length === 0) {
                            alert("Excel 檔案中沒有資料！");
                            return;
                        }

                        const validQuestions = [];
                        let errorCount = 0;

                        jsonData.forEach((row, index) => {
                            const text = row['題目'] || row['Question'] || row['question'];
                            let answerRaw = row['答案'] || row['Answer'] || row['answer'];
                            const explanation = row['解析'] || row['Explanation'] || row['explanation'] || "無解析";

                            if (text) {
                                let answer = 'X';
                                if (answerRaw) {
                                    const ansStr = String(answerRaw).trim().toUpperCase();
                                    const validO = ['O', '0', '圈', '是', 'TRUE', 'T', 'YES', 'Y'];
                                    if (validO.some(v => ansStr.startsWith(v))) {
                                        answer = 'O';
                                    }
                                }

                                validQuestions.push({
                                    id: Date.now() + index,
                                    text: String(text),
                                    answer: answer,
                                    explanation: String(explanation)
                                });
                            } else {
                                errorCount++;
                            }
                        });

                        if (validQuestions.length > 0) {
                            const confirmMsg = `成功讀取 ${validQuestions.length} 題。` + 
                                               (errorCount > 0 ? `\n(有 ${errorCount} 筆資料因格式錯誤被略過)` : "") +
                                               `\n\n請問要「覆蓋」現有題庫，還是「追加」到現有題庫後方？\n(確定=覆蓋，取消=追加)`;
                            
                            if (window.confirm(confirmMsg)) {
                                setQuestions(validQuestions);
                            } else {
                                setQuestions([...questions, ...validQuestions]);
                            }
                            alert("題庫匯入成功！");
                        } else {
                            alert("找不到有效的題目資料，請確認 Excel 欄位名稱是否包含「題目」、「答案」。");
                        }
                        
                        if (fileInputRef.current) fileInputRef.current.value = '';

                    } catch (error) {
                        console.error(error);
                        alert("檔案讀取失敗，請確認檔案格式是否正確 (.xlsx)。");
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            const currentQuestion = questions[currentQIndex];

            const getAnswerColor = (ans) => ans === 'O' ? 'bg-green-600' : 'bg-red-600';
            const getAnswerIcon = (ans) => ans === 'O' ? <CheckCircle size={160} className="text-white drop-shadow-2xl" /> : <XCircle size={160} className="text-white drop-shadow-2xl" />;

            return (
                <div className="h-screen w-screen bg-slate-50 font-sans select-none overflow-hidden relative flex flex-col">
                
                {/* 頂部進度條 */}
                {(gameState === 'playing' || gameState === 'timeUp') && (
                    <div className="absolute top-0 left-0 w-full h-3 bg-slate-200 z-50">
                    <div 
                        className={`h-full transition-all duration-1000 ease-linear ${timeLeft <= 3 ? 'bg-red-500' : 'bg-blue-500'}`}
                        style={{ width: `${(timeLeft / gameTime) * 100}%` }}
                    />
                    </div>
                )}

                {/* 頂部控制列 - Z-Index 提高到 60 確保在遮罩之上 */}
                <div className="absolute top-6 left-6 right-6 flex justify-between items-start z-[60] pointer-events-none">
                    {/* 題號 */}
                    {(gameState === 'playing' || gameState === 'timeUp' || gameState === 'revealed') && (
                        <div className="pointer-events-auto bg-white/90 backdrop-blur shadow-lg rounded-full px-6 py-2 flex items-center gap-3 border border-slate-200">
                        <span className="bg-slate-800 text-white px-3 py-0.5 rounded-full text-lg font-bold">
                            Q{currentQIndex + 1}/{questions.length}
                        </span>
                        <span className="text-slate-600 font-bold text-lg hidden sm:inline">跳跳 Tempo</span>
                        </div>
                    )}
                    
                    {/* 佔位符 */}
                    {(gameState === 'welcome' || gameState === 'settings' || gameState === 'finished') && <div></div>}

                    {/* 右側按鈕 */}
                    <div className="pointer-events-auto flex items-center gap-3">
                    
                    {/* 回首頁按鈕：僅在遊戲進行中(包含暫停、時間到、公布答案)顯示 */}
                    {(gameState === 'playing' || gameState === 'timeUp' || gameState === 'revealed') && (
                        <button 
                            onClick={goHome} 
                            className="bg-white/90 backdrop-blur shadow-lg p-3 rounded-full text-slate-700 hover:text-red-600 hover:scale-105 transition-all border border-slate-200"
                            title="回到首頁"
                        >
                            <Home size={28} />
                        </button>
                    )}

                    {gameState === 'welcome' && (
                            <button 
                            onClick={() => setGameState('settings')} 
                            className="bg-white/90 backdrop-blur shadow-lg p-3 rounded-full text-slate-700 hover:text-slate-900 hover:rotate-90 transition-all border border-slate-200"
                            title="設定"
                            >
                            <Settings size={28} />
                            </button>
                    )}

                    <button 
                        onClick={() => setIsMuted(!isMuted)} 
                        className="bg-white/90 backdrop-blur shadow-lg p-3 rounded-full text-slate-700 hover:text-blue-600 hover:scale-105 transition-all border border-slate-200"
                        title={isMuted ? "開啟音效" : "靜音"}
                    >
                        {isMuted ? <VolumeX size={24} /> : <Volume2 size={24} />}
                    </button>
                    
                    {/* 跳過按鈕：僅在回答階段顯示 */}
                    {gameState === 'playing' && (
                        <button 
                            onClick={skipQuestion} 
                            className="bg-white/90 backdrop-blur shadow-lg p-3 rounded-full text-slate-700 hover:text-orange-500 hover:scale-105 transition-all border border-slate-200"
                            title="跳過此題"
                        >
                            <SkipForward size={28} />
                        </button>
                    )}

                    {gameState === 'playing' && (
                        <button 
                        onClick={togglePause} 
                        className="bg-white/90 backdrop-blur shadow-lg p-3 rounded-full text-slate-700 hover:text-blue-600 hover:scale-105 transition-all border border-slate-200"
                        title={isPaused ? "繼續" : "暫停"}
                        >
                        {isPaused ? <PlayCircle size={28} /> : <Pause size={28} />}
                        </button>
                    )}

                    {(gameState === 'playing' || gameState === 'timeUp') && (
                        <div className={`bg-white/90 backdrop-blur shadow-lg px-5 py-2 rounded-full flex items-center gap-3 border border-slate-200 ${timeLeft <= 3 && gameState === 'playing' ? 'text-red-500' : 'text-slate-700'}`}>
                            <Timer size={24} />
                            <span className="font-mono text-3xl font-bold w-8 text-center">{timeLeft}</span>
                        </div>
                    )}
                    </div>
                </div>

                {/* 主內容區 */}
                <div className="flex-1 flex flex-col items-center justify-center relative w-full h-full">
                    
                    {/* 回首頁確認視窗 Modal */}
                    {showHomeConfirm && (
                        <div className="absolute inset-0 bg-black/50 backdrop-blur-sm z-[70] flex items-center justify-center animate-in fade-in">
                            <div className="bg-white rounded-2xl p-8 shadow-2xl max-w-md w-full mx-4 text-center">
                                <h3 className="text-2xl font-bold text-slate-800 mb-4">確定要回到首頁嗎？</h3>
                                <p className="text-slate-600 mb-8 text-lg">目前的遊戲進度將會遺失。</p>
                                <div className="flex gap-4 justify-center">
                                    <button 
                                        onClick={() => setShowHomeConfirm(false)}
                                        className="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-3 px-6 rounded-xl transition-colors text-lg"
                                    >
                                        取消
                                    </button>
                                    <button 
                                        onClick={confirmGoHome}
                                        className="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-xl transition-colors text-lg"
                                    >
                                        確定
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 設定畫面 */}
                    {gameState === 'settings' && (
                        <div className="absolute inset-0 z-50 bg-slate-100 flex flex-col items-center py-20 px-4 overflow-hidden">
                            <div className="w-full max-w-4xl bg-white rounded-3xl shadow-xl flex flex-col h-full overflow-hidden border border-slate-200 animate-in slide-in-from-bottom duration-300">
                                
                                <div className="bg-slate-800 text-white p-6 flex justify-between items-center shrink-0">
                                    <h2 className="text-3xl font-bold flex items-center gap-3">
                                        <Settings /> 遊戲設定
                                    </h2>
                                    <button 
                                        onClick={() => setGameState('welcome')}
                                        className="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-full font-bold flex items-center gap-2 transition-colors"
                                    >
                                        <Save size={20} /> 完成並返回
                                    </button>
                                </div>

                                <div className="flex-1 overflow-y-auto p-8 space-y-8">
                                    <section className="bg-slate-50 p-6 rounded-2xl border border-slate-200">
                                        <h3 className="text-xl font-bold text-slate-700 mb-4 flex items-center gap-2">
                                            <Timer size={24} /> 每題思考時間
                                        </h3>
                                        <div className="flex items-center gap-4">
                                            <input 
                                                type="range" 
                                                min="3" 
                                                max="60" 
                                                value={gameTime} 
                                                onChange={(e) => setGameTime(Number(e.target.value))}
                                                className="w-64 h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer"
                                            />
                                            <span className="text-3xl font-mono font-bold text-blue-600 w-16 text-center">{gameTime}</span>
                                            <span className="text-slate-500 font-bold">秒</span>
                                        </div>
                                    </section>
                                    
                                    {/* Excel 匯入/匯出區塊 */}
                                    <section className="bg-green-50 p-6 rounded-2xl border border-green-100">
                                        <h3 className="text-xl font-bold text-green-800 mb-4 flex items-center gap-2">
                                            <FileSpreadsheet size={24} /> 批次匯入題庫 (Excel)
                                        </h3>
                                        <div className="flex gap-4 flex-wrap">
                                            <button 
                                                onClick={handleDownloadTemplate}
                                                className="flex-1 bg-white border border-green-200 text-green-700 hover:bg-green-100 px-6 py-4 rounded-xl font-bold flex items-center justify-center gap-3 transition-colors shadow-sm"
                                            >
                                                <Download size={24} /> 下載 Excel 範本
                                            </button>
                                            
                                            <button 
                                                onClick={() => fileInputRef.current.click()}
                                                className="flex-1 bg-green-600 hover:bg-green-700 text-white px-6 py-4 rounded-xl font-bold flex items-center justify-center gap-3 transition-colors shadow-sm"
                                            >
                                                <Upload size={24} /> 匯入 Excel 題庫
                                            </button>
                                            {/* 隱藏的檔案輸入框 */}
                                            <input 
                                                type="file" 
                                                ref={fileInputRef} 
                                                onChange={handleImportExcel} 
                                                accept=".xlsx, .xls"
                                                className="hidden" 
                                            />
                                        </div>
                                        <p className="mt-3 text-sm text-green-600/80">
                                            * 支援格式：.xlsx, .xls。請使用範本格式，欄位順序為：題目、答案、解析。
                                        </p>
                                    </section>

                                    <section>
                                        <div className="flex justify-between items-end mb-4">
                                            <h3 className="text-xl font-bold text-slate-700 flex items-center gap-2">
                                                <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded text-base">共 {questions.length} 題</span> 
                                                單題管理
                                            </h3>
                                            <button 
                                                onClick={handleResetDefaults}
                                                className="text-slate-400 hover:text-red-500 text-sm flex items-center gap-1 transition-colors"
                                            >
                                                <RotateCcw size={14} /> 重置回預設題庫
                                            </button>
                                        </div>

                                        <div className="bg-blue-50 p-6 rounded-2xl border border-blue-100 mb-6">
                                            <h4 className="font-bold text-blue-800 mb-3 flex items-center gap-2"><Plus size={18}/> 新增題目</h4>
                                            <div className="grid grid-cols-1 md:grid-cols-12 gap-4">
                                                <div className="md:col-span-6">
                                                    <input 
                                                        type="text" 
                                                        placeholder="請輸入題目敘述..." 
                                                        value={newQText}
                                                        onChange={(e) => setNewQText(e.target.value)}
                                                        className="w-full p-3 rounded-lg border border-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400"
                                                    />
                                                </div>
                                                <div className="md:col-span-2">
                                                    <select 
                                                        value={newQAns} 
                                                        onChange={(e) => setNewQAns(e.target.value)}
                                                        className="w-full p-3 rounded-lg border border-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400 font-bold"
                                                    >
                                                        <option value="O">答案：O</option>
                                                        <option value="X">答案：X</option>
                                                    </select>
                                                </div>
                                                <div className="md:col-span-3">
                                                    <input 
                                                        type="text" 
                                                        placeholder="解析 (選填)" 
                                                        value={newQExp}
                                                        onChange={(e) => setNewQExp(e.target.value)}
                                                        className="w-full p-3 rounded-lg border border-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400"
                                                    />
                                                </div>
                                                <div className="md:col-span-1">
                                                    <button 
                                                        onClick={handleAddQuestion}
                                                        disabled={!newQText.trim()}
                                                        className="w-full h-full bg-blue-600 hover:bg-blue-700 disabled:bg-slate-300 text-white rounded-lg flex items-center justify-center transition-colors"
                                                    >
                                                        <Plus size={24} />
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="bg-white rounded-2xl border border-slate-200 overflow-hidden max-h-[400px] overflow-y-auto shadow-inner">
                                            {questions.length === 0 ? (
                                                <div className="p-8 text-center text-slate-400">目前沒有題目，請新增。</div>
                                            ) : (
                                                <table className="w-full text-left border-collapse">
                                                    <thead className="bg-slate-50 text-slate-500 sticky top-0 z-10">
                                                        <tr>
                                                            <th className="p-4 font-semibold w-16 text-center">#</th>
                                                            <th className="p-4 font-semibold">題目</th>
                                                            <th className="p-4 font-semibold w-24 text-center">答案</th>
                                                            <th className="p-4 font-semibold hidden md:table-cell">解析</th>
                                                            <th className="p-4 font-semibold w-20 text-center">操作</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y divide-slate-100">
                                                        {questions.map((q, idx) => (
                                                            <tr key={q.id} className="hover:bg-slate-50 transition-colors">
                                                                <td className="p-4 text-center text-slate-400 font-mono">{idx + 1}</td>
                                                                <td className="p-4 text-slate-800 font-medium">{q.text}</td>
                                                                <td className="p-4 text-center">
                                                                    <span className={`inline-block w-8 h-8 rounded-full text-white font-bold leading-8 text-center ${q.answer === 'O' ? 'bg-green-500' : 'bg-red-500'}`}>
                                                                        {q.answer}
                                                                    </span>
                                                                </td>
                                                                <td className="p-4 text-slate-500 text-sm hidden md:table-cell">{q.explanation}</td>
                                                                <td className="p-4 text-center">
                                                                    <button 
                                                                        onClick={() => handleDeleteQuestion(q.id)}
                                                                        className="text-slate-300 hover:text-red-500 p-2 rounded hover:bg-red-50 transition-all"
                                                                        title="刪除"
                                                                    >
                                                                        <Trash2 size={20} />
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            )}
                                        </div>
                                    </section>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 歡迎畫面 */}
                    {gameState === 'welcome' && (
                    <div className="z-10 text-center space-y-12 animate-in fade-in zoom-in duration-700">
                        <div>
                        <h1 className="text-8xl md:text-9xl font-black text-slate-800 tracking-tighter mb-4">
                            <span className="text-blue-600">跳跳</span>
                        </h1>
                        <h2 className="text-4xl md:text-6xl font-bold text-slate-600 tracking-widest uppercase">
                            Tempo Game
                        </h2>
                        </div>
                        
                        <button 
                        onClick={startGame}
                        className="group relative inline-flex items-center justify-center px-16 py-6 overflow-hidden font-bold text-white transition-all duration-300 bg-blue-600 rounded-full hover:bg-blue-700 hover:scale-105 shadow-2xl mx-auto"
                        >
                        <span className="mr-4 text-4xl">開始遊戲</span>
                        <Play size={40} className="group-hover:translate-x-2 transition-transform" />
                        </button>
                        
                        <p className="text-slate-400 text-xl font-medium mt-8">請準備好你的跳躍力！</p>
                    </div>
                    )}

                    {/* 遊戲中 / 時間到 */}
                    {(gameState === 'playing' || gameState === 'timeUp') && (
                    <div className="absolute inset-0 flex items-center justify-center">
                        
                        {/* O 區 (左) */}
                        <div className="absolute left-0 top-0 bottom-0 w-1/4 md:w-1/3 bg-gradient-to-r from-green-100/80 to-transparent flex items-center justify-start pl-8 md:pl-16 transition-opacity duration-300">
                            <div className="flex flex-col items-center opacity-40">
                                <CheckCircle size={140} className="text-green-600 mb-2" />
                                <span className="text-[12rem] leading-none font-black text-green-600/30">O</span>
                            </div>
                        </div>

                        {/* X 區 (右) */}
                        <div className="absolute right-0 top-0 bottom-0 w-1/4 md:w-1/3 bg-gradient-to-l from-red-100/80 to-transparent flex items-center justify-end pr-8 md:pr-16 transition-opacity duration-300">
                            <div className="flex flex-col items-center opacity-40">
                                <XCircle size={140} className="text-red-600 mb-2" />
                                <span className="text-[12rem] leading-none font-black text-red-600/30">X</span>
                            </div>
                        </div>

                        {/* 題目文字 */}
                        <div className="z-20 max-w-6xl w-full px-12 text-center drop-shadow-sm">
                        <h2 className="text-5xl md:text-7xl lg:text-8xl font-black text-slate-800 leading-tight">
                            {currentQuestion.text}
                        </h2>
                        </div>

                        {/* 時間到遮罩 */}
                        {gameState === 'timeUp' && (
                        <div className="absolute inset-0 bg-slate-900/80 backdrop-blur-md z-50 flex flex-col items-center justify-center animate-in fade-in duration-300">
                            <h3 className="text-[10rem] font-black text-yellow-400 leading-none mb-4 drop-shadow-[0_10px_10px_rgba(0,0,0,0.5)] animate-pulse">
                            時間到
                            </h3>
                            <p className="text-4xl text-white font-bold mb-16 tracking-widest bg-slate-800 px-6 py-2 rounded-lg">
                            請停止動作並選定區域
                            </p>
                            <button 
                            onClick={revealAnswer}
                            className="bg-yellow-400 hover:bg-yellow-300 text-slate-900 text-5xl font-bold py-8 px-20 rounded-full shadow-[0_20px_50px_rgba(250,204,21,0.3)] hover:scale-105 transition-all transform hover:-translate-y-1"
                            >
                            公布答案
                            </button>
                        </div>
                        )}
                    </div>
                    )}

                    {/* 公布答案 */}
                    {gameState === 'revealed' && (
                    <div className={`absolute inset-0 z-50 ${getAnswerColor(currentQuestion.answer)} flex flex-col items-center justify-center animate-in slide-in-from-bottom duration-500`}>
                        
                        <div className="flex flex-col items-center mb-12 animate-bounce">
                            {getAnswerIcon(currentQuestion.answer)}
                            <span className="text-white text-8xl font-black mt-4 drop-shadow-md">
                            {currentQuestion.answer === 'O' ? '正確' : '錯誤'}
                            </span>
                        </div>

                        <div className="bg-white/20 backdrop-blur-xl rounded-3xl p-10 max-w-5xl w-[90%] border border-white/30 shadow-2xl text-center">
                            <p className="text-3xl md:text-4xl font-medium text-white/90 mb-6">
                            {currentQuestion.text}
                            </p>
                            <div className="w-24 h-2 bg-white/40 mx-auto rounded-full mb-6"></div>
                            <p className="text-4xl md:text-5xl font-bold text-yellow-300 drop-shadow-sm">
                            {currentQuestion.explanation}
                            </p>
                        </div>

                        <button 
                            onClick={nextQuestion}
                            className="mt-12 bg-white text-slate-900 hover:bg-blue-50 text-3xl font-bold py-5 px-16 rounded-full shadow-2xl hover:scale-105 transition-transform flex items-center gap-4"
                        >
                            下一題 <ArrowRight size={36} />
                        </button>
                    </div>
                    )}

                    {/* 遊戲結束 */}
                    {gameState === 'finished' && (
                    <div className="z-10 text-center animate-in zoom-in duration-500 bg-white/50 backdrop-blur-sm p-16 rounded-[3rem] shadow-2xl border border-white/60">
                        <h2 className="text-8xl font-black text-slate-800 mb-6">遊戲結束！</h2>
                        <p className="text-4xl text-slate-600 mb-12">各位小朋友表現得太棒了！</p>
                        <button 
                            onClick={() => {
                            setGameState('welcome');
                            setCurrentQIndex(0);
                            }}
                            className="bg-slate-800 hover:bg-slate-700 text-white text-3xl font-bold py-6 px-12 rounded-full shadow-xl transition-all hover:scale-105 flex items-center gap-4 mx-auto"
                        >
                            <RotateCcw size={32} /> 再玩一次
                        </button>
                    </div>
                    )}

                </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
