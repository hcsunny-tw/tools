<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英文單字尋找學習單產生器</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <!-- 引入 html2canvas 函式庫 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" xintegrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibVccNEQtXbUT0ay4Lzxn+PrS2YHpGCw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        /* 自訂樣式 */
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }

        /* 用於學習單格線的等寬字體 */
        #grid-container {
            font-family: 'Roboto Mono', monospace;
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10+ */
            user-select: none; /* Standard syntax */
        }
        
        /* 答案高亮樣式 */
        .answer-highlight {
            background-color: #fef9c3; /* Tailwind yellow-100 */
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }

        /* 列印時的樣式 - 已改回直向 */
        @media print {
            @page {
                size: A4 portrait; /* 頁面改為直向 */
                margin: 1cm;
            }
            body > *:not(#print-area) {
                display: none !important;
            }
            #print-area {
                display: block !important;
            }

            .print-copy {
                width: 100%;
                height: 100%;
                padding: 1rem;
                box-sizing: border-box;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                box-shadow: none !important;
                border: 1px solid #ddd;
                font-size: 10pt;
                display: flex;
                flex-direction: column;
            }

            .print-copy .worksheet-main-content {
                flex-grow: 1;
            }
            
            .print-copy #main-content-area {
                display: flex !important;
                flex-direction: column !important;
                gap: 1rem !important;
            }
            
            .print-copy #grid-container-wrapper {
                width: 100% !important;
            }
            .print-copy #word-list-wrapper {
                 width: 100% !important;
                 padding-left: 0 !important;
                 border-left: none !important;
                 border-top: 2px solid #eee !important;
                 padding-top: 1rem !important;
            }

            .print-copy h2 {
                font-size: 18pt !important;
                margin-bottom: 0.5rem !important;
            }
            .print-copy h3 {
                font-size: 12pt !important;
                margin-bottom: 0.5rem !important;
            }
             .print-copy .flex.justify-between {
                font-size: 10pt !important;
                padding-bottom: 0.5rem !important;
                margin-bottom: 0.5rem !important;
            }
            
            .print-copy #grid-container td {
                font-size: 16pt !important;
                line-height: 1 !important;
                letter-spacing: -5px !important;
                padding: 0 !important;
            }
            
            .print-copy #word-list {
                display: grid !important;
                grid-template-columns: repeat(5, 1fr) !important;
                gap: 0.1rem 0.5rem !important;
            }
            .print-copy #word-list div {
                font-size: 22pt !important;
            }

            .print-copy .answer-highlight {
                background-color: transparent !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <main class="container mx-auto p-4 md:p-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- ===== 設定面板 ===== -->
        <div id="settings-panel" class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg h-fit">
            <h1 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-4">學習單產生器設定</h1>

            <!-- 主題 -->
            <div class="mb-4">
                <label for="theme" class="block text-sm font-medium text-gray-700 mb-2">主題</label>
                <select id="theme" class="w-full px-3 py-2 border border-gray-300 bg-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    <option value="" disabled selected>請選擇一個主題</option>
                    <option value="numbers1_10">數字 1-10 (Numbers 1-10)</option>
                    <option value="numbers11_20">數字 11-20 (Numbers 11-20)</option>
                    <option value="tens">10的倍數 (Multiples of 10)</option>
                    <option value="fruits">水果 (Fruits)</option>
                    <option value="animals">動物 (Animals)</option>
                    <option value="custom">自訂主題 (Custom Theme)</option>
                </select>
            </div>

            <!-- 自訂主題名稱 -->
            <div id="custom-theme-name-container" class="mb-4 hidden">
                <label for="custom-theme-name" class="block text-sm font-medium text-gray-700 mb-2">自訂主題名稱</label>
                <input type="text" id="custom-theme-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="例如：交通工具 (Transportation)">
            </div>

            <!-- 自訂單字輸入 -->
            <div id="custom-words-container" class="mb-4 hidden">
                <label for="custom-words" class="block text-sm font-medium text-gray-700 mb-2">請輸入單字 (每行一個)</label>
                <textarea id="custom-words" rows="5" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="APPLE&#10;BANANA&#10;CHERRY"></textarea>
            </div>

            <!-- 單字數量 -->
            <div id="word-count-container" class="mb-4">
                <label for="word-count" class="block text-sm font-medium text-gray-700 mb-2">單字數量</label>
                <select id="word-count" class="w-full px-3 py-2 border border-gray-300 bg-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" disabled>
                    <option value="" disabled selected>請先選擇主題</option>
                </select>
            </div>

            <!-- 形狀選擇 -->
            <div class="mb-4">
                <label for="shape" class="block text-sm font-medium text-gray-700 mb-2">學習單形狀</label>
                <select id="shape" class="w-full px-3 py-2 border border-gray-300 bg-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    <option value="square" selected>方形 (自動尺寸)</option>
                    <option value="circle">圓形 (自動尺寸)</option>
                    <option value="car">汽車 (固定20x20)</option>
                    <option value="diamond">鑽石 (固定20x20)</option>
                    <option value="star">星星 (固定20x20)</option>
                </select>
            </div>

            <!-- 大小寫模式 -->
            <div class="mb-4">
                <label for="case-mode" class="block text-sm font-medium text-gray-700 mb-2">字母大小寫</label>
                <select id="case-mode" class="w-full px-3 py-2 border border-gray-300 bg-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    <option value="upper" selected>全部大寫 (Uppercase)</option>
                    <option value="lower">全部小寫 (Lowercase)</option>
                </select>
            </div>

            <!-- 排列方式 -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">答案排列方式 (可複選)</label>
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <input type="checkbox" id="dir-lr" value="lr" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                        <label for="dir-lr" class="ml-2 text-sm text-gray-600">從左到右</label>
                    </div>
                    <div>
                        <input type="checkbox" id="dir-rl" value="rl" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <label for="dir-rl" class="ml-2 text-sm text-gray-600">從右到左</label>
                    </div>
                    <div>
                        <input type="checkbox" id="dir-tb" value="tb" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                        <label for="dir-tb" class="ml-2 text-sm text-gray-600">從上到下</label>
                    </div>
                    <div>
                        <input type="checkbox" id="dir-bt" value="bt" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <label for="dir-bt" class="ml-2 text-sm text-gray-600">從下到上</label>
                    </div>
                     <div>
                        <input type="checkbox" id="dir-tlbr" value="tlbr" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <label for="dir-tlbr" class="ml-2 text-sm text-gray-600">左上到右下</label>
                    </div>
                    <div>
                        <input type="checkbox" id="dir-brtl" value="brtl" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <label for="dir-brtl" class="ml-2 text-sm text-gray-600">右下到左上</label>
                    </div>
                    <div>
                        <input type="checkbox" id="dir-trbl" value="trbl" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <label for="dir-trbl" class="ml-2 text-sm text-gray-600">右上到左下</label>
                    </div>
                    <div>
                        <input type="checkbox" id="dir-bltr" value="bltr" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <label for="dir-bltr" class="ml-2 text-sm text-gray-600">左下到右上</label>
                    </div>
                </div>
            </div>

            <!-- 操作按鈕 -->
            <button id="generate-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-transform transform hover:scale-105">
                生成學習單
            </button>
                        <!-- 頁尾 -->
            <div class="worksheet-footer text-center text-xs text-gray-400 mt-6 pt-4 border-t border-gray-200">
               Copyright © 2025 HC Peng. All rights reserved.
            </div>
            <p id="error-message" class="text-red-500 text-sm mt-2 text-center"></p>


        </div>

        <!-- ===== 學習單預覽區 ===== -->
        <div class="lg:col-span-2">
            <div id="worksheet-container" class="bg-white p-8 rounded-2xl shadow-lg">
                <div class="worksheet-main-content">
                    <!-- 學習單標頭 -->
                    <div class="flex justify-between items-center border-b-2 border-gray-200 pb-4 mb-4 text-lg">
                        <span><strong>Name:</strong> _________________</span>
                        <span><strong>Date:</strong> _________________</span>
                    </div>
                    <h2 id="worksheet-topic" class="text-2xl font-bold text-center text-gray-800 mb-6"></h2>

                    <!-- 主要內容區: 格線 + 單字列表 -->
                    <div id="main-content-area" class="flex flex-col md:flex-row gap-8">
                        <!-- 學習單格線 (左側) -->
                        <div id="grid-container-wrapper" class="w-full md:w-2/3">
                            <div id="grid-container" class="w-full aspect-square flex items-center justify-center p-2 border-2 border-dashed rounded-lg">
                                <p class="text-gray-400">請點擊左側按鈕生成學習單</p>
                            </div>
                        </div>

                        <!-- 單字列表 (右側) -->
                        <div id="word-list-wrapper" class="w-full md:w-1/3 md:pl-6 md:border-l-2 border-gray-200">
                            <h3 class="text-xl font-bold text-center md:text-left text-gray-700 mb-4">Find these words:</h3>
                            <div id="word-list" class="grid grid-cols-2 gap-x-4 gap-y-1 text-base">
                                 <p class="text-gray-400 text-base col-span-2">...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 操作按鈕容器 -->
            <div id="action-buttons-container" class="mt-6 text-center space-x-4">
                 <button id="save-image-btn" class="bg-purple-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-4 focus:ring-purple-300 transition-transform transform hover:scale-105 hidden">
                    📷 儲存圖片
                </button>
                 <button id="toggle-answers-btn" class="bg-orange-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-orange-600 focus:outline-none focus:ring-4 focus:ring-orange-300 transition-transform transform hover:scale-105 hidden">
                    💡 顯示/隱藏答案
                </button>
                 <button id="print-btn" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 transition-transform transform hover:scale-105 hidden">
                    🖨️ 列印
                </button>
            </div>
        </div>
    </main>

    <!-- 這個容器預設為隱藏，只在列印時使用 -->
    <div id="print-area" class="hidden"></div>

    <script>
        const generateBtn = document.getElementById('generate-btn');
        const printBtn = document.getElementById('print-btn');
        const toggleAnswersBtn = document.getElementById('toggle-answers-btn');
        const saveImageBtn = document.getElementById('save-image-btn');
        const errorMessage = document.getElementById('error-message');
        const gridContainer = document.getElementById('grid-container');
        const wordListContainer = document.getElementById('word-list');
        const worksheetTopic = document.getElementById('worksheet-topic');
        const themeSelector = document.getElementById('theme');
        const wordCountSelector = document.getElementById('word-count');
        const customWordsContainer = document.getElementById('custom-words-container');
        const wordCountContainer = document.getElementById('word-count-container');
        const customThemeNameContainer = document.getElementById('custom-theme-name-container');

        let placedWordDetails = [];
        let answersVisible = false;

        const wordBank = {
            numbers1_10: ['ONE', 'TWO', 'THREE', 'FOUR', 'FIVE', 'SIX', 'SEVEN', 'EIGHT', 'NINE', 'TEN'],
            numbers11_20: ['ELEVEN', 'TWELVE', 'THIRTEEN', 'FOURTEEN', 'FIFTEEN', 'SIXTEEN', 'SEVENTEEN', 'EIGHTEEN', 'NINETEEN', 'TWENTY'],
            tens: ['TEN', 'TWENTY', 'THIRTY', 'FORTY', 'FIFTY', 'SIXTY', 'SEVENTY', 'EIGHTY', 'NINETY', 'HUNDRED'],
            fruits: ['APPLE', 'BANANA', 'CHERRY', 'ORANGE', 'GRAPE', 'LEMON', 'MANGO', 'PEACH', 'KIWI', 'PEAR', 'PLUM', 'BERRY', 'LIME', 'MELON'],
            animals: ['LION', 'TIGER', 'BEAR', 'WOLF', 'FOX', 'DEER', 'GOAT', 'PANDA', 'SNAKE', 'EAGLE', 'HORSE', 'MOUSE', 'RABBIT', 'SHARK', 'WHALE', 'BIRD', 'FISH']
        };

        // 定義方向向量
        const directions = {
            lr: { r: 0, c: 1 },    // 從左到右
            rl: { r: 0, c: -1 },   // 從右到左
            tb: { r: 1, c: 0 },    // 從上到下
            bt: { r: -1, c: 0 },   // 從下到上
            tlbr: { r: 1, c: 1 },  // 左上到右下
            brtl: { r: -1, c: -1}, // 右下到左上
            trbl: { r: 1, c: -1},  // 右上到左下
            bltr: { r: -1, c: 1}   // 左下到右上
        };
        
        // 定義 20x20 的形狀遮罩
        const shapeMasks = {
            car: [
              '00000000000000000000', '00000000000000000000', '00000000000000000000', '00000011111100000000',
              '00001111111111000000', '00011111111111110000', '00111111111111111100', '00111111111111111100',
              '11111111111111111111', '11111111111111111111', '11111111111111111111', '01111111111111111110',
              '00111001111110011100', '00111001111110011100', '00111001111110011100', '00000000000000000000',
              '00000000000000000000', '00000000000000000000', '00000000000000000000', '00000000000000000000',
            ].map(row => row.split('').map(Number)),
            diamond: [
              '00000000011000000000', '00000000111100000000', '00000001111110000000', '00000011111111000000',
              '00000111111111100000', '00001111111111110000', '00011111111111111000', '00111111111111111100',
              '01111111111111111110', '11111111111111111111', '11111111111111111111', '01111111111111111110',
              '00111111111111111100', '00011111111111111000', '00001111111111110000', '00000111111111100000',
              '00000011111111000000', '00000001111110000000', '00000000111100000000', '00000000011000000000',
            ].map(row => row.split('').map(Number)),
            star: [
              '00000000001000000000', '00000000011100000000', '00000000111110000000', '00011111111111111100',
              '00111111111111111110', '00011111111111111100', '00000011111111000000', '00000001111110000000',
              '00000011111111000000', '00000111000011100000', '00001110000001110000', '00011100000000111000',
              '00111000000000011100', '01110000000000001110', '11111111111111111111', '01111111111111111110',
              '00111111111111111110', '00011111111111111100', '00000000000000000000', '00000000000000000000',
            ].map(row => row.split('').map(Number)),
        };

        themeSelector.addEventListener('change', () => {
            const selectedTheme = themeSelector.value;
            if (selectedTheme === 'custom') {
                customThemeNameContainer.classList.remove('hidden');
                customWordsContainer.classList.remove('hidden');
                wordCountContainer.classList.add('hidden');
            } else {
                customThemeNameContainer.classList.add('hidden');
                customWordsContainer.classList.add('hidden');
                wordCountContainer.classList.remove('hidden');
                updateWordCountOptions();
            }
        });

        function updateWordCountOptions() {
            const selectedTheme = themeSelector.value;
            const availableWords = wordBank[selectedTheme] || [];
            const maxWords = availableWords.length;

            wordCountSelector.innerHTML = ''; // 清空舊選項
            wordCountSelector.disabled = false;

            if (maxWords === 0) {
                wordCountSelector.innerHTML = '<option value="" disabled selected>請先選擇主題</option>';
                wordCountSelector.disabled = true;
                return;
            }

            const countOptions = [5, 8, 10, 12, 15];
            let hasOptions = false;
            countOptions.forEach(count => {
                if (count <= maxWords) {
                    const option = document.createElement('option');
                    option.value = count;
                    option.textContent = `${count} 個單字`;
                    wordCountSelector.appendChild(option);
                    hasOptions = true;
                }
            });
            
            if (!hasOptions && maxWords > 0) {
                 const option = document.createElement('option');
                 option.value = maxWords;
                 option.textContent = `${maxWords} 個單字`;
                 wordCountSelector.appendChild(option);
            }

            if (wordCountSelector.options.length > 0) {
                wordCountSelector.selectedIndex = wordCountSelector.options.length - 1;
            }
        }

        generateBtn.addEventListener('click', () => {
            try {
                errorMessage.textContent = '';
                generateWorksheet();
                printBtn.classList.remove('hidden');
                toggleAnswersBtn.classList.remove('hidden');
                saveImageBtn.classList.remove('hidden');
            } catch (e) {
                errorMessage.textContent = e.message;
                console.error(e);
            }
        });

        printBtn.addEventListener('click', () => {
            const printArea = document.getElementById('print-area');
            const worksheet = document.getElementById('worksheet-container');

            if (answersVisible) {
                toggleAnswers(true); 
            }

            printArea.innerHTML = '';
            const clone1 = worksheet.cloneNode(true);
            clone1.classList.add('print-copy');
            printArea.appendChild(clone1);

            window.print();
        });
        
        toggleAnswersBtn.addEventListener('click', () => toggleAnswers());

        saveImageBtn.addEventListener('click', () => {
            if (answersVisible) {
                toggleAnswers(true); 
            }
            const worksheetElement = document.getElementById('worksheet-container');
            html2canvas(worksheetElement, {
                 scale: 2, // 提高解析度
                 useCORS: true,
                 backgroundColor: '#ffffff'
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'word-search-worksheet.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        });


        function toggleAnswers(forceHide = false) {
            if (forceHide) {
                answersVisible = false;
            } else {
                answersVisible = !answersVisible;
            }

            placedWordDetails.forEach(wordDetail => {
                wordDetail.coords.forEach(coord => {
                    const cell = document.querySelector(`#grid-container td[data-r='${coord.r}'][data-c='${coord.c}']`);
                    if (cell) {
                        if (answersVisible) {
                            cell.classList.add('answer-highlight');
                        } else {
                            cell.classList.remove('answer-highlight');
                        }
                    }
                });
            });
        }

        function generateWorksheet() {
            // 重設答案狀態
            placedWordDetails = [];
            if (answersVisible) {
                toggleAnswers(true); // 強制隱藏舊答案
            }
            
            const theme = themeSelector.value;
            let themeText = themeSelector.options[themeSelector.selectedIndex].text;
            const shape = document.getElementById('shape').value;
            const caseMode = document.getElementById('case-mode').value;
            
            let words;

            if (theme === 'custom') {
                const customThemeName = document.getElementById('custom-theme-name').value.trim();
                const customWordsInput = document.getElementById('custom-words').value;
                if (!customWordsInput.trim()) {
                    throw new Error('請在自訂主題中輸入單字！');
                }
                words = customWordsInput.split('\n')
                                   .map(w => w.trim())
                                   .filter(w => w.length > 0);
                
                // 驗證自訂單字
                for (const word of words) {
                    if (!/^[a-zA-Z]+$/.test(word)) {
                        throw new Error(`自訂單字 "${word}" 包含無效字元，請只輸入英文字母。`);
                    }
                }

                themeText = customThemeName || "自訂單字 (Custom Words)";
            } else {
                const wordCount = parseInt(wordCountSelector.value, 10);
                if (!theme || !wordCount) {
                    throw new Error('請選擇主題和單字數量！');
                }
                const fullWordList = [...wordBank[theme]];
                words = fullWordList.sort(() => 0.5 - Math.random()).slice(0, wordCount);
            }
            
            if (caseMode === 'lower') {
                words = words.map(word => word.toLowerCase());
            } else {
                words = words.map(word => word.toUpperCase());
            }

            const selectedDirections = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
            if (selectedDirections.length === 0) {
                throw new Error('請至少選擇一種排列方式！');
            }

            let size;
            if (shape === 'square' || shape === 'circle') {
                const longestWordLength = words.reduce((max, word) => Math.max(max, word.length), 0);
                size = Math.max(longestWordLength + 2, Math.ceil(Math.sqrt(words.length * 15)));
                size = Math.min(Math.max(size, 10), 22); // 限制尺寸在 10 到 22 之間
            } else {
                size = 20; // 不規則形狀使用固定尺寸
            }

            let grid = Array(size).fill(null).map(() => Array(size).fill(null));
            words.sort((a, b) => b.length - a.length);

            words.forEach(word => {
                let placed = false;
                let attempts = 0;
                while (!placed && attempts < 200) { // 增加嘗試次數
                    const dirKey = selectedDirections[Math.floor(Math.random() * selectedDirections.length)];
                    const direction = directions[dirKey];
                    const startR = Math.floor(Math.random() * size);
                    const startC = Math.floor(Math.random() * size);

                    if (canPlaceWord(word, grid, startR, startC, direction, shape)) {
                        const wordDetail = { word: word, coords: [] };
                        for (let i = 0; i < word.length; i++) {
                            const r = startR + i * direction.r;
                            const c = startC + i * direction.c;
                            grid[r][c] = word[i];
                            wordDetail.coords.push({ r, c });
                        }
                        placedWordDetails.push(wordDetail);
                        placed = true;
                    }
                    attempts++;
                }
            });

            const alphabet = caseMode === 'lower' ? "abcdefghijklmnopqrstuvwxyz" : "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            for (let r = 0; r < size; r++) {
                for (let c = 0; c < size; c++) {
                    if (grid[r][c] === null) {
                        grid[r][c] = alphabet[Math.floor(Math.random() * alphabet.length)];
                    }
                }
            }
            
            renderGrid(grid, shape);
            renderWordList(words.filter(w => placedWordDetails.some(pd => pd.word === w))); // 只顯示成功放置的單字
            worksheetTopic.textContent = themeText;
        }

        function isInsideShape(r, c, size, shape) {
            if (shape === 'square') return true;
            if (shape === 'circle') {
                const radius = size / 2;
                const center = radius - 0.5;
                return Math.sqrt(Math.pow(r - center, 2) + Math.pow(c - center, 2)) <= radius;
            }
            if (shapeMasks[shape]) {
                const maskSize = shapeMasks[shape].length;
                if (r >= 0 && r < maskSize && c >= 0 && c < maskSize) {
                    return shapeMasks[shape][r][c] === 1;
                }
                return false;
            }
            return false;
        }

        function canPlaceWord(word, grid, r, c, direction, shape) {
            const size = grid.length;
            for (let i = 0; i < word.length; i++) {
                const newR = r + i * direction.r;
                const newC = c + i * direction.c;
                if (newR < 0 || newR >= size || newC < 0 || newC >= size) return false;
                if (!isInsideShape(newR, newC, size, shape)) return false;
                const existingLetter = grid[newR][newC];
                if (existingLetter !== null && existingLetter !== word[i]) return false;
            }
            return true;
        }

        function renderGrid(grid, shape) {
            gridContainer.innerHTML = '';
            gridContainer.classList.remove('p-2', 'border-2', 'border-dashed', 'items-center', 'justify-center');
            const size = grid.length;
            const table = document.createElement('table');
            table.className = 'w-full h-full border-collapse';
            for (let r = 0; r < size; r++) {
                const tr = document.createElement('tr');
                for (let c = 0; c < size; c++) {
                    const td = document.createElement('td');
                    td.dataset.r = r; // 加上座標方便選取
                    td.dataset.c = c;
                    td.textContent = grid[r][c];
                    // 計算適合的字體大小
                    const fontSize = Math.max(12, 32 - size); // 提高基礎與計算後的字體大小
                    td.style.fontSize = `${fontSize}px`;

                    if (!isInsideShape(r, c, size, shape)) {
                        td.style.color = 'transparent';
                        td.style.backgroundColor = 'white';
                    } else {
                         td.className = 'text-center font-bold text-gray-700 leading-none';
                    }
                    tr.appendChild(td);
                }
                table.appendChild(tr);
            }
            gridContainer.appendChild(table);
        }

        function renderWordList(words) {
            wordListContainer.innerHTML = '';
            if (words.length === 0) {
                 wordListContainer.innerHTML = '<p class="text-gray-400 text-base col-span-full">沒有可以成功放置的單字。</p>';
                 return;
            }
            
            const currentTheme = themeSelector.value;
            // 如果是數字相關主題，則進行數字大小排序
            if (currentTheme.startsWith('numbers') || currentTheme === 'tens') {
                const numberOrder = {
                    'ONE': 1, 'TWO': 2, 'THREE': 3, 'FOUR': 4, 'FIVE': 5, 'SIX': 6, 'SEVEN': 7, 'EIGHT': 8, 'NINE': 9, 'TEN': 10,
                    'ELEVEN': 11, 'TWELVE': 12, 'THIRTEEN': 13, 'FOURTEEN': 14, 'FIFTEEN': 15, 'SIXTEEN': 16, 'SEVENTEEN': 17, 'EIGHTEEN': 18, 'NINETEEN': 19, 'TWENTY': 20,
                    'THIRTY': 30, 'FORTY': 40, 'FIFTY': 50, 'SIXTY': 60, 'SEVENTY': 70, 'EIGHTY': 80, 'NINETY': 90, 'HUNDRED': 100
                };
                 words.sort((a, b) => {
                    const wordA = a.toUpperCase();
                    const wordB = b.toUpperCase();
                    return (numberOrder[wordA] || 0) - (numberOrder[wordB] || 0);
                });
            } else {
                // 其他主題則按照字母順序排序
                words.sort(); 
            }

            words.forEach(word => {
                const wordEl = document.createElement('div');
                wordEl.textContent = word;
                wordEl.className = 'font-medium text-gray-600 tracking-wide';
                wordListContainer.appendChild(wordEl);
            });
        }
    </script>
</body>
</html>

