<!DOCTYPE html>
<html lang="zh-Hant-TW" data-theme="light" data-color-theme="guild">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ›¡ï¸ å†’éšªè€…å…¬æœƒ (PROç‰ˆ) ğŸ›¡ï¸</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    /* ============================================================
       ğŸš¨ æ ¸å¿ƒè¦–åœ–æ§åˆ¶ & è®Šæ•¸
       ============================================================ */
    .view { display: none !important; } 
    .view.show { display: block !important; animation: fadeIn .3s ease; }
    @keyframes fadeIn{ from{ opacity:0; transform:translateY(10px); } to{ opacity:1; transform:translateY(0); } }

    :root, html[data-color-theme='guild'] {
      --primary: #8B4513; --accent: #CD853F; --ring: rgba(139, 69, 19, 0.3);
      --bg: #F4E4BC; --card: #FDF5E6; 
      --tbl-head: #E6D2B5; --tbl-alt: #FAF0E6; --tbl-hover: #DEB887; --tbl-border: #D2B48C;
      --text-main: #3E2723; --text-light: #5D4037; --muted: #8D6E63;
      --success: #556B2F; --danger: #8B0000;
      --progress-bar: #32CD32; 
      --shadow: 3px 3px 0px rgba(93, 64, 55, 0.2);
      --radius: 8px; --seat: 56px; --seat-font: 16px; 
    }
    
    html[data-color-theme='guild'] body {
      font-family: "Courier New", Courier, "Microsoft JhengHei", monospace;
      background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%238b4513' fill-opacity='0.03' fill-rule='evenodd'/%3E%3C/svg%3E");
    }
    html[data-color-theme='guild'] .btn { border: 2px solid #5D4037; box-shadow: 2px 2px 0px #5D4037; }
    html[data-color-theme='guild'] .btn:active { box-shadow: none; transform: translate(2px, 2px); }
    html[data-color-theme='guild'] .card::before { content: ""; position: absolute; top: -5px; left: 50%; transform: translateX(-50%); width: 100px; height: 10px; background: rgba(0,0,0,0.1); border-radius: 50%; filter: blur(2px); z-index: -1; }

    html[data-theme='dark'] { --primary: #D2691E; --bg: #2C1810; --card: #3E2723; --text-main: #E6D2B5; --tbl-head: #4E342E; --tbl-alt: #3E2723; --tbl-hover: #5D4037; --tbl-border: #5D4037; }

    html[data-color-theme='christmas'] { --primary: #d32f2f; --accent: #2e7d32; --ring: rgba(211, 47, 47, 0.3); --bg: #fffbf7; --card: rgba(255, 255, 255, 0.95); --tbl-head: #e8f5e9; --tbl-alt: #fff; --tbl-hover: #ffebee; --tbl-border: #c8e6c9; --text-main: #1e293b; --text-light: #475569; --muted:#64748b; --shadow:0 8px 30px rgba(211,47,47,.1); --radius:16px; --success:#2e7d32; --danger:#d32f2f; --progress-bar: #00e676; --seat: 56px; --seat-font: 16px; }
    html[data-color-theme='christmas'] body { background-image: url("data:image/svg+xml,%3Csvg width='200' height='200' viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M40 160 L60 120 L50 120 L70 90 L60 90 L80 60 L100 90 L90 90 L110 120 L100 120 L120 160 Z' fill='%232e7d32' opacity='0.15'/%3E%3Crect x='75' y='160' width='10' height='20' fill='%23795548' opacity='0.15'/%3E%3C!-- é›ªäºº --%3E%3Ccircle cx='150' cy='150' r='25' fill='%23b0bec5' opacity='0.15'/%3E%3Ccircle cx='150' cy='110' r='18' fill='%23b0bec5' opacity='0.15'/%3E%3C/svg%3E"); }
    html[data-color-theme='christmas'] .logo { background: linear-gradient(135deg, #d32f2f, #2e7d32); box-shadow: 0 4px 15px rgba(211, 47, 47, 0.4); }
    html[data-color-theme='christmas'][data-theme='dark'] { --primary: #ef5350; --accent: #66bb6a; --bg: #1b1b1b; --card: #2d2d2d; --text-main: #e2e8f0; --text-light: #94a3b8; --tbl-head: #2e3a2f; --tbl-alt: #1b1b1b; --tbl-hover: #3e2727; --tbl-border: #424242; }

    html[data-color-theme='blue'] { --primary: #2563eb; --accent: #1d4ed8; --ring: rgba(37, 99, 235, 0.3); --bg: #eff6ff; --card: #fff; --tbl-head: #dbeafe; --tbl-alt: #f1f5f9; --tbl-hover: #eff6ff; --tbl-border: #bfdbfe; --text-main: #1e3a8a; --text-light: #3b82f6; --muted: #64748b; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); --radius: 8px; --seat: 56px; --seat-font: 16px; --progress-bar: #3b82f6; }
    html[data-color-theme='orange'] { --primary: #f97316; --accent: #ea580c; --ring: rgba(249, 115, 22, 0.3); --bg: #fff7ed; --card: #fff; --tbl-head: #ffedd5; --tbl-alt: #fafaf9; --tbl-hover: #fff7ed; --tbl-border: #fed7aa; --text-main: #7c2d12; --text-light: #ea580c; --muted: #9a3412; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); --radius: 8px; --seat: 56px; --seat-font: 16px; --progress-bar: #f97316; }
    html[data-color-theme='green'] { --primary: #2e7d32; --accent: #4caf50; --ring: rgba(46, 125, 50, 0.3); --bg: #e8f5e9; --card: #fff; --tbl-head: #c8e6c9; --tbl-alt: #f1f8e9; --tbl-hover: #e8f5e9; --tbl-border: #a5d6a7; --text-main: #1b5e20; --text-light: #2e7d32; --muted: #388e3c; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); --radius: 8px; --seat: 56px; --seat-font: 16px; --progress-bar: #4caf50; }
    
    html[data-color-theme='blue'][data-theme='dark'] { --primary: #60a5fa; --bg: #0f172a; --card: #1e293b; --text-main: #e2e8f0; --tbl-head: #1e293b; --tbl-alt: #0f172a; --tbl-hover: #334155; --tbl-border: #334155; }
    html[data-color-theme='orange'][data-theme='dark'] { --primary: #fb923c; --bg: #431407; --card: #2a0a04; --text-main: #ffedd5; --tbl-head: #431407; --tbl-alt: #2a0a04; --tbl-hover: #5e1c0a; --tbl-border: #7c2d12; }
    html[data-color-theme='green'][data-theme='dark'] { --primary: #66bb6a; --bg: #1b5e20; --card: #2e7d32; --text-main: #e8f5e9; --tbl-head: #1b5e20; --tbl-alt: #14421b; --tbl-hover: #388e3c; --tbl-border: #4caf50; }

    *{ box-sizing:border-box; }
    html, body{ 
        height:100%; margin:0; font-family:"Microsoft JhengHei", sans-serif; 
        transition: background-color .3s, color .3s; 
        background: var(--bg); color: var(--text-main);
        /* ğŸ”¥ å·²é‚„åŸç¸®æ”¾æ¯”ä¾‹è‡³ 100% */
    }
    .wrap{ max-width:1200px; margin:0 auto; padding:16px 12px 96px; display: flex; flex-direction: column; min-height: 100vh; }
    header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; flex-wrap: wrap; }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo{ width:48px; height:48px; border-radius:12px; display:grid; place-items:center; color:#fff; font-size:24px; background: var(--primary); box-shadow:var(--shadow); }
    h1{ margin:0; font-size:clamp(18px,2.2vw,24px); font-weight:800; }
    .muted{ color:var(--muted); font-size:12px; }
    
    .card{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; margin-bottom:16px; border:1px solid var(--tbl-border); position: relative; }
    .card h2{ margin:0 0 12px; font-size:18px; color: var(--primary); border-bottom: 1px solid var(--tbl-border); padding-bottom: 8px; display:flex; align-items:center; gap:8px;}
    .field{ display:flex; flex-direction:column; gap:4px; }
    
    label{ font-weight:800; font-size:13px; color: var(--text-light); }
    input:not([type="checkbox"]), select, textarea { background:var(--bg); color: var(--text-main); border:2px solid var(--tbl-border); border-radius:4px; padding:10px; font-size:14px; outline:none; width: 100%; font-weight: bold; }
    input:focus, select:focus{ border-color:var(--primary); }
    input[type="checkbox"] { width: auto; display: inline-block; cursor: pointer; }

    .actions{ display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; }
    .btn{ border:2px solid var(--text-light); border-radius:6px; padding:8px 16px; font-weight:800; cursor:pointer; display:inline-flex; align-items:center; gap:6px; background:var(--primary); color:#fff; font-size:14px; }
    .btn.ghost{ background:var(--card); color:var(--text-light); border:2px dashed var(--tbl-border); }
    .btn.sm{ font-size:12px; padding:4px 10px; }
    .btn.icon-only { padding: 4px 8px; font-size: 14px; }
    .btn.chest { background: #DAA520; border-color: #B8860B; color: #fff; }
    .btn:hover{ filter:brightness(1.1); transform: translateY(-1px); } 
    .btn:active{ transform:translateY(2px); box-shadow:none; }
    .btn.warn { background: var(--danger); border-color: var(--danger); color: #fff; }

    .user-badge { font-size: 12px; font-weight: bold; color: var(--text-light); opacity: 0.8; background: var(--bg); padding: 4px 10px; border-radius: 20px; border: 1px solid var(--tbl-border); display: flex; align-items: center; gap: 6px; cursor: pointer; transition: all .2s; }
    .user-badge:hover { opacity: 1; transform: scale(1.05); border-color: var(--primary); }
    
    .grid{ display:grid; gap:10px; grid-template-columns:repeat(auto-fill, minmax(calc(var(--seat) + 70px), 1fr)); background:var(--bg); border:2px solid var(--tbl-border); border-radius:var(--radius); padding:10px; }
    .seatItem{ display:flex; align-items:center; gap:8px; }
    .seatItem.not-assigned { opacity: 0.35; filter: grayscale(80%); pointer-events: none; }
    .seat{ width:var(--seat); height:var(--seat); border-radius:12px; display:grid; place-items:center; font-weight:900; font-size:var(--seat-font); border:2px solid #5D4037; cursor:pointer; box-shadow:var(--shadow); transition:transform .06s; }
    .seat:active{ transform:scale(.95); }
    html[data-theme='dark'] .seat { border-color: var(--tbl-border); }
    .s0{ background:#d6d3d1; color:#44403c; } .s1{ background:#fef9c3; color:#713f12; } 
    .s2{ background:#fdba74; color:#9a3412; } .s3{ background:#86efac; color:#14532d; } 
    .seatName{ flex:1; font-weight:800; font-size:13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    .custom-tooltip { position: fixed; background: #3E2723; color: #FDF5E6; padding: 10px 14px; border-radius: 6px; font-size: 18px; font-weight: 900; pointer-events: none; z-index: 10002; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.5); border: 2px solid #CD853F; font-family: "Courier New", monospace; line-height: 1.5; white-space: pre-line; }
    .custom-tooltip.show { display: block; animation: fadeIn .1s ease-out; }

    /* 2. æ‡¸æµ®è©³æƒ…è¦–çª—æ¨£å¼ (å„ªåŒ–ï¼šå¤§å­—é«”) */
    .assignment-tooltip {
        position: fixed;
        background: var(--card);
        border: 2px solid var(--primary);
        border-radius: 8px;
        padding: 12px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        z-index: 9999;
        display: none;
        pointer-events: none;
        min-width: 180px;
        max-width: 300px;
        animation: fadeIn 0.15s ease-out;
    }
    .assignment-tooltip h4 { margin: 0 0 8px; font-size: 18px; font-weight: 900; color: var(--primary); border-bottom: 1px dashed var(--muted); padding-bottom: 4px; }
    .assignment-tooltip ul { padding: 0; margin: 0; list-style: none; font-size: 16px; font-weight: bold; line-height: 1.5; }
    .assignment-tooltip li { margin-bottom: 4px; word-wrap: break-word; }
    .assignment-tooltip .t-miss { color: var(--muted); }
    .assignment-tooltip .t-redo { color: var(--accent); }

    /* 3. è™›æ“¬å°éµç›¤æ¨£å¼ (é è¨­éš±è—) */
    .virtual-keypad { display: none; grid-template-columns: repeat(6, 1fr); gap: 4px; margin-top: 8px; background: var(--tbl-alt); padding: 6px; border-radius: 6px; border: 1px dashed var(--tbl-border); }
    .vk-btn { background: var(--card); border: 1px solid var(--tbl-border); border-radius: 4px; padding: 6px 2px; font-size: 12px; font-weight: bold; cursor: pointer; color: var(--text-main); text-align: center; transition: all .1s; }
    .vk-btn:hover { background: var(--primary); color: #fff; transform: translateY(-1px); }
    .vk-btn:active { transform: translateY(1px); }
    .vk-btn.wide { grid-column: span 2; }

    /* 4. ä»»å‹™è¨­å®š UI å„ªåŒ– */
    .quest-config-card { background: var(--card); border: 1px solid var(--tbl-border); border-radius: 8px; padding: 12px; margin-bottom: 12px; box-shadow: 2px 2px 5px rgba(0,0,0,0.05); }
    .quest-config-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--tbl-head); padding-bottom: 8px; margin-bottom: 8px; }
    .quest-config-title { font-weight: 900; font-size: 16px; color: var(--primary); }
    .quest-tags { display: flex; flex-wrap: wrap; gap: 6px; }
    .quest-tag { background: var(--tbl-alt); padding: 4px 10px; border-radius: 20px; font-size: 13px; font-weight: bold; border: 1px solid var(--tbl-border); display: flex; align-items: center; gap: 6px; }
    .quest-tag i { cursor: pointer; opacity: 0.6; transition: opacity .2s; }
    .quest-tag i:hover { opacity: 1; color: var(--danger); }
    .quest-add-row { display: flex; gap: 6px; margin-top: 10px; }

    /* 5. æˆ°æ³å„€è¡¨æ¿ (æ–°åŠŸèƒ½) - ğŸ”¥ å„ªåŒ–ï¼šåŠ å¤§æ•¸å­— */
    .status-overview { display: flex; gap: 12px; margin-bottom: 16px; }
    .overview-card { flex: 1; background: var(--card); border: 2px solid var(--tbl-border); border-radius: 8px; padding: 12px; display: flex; flex-direction: column; gap: 8px; box-shadow: var(--shadow); position: relative; overflow: hidden; }
    .overview-card.success { border-color: var(--success); background: #f0fdf4; }
    .overview-card.danger { border-color: var(--danger); background: #fef2f2; }
    .overview-header { font-weight: 900; font-size: 16px; display: flex; align-items: center; gap: 8px; border-bottom: 1px dashed rgba(0,0,0,0.1); padding-bottom: 6px; }
    .overview-nums { display: flex; flex-wrap: wrap; gap: 4px; max-height: 100px; overflow-y: auto; }
    .num-badge { 
        width: 42px; height: 42px; /* åŠ å¤§å°ºå¯¸ */
        border-radius: 50%; display: grid; place-items: center; 
        font-weight: bold; 
        font-size: 22px; /* åŠ å¤§å­—é«” */
        border: 2px solid rgba(255,255,255,0.5); 
        box-shadow: 1px 1px 3px rgba(0,0,0,0.1); 
    }
    .overview-card.success .num-badge { background: var(--success); color: #fff; }
    .overview-card.danger .num-badge { background: var(--danger); color: #fff; }
    .overview-card.success .overview-header { color: var(--success); }
    .overview-card.danger .overview-header { color: var(--danger); }
    .overview-icon-bg { position: absolute; right: -10px; bottom: -10px; font-size: 80px; opacity: 0.1; pointer-events: none; }

    /* ğŸ”¥ ä¿®å¾©ï¼šç‹€æ…‹é¸å–® (ä½¿ç”¨ fixed é¿å…è·‘ç‰ˆï¼Œç§»é™¤ scale è¨ˆç®—) */
    #statusPicker { display: none; position: fixed; background: var(--card); border: 3px solid var(--primary); border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); padding: 10px; z-index: 20000; width: 160px; flex-direction: column; gap: 8px; }
    #statusPicker.show { display: flex; }
    .status-option-btn { border: 1px solid rgba(0,0,0,0.1); border-radius: 6px; padding: 12px; text-align: left; font-weight: 900; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 15px; color: #3e2723; }
    /* ğŸ”¥ ä¿®å¾©ï¼šç‹€æ…‹é¸å–®æŒ‰éˆ•é¡è‰² */
    .status-option-btn.sp-1 { background: #fef9c3; color: #854d0e; border-color: #facc15; } /* å·²å›å ± (é»ƒ) */
    .status-option-btn.sp-2 { background: #ffedd5; color: #9a3412; border-color: #fb923c; } /* å†æŒ‘æˆ° (æ©˜) */
    .status-option-btn.sp-3 { background: #dcfce7; color: #166534; border-color: #4ade80; } /* æˆåŠŸ (ç¶ ) */

    #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 20000; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 20px; }
    #loginBox { background: var(--card); padding: 40px; border-radius: 16px; box-shadow: var(--shadow); text-align: center; border: 3px double var(--primary); max-width: 90%; width: 400px; }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: center; }
    .modal-overlay.show { display: flex; }
    .modal-content { background: var(--card); padding: 20px; border-radius: var(--radius); width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; border: 3px double var(--primary); position: relative; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; border-bottom: 2px dashed var(--primary); padding-bottom: 10px; }
    .modal-close-btn { background: var(--danger); color: #fff; border: 2px solid #8B0000; width: 32px; height: 32px; border-radius: 50%; font-size: 20px; line-height: 1; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); transition: transform 0.2s; }
    .modal-close-btn:hover { transform: scale(1.1) rotate(90deg); }

    .theme-options { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 8px; }
    .theme-option { width: 40px; height: 40px; border-radius: 8px; border: 2px solid var(--tbl-border); cursor: pointer; transition: transform .1s, border-color .1s; }
    .theme-option:hover { transform: scale(1.1); }
    .theme-option.active { border-color: var(--primary); box-shadow: 0 0 0 3px var(--ring); }
    .theme-option[data-theme="guild"] { background: linear-gradient(135deg, #8B4513, #CD853F); }
    .theme-option[data-theme="christmas"] { background: linear-gradient(135deg, #d32f2f, #2e7d32); }
    .theme-option[data-theme="blue"] { background: linear-gradient(135deg, #2563eb, #1d4ed8); }
    .theme-option[data-theme="orange"] { background: linear-gradient(135deg, #f97316, #ea580c); }
    .theme-option[data-theme="green"] { background: linear-gradient(135deg, #2e7d32, #66bb6a); }
    
    .dark-mode-toggle { display: flex; align-items: center; justify-content: space-between; background-color: var(--bg); padding: 12px; border-radius: 8px; border: 2px solid var(--tbl-border); margin-top: 20px; }
    .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--primary); }
    input:checked + .slider:before { transform: translateX(22px); }

    .roster-tabs { display: flex; gap: 4px; margin-bottom: 0; }
    .tab-btn { flex: 1; padding: 12px; border: none; background: transparent; font-weight: 800; cursor: pointer; color: var(--text-light); border-radius: 8px 8px 0 0; border-bottom: 3px solid transparent; transition: all .2s; }
    .tab-btn:hover { background: var(--tbl-hover); }
    .tab-btn.active { background: var(--card); color: var(--primary); border-bottom-color: var(--primary); }
    .roster-content { display: none; background: var(--card); padding: 16px; border-radius: 0 0 8px 8px; border: 1px solid var(--tbl-border); border-top: none; }
    .roster-content.show { display: block; }
    .roster-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 8px; max-height: 50vh; overflow-y: auto; }
    .roster-item, .teacher-item { display: flex; align-items: center; gap: 8px; padding: 4px; border-bottom: 1px dashed var(--tbl-border); }
    .roster-no-input { flex: 0 0 60px; min-width: 0; }
    .roster-name-input, .teacher-name-input { flex: 1; min-width: 0; }

    .student-status-list { list-style: none; padding: 0; }
    .student-status-list li { 
        padding: 8px; 
        border-bottom: 1px dashed var(--tbl-border); 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        cursor: pointer; 
        transition: background 0.2s;
    }
    .student-status-list li:hover {
        background: var(--tbl-hover); 
    }
    
    .student-status-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(210px, 1fr)); gap: 12px; align-items: start; }
    .student-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .batch-export-checkbox { width: 18px !important; height: 18px !important; margin-right: 8px; accent-color: var(--primary); display: none !important; }
    .batch-mode .batch-export-checkbox { display: inline-block !important; }
    
    .pill { 
        display: inline-flex; 
        gap: 6px; 
        align-items: center; 
        padding: 6px 12px; 
        border-radius: 20px; 
        font-weight: 800; 
        color: #fff; 
        white-space: nowrap; 
        font-size: 14px;
        box-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        transition: transform 0.1s;
    }
    .pill:active { transform: scale(0.95); }
    
    .p-gray { background: #e5e7eb; color: #374151; } /* 0: æœªå›å ± (æŸ”ç°) */
    .p-yellow { background: #fef9c3; color: #854d0e; } /* 1: å·²å›å ± (æŸ”é»ƒ) */
    .p-orange { background: #ffedd5; color: #9a3412; } /* 2: å†æŒ‘æˆ° (æŸ”æ©˜) */
    .p-green { background: #dcfce7; color: #166534; } /* 3: æˆåŠŸ (æŸ”ç¶ ) */
    
    .assign-student-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 8px; margin-bottom: 12px; max-height: 400px; overflow-y: auto; }
    .assign-student-item { display: flex; align-items: center; gap: 8px; padding: 8px; border: 1px solid var(--tbl-border); border-radius: 6px; cursor: pointer; background: var(--bg); transition: background .2s; }
    .assign-student-item:hover { background: var(--tbl-hover); }

    .app-footer { text-align: center; padding: 20px; color: var(--muted); font-size: 12px; font-weight: bold; margin-top: auto; border-top: 1px dashed var(--tbl-border); width: 100%; }

    /* ============================================================
       ğŸš¨ å„ªåŒ–ï¼šæ–°ç‰ˆå·¥å…·ç®±æ¨£å¼ (Debug Fix: æ”¹ç”¨çµ•å°å®šä½é¿å…è¢«é®æ“‹)
       ============================================================ */
    .toolbox-container { position: fixed; bottom: 30px; right: 30px; z-index: 5000; display: flex; flex-direction: column; align-items: flex-end; gap: 12px; }
    .toolbox-toggle { width: 64px; height: 64px; border-radius: 50%; background: var(--primary); color: #fff; font-size: 28px; display: grid; place-items: center; cursor: pointer; box-shadow: 0 6px 16px rgba(0,0,0,0.3); border: 3px solid #fff; transition: transform 0.3s; z-index: 5002; }
    .toolbox-toggle:hover { transform: scale(1.1); }
    .toolbox-toggle.active { transform: rotate(45deg); background: var(--danger); border-color: #ffcccc; }

    .toolbox-menu { display: flex; flex-direction: column; gap: 10px; align-items: center; margin-bottom: 5px; opacity: 0; visibility: hidden; transform: translateY(20px); transition: all 0.3s; pointer-events: none; }
    .toolbox-menu.show { opacity: 1; visibility: visible; transform: translateY(0); pointer-events: auto; }
    
    .fab-btn { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--tbl-border); background: var(--card); color: var(--primary); display: grid; place-items: center; font-size: 20px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: transform 0.2s; position: relative; }
    .fab-btn:hover { transform: scale(1.15); color: #fff; background: var(--primary); }
    .fab-btn.huge { width: 70px; height: 70px; font-size: 32px; border-width: 3px; background: var(--accent); color: #fff; border-color: #fff; }
    
    /* å·¥å…·è¦–çª— */
    .tool-window { position: fixed; bottom: 100px; right: 90px; width: 300px; background: var(--card); border: 3px solid var(--primary); border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.4); display: none; flex-direction: column; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 5005; }
    .tool-window.show { display: flex; }
    @keyframes popIn { from { opacity: 0; transform: scale(0.8) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
    
    .tool-header { background: var(--primary); color: #fff; padding: 10px 14px; border-radius: 8px 8px 0 0; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
    .tool-close { background: none; border: none; color: #fff; font-size: 20px; cursor: pointer; opacity: 0.8; transition: opacity 0.2s; line-height: 1; padding: 0 5px; }
    .tool-close:hover { opacity: 1; transform: scale(1.2); }
    .tool-body { padding: 16px; display: flex; flex-direction: column; gap: 12px; }

    .tb-clock { font-family: monospace; font-size: 32px; font-weight: bold; text-align: center; color: var(--primary); letter-spacing: 2px; }
    .timer-controls { display: flex; gap: 8px; align-items: center; }
    #timerDisplay { font-family: monospace; font-size: 28px; font-weight: bold; flex: 1; text-align: center; color: var(--text-main); }
    #luckyDrawResult { font-size: 24px; font-weight: 900; text-align: center; color: var(--danger); min-height: 60px; display: grid; place-items: center; margin-bottom: 4px; border: 2px dashed var(--accent); border-radius: 8px; background: var(--bg); }
    
    .delete-choice-card { text-align: center; display: flex; flex-direction: column; gap: 16px; }
    .delete-choice-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .btn-archive { background: #607d8b; border-color: #455a64; color: #fff; }
    .btn-destroy { background: #c62828; border-color: #b71c1c; color: #fff; }
    .delete-desc { font-size: 14px; color: var(--muted); line-height: 1.5; background: var(--bg); padding: 10px; border-radius: 6px; border: 1px dashed var(--tbl-border); }

    .marquee-container { position: fixed; top: 0; left: 0; width: 100%; background: rgba(0, 0, 0, 0.85); overflow: hidden; z-index: 9999; padding: 8px 0; pointer-events: none; border-bottom: 2px solid var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
    .marquee-content { display: inline-block; white-space: nowrap; font-weight: 900; padding-left: 100%; animation: marquee-anim linear infinite; font-family: "Microsoft JhengHei", monospace; text-shadow: 2px 2px 0px #000; }
    @keyframes marquee-anim { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

    #confettiCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
    .toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 6000; display: flex; flex-direction: column; gap: 10px; align-items: center; }
    .toast-msg { background: #333; color: #fff; padding: 12px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); display: flex; align-items: center; gap: 16px; animation: slideUpFade 0.3s ease-out; font-weight: bold; min-width: 300px; justify-content: space-between; }
    @keyframes slideUpFade { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    /* ğŸ”¥ å„ªåŒ–ï¼šçœ‹æ¿ä½ˆå±€ & å·¦å´åˆ—è¡¨é«˜åº¦é–å®š */
    .dashboard-layout { display: flex; gap: 16px; align-items: flex-start; height: calc(100vh - 80px); overflow: hidden; }
    .dash-sidebar { 
        flex: 0 0 240px; 
        display: flex; 
        flex-direction: column; 
        gap: 12px; 
        height: 100%; /* å¡«æ»¿ dashboard-layout é«˜åº¦ */
        overflow: hidden; /* é˜²æ­¢ sidebar æ•´é«”æ²å‹• */
    }
    .dash-main { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 16px; height: 100%; overflow-y: auto; }
    .filter-panel { display: none; background: var(--card); border: 1px solid var(--tbl-border); border-top: none; padding: 10px; border-radius: 0 0 6px 6px; margin-bottom: 12px; animation: slideDown 0.2s ease-out; }
    .filter-panel.show { display: block; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    @media (max-width: 768px) { .dashboard-layout { flex-direction: column; height: auto; } .dash-sidebar { width: 100%; position: static; flex: none; height: auto; } }

    /* ğŸ”¥ å„ªåŒ–ï¼šåˆ—è¡¨å®¹å™¨è‡ªå‹•å¡«æ»¿å‰©é¤˜ç©ºé–“ä¸¦ç”¢ç”Ÿæ²å‹• */
    .side-list-container { 
        flex: 1; 
        overflow-y: auto; 
        display: flex; 
        flex-direction: column; 
        gap: 8px; 
        min-height: 0; /* é—œéµï¼šè®“ flex item å¯ä»¥å°æ–¼å…§å®¹é«˜åº¦ */
        padding-right: 4px; /* é¿å…æ²è»¸è“‹ä½å…§å®¹ */
        border-top: 1px dashed var(--tbl-border);
        padding-top: 8px;
    }
    
    .side-item { background: var(--card); border: 2px solid var(--tbl-border); border-radius: 6px; padding: 12px; cursor: pointer; transition: all 0.2s; position: relative; }
    .side-item:hover { border-color: var(--primary); transform: translateX(4px); }
    .side-item.active { background: var(--primary); color: #fff; border-color: var(--text-main); box-shadow: 2px 2px 5px rgba(0,0,0,0.2); }
    .side-item.active .muted { color: rgba(255,255,255,0.8) !important; }
    .side-item-title { font-weight: 900; font-size: 15px; margin-bottom: 4px; }
    .side-item-meta { font-size: 12px; display: flex; justify-content: space-between; }
    #dashDetailPanel { display: none; background: var(--card); border: 2px solid var(--tbl-border); border-radius: 8px; padding: 16px; min-height: 400px; }
    #dashDetailPanel.show { display: block; animation: fadeIn 0.3s; }
    /* ç§»é™¤èˆŠçš„ newQuestPanel ç›¸é—œ CSS */
    #dashEmptyState { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 400px; color: var(--muted); border: 2px dashed var(--tbl-border); border-radius: 8px; }

    /* ğŸ“ é»åç°¿å°ˆç”¨æ¨£å¼ (ä¿®å¾©è·‘ç‰ˆ) */
    .att-card {
        display: flex;
        align-items: center;
        padding: 10px;
        border-bottom: 1px dashed var(--tbl-border);
        gap: 10px;
        background: var(--card);
        margin-bottom: 6px;
        border-radius: 6px;
    }
    .att-no {
        font-weight: 900;
        width: 40px;
        text-align: center;
        font-size: 18px;
        color: var(--primary);
    }
    .att-name {
        flex: 1;
        font-weight: bold;
        font-size: 16px;
        display: flex;
        align-items: center;
    }
    .att-note {
        font-size: 12px;
        color: var(--danger);
        background: #fee2e2;
        padding: 2px 6px;
        border-radius: 4px;
        margin-left: 8px;
        border: 1px solid #fecaca;
    }
    .att-status-group {
        display: flex;
        gap: 4px;
        flex-wrap: wrap;
    }
    .att-btn {
        border: 1px solid var(--tbl-border);
        background: var(--bg);
        color: var(--muted);
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
        transition: all 0.2s;
    }
    .att-btn:hover {
        background: var(--tbl-hover);
    }
    .att-btn.active {
        background: var(--primary);
        color: #fff;
        border-color: var(--primary);
        transform: scale(1.05);
        box-shadow: 1px 1px 3px rgba(0,0,0,0.2);
    }
    
    /* çµ±è¨ˆæ¢æ¨£å¼ */
    .att-stats-bar {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
        background: var(--tbl-alt);
        padding: 10px;
        border-radius: 8px;
        overflow-x: auto;
        border: 1px solid var(--tbl-border);
    }
    .att-stat-item {
        flex: 1;
        text-align: center;
        min-width: 60px;
        border-right: 1px solid var(--tbl-border);
    }
    .att-stat-item:last-child { border-right: none; }
    .att-stat-val { font-size: 20px; font-weight: 900; line-height: 1; margin-bottom: 4px; }
    .att-stat-label { font-size: 12px; color: var(--muted); font-weight: bold; }

    @media print { .no-print, .toolbox-container, .marquee-container, #confettiCanvas { display: none !important; } }
  </style>
  
  <!-- å…¨åŸŸéŒ¯èª¤æ””æˆª (Debug Mode) -->
  <script>
    window.onerror = function (msg, url, lineNo, columnNo, error) {
      if(msg.toLowerCase().indexOf("script error") > -1) { alert('Script Error: Check Browser Console'); }
      else { alert('âš ï¸ ç³»çµ±éŒ¯èª¤ (System Error):\n' + msg + '\nLine: ' + lineNo); }
      return false;
    };
    window.onunhandledrejection = function (event) {
      alert("âš ï¸ é€£ç·šæˆ–éåŒæ­¥éŒ¯èª¤ (Async Error):\n" + event.reason);
    };
  </script>
</head>
<body>
  
  <div id="topMarquee" class="marquee-container" style="display:none;">
      <div id="marqueeText" class="marquee-content"></div>
  </div>

  <canvas id="confettiCanvas"></canvas>
  <div id="toastContainer" class="toast-container"></div>
  
  <!-- ä»»å‹™è©³æƒ…æµ®å‹•è¦–çª— (Tooltip) -->
  <div id="assignmentTooltip" class="assignment-tooltip"></div>

  <div id="attendanceReminderModal" class="modal-overlay">
      <div class="modal-content" style="text-align: center; border: 4px double var(--danger);">
          <div class="modal-header" style="border-bottom: none; justify-content: center;">
              <h2 style="color: var(--danger); font-size: 24px;"><i class="bi bi-exclamation-diamond-fill"></i> ç·Šæ€¥ä»»å‹™</h2>
          </div>
          <p style="font-size: 18px; font-weight: bold; margin-bottom: 20px;">æœ¬æ—¥é»åå°šæœªå®Œæˆï¼<br><span style="font-size: 14px; color: var(--muted);">ç¢ºèªå†’éšªè€…å®‰å±æ˜¯å…¬æœƒé•·çš„é¦–è¦è·è²¬ã€‚</span></p>
          <button class="btn" id="btnGoToAttendance" style="width: 100%; justify-content: center; font-size: 18px;">å‰å¾€é»å</button>
          <button class="btn ghost sm" style="margin-top: 10px; width: 100%; border: none;" onclick="document.getElementById('attendanceReminderModal').classList.remove('show')">ç¨å¾Œå†èªª</button>
      </div>
  </div>

  <div id="loginOverlay">
      <div id="loginBox">
          <div class="logo" style="margin: 0 auto 20px; width: 80px; height: 80px; font-size: 40px;">ğŸ›¡ï¸</div>
          <h1>å†’éšªè€…å…¬æœƒç™»å…¥</h1>
          <p class="muted">è«‹å‡ºç¤ºæ‚¨çš„å…¬æœƒé•·è­‰ä»¶ (Google å¸³è™Ÿ)</p>
          <button id="btnLogin" class="btn" style="font-size: 18px; padding: 12px 24px; width: 100%; justify-content: center;">
              <i class="bi bi-google"></i> ä½¿ç”¨ Google ç™»å…¥
          </button>
      </div>
  </div>

  <div class="wrap no-print" style="display:none;" id="mainApp">
    <header>
      <div class="brand">
        <div class="logo"><i class="bi bi-shield-shaded"></i></div>
        <div>
          <h1>å†’éšªè€…å…¬æœƒ</h1>
          <div class="muted">ç‹€æ…‹å¾ªç’°ï¼šç°ï¼æœªæ¥å– â†’ é»ƒï¼å·²å›å ± â†’ æ©˜ï¼å†æŒ‘æˆ° â†’ ç¶ ï¼è¨ä¼æˆåŠŸ</div>
        </div>
      </div>
      <div class="actions">
        <span id="userEmailDisplay" class="user-badge" title="é»æ“ŠæŸ¥çœ‹åŸ·å‹™å®¤"><i class="bi bi-person-circle"></i> ...</span>
        <button class="btn ghost" id="btnRefreshData" title="æ‰‹å‹•é‡æ–°æ•´ç†"><i class="bi bi-arrow-clockwise"></i></button>
        <button class="btn ghost" id="btnNavDashboard"><i class="bi bi-columns-gap"></i> å§”è¨—çœ‹æ¿</button>
        <button class="btn ghost" id="btnNavStudentStatus"><i class="bi bi-backpack4"></i> å†’éšªè€…ç‹€æ…‹</button>
        <button class="btn ghost" id="btnNavRoster"><i class="bi bi-people"></i> å…¬æœƒåå†Š</button>
        <button class="btn ghost" id="btnOpenSettings" title="å¤–è§€è¨­å®š"><i class="bi bi-palette"></i></button>
        <div id="saveStatusIndicator"><i class="bi bi-hourglass"></i></div>
      </div>
    </header>

<section id="view-dashboard" class="view show">
  <div class="dashboard-layout">
    <aside class="dash-sidebar">
      <!-- ğŸ”¥ å„ªåŒ–ï¼šå´æ¬„æ¨™é ­ (ç¯©é¸ + æ–°å¢ä»»å‹™) -->
      <div class="sidebar-header" style="display: flex; gap: 8px; margin-bottom: 0;">
          <button id="btnToggleFilter" class="btn ghost sm" style="flex: 1;" onclick="this.classList.toggle('active'); document.getElementById('filterPanel').classList.toggle('show');">
              <i class="bi bi-funnel"></i> ç¯©é¸æ¢ä»¶
          </button>
          <button id="btnOpenNewQuestWindowSidebar" class="btn sm" style="flex: 0 0 auto;" title="ç™¼å¸ƒæ–°å§”è¨—">
              <i class="bi bi-plus-lg"></i> æ–°å¢ä»»å‹™
          </button>
      </div>

      <!-- ç¯©é¸é¢æ¿ -->
      <div id="filterPanel" class="filter-panel">
          <div style="margin-bottom: 8px;">
              <select id="teacherFilter" style="width:100%; padding:6px;"><option value="all">æ‰€æœ‰å°å¸«</option></select>
          </div>
          <div style="margin-bottom: 8px;">
              <select id="subjectFilter" style="width:100%; padding:6px;"><option value="all">æ‰€æœ‰ç§‘ç›®</option></select>
          </div>
          <button id="btnClearFilter" class="btn sm secondary" style="width:100%; justify-content:center;">
              <i class="bi bi-arrow-counterclockwise"></i> é‡ç½®
          </button>
      </div>

      <!-- å·¦å´åˆ—è¡¨å®¹å™¨ (è‡ªå‹•å¡«æ»¿å‰©é¤˜é«˜åº¦) -->
      <div id="sideAssignmentList" class="side-list-container"></div>
    </aside>

    <main class="dash-main">
      <div id="dashEmptyState">
          <i class="bi bi-arrow-left-circle" style="font-size: 48px; margin-bottom: 10px;"></i>
          <p style="font-weight:bold;">è«‹å¾å·¦å´é¸æ“‡ä¸€å¼µå§”è¨—</p>
          <p style="font-size:12px;">æˆ–é»æ“Šå·¦ä¸Šè§’ã€Œæ–°å¢ä»»å‹™ã€ç™¼å¸ƒ</p>
      </div>

      <div id="dashDetailPanel">
         <div class="assignment-bar" style="border-bottom: 2px solid var(--tbl-border); padding-bottom:12px; margin-bottom:12px;">
            <div class="title" id="dashDetailTitle" style="font-size:20px; font-weight:900; color:var(--primary); display:flex; align-items:center; gap:8px;">
                <!-- æ¨™é¡Œæœƒå‹•æ…‹æ’å…¥ -->
            </div>
            <div class="actions" style="margin-top:8px; align-items: center; gap: 10px; flex-wrap: wrap;">
                <button class="btn sm ghost" id="btnMarkAllYellow"><i class="bi bi-check-circle-fill"></i> å…¨å“¡å›å ±</button>
                <button class="btn sm ghost" id="btnMarkAllOrange"><i class="bi bi-exclamation-circle-fill"></i> å…¨å“¡å†æˆ°</button>
                <div class="legend" style="font-size:12px;">
                    <span><span class="dot s0"></span>æœªæ¥</span>
                    <span><span class="dot s1"></span>å·²å ±</span>
                    <span><span class="dot s2"></span>å†æˆ°</span>
                    <span><span class="dot s3"></span>æˆåŠŸ</span>
                </div>
                <button class="btn sm warn ghost" id="btnDeleteCurrent" style="margin-left:auto;"><i class="bi bi-trash3"></i> åˆªé™¤</button>
            </div>
        </div>
        <div class="field" style="margin-bottom: 8px;">
            <input type="range" id="rangeSize" min="40" max="100" value="56" style="padding: 0;">
        </div>
        <div id="dashGridContainer" class="grid"></div>
      </div>
    </main>
  </div>
</section>

    <section id="view-attendance" class="view">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; flex-wrap:wrap; gap:10px;">
                <h2><i class="bi bi-calendar-check"></i> æ¯æ—¥é»å</h2>
                <div style="display:flex; gap:8px;">
                    <input type="date" id="attDatePicker" style="width: auto;">
                    <button class="btn sm secondary" id="btnExportAttendance"><i class="bi bi-file-earmark-excel"></i> ä¸‹è¼‰å ±è¡¨</button>
                </div>
            </div>
            
            <div class="att-stats-bar">
                <div class="att-stat-item"><div class="att-stat-val" style="color:var(--success)" id="statPresent">0</div><div class="att-stat-label">å‡ºå¸­</div></div>
                <div class="att-stat-item"><div class="att-stat-val" style="color:#854d0e" id="statLate">0</div><div class="att-stat-label">é²åˆ°</div></div>
                <div class="att-stat-item"><div class="att-stat-val" style="color:#1e40af" id="statEarly">0</div><div class="att-stat-label">æ—©é€€</div></div>
                <div class="att-stat-item"><div class="att-stat-val" style="color:var(--danger)" id="statSick">0</div><div class="att-stat-label">ç—…å‡</div></div>
                <div class="att-stat-item"><div class="att-stat-val" style="color:#4b5563" id="statPersonal">0</div><div class="att-stat-label">äº‹å‡</div></div>
                <div class="att-stat-item"><div class="att-stat-val" style="color:#6b21a8" id="statOfficial">0</div><div class="att-stat-label">å…¬å‡</div></div>
            </div>

            <div id="attendanceList"></div>
            <div class="actions" style="justify-content: flex-end; margin-top: 16px;">
                <button class="btn" id="btnSaveAttendance"><i class="bi bi-check-lg"></i> ç¢ºèªé€å‡ºé»åå–®</button>
            </div>
        </div>
    </section>

    <section id="view-roster" class="view">
        <div class="roster-tabs">
            <button id="tabBtnStudents" class="tab-btn active"><i class="bi bi-person-lines-fill"></i> å†’éšªè€…åå†Š</button>
            <button id="tabBtnTeachers" class="tab-btn"><i class="bi bi-person-badge"></i> å…¬æœƒé•·åå†Š</button>
        </div>
        <div id="roster-content-students" class="roster-content show">
            <div class="roster-grid" id="rosterEditor"></div>
            <div class="actions" style="margin-top:16px; justify-content:space-between; border-top:1px dashed var(--tbl-border); padding-top:12px;">
                <button class="btn sm secondary" id="btnAddStudentRow"><i class="bi bi-plus-lg"></i> æ–°å¢ä¸€è¡Œ</button>
                <div style="display:flex; gap:8px;">
                     <details style="display:inline-block;"><summary class="btn sm ghost" style="list-style:none; cursor:pointer;">ğŸ“œ è²¼ä¸Šåå–®</summary>
                        <div style="position:absolute; bottom:60px; right:20px; background:var(--card); padding:10px; border:2px solid var(--primary); border-radius:8px; width:250px; z-index:100;">
                            <textarea id="taRosterPaste" rows="10" style="width:100%;" placeholder="ä¸€è¡Œä¸€å€‹å§“å..."></textarea>
                            <button class="btn sm secondary" id="btnLoadFromPaste" style="width:100%; margin-top:8px;">è¼‰å…¥</button>
                        </div>
                     </details>
                     <button class="btn" id="btnApplyRoster"><i class="bi bi-check-circle"></i> å„²å­˜è®Šæ›´</button>
                </div>
            </div>
        </div>
        <div id="roster-content-teachers" class="roster-content">
            <div class="roster-grid" id="teacherEditor"></div>
            <div class="actions" style="margin-top:16px; justify-content:flex-end;">
                 <button class="btn" id="btnApplyTeachers"><i class="bi bi-check-circle"></i> å„²å­˜è®Šæ›´</button>
            </div>
        </div>
    </section>

    <section id="view-student-status" class="view">
      <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center;">
              <h2 id="studentStatusHeaderTitle"><i class="bi bi-clipboard2-check"></i> å†’éšªè€…å¾…è¾¦æ¸…å–®</h2>
              <div class="actions">
                  <button class="btn sm secondary" id="btnToggleBatchMode"><i class="bi bi-check-square"></i> æ‰¹é‡åŒ¯å‡ºå·è»¸</button>
                  <button class="btn sm" id="btnBatchSelectAll" style="display:none;"><i class="bi bi-check-all"></i> å…¨é¸</button>
                  <button class="btn sm" id="btnBatchExport" style="display:none;"><i class="bi bi-printer"></i> åŒ¯å‡ºé¸å–é …ç›®</button>
              </div>
          </div>
          <div id="studentStatusContainer"></div>
      </div>
    </section>

    <footer class="app-footer">Created by HCSunny & Abby</footer>
  </div>

  <div id="settingsModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h2><i class="bi bi-gear-fill"></i> ç³»çµ±è¨­å®š</h2>
            <button class="modal-close-btn">&times;</button>
        </div>
        <div class="field" style="margin-bottom: 20px;">
            <label>é¢¨æ ¼ä¸»é¡Œ</label>
            <div class="theme-options" id="themeOptionsContainer">
                <div class="theme-option" data-theme="guild" title="æ¢éšªå…¬æœƒ (é è¨­)"></div>
                <div class="theme-option" data-theme="christmas" title="è–èª•ç¯€"></div>
                <div class="theme-option" data-theme="blue" title="çš‡å®¶è—"></div>
                <div class="theme-option" data-theme="orange" title="æ´»åŠ›æ©˜"></div>
                <div class="theme-option" data-theme="green" title="è­·çœ¼ç¶ "></div>
            </div>
        </div>
        <div class="field">
            <label>ç’°å¢ƒå…‰ç·š</label>
            <div class="dark-mode-toggle">
                <span style="font-weight: bold;"><i class="bi bi-moon-stars-fill"></i> å¤œé–“ç‡Ÿç«æ¨¡å¼</span>
                <label class="switch">
                    <input type="checkbox" id="darkModeToggle">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>
  </div>
  
  <div id="questSettingsModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 500px; height: 80vh; display: flex; flex-direction: column;">
        <div class="modal-header">
            <h2><i class="bi bi-journal-plus"></i> ç·¨è¼¯ä»»å‹™é¸å–®</h2>
            <button class="modal-close-btn">&times;</button>
        </div>
        <div id="questConfigList" style="flex: 1; overflow-y: auto; padding: 4px;"></div>
        <div style="background: var(--bg); padding: 12px; border-radius: 8px; border: 2px dashed var(--primary); margin-top: 10px;">
            <div style="display: flex; gap: 8px;">
                <input type="text" id="ipNewSubject" placeholder="è¼¸å…¥æ–°ç§‘ç›®åç¨±..." style="flex:1;">
                <button class="btn sm" id="btnAddSubject"><i class="bi bi-plus-lg"></i> æ–°å¢ç§‘ç›®</button>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn ghost modal-close-btn">å–æ¶ˆ</button>
            <button class="btn" id="btnSaveQuestSettings"><i class="bi bi-save"></i> å„²å­˜è¨­å®š</button>
        </div>
    </div>
  </div>
  
  <div id="adminProfileModal" class="modal-overlay">
      <div class="modal-content" style="max-width: 600px;">
          <div class="modal-header">
              <h2><i class="bi bi-person-badge-fill"></i> å…¬æœƒé•·åŸ·å‹™å®¤</h2>
              <div style="display: flex; align-items: center; gap: 8px;">
                <button class="btn sm" id="btnAdminAttendance" title="é»åç°¿"><i class="bi bi-book"></i> é»åç°¿</button>
                <button class="modal-close-btn">&times;</button>
              </div>
          </div>
          <div style="background: var(--bg); padding: 16px; border-radius: 8px; border: 1px solid var(--tbl-border); margin-bottom: 20px;">
              <h3 style="margin:0 0 10px; font-size: 16px; color: var(--primary);">ğŸ“Š å†’éšªè€…æ¬ æ¬¾åå–® (æœªå›å ±/å†æŒ‘æˆ° > 5)</h3>
              <div id="adminDebtList" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
          </div>
          <div style="background: var(--bg); padding: 16px; border-radius: 8px; border: 1px solid var(--tbl-border); margin-bottom: 12px;">
               <h3 style="margin:0 0 10px; font-size: 16px; color: var(--primary);">ğŸ—„ï¸ æ­·å²å°å­˜ç´€éŒ„</h3>
               <p class="muted" style="margin-bottom:8px;">ä¸‹è¼‰æ‰€æœ‰å·²è¢«å°å­˜çš„å§”è¨—ä»»å‹™ (Excel è©¦ç®—è¡¨æ ¼å¼)ã€‚</p>
               <button class="btn sm secondary" id="btnDownloadArchive"><i class="bi bi-file-earmark-spreadsheet"></i> ä¸‹è¼‰å°å­˜ç´€éŒ„ (CSV)</button>
          </div>
          
          <div style="background: #fff0f0; padding: 16px; border-radius: 8px; border: 2px dashed var(--danger); margin-top: 12px;">
                <h3 style="margin:0 0 10px; font-size: 16px; color: var(--danger);">âš ï¸ å±éšªç¦å€</h3>
                <div style="display:flex; flex-direction:column; gap:8px;">
                    <button class="btn ghost warn" id="btnClearAssignments" style="justify-content:center;"><i class="bi bi-fire"></i> éŠ·æ¯€æ‰€æœ‰å¥‘ç´„ (ä¿ç•™åå–®)</button>
                    <button class="btn warn" id="btnResetAll" style="justify-content:center;"><i class="bi bi-radioactive"></i> å¦é—¢æ–°å…¬æœƒ (å…¨éƒ¨é‡ç½®)</button>
                </div>
          </div>

          <div class="modal-footer" style="border-top: 2px dashed var(--tbl-border); padding-top: 16px; margin-top: 20px; justify-content: space-between;">
              <span class="muted" style="align-self: center;">å·¥ä½œè¾›è‹¦äº†ï¼</span>
              <button class="btn ghost" id="btnLogout" style="color: var(--danger); border-color: var(--danger);"><i class="bi bi-box-arrow-right"></i> ç™»å‡ºç³»çµ±</button>
          </div>
      </div>
  </div>

  <div id="assignStudentModal" class="modal-overlay">
      <div class="modal-content">
          <div class="modal-header">
              <h2><i class="bi bi-person-check-fill"></i> æŒ‡æ´¾ä»»å‹™å°è±¡</h2>
              <button class="modal-close-btn">&times;</button>
          </div>
          <div class="actions" style="margin-top: 0; margin-bottom: 12px;">
              <button class="btn sm" id="btnAssignSelectAll">å…¨é¸</button>
              <button class="btn sm ghost" id="btnAssignDeselectAll">å–æ¶ˆ</button>
          </div>
          <div id="assignStudentListContainer" class="assign-student-list"></div>
          <div class="modal-footer">
              <button class="btn ghost modal-close-btn">å–æ¶ˆ</button>
              <button class="btn" id="btnConfirmAssign">ç¢ºèªæŒ‡æ´¾</button>
          </div>
      </div>
  </div>

  <div id="deleteChoiceModal" class="modal-overlay">
      <div class="modal-content" style="max-width: 450px;">
          <div class="modal-header">
              <h2 style="color: var(--danger);"><i class="bi bi-exclamation-triangle-fill"></i> è™•ç½®å§”è¨—</h2>
              <button class="modal-close-btn">&times;</button>
          </div>
          <div class="delete-choice-card">
              <p style="font-size: 18px; font-weight: bold; margin: 0;">æ‚¨æ‰“ç®—å¦‚ä½•è™•ç†é€™å¼µå§”è¨—å–®ï¼Ÿ</p>
              <div id="deleteTargetTitle" style="color: var(--primary); font-weight: bold;"></div>
              
              <div class="delete-desc">
                  <strong>ğŸ“¦ å°å°è‡³å€‰åº« (å°å­˜)ï¼š</strong><br>
                  å§”è¨—å°‡å¾çœ‹æ¿ç§»é™¤ï¼Œä½†åœ¨ã€ŒåŸ·å‹™å®¤ã€å¯ä»¥ä¸‹è¼‰ç´€éŒ„ã€‚<br>
                  <span style="color: var(--success); font-size:12px;">(æ¨è–¦ï¼šæœŸæœ«å¯èƒ½éœ€è¦æŸ¥é–±æ™‚ä½¿ç”¨)</span>
              </div>

              <div class="delete-desc">
                  <strong>ğŸ”¥ éŠ·æ¯€å¥‘ç´„ (åˆªé™¤)ï¼š</strong><br>
                  è³‡æ–™å°‡æ°¸ä¹…æ¶ˆå¤±ï¼Œç„¡æ³•å¾©åŸã€‚<br>
                  <span style="color: var(--danger); font-size:12px;">(æ³¨æ„ï¼šç™¼éŒ¯æ–‡æˆ–æ¸¬è©¦æ™‚ä½¿ç”¨)</span>
              </div>

              <div class="delete-choice-actions">
                  <button class="btn btn-archive" id="btnConfirmArchive">
                      <i class="bi bi-archive-fill"></i> å°å°è‡³å€‰åº«
                  </button>
                  <button class="btn btn-destroy" id="btnConfirmDelete">
                      <i class="bi bi-fire"></i> éŠ·æ¯€å¥‘ç´„
                  </button>
              </div>
          </div>
      </div>
  </div>

  <div id="statusPicker">
      <button class="status-option-btn sp-1" data-status="1"><span class="dot s1"></span> å·²å›å ±</button>
      <button class="status-option-btn sp-2" data-status="2"><span class="dot s2"></span> å†æŒ‘æˆ°</button>
      <button class="status-option-btn sp-3" data-status="3"><span class="dot s3"></span> è¨ä¼æˆåŠŸ</button>
  </div>
  <div id="customTooltip" class="custom-tooltip"></div>

  <!-- å·¥å…·ç®±çµæ§‹ -->
  <div class="toolbox-container">
      <!-- æ‡¸æµ®é¸å–® -->
      <div class="toolbox-menu" id="toolboxMenu">
          <button class="fab-btn" id="btnOpenMarquee" title="è·‘é¦¬ç‡ˆ"><i class="bi bi-broadcast"></i></button>
          <button class="fab-btn" id="btnOpenTimer" title="è¨ˆæ™‚å™¨"><i class="bi bi-stopwatch"></i></button>
          <button class="fab-btn" id="btnOpenDraw" title="æŠ½ç±¤"><i class="bi bi-gift"></i></button>
      </div>

      <!-- ä¸»é–‹é—œæŒ‰éˆ• -->
      <div class="toolbox-toggle" id="btnToggleToolbox" title="ç™¾å¯¶ç®±">
          <i class="bi bi-box-seam-fill"></i>
      </div>
  </div>
  
  <!-- ğŸ”¥ å„ªåŒ–ï¼šç™¼å¸ƒæ–°å§”è¨—å½ˆå‡ºè¦–çª— (é¡ä¼¼å·¥å…·ç®±) -->
  <div id="panelNewQuest" class="tool-window" style="width: 350px; bottom: auto; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.8); height: auto; max-height: 80vh; overflow-y: auto;">
      <div class="tool-header">
          <span><i class="bi bi-plus-circle-dotted"></i> ç™¼å¸ƒæ–°å§”è¨—</span>
          <button class="tool-close">&times;</button>
      </div>
      <div class="tool-body">
          <div class="field">
              <label style="font-size:12px;">ç™¼å¸ƒå°å¸«</label>
              <select id="ipTeacherSelect" style="padding:6px;"></select>
              <input id="ipTeacherCustom" type="text" placeholder="è¼¸å…¥å§“å" style="display:none; margin-top:4px;">
          </div>
          <div class="field" style="margin-top:4px;">
              <label style="font-size:12px;">æ—¥æœŸ</label>
              <input id="ipDate" type="date" style="padding:6px;">
          </div>
          <div class="field" style="margin-top:4px;">
               <label style="font-size:12px;">å…§å®¹</label>
               <div style="display:flex; gap:4px; margin-bottom:4px;">
                   <select id="selSubject" style="padding:6px; flex:1;"><option value="">ğŸ“‚ ç§‘ç›®...</option></select>
                   <select id="selPresetTask" style="padding:6px; flex:1.5;"><option value="">ğŸ“œ å¸¸ç”¨...</option></select>
                   <button class="btn ghost sm" id="btnOpenQuestSettings" title="è¨­å®šå¸¸ç”¨ä»»å‹™" style="padding: 4px 8px; color:var(--primary); border-color:var(--primary);"><i class="bi bi-gear-fill"></i></button>
               </div>
               
               <div style="display:flex; gap:4px;">
                   <input id="ipTitle" type="text" placeholder="ä»»å‹™å…§å®¹..." style="padding:6px; flex:1;" />
                   <button class="btn sm ghost" id="btnToggleKeypad" title="é–‹å•Ÿå°éµç›¤" style="padding: 6px 10px;"><i class="bi bi-keyboard"></i></button>
               </div>
               
               <div class="virtual-keypad" id="virtualKeypad">
                   <div class="vk-btn" data-val="1">1</div><div class="vk-btn" data-val="2">2</div><div class="vk-btn" data-val="3">3</div>
                   <div class="vk-btn" data-val="4">4</div><div class="vk-btn" data-val="5">5</div><div class="vk-btn" data-val="6">6</div>
                   <div class="vk-btn" data-val="7">7</div><div class="vk-btn" data-val="8">8</div><div class="vk-btn" data-val="9">9</div>
                   <div class="vk-btn" data-val="0">0</div><div class="vk-btn" data-val="-">-</div><div class="vk-btn" data-val="~">~</div>
                   <div class="vk-btn" data-val="L.">L</div><div class="vk-btn" data-val="P.">P</div><div class="vk-btn" data-val="U.">U</div>
                   <div class="vk-btn" data-val="CH.">CH</div><div class="vk-btn" data-val="ç¿’ä½œ">ç¿’</div><div class="vk-btn" data-val="è€ƒå·">å·</div>
                   <div class="vk-btn wide" data-val="backspace">âŒ«</div><div class="vk-btn wide" data-val="clear">CLR</div><div class="vk-btn wide" data-val="space">_</div>
               </div>
          </div>
          
          <div class="field" style="margin-top:4px;">
               <button class="btn ghost sm" id="btnOpenAssignModal">æŒ‡å®šå°è±¡...</button>
               <div id="assignStatusText" style="font-size:12px; margin-top:4px; color:var(--muted);">å…¨é«”å†’éšªè€…</div>
          </div>
          <button class="btn sm" id="btnCreate" style="margin-top:8px; width:100%; justify-content:center;">ç¢ºèªç™¼å¸ƒ</button>
      </div>
  </div>
      
  <!-- 1. è·‘é¦¬ç‡ˆè¦–çª— -->
  <div id="panelMarquee" class="tool-window">
      <div class="tool-header">
          <span><i class="bi bi-broadcast"></i> å…¬å‘Šè·‘é¦¬ç‡ˆ</span>
          <button class="tool-close">&times;</button>
      </div>
      <div class="tool-body">
          <input type="text" id="mqTextInput" placeholder="è¼¸å…¥å…¬å‘Šå…§å®¹..." style="margin-bottom:4px;">
          <div class="tb-control-row" style="display:flex;gap:8px;">
              <label style="font-size:12px;">é¡è‰²</label>
              <input type="color" id="mqColorInput" value="#FFD700" style="width:40px;height:36px;padding:0;">
              <label style="font-size:12px; margin-left:8px;">å¤§å°</label>
              <input type="range" id="mqSizeInput" min="16" max="60" value="24" style="flex:1">
          </div>
          <div class="tb-control-row" style="display:flex;gap:8px;">
              <label style="font-size:12px;">é€Ÿåº¦</label>
              <input type="range" id="mqSpeedInput" min="1" max="5" step="0.5" value="1" style="flex:1" title="è¶Šå³é‚Šè¶Šå¿«">
          </div>
          <div class="actions sm" style="justify-content: flex-end;">
              <button class="btn sm" id="btnMqShow"><i class="bi bi-play-fill"></i> æ’­æ”¾</button>
              <button class="btn sm warn" id="btnMqHide">é—œé–‰</button>
          </div>
      </div>
  </div>

  <!-- 2. è¨ˆæ™‚å™¨è¦–çª— -->
  <div id="panelTimer" class="tool-window">
      <div class="tool-header">
          <span><i class="bi bi-stopwatch"></i> è¨ˆæ™‚å™¨ & æ™‚é˜</span>
          <button class="tool-close">&times;</button>
      </div>
      <div class="tool-body">
           <div id="tbClock" class="tb-clock" style="margin-bottom:8px;">00:00:00</div>
           <div class="timer-presets" style="display:flex;gap:6px;">
              <button class="btn sm ghost btn-timer-preset" data-min="1" style="flex:1;">1åˆ†</button>
              <button class="btn sm ghost btn-timer-preset" data-min="3" style="flex:1;">3åˆ†</button>
              <button class="btn sm ghost btn-timer-preset" data-min="5" style="flex:1;">5åˆ†</button>
              <button class="btn sm ghost btn-timer-preset" data-min="10" style="flex:1;">10åˆ†</button>
           </div>
           <div class="timer-controls">
               <input type="number" id="timerInput" placeholder="åˆ†" style="width:60px; text-align:center;">
               <span style="font-weight:bold">:</span>
               <input type="number" id="timerInputSec" placeholder="ç§’" style="width:60px; text-align:center;">
               <div id="timerDisplay">00:00</div>
           </div>
           <div class="actions sm" style="justify-content: flex-end;">
               <button class="btn sm" id="btnTimerStart">é–‹å§‹</button>
               <button class="btn sm warn" id="btnTimerReset">é‡ç½®</button>
           </div>
      </div>
  </div>

  <!-- 3. å¹¸é‹æŠ½ç±¤è¦–çª— -->
  <div id="panelDraw" class="tool-window">
      <div class="tool-header">
          <span><i class="bi bi-gift"></i> å¹¸é‹æŠ½ç±¤</span>
          <button class="tool-close">&times;</button>
      </div>
      <div class="tool-body">
          <div id="luckyDrawResult">???</div>
          <button class="btn chest" id="btnLuckyDraw" style="width:100%">æŠ½å‡ºä¸€ä½å†’éšªè€…</button>
      </div>
  </div>

  <script type="module">
    function getTaipeiDateString() {
        return new Date().toLocaleDateString('zh-TW', { timeZone: 'Asia/Taipei', year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-');
    }
    function getTaipeiTimeString() {
        return new Date().toLocaleTimeString('zh-TW', { timeZone: 'Asia/Taipei', hour12: false, hour: '2-digit', minute: '2-digit' });
    }
    
    const firebaseConfig = {
      apiKey: "AIzaSyDlVtBkmo7pmrxQKXKUzQqIK8LIGW59Dyw",
      authDomain: "hwcheck-8888.firebaseapp.com",
      projectId: "hwcheck-8888",
      storageBucket: "hwcheck-8888.firebasestorage.app",
      messagingSenderId: "661808262560",
      appId: "1:661808262560:web:413e036d53b19ea3c108c5",
      measurementId: "G-FR4LMZ630Q"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"; 
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    let app, db, auth;
    try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
    } catch (e) { console.error(e); alert("Firebase è¨­å®šéŒ¯èª¤"); }

    let currentUser = null;
    let data = { roster: [], assignments: [], teachers: [], questSettings: {}, attendance: {} }; 
    const defaultData = {
        roster: [ { no: 1, name: "å‹‡è€…A" }, { no: 2, name: "æ³•å¸«B" }, { no: 3, name: "å¼“æ‰‹C" } ],
        assignments: [], teachers: ["å…¬æœƒé•·"],
        questSettings: { "åœ‹èª": ["åœ‹èªç¿’ä½œ", "åœ‹èªè€ƒå·"], "æ•¸å­¸": ["æ•¸å­¸ç¿’ä½œ", "æ•¸å­¸è€ƒå·"] },
        attendance: {} 
    };

    const loginOverlay = document.getElementById('loginOverlay');
    const mainApp = document.getElementById('mainApp');
    const APP_SCALE = 1; // ğŸ”¥ ä¿®æ­£ç¸®æ”¾å¸¸æ•¸ç‚º 1

    document.getElementById('btnLogin').addEventListener('click', () => {
        const provider = new GoogleAuthProvider();
        signInWithPopup(auth, provider).catch(error => alert("ç™»å…¥å¤±æ•—ï¼š" + error.message));
    });

    document.getElementById('btnLogout').addEventListener('click', () => {
        if(confirm("ç¢ºå®šè¦ç™»å‡ºç³»çµ±å—ï¼Ÿ")) signOut(auth).then(() => window.location.reload());
    });

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            loginOverlay.style.display = 'none';
            mainApp.style.display = 'flex';
            mainApp.style.flexDirection = 'column';
            const emailDisp = document.getElementById('userEmailDisplay');
            if(emailDisp) emailDisp.innerHTML = `<i class="bi bi-person-circle"></i> ${user.email.split('@')[0]}`;
            initApp();
        } else {
            loginOverlay.style.display = 'flex';
            mainApp.style.display = 'none';
        }
    });

    async function loadDataFromFirebase() {
        if (!currentUser) return;
        updateSaveStatus('saving', 'è®€å–ä¸­...');
        try {
            const docRef = doc(db, "users", currentUser.uid, "data", "guildData");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                data = docSnap.data();
                if(!data.questSettings) data.questSettings = JSON.parse(JSON.stringify(defaultData.questSettings));
                if(!data.attendance) data.attendance = {};
                // ğŸ”¥ Critical Fix: Ensure assignments array exists
                if(!data.assignments) data.assignments = [];
            } else {
                data = JSON.parse(JSON.stringify(defaultData));
                await setDoc(docRef, data);
            }
            onDataLoaded();
            updateSaveStatus('success', 'è®€å–å®Œæˆ');
            checkAttendanceReminder();
        } catch (error) {
            console.log("åˆ‡æ›è‡³é›¢ç·šæ¨¡å¼");
            if(data.roster.length === 0) data = JSON.parse(JSON.stringify(defaultData));
            onDataLoaded();
            updateSaveStatus('error', 'é€£ç·šå¤±æ•—(é›¢ç·šæ¨¡å¼)');
        }
    }

    let saveTimeout = null;
    function triggerAutoSave() {
        clearTimeout(saveTimeout);
        updateSaveStatus('pending');
        saveTimeout = setTimeout(async () => {
            if (!currentUser) return;
            try {
                await setDoc(doc(db, "users", currentUser.uid, "data", "guildData"), data);
                updateSaveStatus('success');
            } catch (e) { updateSaveStatus('error', 'å„²å­˜å¤±æ•—'); }
        }, 1500); 
    }

    function updateSaveStatus(status, message = '') {
        const indicator = document.getElementById('saveStatusIndicator');
        if(!indicator) return;
        if (status === 'pending') indicator.innerHTML = `<span style="color:var(--primary)"><i class="bi bi-pencil"></i> ç´€éŒ„ä¸­...</span>`;
        else if (status === 'saving') indicator.innerHTML = `<span style="color:var(--text-light)"><i class="bi bi-cloud-upload"></i> åŒæ­¥ä¸­...</span>`;
        else if (status === 'success') indicator.innerHTML = `<span style="color:var(--success)"><i class="bi bi-cloud-check"></i> ${message || 'å·²åŒæ­¥'}</span>`;
        else indicator.innerHTML = `<span style="color:var(--danger)"><i class="bi bi-exclamation-triangle"></i> ${message}</span>`;
    }

    let currentAssignmentId = null;
    let currentFilter = { teacher: 'all', subject: 'all' }; 
    let newAssignmentAssignedIndices = []; 
    let isBatchMode = false;
    let tempQuestSettings = {};
    let tempAttendanceData = []; 
    let targetAssignmentIdToDelete = null; 

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function resumeAudio() { if (audioCtx.state === 'suspended') audioCtx.resume(); }

    function playSuccessSound() {
        resumeAudio();
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.type = 'sine'; o.frequency.setValueAtTime(523.25, audioCtx.currentTime);
        o.frequency.exponentialRampToValueAtTime(1046.5, audioCtx.currentTime + 0.1);
        g.gain.setValueAtTime(0.3, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + 0.5);
    }

    function playAlarmSound() {
        resumeAudio();
        const now = audioCtx.currentTime;
        [523, 659, 783, 1046, 783, 659, 523].forEach((f, i) => {
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.frequency.setValueAtTime(f, now + i * 0.4);
            g.gain.setValueAtTime(0.2, now + i * 0.4); g.gain.exponentialRampToValueAtTime(0.01, now + i * 0.4 + 0.3);
            o.connect(g); g.connect(audioCtx.destination);
            o.start(now + i * 0.4); o.stop(now + i * 0.4 + 0.4);
        });
    }

    function confetti() {
        const c = document.getElementById('confettiCanvas'); 
        if(!c) return;
        const ctx = c.getContext('2d');
        c.width = window.innerWidth; c.height = window.innerHeight;
        const pieces = Array.from({length:300}).map(()=>({
            x: Math.random()*c.width, y: Math.random()*c.height-c.height, w: Math.random()*10+5, h: Math.random()*10+5, 
            c: `hsl(${Math.random()*360}, 100%, 50%)`, v: Math.random()*5+2, r: Math.random()*360
        }));
        function draw() {
            ctx.clearRect(0,0,c.width,c.height);
            let active = false;
            pieces.forEach(p=>{
                p.y+=p.v; p.r+=p.v; if(p.y<c.height) active=true;
                ctx.save(); ctx.translate(p.x+p.w/2,p.y+p.h/2); ctx.rotate(p.r*Math.PI/180);
                ctx.fillStyle=p.c; ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h); ctx.restore();
            });
            if(active) requestAnimationFrame(draw); else ctx.clearRect(0,0,c.width,c.height);
        }
        draw();
    }

    function showToast(msg, actText, actCb) {
        const c = document.getElementById('toastContainer');
        const t = document.createElement('div'); t.className = 'toast-msg';
        t.innerHTML = `<span>${msg}</span>` + (actText ? `<button>${actText}</button>` : '');
        c.appendChild(t);
        if(actText && actCb) { t.querySelector('button').onclick = ()=>{ actCb(); t.remove(); }; }
        setTimeout(()=>t.remove(), 3000);
    }

    function initApp() {
        const theme = localStorage.getItem('hwTheme') || 'light';
        const color = localStorage.getItem('hwColor') || 'guild';
        document.documentElement.setAttribute('data-theme', theme);
        document.documentElement.setAttribute('data-color-theme', color);
        document.getElementById('darkModeToggle').checked = theme === 'dark';
        document.querySelectorAll('.theme-option').forEach(el => el.classList.toggle('active', el.dataset.theme === color));
        
        switchView('view-dashboard');
        loadDataFromFirebase();
        
        setInterval(() => {
             const clk = document.getElementById('tbClock');
             if(clk) clk.innerText = new Date().toLocaleTimeString('zh-TW', { timeZone: 'Asia/Taipei', hour12: false });
        }, 1000);
        document.getElementById('attDatePicker').value = getTaipeiDateString();
    }

    function checkAttendanceReminder() {
        const today = new Date().toISOString().split('T')[0];
        if (data.attendance && !data.attendance[today]) setTimeout(() => document.getElementById('attendanceReminderModal').classList.add('show'), 1000);
    }
    
    document.getElementById('btnGoToAttendance').addEventListener('click', () => {
        document.getElementById('attendanceReminderModal').classList.remove('show');
        document.getElementById('adminProfileModal').classList.add('show');
    });

    function onDataLoaded() {
        populateTeacherDropdowns();
        updateSubjectDropdown();
        resetNewAssignmentState();
        renderAll();
    }

    function renderAll() {
        const v = document.querySelector('.view.show');
        if(!v) return;
        if (v.id === 'view-dashboard') renderDashboard();
        else if (v.id === 'view-roster') { renderRosterEditor(); renderTeacherEditor(); }
        else if (v.id === 'view-student-status') renderStudentStatus();
        else if (v.id === 'view-attendance') initAttendanceView();
    }

    function switchView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('show'));
        const target = document.getElementById(id);
        if(target) {
            target.classList.add('show');
            renderAll();
        }
    }

    function populateTeacherDropdowns() {
        const ts = data.teachers || [];
        const sel = document.getElementById('ipTeacherSelect');
        const fil = document.getElementById('teacherFilter');
        if(sel) {
            sel.innerHTML = ts.map(t => `<option value="${t}">${t}</option>`).join('') + '<option value="custom">è‡ªè¡Œè¼¸å…¥...</option>';
            document.getElementById('ipTeacherCustom').style.display = sel.value === 'custom' ? 'block' : 'none';
        }
        if(fil) {
            fil.innerHTML = '<option value="all">æ‰€æœ‰å…¬æœƒé•·</option>' + ts.map(t => `<option value="${t}">${t}</option>`).join('');
            fil.value = currentFilter.teacher;
        }
    }
    
    function resetNewAssignmentState() {
        document.getElementById('ipTitle').value = '';
        document.getElementById('selSubject').value = '';
        document.getElementById('selPresetTask').innerHTML = '<option value="">ğŸ“œ å¸¸ç”¨...</option>';
        document.getElementById('ipDate').value = getTaipeiDateString();
        newAssignmentAssignedIndices = [];
        document.getElementById('assignStatusText').innerText = "å…¨é«”å†’éšªè€…";
        const sel = document.getElementById('ipTeacherSelect');
        if(sel && data.teachers && data.teachers.length > 0) { sel.value = data.teachers[0]; document.getElementById('ipTeacherCustom').style.display = 'none'; }
    }

    function updateSubjectDropdown() {
        const db = data.questSettings || defaultData.questSettings;
        const sel = document.getElementById('selSubject');
        const fil = document.getElementById('subjectFilter');
        if(sel) sel.innerHTML = '<option value="">ğŸ“‚ ç§‘ç›®...</option>';
        if(fil) fil.innerHTML = '<option value="all">ğŸ“š æ‰€æœ‰ç§‘ç›®</option>';
        if(db && sel && fil) Object.keys(db).forEach(s => { sel.add(new Option(s, s)); fil.add(new Option(s, s)); });
    }

    // Dashboard with Tooltip Logic (å„ªåŒ–ï¼šåªé¡¯ç¤ºåº§è™Ÿï¼Œä¸é¡¯ç¤ºå§“åï¼Œä¸¦é…åˆç¸®æ”¾ä¿®æ­£åº§æ¨™)
    const toolTipEl = document.getElementById('assignmentTooltip');
    function showAssignmentTooltip(e, a) {
        if (!a) return;
        const indices = a.assignedIndices || 'all';
        const missing = [];
        const redo = [];
        
        data.roster.forEach((s, i) => {
            if (indices === 'all' || indices.includes(i)) {
                const status = (a.statuses || [])[i] || 0;
                if (status === 0) missing.push(s.no);
                if (status === 2) redo.push(s.no);
            }
        });

        if (missing.length === 0 && redo.length === 0) return;

        let html = `<h4>${a.title}</h4><ul>`;
        if (redo.length) html += `<li class="t-redo">å†æˆ°ï¼š${redo.join(', ')}</li>`;
        if (missing.length) html += `<li class="t-miss">æœªå›å ±ï¼š${missing.join(', ')}</li>`;
        html += `</ul>`;
        
        toolTipEl.innerHTML = html;
        toolTipEl.style.display = 'block';
        moveAssignmentTooltip(e);
    }

    function moveAssignmentTooltip(e) {
        // ä¿®æ­£åº§æ¨™ä»¥é…åˆ zoom: 1.25
        const x = (e.clientX + 15) / APP_SCALE;
        const y = (e.clientY + 15) / APP_SCALE;
        
        toolTipEl.style.top = y + 'px';
        toolTipEl.style.left = x + 'px';
        
        const rect = toolTipEl.getBoundingClientRect();
        // ç°¡å–®é‚Šç•Œæª¢æŸ¥ (ä½¿ç”¨é‚è¼¯å¯¬åº¦æª¢æŸ¥)
        if((x * APP_SCALE + rect.width) > window.innerWidth) {
             toolTipEl.style.left = ((e.clientX - rect.width - 10) / APP_SCALE) + 'px';
        }
        if((y * APP_SCALE + rect.height) > window.innerHeight) {
             toolTipEl.style.top = ((e.clientY - rect.height - 10) / APP_SCALE) + 'px';
        }
    }

    function hideAssignmentTooltip() {
        toolTipEl.style.display = 'none';
    }

    function renderDashboard() {
        const list = document.getElementById('sideAssignmentList');
        const empty = document.getElementById('dashEmptyState');
        const detail = document.getElementById('dashDetailPanel');
        
        if(!list) return;

        let assignments = (data.assignments || []).filter(a => {
            if (a.archived) return false;
            return (currentFilter.teacher === 'all' || a.teacher === currentFilter.teacher) &&
                   (currentFilter.subject === 'all' || (a.subject ? a.subject === currentFilter.subject : a.title.includes(currentFilter.subject)));
        }).sort((a,b) => a.date < b.date ? 1 : -1);

        list.innerHTML = '';
        if (assignments.length === 0) {
            list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--muted); font-size:13px;">æ²’æœ‰ç¬¦åˆçš„å§”è¨—</div>';
            empty.style.display = 'flex'; detail.classList.remove('show');
            return;
        }

        assignments.forEach(a => {
            const el = document.createElement('div');
            el.className = 'side-item' + (currentAssignmentId === a.id ? ' active' : '');
            const indices = a.assignedIndices || 'all';
            const total = indices === 'all' ? data.roster.length : indices.length;
            const completed = (a.statuses || []).filter((s, i) => s === 3 && (indices === 'all' || indices.includes(i))).length;
            const progress = total > 0 ? Math.round((completed / total) * 100) : 0;
            const color = progress === 100 ? 'var(--success)' : 'var(--primary)';

            el.innerHTML = `
                <div class="side-item-title">${a.title}</div>
                <div class="side-item-meta muted"><span>${a.date}</span><span>${a.teacher}</span></div>
                <div style="margin-top:6px; display:flex; align-items:center; gap:6px; font-size:12px;">
                    <div style="flex:1; height:6px; background:rgba(0,0,0,0.1); border-radius:3px; overflow:hidden;">
                        <div style="width:${progress}%; height:100%; background:${color}; transition: width 0.5s;"></div>
                    </div>
                    <span>${completed}/${total}</span>
                </div>
            `;
            el.addEventListener('click', () => { currentAssignmentId = a.id; renderDashboard(); renderDashboardDetail(a.id); });
            // Add tooltip listeners
            el.addEventListener('mouseenter', (e) => showAssignmentTooltip(e, a));
            el.addEventListener('mousemove', moveAssignmentTooltip);
            el.addEventListener('mouseleave', hideAssignmentTooltip);
            
            list.appendChild(el);
        });

        if (currentAssignmentId && assignments.find(x=>x.id==currentAssignmentId)) renderDashboardDetail(currentAssignmentId);
        else { empty.style.display = 'flex'; detail.classList.remove('show'); }
    }

    // ğŸ”¥ æ–°å¢ï¼šç·¨è¼¯æ¨™é¡ŒåŠŸèƒ½
    window.editAssignmentTitle = function(id) {
        const a = data.assignments.find(x => x.id == id);
        if(!a) return;
        const newTitle = prompt("è«‹è¼¸å…¥æ–°çš„å§”è¨—å…§å®¹ï¼š", a.title);
        if(newTitle && newTitle.trim() !== "") {
            a.title = newTitle.trim();
            triggerAutoSave();
            renderDashboardDetail(id); // é‡æ–°æ¸²æŸ“æ¨™é¡Œ
            renderDashboard(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥æ›´æ–°å´é‚Šæ¬„æ¨™é¡Œ
        }
    };

    function renderDashboardDetail(id) {
        const a = data.assignments.find(x => x.id == id);
        if (!a) return;
        document.getElementById('dashEmptyState').style.display = 'none';
        document.getElementById('dashDetailPanel').classList.add('show');
        
        // ğŸ”¥ æ–°å¢ï¼šæ¨™é¡Œæ—çš„ç·¨è¼¯æŒ‰éˆ•
        document.getElementById('dashDetailTitle').innerHTML = `
            <span class="badge" style="background:var(--primary); color:#fff; font-size:14px; padding:2px 8px; border-radius:4px;">${a.subject || 'ä¸€èˆ¬'}</span> 
            ${a.title}
            <button class="btn sm ghost icon-only" title="ç·¨è¼¯åç¨±" onclick="editAssignmentTitle(${a.id})" style="border:none; color:var(--muted);"><i class="bi bi-pencil-fill"></i></button>
        `;

        const grid = document.getElementById('dashGridContainer');
        grid.innerHTML = '';
        const indices = a.assignedIndices || 'all';
        
        data.roster.forEach((s, i) => {
            const isAssigned = indices === 'all' || indices.includes(i);
            const status = (a.statuses || [])[i] || 0;
            const div = document.createElement('div');
            div.className = `seatItem ${!isAssigned ? 'not-assigned' : ''}`;
            div.innerHTML = `<div class="seat s${status}">${s.no}</div><div class="seatName">${s.name}</div>`;
            if(isAssigned) {
                div.querySelector('.seat').onclick = () => toggleStatus(id, i);
            }
            grid.appendChild(div);
        });

        document.getElementById('btnDeleteCurrent').onclick = () => {
            targetAssignmentIdToDelete = id;
            document.getElementById('deleteTargetTitle').innerText = a.title;
            document.getElementById('deleteChoiceModal').classList.add('show');
        };
    }

    function toggleStatus(aid, idx) {
        resumeAudio();
        const a = data.assignments.find(x => x.id == aid);
        if(!a) return;
        let s = (a.statuses || [])[idx] || 0;
        s = (s + 1) % 4;
        if(!a.statuses) a.statuses = Array(data.roster.length).fill(0);
        a.statuses[idx] = s;
        if(s === 3) playSuccessSound();
        
        const indices = a.assignedIndices || 'all';
        let allCompleted = true;
        for(let i=0; i<data.roster.length; i++) {
             if(indices === 'all' || indices.includes(i)) { if(a.statuses[i] !== 3) allCompleted = false; }
        }
        if(allCompleted) confetti();
        triggerAutoSave();
        renderDashboardDetail(aid);
        setTimeout(renderDashboard, 500);
    }

    // é»å
    function initAttendanceView() {
        const date = document.getElementById('attDatePicker').value;
        const btn = document.getElementById('btnSaveAttendance');
        if (data.attendance[date]) {
            tempAttendanceData = JSON.parse(JSON.stringify(data.attendance[date]));
            btn.innerHTML = `<i class="bi bi-arrow-repeat"></i> æ›´æ–°é»åç´€éŒ„`;
        } else {
            tempAttendanceData = data.roster.map(() => ({ status: 0, note: '' }));
            btn.innerHTML = `<i class="bi bi-check-lg"></i> ç¢ºèªé€å‡ºé»åå–®`;
        }
        renderAttendanceUI();
    }

    function renderAttendanceUI() {
        const list = document.getElementById('attendanceList');
        const stats = [0,0,0,0,0,0];
        tempAttendanceData.forEach(d => { if(d.status >=0 && d.status <=5) stats[d.status]++; });
        document.getElementById('statPresent').innerText = stats[0];
        document.getElementById('statLate').innerText = stats[1];
        document.getElementById('statEarly').innerText = stats[2];
        document.getElementById('statSick').innerText = stats[3];
        document.getElementById('statOfficial').innerText = stats[4];
        document.getElementById('statPersonal').innerText = stats[5];

        list.innerHTML = '';
        data.roster.forEach((s, i) => {
            const r = tempAttendanceData[i];
            const div = document.createElement('div');
            div.className = 'att-card';
            let btns = '';
            [{id:0,l:'å‡ºå¸­'},{id:1,l:'é²åˆ°'},{id:2,l:'æ—©é€€'},{id:3,l:'ç—…å‡'},{id:5,l:'äº‹å‡'},{id:4,l:'å…¬å‡'}].forEach(o => {
                btns += `<button class="att-btn ${r.status===o.id?'active':''}" data-status="${o.id}" data-idx="${i}">${o.l}</button>`;
            });
            div.innerHTML = `<div class="att-no">${s.no}</div><div class="att-name">${s.name} ${r.note?`<span class="att-note">${r.note}</span>`:''}</div><div class="att-status-group" style="flex-wrap:wrap;">${btns}</div>`;
            list.appendChild(div);
        });
    }

    document.getElementById('attendanceList').addEventListener('click', (e) => {
        if(e.target.classList.contains('att-btn')) {
            const idx = parseInt(e.target.dataset.idx);
            const status = parseInt(e.target.dataset.status);
            let note = tempAttendanceData[idx].note;
            if (status === 2) { 
                const time = prompt("æ—©é€€æ™‚é–“ (ä¾‹ 14:00)ï¼š", getTaipeiTimeString());
                if (time) note = `æ—©é€€ ${time}`;
            } else note = '';
            tempAttendanceData[idx] = { status, note };
            renderAttendanceUI();
        }
    });
    
    document.getElementById('attDatePicker').addEventListener('change', initAttendanceView);
    document.getElementById('btnSaveAttendance').addEventListener('click', () => {
        data.attendance[document.getElementById('attDatePicker').value] = tempAttendanceData;
        triggerAutoSave();
        alert("é»åç´€éŒ„å·²å„²å­˜ï¼");
        initAttendanceView();
    });

    document.getElementById('btnExportAttendance').addEventListener('click', () => {
        let csv = "\uFEFFåº§è™Ÿ,å§“å,å‡ºå¸­ç¸½è¨ˆ,é²åˆ°,æ—©é€€,ç—…å‡,äº‹å‡,å…¬å‡,ç¼ºå¸­ç¸½è¨ˆ,";
        const dates = Object.keys(data.attendance).sort();
        if(!dates.length) { alert("ç„¡ç´€éŒ„"); return; }
        csv += dates.join(",") + "\n";
        data.roster.forEach((s, idx) => {
            let row = `${s.no},${s.name}`;
            let c = {0:0,1:0,2:0,3:0,4:0,5:0};
            const ds = dates.map(d => {
                const r = data.attendance[d][idx];
                if(!r) return "-";
                if(c[r.status]!==undefined) c[r.status]++;
                let t = {0:"âœ”",1:"é²",2:"æ—©",3:"ç—…",4:"å…¬",5:"äº‹"}[r.status] || "?";
                if(r.status===2 && r.note) t+=`(${r.note})`;
                return t;
            });
            row += `,${c[0]+c[1]+c[2]},${c[1]},${c[2]},${c[3]},${c[5]},${c[4]},${c[3]+c[4]+c[5]},` + ds.join(",");
            csv += row + "\n";
        });
        const url = URL.createObjectURL(new Blob([csv], {type:"text/csv"}));
        const a = document.createElement("a"); a.href=url; a.download="é»åå ±è¡¨.csv"; a.click();
    });

    // ç‹€æ…‹ç®¡ç†é é¢ (å„ªåŒ–ï¼šåŠ å…¥å„€è¡¨æ¿)
    function renderStudentStatus() {
        const con = document.getElementById('studentStatusContainer');
        const title = document.getElementById('studentStatusHeaderTitle');
        const btn = document.getElementById('btnToggleBatchMode');
        const btnSelectAll = document.getElementById('btnBatchSelectAll');
        
        con.innerHTML = '';
        
        // 1. è¨ˆç®—å„€è¡¨æ¿æ•¸æ“š
        const activeAssigns = (data.assignments || []).filter(a => !a.archived);
        const clearedStudents = [];
        const helpStudents = []; // Count >= 5
        
        data.roster.forEach((s, i) => {
            let pendingCount = 0;
            for (let a of activeAssigns) {
                const indices = a.assignedIndices || 'all';
                if (indices === 'all' || indices.includes(i)) {
                    const st = (a.statuses || [])[i] || 0;
                    if (st === 0 || st === 2) {
                        pendingCount++;
                    }
                }
            }
            
            if (pendingCount === 0) clearedStudents.push(s.no);
            if (pendingCount >= 5) helpStudents.push(s.no);
        });
        
        // æ•¸å­—æ’åº
        clearedStudents.sort((a,b)=>a-b);
        helpStudents.sort((a,b)=>a-b);

        // 2. ç¹ªè£½å„€è¡¨æ¿ HTML
        if (!isBatchMode) { // æ‰¹é‡æ¨¡å¼ä¸‹éš±è—å„€è¡¨æ¿ä»¥ç¯€çœç©ºé–“
            const overview = document.createElement('div');
            overview.className = 'status-overview';
            overview.innerHTML = `
                <div class="overview-card success">
                    <div class="overview-icon-bg"><i class="bi bi-trophy"></i></div>
                    <div class="overview-header"><i class="bi bi-trophy-fill"></i> è¨ä¼å…¨å† ç‹ (${clearedStudents.length})</div>
                    <div class="overview-nums">
                        ${clearedStudents.length > 0 ? clearedStudents.map(n => `<span class="num-badge">${n}</span>`).join('') : '<span style="font-size:12px;opacity:0.6;">ğŸ’ª å°šç„¡äººé”æˆ</span>'}
                    </div>
                </div>
                <div class="overview-card danger">
                    <div class="overview-icon-bg"><i class="bi bi-bandaid"></i></div>
                    <div class="overview-header"><i class="bi bi-bandaid-fill"></i> éœ€è£œè¡€æˆå“¡ (æ¬ æ¬¾â‰¥5)</div>
                    <div class="overview-nums">
                        ${helpStudents.length > 0 ? helpStudents.map(n => `<span class="num-badge">${n}</span>`).join('') : '<span style="font-size:12px;opacity:0.6;">âœ… å…¨å“¡å¥åº·</span>'}
                    </div>
                </div>
            `;
            con.appendChild(overview);
        }

        // 3. ç¹ªè£½åˆ—è¡¨
        if(isBatchMode) { 
            con.classList.add('batch-mode'); btn.classList.add('warn'); btn.innerHTML = `<i class="bi bi-x-square"></i> å–æ¶ˆæ‰¹é‡`;
            document.getElementById('btnBatchExport').style.display='inline-flex';
            if(btnSelectAll) btnSelectAll.style.display='inline-flex'; 
            title.innerHTML = `<i class="bi bi-check2-square"></i> å‹¾é¸åŒ¯å‡ºå°è±¡`;
        } else { 
            con.classList.remove('batch-mode'); btn.classList.remove('warn'); btn.innerHTML = `<i class="bi bi-check-square"></i> æ‰¹é‡åŒ¯å‡ºå·è»¸`;
            document.getElementById('btnBatchExport').style.display='none'; 
            if(btnSelectAll) btnSelectAll.style.display='none'; 
            title.innerHTML = `<i class="bi bi-clipboard2-check"></i> å†’éšªè€…å¾…è¾¦æ¸…å–®`;
        }

        const pending = [];
        data.roster.forEach((s, idx) => {
            let tasks = [];
            (data.assignments || []).forEach(a => {
                if(a.archived) return;
                const indices = a.assignedIndices || 'all';
                if ((indices === 'all' || indices.includes(idx))) {
                    const st = (a.statuses || [])[idx] || 0;
                    // ğŸ”¥ ä¿®å¾©ï¼šä¸ç®¡ç‹€æ…‹æ˜¯ä»€éº¼éƒ½åˆ—å‡ºï¼Œä»¥ä¾¿ä¿®æ”¹ (ä¹‹å‰æ˜¯ if st===0 || st===2)
                    // ä½†é€™è£¡æˆ‘å€‘è¦åˆ—å‡ºæ‰€æœ‰ç›¸é—œä»»å‹™ï¼Œé€™æ¨£æ‰èƒ½çœ‹åˆ°ã€Œå·²å®Œæˆã€çš„ä»»å‹™ä¸¦åæ‚”
                    // ä¸éåŸéœ€æ±‚æ˜¯ã€Œå†’éšªè€…å¾…è¾¦æ¸…å–®ã€ï¼Œé€šå¸¸åªåˆ—æœªå®Œæˆã€‚
                    // ä½†ä½¿ç”¨è€…èªªã€Œæœªå›å ±é»é¸å¾Œå¯ä»¥åˆ‡æ›...é»éä¸€æ¬¡ä¸èƒ½å†é»ã€ï¼Œé€™æš—ç¤ºä»–å€‘å¸Œæœ›åˆ—è¡¨èƒ½æŒçºŒæ“ä½œ
                    // æ‰€ä»¥é€™è£¡æ”¹ç‚ºï¼šåªåˆ—å‡ºã€Œæœªå›å ± (0)ã€å’Œã€Œå†æŒ‘æˆ° (2)ã€ä»¥åŠã€Œå·²å›å ± (1)ã€ï¼Œå› ç‚ºå·²å›å ±å¯èƒ½è¦æ”¹æˆå†æŒ‘æˆ°
                    // è¨ä¼æˆåŠŸ (3) é€šå¸¸å°±å¾å¾…è¾¦æ¸…å–®æ¶ˆå¤±äº†ã€‚
                    if (st !== 3) tasks.push({ id: a.id, title: a.title, status: st });
                }
            });
            if (tasks.length > 0) pending.push({ idx, tasks });
        });

        if (pending.length === 0) { 
            const happyDiv = document.createElement('div');
            happyDiv.style.textAlign = 'center';
            happyDiv.style.marginTop = '20px';
            happyDiv.innerHTML = `<div style="font-size:40px;">ğŸ‰</div><div style="font-size:20px;font-weight:bold;">å…¨å“¡è¨ä¼æˆåŠŸï¼</div>`;
            con.appendChild(happyDiv);
            return; 
        }

        const grid = document.createElement('div'); grid.className = 'student-status-grid';
        pending.forEach(item => {
            const s = data.roster[item.idx];
            const div = document.createElement('div'); div.className = 'card';
            let html = `<div class="student-card-header"><h2>${isBatchMode?`<input type="checkbox" class="batch-export-checkbox" data-sidx="${item.idx}">`:''} ${s.no}. ${s.name}</h2><button class="btn sm ghost btn-print-single" data-sidx="${item.idx}"><i class="bi bi-printer"></i></button></div><ul class="student-status-list">`;
            item.tasks.forEach(t => {
                // è¨­å®šé¡è‰²èˆ‡æ–‡å­—
                let pillClass = 'p-gray';
                let statusText = 'æœªå›å ±';
                if(t.status === 1) { pillClass = 'p-yellow'; statusText = 'å·²å›å ±'; }
                else if(t.status === 2) { pillClass = 'p-orange'; statusText = 'å†æŒ‘æˆ°'; }
                
                // æ³¨æ„ï¼šé€™è£¡åœ¨ li ä¸Šé¢åŠ äº† data-statusï¼Œæ–¹ä¾¿é»æ“Šæ™‚åˆ¤æ–·
                html += `<li data-aid="${t.id}" data-sidx="${item.idx}" data-status="${t.status}">
                            <span style="flex:1;">${t.title}</span> 
                            <span class="pill ${pillClass}">${statusText}</span>
                         </li>`;
            });
            div.innerHTML = html + '</ul>';
            grid.appendChild(div);
        });
        con.appendChild(grid);
    }
    
    // æ‰¹é‡å…¨é¸åŠŸèƒ½
    document.getElementById('btnBatchSelectAll').addEventListener('click', () => {
        const checkboxes = document.querySelectorAll('.batch-export-checkbox');
        const allChecked = Array.from(checkboxes).every(c => c.checked);
        checkboxes.forEach(c => c.checked = !allChecked);
    });
    
    // é–‹å•Ÿ/éš±è—å°éµç›¤
    document.getElementById('btnToggleKeypad').addEventListener('click', () => {
        const kp = document.getElementById('virtualKeypad');
        kp.style.display = kp.style.display === 'none' || kp.style.display === '' ? 'grid' : 'none';
    });
    
    // ----------------------------------------------------
    // ğŸ”¥ æ ¸å¿ƒä¿®å¾©ï¼šç‹€æ…‹é»æ“Šé‚è¼¯ (æ©˜è‰²ç›´æ¥è®Šæ›´ / å…¶ä»–è·³é¸å–®)
    // ----------------------------------------------------
    let pickerTarget = null; // å„²å­˜ç•¶å‰æ“ä½œçš„ç›®æ¨™

    document.getElementById('studentStatusContainer').addEventListener('click', (e) => {
        // å¿½ç•¥åˆ—å°æŒ‰éˆ•å’Œæ ¸å–æ–¹å¡Š
        if(e.target.closest('.btn-print-single') || e.target.classList.contains('batch-export-checkbox')) return;
        
        const li = e.target.closest('li');
        if(!li) return;

        const aid = li.dataset.aid;
        const sidx = parseInt(li.dataset.sidx);
        const assignment = data.assignments.find(i => i.id == aid);
        if (!assignment) return;
        
        const currentStatus = (assignment.statuses || [])[sidx] || 0;

        // ğŸŸ¢ é‚è¼¯ Aï¼šå¦‚æœæ˜¯ã€Œå†æŒ‘æˆ° (æ©˜è‰² 2)ã€ï¼Œç›´æ¥è©¢å•æ˜¯å¦æˆåŠŸ
        if (currentStatus === 2) {
            if (confirm(`ã€${data.roster[sidx].name}ã€‘çš„ã€Œ${assignment.title}ã€\næ˜¯å¦å·²å®Œæˆä¸¦å°‡ç‹€æ…‹æ”¹ç‚ºã€Œè¨ä¼æˆåŠŸã€ï¼Ÿ`)) {
                updateStatus(aid, sidx, 3);
            }
            return;
        }

        // ğŸŸ¡ é‚è¼¯ Bï¼šé–‹å•Ÿé¸å–® (è·Ÿéš¨æ»‘é¼ ä½ç½®)
        pickerTarget = { idx: sidx, aid: aid };
        const picker = document.getElementById('statusPicker');
        
        // 1. å–å¾—æ»‘é¼ é»æ“Šåº§æ¨™ (e.clientX, e.clientY)
        // ğŸ”¥ é‡é»ï¼šä¸€å®šè¦é™¤ä»¥ APP_SCALE (1)ï¼Œå¦å‰‡å› ç‚ºç¶²é æœ‰ç¸®æ”¾ï¼Œé¸å–®æœƒåé›¢æ»‘é¼ 
        let mouseX = e.clientX / APP_SCALE;
        let mouseY = e.clientY / APP_SCALE;
        
        // 2. ç¨å¾®å¾€å³ä¸‹åç§»ä¸€é»é» (+10)ï¼Œé¿å…æ»‘é¼ ç›´æ¥é®ä½é¸å–®çš„ç¬¬ä¸€å€‹é¸é …
        picker.style.top = (mouseY + 10) + 'px';
        picker.style.left = (mouseX + 10) + 'px';
        
        picker.classList.add('show');

        // é»æ“Šç©ºç™½è™•é—œé–‰é¸å–®
        const close = (evt) => { 
            if(!picker.contains(evt.target)) { 
                picker.classList.remove('show'); 
                document.removeEventListener('click', close); 
            }
        };
        setTimeout(() => document.addEventListener('click', close), 100);
    });

    // è¼”åŠ©å‡½å¼ï¼šçµ±ä¸€æ›´æ–°ç‹€æ…‹ä¸¦å­˜æª”
    function updateStatus(aid, sidx, newStatus) {
        const a = data.assignments.find(i => i.id == aid);
        if(a) {
            if(!a.statuses) a.statuses = Array(data.roster.length).fill(0);
            a.statuses[sidx] = newStatus;
            
            if(newStatus === 3) {
                playSuccessSound();
                // å¯é¸ï¼šå¦‚æœè¦æ”¾ç…™ç« confetti(); 
            }
            
            triggerAutoSave(); 
            renderStudentStatus(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
            renderDashboard();     // åŒæ­¥æ›´æ–°çœ‹æ¿
        }
    }

    // é¸å–®æŒ‰éˆ•é»æ“Šäº‹ä»¶ (ä¿æŒåŸæ¨£ï¼Œä½†æ”¹å‘¼å« updateStatus)
    document.querySelectorAll('.status-option-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            if(!pickerTarget) return;
            const s = parseInt(btn.dataset.status);
            updateStatus(pickerTarget.aid, pickerTarget.idx, s);
            document.getElementById('statusPicker').classList.remove('show');
        });
    });

    // åˆªé™¤/å°å­˜
    document.getElementById('btnConfirmArchive').addEventListener('click', () => {
        const a = data.assignments.find(x => x.id == targetAssignmentIdToDelete);
        if(a) { a.archived = true; triggerAutoSave(); renderDashboard(); }
        document.getElementById('deleteChoiceModal').classList.remove('show');
    });

    document.getElementById('btnConfirmDelete').addEventListener('click', () => {
        const a = data.assignments.find(x => x.id == targetAssignmentIdToDelete);
        if(a) {
            const backup = JSON.stringify(a);
            data.assignments = data.assignments.filter(x => x.id != targetAssignmentIdToDelete);
            triggerAutoSave(); renderDashboard();
            showToast("å·²åˆªé™¤", "å¾©åŸ", () => {
                data.assignments.push(JSON.parse(backup));
                triggerAutoSave(); renderDashboard();
            });
        }
        document.getElementById('deleteChoiceModal').classList.remove('show');
    });

    // äº‹ä»¶ç›£è½èˆ‡ UI åˆ‡æ›
    ['btnNavDashboard','btnNavStudentStatus','btnNavRoster'].forEach(id => {
        document.getElementById(id).addEventListener('click', (e) => {
            const map = {'btnNavDashboard':'view-dashboard','btnNavStudentStatus':'view-student-status','btnNavRoster':'view-roster'};
            switchView(map[e.currentTarget.id]);
        });
    });

    document.getElementById('tabBtnStudents').addEventListener('click', () => {
        document.getElementById('tabBtnStudents').classList.add('active'); document.getElementById('tabBtnTeachers').classList.remove('active');
        document.getElementById('roster-content-students').classList.add('show'); document.getElementById('roster-content-teachers').classList.remove('show');
    });
    document.getElementById('tabBtnTeachers').addEventListener('click', () => {
        document.getElementById('tabBtnTeachers').classList.add('active'); document.getElementById('tabBtnStudents').classList.remove('active');
        document.getElementById('roster-content-teachers').classList.add('show'); document.getElementById('roster-content-students').classList.remove('show');
    });

    document.getElementById('btnOpenSettings').addEventListener('click', () => document.getElementById('settingsModal').classList.add('show'));
    document.querySelectorAll('.modal-close-btn').forEach(b => b.addEventListener('click', (e) => e.target.closest('.modal-overlay').classList.remove('show')));
    document.getElementById('ipTeacherSelect').addEventListener('change', (e) => document.getElementById('ipTeacherCustom').style.display = e.target.value === 'custom' ? 'block' : 'none');
    
    document.getElementById('selSubject').addEventListener('change', (e) => {
        const sel = document.getElementById('selPresetTask'); sel.innerHTML = '<option value="">ğŸ“œ å¸¸ç”¨ä»»å‹™...</option>';
        if(e.target.value && data.questSettings[e.target.value]) data.questSettings[e.target.value].forEach(t => sel.add(new Option(t, t)));
    });
    document.getElementById('selPresetTask').addEventListener('change', (e) => { if(e.target.value) document.getElementById('ipTitle').value = e.target.value; });

    document.getElementById('btnCreate').addEventListener('click', () => {
        let t = document.getElementById('ipTeacherSelect').value;
        if(t === 'custom') t = document.getElementById('ipTeacherCustom').value.trim();
        const title = document.getElementById('ipTitle').value.trim();
        const sub = document.getElementById('selSubject').value;
        const d = document.getElementById('ipDate').value;
        if(!t || !title || !d) { alert("è«‹å¡«å¯«å®Œæ•´"); return; }
        if(!data.teachers.includes(t)) data.teachers.push(t);
        const isAll = !newAssignmentAssignedIndices.length || newAssignmentAssignedIndices.length === data.roster.length;
        data.assignments.push({ 
            id: Date.now(), teacher: t, title, subject: sub, date: d, 
            assignedIndices: isAll ? 'all' : newAssignmentAssignedIndices, statuses: Array(data.roster.length).fill(0) 
        });
        triggerAutoSave(); resetNewAssignmentState(); renderAll();
        // æˆåŠŸå¾Œé—œé–‰å½ˆçª—
        document.getElementById('panelNewQuest').classList.remove('show');
    });

    document.getElementById('btnMarkAllYellow').addEventListener('click', () => { if(confirm("å…¨å“¡å·²å ±ï¼Ÿ")) updateAllStatus(1); });
    document.getElementById('btnMarkAllOrange').addEventListener('click', () => { if(confirm("å…¨å“¡å†æˆ°ï¼Ÿ")) updateAllStatus(2); });
    function updateAllStatus(s) {
        const a = data.assignments.find(x => x.id == currentAssignmentId);
        if(a) { 
            const idxs = a.assignedIndices || 'all';
            data.roster.forEach((_, i) => { if(idxs === 'all' || idxs.includes(i)) a.statuses[i] = s; });
            triggerAutoSave(); renderDashboardDetail(currentAssignmentId);
        }
    }
    
    document.getElementById('rangeSize').addEventListener('input', (e) => {
        document.documentElement.style.setProperty('--seat', `${e.target.value}px`);
        document.documentElement.style.setProperty('--seat-font', `${Math.max(10, Math.floor(e.target.value * 0.3))}px`);
    });

    // åŸ·å‹™å®¤èˆ‡å…¬æœƒé•·é‚è¼¯
    const userBadge = document.getElementById('userEmailDisplay');
    if(userBadge) {
        userBadge.addEventListener('click', () => {
            const list = document.getElementById('adminDebtList');
            list.innerHTML = '';
            const debts = [];
            data.roster.forEach((s, idx) => {
                let c = 0;
                data.assignments.forEach(a => { if(!a.archived) { const st = (a.statuses||[])[idx]||0; if(st===0||st===2) c++; } });
                if(c>=5) debts.push({name: s.name, c});
            });
            if(debts.length) debts.forEach(d => list.innerHTML += `<span style="background:#fee2e2;color:#b91c1c;padding:6px 12px;border-radius:20px;font-weight:bold;margin-right:8px;">${d.name} (${d.c})</span>`);
            else list.innerHTML = '<p style="color:var(--success)">ç›®å‰ç„¡äººæ¬ æ¬¾ï¼</p>';
            document.getElementById('adminProfileModal').classList.add('show');
        });
    }

    document.getElementById('btnAdminAttendance').addEventListener('click', () => {
        document.getElementById('adminProfileModal').classList.remove('show');
        switchView('view-attendance');
    });

    document.getElementById('btnDownloadArchive').addEventListener('click', () => {
        const arcs = data.assignments.filter(a => a.archived);
        if(!arcs.length) { alert("ç„¡å°å­˜è³‡æ–™"); return; }
        let csv = "\uFEFFç™¼å¸ƒæ—¥æœŸ,å…§å®¹,å°å¸«," + data.roster.map(s => s.name).join(",") + "\n";
        arcs.forEach(a => {
            const st = a.statuses || [];
            csv += `${a.date},"${a.title}",${a.teacher},` + data.roster.map((_, i) => ["æœª","äº¤","æ”¹","å®Œ"][st[i]||0]).join(",") + "\n";
        });
        const url = URL.createObjectURL(new Blob([csv], {type:"text/csv"}));
        const el = document.createElement("a"); el.href=url; el.download="å°å­˜.csv"; el.click();
    });

    document.getElementById('btnClearAssignments').addEventListener('click', () => {
        if(confirm("è­¦å‘Šï¼šé€™å°‡åˆªé™¤æ‰€æœ‰ä»»å‹™ï¼")) { data.assignments = []; triggerAutoSave(); renderAll(); document.getElementById('adminProfileModal').classList.remove('show'); }
    });
    document.getElementById('btnResetAll').addEventListener('click', () => {
        if(prompt("è¼¸å…¥ DESTROY ä»¥é‡ç½®ä¸€åˆ‡") === "DESTROY") { 
            data.roster = []; data.assignments = []; data.attendance = {}; 
            triggerAutoSave(); renderAll(); document.getElementById('adminProfileModal').classList.remove('show'); 
        }
    });

    // ç¯©é¸å™¨
    ['teacherFilter','subjectFilter'].forEach(id => {
        document.getElementById(id).addEventListener('change', (e) => {
            currentFilter[id.replace('Filter','')] = e.target.value;
            renderDashboard();
            document.getElementById('filterPanel').classList.remove('show');
            document.getElementById('btnToggleFilter').classList.remove('active');
        });
    });
    document.getElementById('btnClearFilter').addEventListener('click', () => {
        currentFilter = { teacher: 'all', subject: 'all' };
        document.getElementById('teacherFilter').value = 'all'; document.getElementById('subjectFilter').value = 'all';
        renderDashboard(); document.getElementById('filterPanel').classList.remove('show');
    });

    // è¨­å®š
    document.getElementById('btnOpenQuestSettings').addEventListener('click', () => {
        tempQuestSettings = JSON.parse(JSON.stringify(data.questSettings));
        renderQuestConfig();
        document.getElementById('questSettingsModal').classList.add('show');
    });
    function renderQuestConfig() {
        const list = document.getElementById('questConfigList'); list.innerHTML = '';
        Object.keys(tempQuestSettings).forEach(sub => {
            const div = document.createElement('div'); div.className = 'quest-config-card';
            div.innerHTML = `
                <div class="quest-config-header">
                    <span class="quest-config-title">${sub}</span>
                    <button class="btn sm warn btn-del-subj" data-sub="${sub}"><i class="bi bi-trash"></i> ç§»é™¤ç§‘ç›®</button>
                </div>
                <div class="quest-tags">
                    ${tempQuestSettings[sub].map((t, i) => `<span class="quest-tag">${t} <i class="bi bi-x-circle-fill btn-del-task" data-sub="${sub}" data-idx="${i}"></i></span>`).join('')}
                </div>
                <div class="quest-add-row">
                    <input placeholder="è¼¸å…¥æ–°ä»»å‹™åç¨±..." id="newT_${sub}" style="flex:1; font-size:13px; padding:6px;">
                    <button class="btn sm btn-add-task" data-sub="${sub}"><i class="bi bi-plus-lg"></i> æ–°å¢</button>
                </div>
            `;
            list.appendChild(div);
        });
    }

    // Quest Config Event Delegation (Fix for inline handlers)
    const qList = document.getElementById('questConfigList');
    qList.addEventListener('click', (e) => {
        if(e.target.closest('.btn-del-subj')) {
            const s = e.target.closest('.btn-del-subj').dataset.sub;
            if(confirm(`ç¢ºå®šè¦ç§»é™¤ã€${s}ã€‘ç§‘ç›®èˆ‡å…¶æ‰€æœ‰ä»»å‹™å—ï¼Ÿ`)) { delete tempQuestSettings[s]; renderQuestConfig(); }
        } else if(e.target.closest('.btn-del-task')) {
            const t = e.target.closest('.btn-del-task');
            const s = t.dataset.sub; const i = parseInt(t.dataset.idx);
            tempQuestSettings[s].splice(i, 1); renderQuestConfig();
        } else if(e.target.closest('.btn-add-task')) {
            const s = e.target.closest('.btn-add-task').dataset.sub;
            const ip = document.getElementById(`newT_${s}`);
            if(ip.value.trim()) { tempQuestSettings[s].push(ip.value.trim()); renderQuestConfig(); }
        }
    });

    document.getElementById('btnAddSubject').addEventListener('click', () => {
        const v = document.getElementById('ipNewSubject').value.trim();
        if(v && !tempQuestSettings[v]) { tempQuestSettings[v] = []; document.getElementById('ipNewSubject').value=''; renderQuestConfig(); }
    });
    document.getElementById('btnSaveQuestSettings').addEventListener('click', () => {
        data.questSettings = tempQuestSettings; triggerAutoSave(); updateSubjectDropdown();
        document.getElementById('questSettingsModal').classList.remove('show');
    });
    
    // è™›æ“¬éµç›¤é‚è¼¯
    document.getElementById('virtualKeypad').addEventListener('click', (e) => {
        if(e.target.classList.contains('vk-btn')) {
            const val = e.target.dataset.val;
            const ip = document.getElementById('ipTitle');
            if (val === 'backspace') {
                ip.value = ip.value.slice(0, -1);
            } else if (val === 'clear') {
                ip.value = '';
            } else if (val === 'space') {
                ip.value += ' ';
            } else {
                ip.value += val;
            }
            ip.focus();
        }
    });

    document.getElementById('themeOptionsContainer').addEventListener('click', (e) => {
        if(e.target.classList.contains('theme-option')) {
            const t = e.target.dataset.theme;
            document.documentElement.setAttribute('data-color-theme', t);
            localStorage.setItem('hwColor', t);
            document.querySelectorAll('.theme-option').forEach(el => el.classList.remove('active'));
            e.target.classList.add('active');
        }
    });
    document.getElementById('darkModeToggle').addEventListener('change', (e) => {
        const t = e.target.checked ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', t);
        localStorage.setItem('hwTheme', t);
    });

    // åå†Šç·¨è¼¯
    document.getElementById('btnAddStudentRow').addEventListener('click', () => {
        const div = document.getElementById('rosterEditor');
        const c = div.querySelectorAll('.roster-item').length + 1;
        const d = document.createElement('div'); d.className = 'roster-item';
        d.innerHTML = `<input type="number" value="${c}" class="roster-no-input"><input class="roster-name-input">`;
        div.appendChild(d);
    });
    document.getElementById('btnApplyRoster').addEventListener('click', () => {
        const r = [];
        document.querySelectorAll('.roster-item').forEach(d => {
            const no = parseInt(d.querySelector('.roster-no-input').value);
            const name = d.querySelector('.roster-name-input').value.trim();
            if(no && name) r.push({no, name});
        });
        data.roster = r; triggerAutoSave(); renderRosterEditor(); alert("å·²æ›´æ–°");
    });
    function renderRosterEditor() {
        const d = document.getElementById('rosterEditor'); d.innerHTML = '';
        data.roster.forEach(s => {
            d.innerHTML += `<div class="roster-item"><input type="number" value="${s.no}" class="roster-no-input"><input value="${s.name}" class="roster-name-input"></div>`;
        });
    }

    document.getElementById('btnApplyTeachers').addEventListener('click', () => {
        const ts = [];
        document.querySelectorAll('.teacher-name-input').forEach(i => { if(i.value.trim()) ts.push(i.value.trim()); });
        data.teachers = [...new Set(ts)]; triggerAutoSave(); renderTeacherEditor(); alert("å·²æ›´æ–°");
    });
    function renderTeacherEditor() {
        const d = document.getElementById('teacherEditor'); d.innerHTML = '';
        data.teachers.forEach(t => {
            const div = document.createElement('div'); div.className = 'teacher-item';
            div.innerHTML = `<input value="${t}" class="teacher-name-input"><button class="btn warn sm btn-del-t">åˆª</button>`;
            div.querySelector('.btn-del-t').onclick = () => { if(confirm("åˆªé™¤?")) { data.teachers = data.teachers.filter(x=>x!==t); triggerAutoSave(); renderTeacherEditor(); }};
            d.appendChild(div);
        });
    }
    
    document.getElementById('btnLoadFromPaste').addEventListener('click', () => {
        const txt = document.getElementById('taRosterPaste').value.trim();
        if(!txt) return;
        const d = document.getElementById('rosterEditor');
        let c = d.querySelectorAll('.roster-item').length + 1;
        txt.split(/\r?\n/).forEach(n => {
            if(n.trim()){ d.innerHTML += `<div class="roster-item"><input type="number" value="${c++}" class="roster-no-input"><input value="${n.trim()}" class="roster-name-input"></div>`; }
        });
        document.getElementById('taRosterPaste').value = '';
    });

    // æŒ‡æ´¾å°è±¡ Modal
    document.getElementById('btnOpenAssignModal').addEventListener('click', () => {
        const c = document.getElementById('assignStudentListContainer'); c.innerHTML = '';
        data.roster.forEach((s, i) => {
            const chk = !newAssignmentAssignedIndices.length || newAssignmentAssignedIndices.includes(i);
            const l = document.createElement('label'); l.className = 'assign-student-item';
            l.innerHTML = `<input type="checkbox" data-idx="${i}" ${chk?'checked':''}> ${s.no}.${s.name}`;
            c.appendChild(l);
        });
        document.getElementById('assignStudentModal').classList.add('show');
    });
    document.getElementById('btnConfirmAssign').addEventListener('click', () => {
        const chks = document.querySelectorAll('#assignStudentListContainer input:checked');
        newAssignmentAssignedIndices = Array.from(chks).map(c => parseInt(c.dataset.idx));
        document.getElementById('assignStatusText').innerText = newAssignmentAssignedIndices.length === data.roster.length ? "å…¨é«”å†’éšªè€…" : `å·²é¸ ${newAssignmentAssignedIndices.length} ä½`;
        document.getElementById('assignStudentModal').classList.remove('show');
    });
    document.getElementById('btnAssignSelectAll').addEventListener('click', () => document.querySelectorAll('#assignStudentListContainer input').forEach(c => c.checked=true));
    document.getElementById('btnAssignDeselectAll').addEventListener('click', () => document.querySelectorAll('#assignStudentListContainer input').forEach(c => c.checked=false));

    // æ‰¹é‡è™•ç†
    document.getElementById('btnToggleBatchMode').addEventListener('click', () => { isBatchMode = !isBatchMode; renderStudentStatus(); });
// ============================================================
// ============================================================
    // ğŸ–¨ï¸ å„ªåŒ–ç‰ˆï¼šæ‰¹é‡åŒ¯å‡ºå·è»¸ (A4 æ’ç‰ˆ + ç°½åæ¬„ + æ ¼ç‹€çœç´™)
    // ============================================================
    document.getElementById('btnBatchExport').addEventListener('click', () => {
        const chks = document.querySelectorAll('.batch-export-checkbox:checked');
        if(!chks.length) { alert("å°šæœªå‹¾é¸ä»»ä½•å†’éšªè€…ï¼"); return; }
        
        // 1. æº–å‚™å…§å®¹
        let cardsHtml = '';
        const printDate = new Date().toLocaleDateString('zh-TW');

        chks.forEach(c => {
            const card = c.closest('.card');
            if(!card) return;
            
            // æŠ“å–å§“å (ç§»é™¤ checkbox æœ¬èº«)
            let nameText = card.querySelector('h2').innerText.trim();
            
            // æŠ“å–ä»»å‹™åˆ—è¡¨ï¼Œä¸¦å°‡ç¶²é çš„ Pill è½‰ç‚ºç´™æœ¬çš„ Checkbox
            const listItems = Array.from(card.querySelectorAll('li')).map(li => {
                // å–å¾—ä»»å‹™åç¨± (ç§»é™¤å¾Œé¢çš„ pill)
                const taskName = li.childNodes[0].textContent.trim();
                // åˆ¤æ–·ç›®å‰ç‹€æ…‹ (é›–ç„¶å°å‡ºä¾†é€šå¸¸æ˜¯è®“ä»–å€‘è£œåšï¼Œä½†ä¿ç•™ç‹€æ…‹ä¹Ÿä¸éŒ¯)
                const statusPill = li.querySelector('.pill');
                const statusText = statusPill ? statusPill.innerText : '';
                
                return `
                    <li class="print-task-item">
                        <span class="print-checkbox">â˜</span>
                        <span class="print-task-name">${taskName}</span>
                        <span class="print-task-status">(${statusText})</span>
                    </li>`;
            }).join('');

            cardsHtml += `
                <div class="print-card">
                    <div class="print-header">
                        <div class="print-name">${nameText}</div>
                        <div class="print-title">å†’éšªè€…ä»»å‹™æ¸…å–®</div>
                    </div>
                    <ul class="print-list">
                        ${listItems}
                    </ul>
                    <div class="print-footer">
                        <div class="print-date">ğŸ“… ${printDate}</div>
                        <div class="print-sign">å®¶é•·ç°½åï¼š________________</div>
                    </div>
                </div>
            `;
        });

        // 2. å»ºç«‹åˆ—å°è¦–çª— (åŒ…å«ç¾åŒ– CSS)
        const w = window.open('', '', 'width=900,height=800');
        w.document.write(`
            <html>
            <head>
                <title>å†’éšªè€…ä»»å‹™å·è»¸åŒ¯å‡º</title>
                <style>
                    body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; background: #fff; }
                    
                    /* æ ¼ç‹€æ’ç‰ˆï¼šç”±é€™è£¡æ§åˆ¶ä¸€åˆ—å¹¾å€‹ (é è¨­ 2 å€‹ï¼Œçœç´™) */
                    .print-container {
                        display: grid;
                        grid-template-columns: 1fr 1fr; 
                        gap: 20px;
                    }
                    
                    .print-card {
                        border: 2px solid #3E2723; /* æ·±å’–å•¡è‰²é‚Šæ¡† */
                        border-radius: 8px;
                        padding: 15px;
                        break-inside: avoid; /* é˜²æ­¢è¢«åˆ‡é  */
                        display: flex;
                        flex-direction: column;
                        background: #fff;
                        box-shadow: 4px 4px 0px rgba(0,0,0,0.1);
                    }

                    .print-header {
                        border-bottom: 2px dashed #8B4513;
                        padding-bottom: 8px;
                        margin-bottom: 8px;
                        display: flex;
                        justify-content: space-between;
                        align-items: baseline;
                    }
                    .print-name { font-size: 22px; font-weight: 900; color: #000; }
                    .print-title { font-size: 14px; font-weight: bold; color: #666; }

                    .print-list { list-style: none; padding: 0; margin: 0; flex: 1; }
                    .print-task-item {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        padding: 6px 0;
                        border-bottom: 1px dotted #ccc;
                        font-size: 16px;
                    }
                    .print-checkbox { font-size: 20px; font-weight: bold; line-height: 1; }
                    .print-task-name { font-weight: bold; flex: 1; }
                    .print-task-status { font-size: 12px; color: #888; }

                    .print-footer {
                        margin-top: 15px;
                        padding-top: 10px;
                        border-top: 2px solid #eee;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        font-size: 14px;
                    }
                    .print-date { font-weight: bold; color: #555; }
                    .print-sign { font-weight: 900; color: #000; }

                    /* åˆ—å°å°ˆç”¨è¨­å®š */
                    @media print {
                        body { padding: 0; margin: 0; }
                        .print-card { box-shadow: none; border-width: 1px; }
                        @page { margin: 1cm; }
                    }
                </style>
            </head>
            <body>
                <div class="print-container">
                    ${cardsHtml}
                </div>
                <script>
                    window.onload = () => { setTimeout(() => { window.print(); window.close(); }, 500); };
                <\/script>
            </body>
            </html>
        `);
        w.document.close();
    });
    // ==========================================
    // ğŸ› ï¸ ä¿®å¾©å¾Œçš„å·¥å…·ç®±èˆ‡å…¨åŸŸäº‹ä»¶é‚è¼¯ (Fixes)
    // ==========================================
    
    // 1. å·¥å…·ç®±é–‹é—œ
    document.getElementById('btnToggleToolbox').addEventListener('click', function() {
        document.getElementById('toolboxMenu').classList.toggle('show');
        this.classList.toggle('active');
    });
    
    // ğŸ”¥ å„ªåŒ–ï¼šç™¼å¸ƒæ–°å§”è¨—é–‹é—œ
    document.getElementById('btnOpenNewQuestWindowSidebar').addEventListener('click', () => {
        resetNewAssignmentState();
        openTool('panelNewQuest');
    });

    // 2. é–‹å•Ÿå„å€‹å°è¦–çª—
    function openTool(id) {
        document.querySelectorAll('.tool-window').forEach(w => w.classList.remove('show'));
        const win = document.getElementById(id);
        if(win) win.classList.add('show');
        document.getElementById('toolboxMenu').classList.remove('show');
        document.getElementById('btnToggleToolbox').classList.remove('active');
    }
    document.getElementById('btnOpenMarquee').addEventListener('click', () => openTool('panelMarquee'));
    document.getElementById('btnOpenTimer').addEventListener('click', () => openTool('panelTimer'));
    document.getElementById('btnOpenDraw').addEventListener('click', () => openTool('panelDraw'));

    // 3. å…¨åŸŸé—œé–‰æŒ‰éˆ• (äº‹ä»¶å§”æ´¾)
    document.addEventListener('click', (e) => {
        if (e.target.closest('.tool-close')) {
            const win = e.target.closest('.tool-window');
            if (win) win.classList.remove('show');
        }
    });

    // 4. è·‘é¦¬ç‡ˆé‚è¼¯
    document.getElementById('btnMqShow').addEventListener('click', () => {
        const txt = document.getElementById('mqTextInput').value;
        const col = document.getElementById('mqColorInput').value;
        const sz = document.getElementById('mqSizeInput').value;
        const spd = document.getElementById('mqSpeedInput').value;
        
        if(!txt) return;
        const el = document.getElementById('marqueeText');
        el.innerText = txt; el.style.color = col; el.style.fontSize = sz + 'px';
        el.style.animationDuration = (Math.max(10, txt.length*0.8) / spd) + 's';
        document.getElementById('topMarquee').style.display = 'block';
    });
    document.getElementById('btnMqHide').addEventListener('click', () => document.getElementById('topMarquee').style.display = 'none');
    document.getElementById('mqSizeInput').addEventListener('input', (e) => document.getElementById('marqueeText').style.fontSize = e.target.value+'px');

    // 5. è¨ˆæ™‚å™¨é‚è¼¯
    let timerInt = null;
    let timerSec = 0;
    function updateTimer() {
        document.getElementById('timerDisplay').innerText = `${String(Math.floor(timerSec/60)).padStart(2,'0')}:${String(timerSec%60).padStart(2,'0')}`;
    }
    document.querySelectorAll('.btn-timer-preset').forEach(b => b.addEventListener('click', (e) => {
        clearInterval(timerInt); timerInt = null;
        timerSec = e.target.dataset.min * 60;
        document.getElementById('timerInput').value = e.target.dataset.min;
        document.getElementById('btnTimerStart').innerText = "é–‹å§‹";
        updateTimer();
    }));
    document.getElementById('btnTimerStart').addEventListener('click', (e) => {
        resumeAudio();
        if(timerInt) { clearInterval(timerInt); timerInt=null; e.target.innerText="ç¹¼çºŒ"; }
        else {
            if(timerSec === 0) {
                const m = parseInt(document.getElementById('timerInput').value)||0;
                const s = parseInt(document.getElementById('timerInputSec').value)||0;
                timerSec = m*60+s;
            }
            if(timerSec>0) {
                e.target.innerText="æš«åœ";
                timerInt = setInterval(() => {
                    if(timerSec>0) { timerSec--; updateTimer(); }
                    else { 
                        clearInterval(timerInt); 
                        timerInt=null; 
                        e.target.innerText="é–‹å§‹"; 
                        playAlarmSound(); 
                        showToast("â° æ™‚é–“åˆ°ï¼ä»»å‹™çµæŸï¼", "ç¢ºèª"); 
                    }
                }, 1000);
            }
        }
    });
    document.getElementById('btnTimerReset').addEventListener('click', () => {
        clearInterval(timerInt); timerInt=null; timerSec=0; updateTimer();
        document.getElementById('btnTimerStart').innerText="é–‹å§‹";
        document.getElementById('timerInput').value=''; document.getElementById('timerInputSec').value='';
    });

    // 6. æŠ½ç±¤é‚è¼¯
    document.getElementById('btnLuckyDraw').addEventListener('click', () => {
        resumeAudio();
        const res = document.getElementById('luckyDrawResult');
        if(!data.roster.length) { res.innerText="ç„¡äºº"; return; }
        let c = 0;
        const t = setInterval(() => {
            res.innerText = data.roster[Math.floor(Math.random()*data.roster.length)].name;
            c++;
            if(c>20) { clearInterval(t); res.style.color='var(--danger)'; playSuccessSound(); }
            else res.style.color='var(--text-main)';
        }, 50);
    });

  </script>
</body>
</html>
