<!DOCTYPE html>
<html lang="zh-Hant-TW" data-theme="light" data-color-theme="guild">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ›¡ï¸ å†’éšªè€…å…¬æœƒ ğŸ›¡ï¸</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    /* ============================================================
       ğŸš¨ æ ¸å¿ƒè¦–åœ–æ§åˆ¶
       ============================================================ */
    .view { display: none !important; } 
    .view.show { display: block !important; animation: fadeIn .3s ease; }
    @keyframes fadeIn{ from{ opacity:0; transform:translateY(10px); } to{ opacity:1; transform:translateY(0); } }

    /* ============================================================
       ğŸ¨ è®Šæ•¸èˆ‡ä¸»é¡Œ
       ============================================================ */
    :root, html[data-color-theme='guild'] {
      --primary: #8B4513; --accent: #CD853F; --ring: rgba(139, 69, 19, 0.3);
      --bg: #F4E4BC; --card: #FDF5E6; 
      --tbl-head: #E6D2B5; --tbl-alt: #FAF0E6; --tbl-hover: #DEB887; --tbl-border: #D2B48C;
      --text-main: #3E2723; --text-light: #5D4037; --muted: #8D6E63;
      --success: #556B2F; --danger: #8B0000;
      --progress-bar: #32CD32; 
      --shadow: 3px 3px 0px rgba(93, 64, 55, 0.2);
      --radius: 8px; --seat: 56px; --seat-font: 16px; 
    }
    
    html[data-color-theme='guild'] body {
      font-family: "Courier New", Courier, "Microsoft JhengHei", monospace;
      background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%238b4513' fill-opacity='0.03' fill-rule='evenodd'/%3E%3C/svg%3E");
    }
    html[data-color-theme='guild'] .btn { border: 2px solid #5D4037; box-shadow: 2px 2px 0px #5D4037; }
    html[data-color-theme='guild'] .btn:active { box-shadow: none; transform: translate(2px, 2px); }
    html[data-color-theme='guild'] .card::before { content: ""; position: absolute; top: -5px; left: 50%; transform: translateX(-50%); width: 100px; height: 10px; background: rgba(0,0,0,0.1); border-radius: 50%; filter: blur(2px); z-index: -1; }

    html[data-theme='dark'] { --primary: #D2691E; --bg: #2C1810; --card: #3E2723; --text-main: #E6D2B5; --tbl-head: #4E342E; --tbl-alt: #3E2723; --tbl-hover: #5D4037; --tbl-border: #5D4037; }

    /* 2. ä¸»é¡Œï¼šè–èª• */
    html[data-color-theme='christmas'] { --primary: #d32f2f; --accent: #2e7d32; --ring: rgba(211, 47, 47, 0.3); --bg: #fffbf7; --card: rgba(255, 255, 255, 0.95); --tbl-head: #e8f5e9; --tbl-alt: #fff; --tbl-hover: #ffebee; --tbl-border: #c8e6c9; --text-main: #1e293b; --text-light: #475569; --muted:#64748b; --shadow:0 8px 30px rgba(211,47,47,.1); --radius:16px; --success:#2e7d32; --danger:#d32f2f; --progress-bar: #00e676; --seat: 56px; --seat-font: 16px; }
    html[data-color-theme='christmas'] body { background-image: url("data:image/svg+xml,%3Csvg width='200' height='200' viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M40 160 L60 120 L50 120 L70 90 L60 90 L80 60 L100 90 L90 90 L110 120 L100 120 L120 160 Z' fill='%232e7d32' opacity='0.15'/%3E%3Crect x='75' y='160' width='10' height='20' fill='%23795548' opacity='0.15'/%3E%3C!-- é›ªäºº --%3E%3Ccircle cx='150' cy='150' r='25' fill='%23b0bec5' opacity='0.15'/%3E%3Ccircle cx='150' cy='110' r='18' fill='%23b0bec5' opacity='0.15'/%3E%3C/svg%3E"); }
    html[data-color-theme='christmas'] .logo { background: linear-gradient(135deg, #d32f2f, #2e7d32); box-shadow: 0 4px 15px rgba(211, 47, 47, 0.4); }
    html[data-color-theme='christmas'][data-theme='dark'] { --primary: #ef5350; --accent: #66bb6a; --bg: #1b1b1b; --card: #2d2d2d; --text-main: #e2e8f0; --text-light: #94a3b8; --tbl-head: #2e3a2f; --tbl-alt: #1b1b1b; --tbl-hover: #3e2727; --tbl-border: #424242; }

    /* 3. ä¸»é¡Œï¼šè— & æ©˜ */
    html[data-color-theme='blue'] { --primary: #2563eb; --accent: #1d4ed8; --ring: rgba(37, 99, 235, 0.3); --bg: #eff6ff; --card: #fff; --tbl-head: #dbeafe; --tbl-alt: #f1f5f9; --tbl-hover: #eff6ff; --tbl-border: #bfdbfe; --text-main: #1e3a8a; --text-light: #3b82f6; --muted: #64748b; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); --radius: 8px; --seat: 56px; --seat-font: 16px; --progress-bar: #3b82f6; }
    html[data-color-theme='orange'] { --primary: #f97316; --accent: #ea580c; --ring: rgba(249, 115, 22, 0.3); --bg: #fff7ed; --card: #fff; --tbl-head: #ffedd5; --tbl-alt: #fafaf9; --tbl-hover: #fff7ed; --tbl-border: #fed7aa; --text-main: #7c2d12; --text-light: #ea580c; --muted: #9a3412; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); --radius: 8px; --seat: 56px; --seat-font: 16px; --progress-bar: #f97316; }
    
    html[data-color-theme='blue'][data-theme='dark'] { --primary: #60a5fa; --bg: #0f172a; --card: #1e293b; --text-main: #e2e8f0; --tbl-head: #1e293b; --tbl-alt: #0f172a; --tbl-hover: #334155; --tbl-border: #334155; }
    html[data-color-theme='orange'][data-theme='dark'] { --primary: #fb923c; --bg: #431407; --card: #2a0a04; --text-main: #ffedd5; --tbl-head: #431407; --tbl-alt: #2a0a04; --tbl-hover: #5e1c0a; --tbl-border: #7c2d12; }

    /* 4. æ–°å¢ä¸»é¡Œï¼šè­·çœ¼ç¶  */
    html[data-color-theme='green'] { --primary: #2e7d32; --accent: #4caf50; --ring: rgba(46, 125, 50, 0.3); --bg: #e8f5e9; --card: #fff; --tbl-head: #c8e6c9; --tbl-alt: #f1f8e9; --tbl-hover: #e8f5e9; --tbl-border: #a5d6a7; --text-main: #1b5e20; --text-light: #2e7d32; --muted: #388e3c; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); --radius: 8px; --seat: 56px; --seat-font: 16px; --progress-bar: #4caf50; }
    html[data-color-theme='green'][data-theme='dark'] { --primary: #66bb6a; --bg: #1b5e20; --card: #2e7d32; --text-main: #e8f5e9; --tbl-head: #1b5e20; --tbl-alt: #14421b; --tbl-hover: #388e3c; --tbl-border: #4caf50; }


    /* é€šç”¨ */
    *{ box-sizing:border-box; }
    html, body{ height:100%; margin:0; font-family:"Microsoft JhengHei", sans-serif; transition: background-color .3s, color .3s; background: var(--bg); color: var(--text-main); }
    .wrap{ max-width:1200px; margin:0 auto; padding:16px 12px 96px; display: flex; flex-direction: column; min-height: 100vh; }
    header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; flex-wrap: wrap; }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo{ width:48px; height:48px; border-radius:12px; display:grid; place-items:center; color:#fff; font-size:24px; background: var(--primary); box-shadow:var(--shadow); }
    h1{ margin:0; font-size:clamp(18px,2.2vw,24px); font-weight:800; }
    .muted{ color:var(--muted); font-size:12px; }
    
    .card{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; margin-bottom:16px; border:1px solid var(--tbl-border); position: relative; }
    .card h2{ margin:0 0 12px; font-size:18px; color: var(--primary); border-bottom: 1px solid var(--tbl-border); padding-bottom: 8px; display:flex; align-items:center; gap:8px;}
    .row{ display:grid; gap:12px; grid-template-columns:repeat(12, 1fr); }
    .field{ grid-column:span 12; display:flex; flex-direction:column; gap:4px; }
    @media (min-width:720px){ .sm-6{ grid-column:span 6; } .sm-5{ grid-column:span 5; } .sm-4{ grid-column:span 4; } .sm-3{ grid-column:span 3; } .sm-2{ grid-column:span 2; } }
    
    label{ font-weight:800; font-size:13px; color: var(--text-light); }
    input:not([type="checkbox"]), select, textarea { background:var(--bg); color: var(--text-main); border:2px solid var(--tbl-border); border-radius:4px; padding:10px; font-size:14px; outline:none; width: 100%; font-weight: bold; }
    input:focus, select:focus{ border-color:var(--primary); }
    input[type="checkbox"] { width: auto; display: inline-block; cursor: pointer; }

    .actions{ display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; }
    .btn{ border:2px solid var(--text-light); border-radius:6px; padding:8px 16px; font-weight:800; cursor:pointer; display:inline-flex; align-items:center; gap:6px; background:var(--primary); color:#fff; font-size:14px; }
    .btn.ghost{ background:var(--card); color:var(--text-light); border:2px dashed var(--tbl-border); }
    .btn.sm{ font-size:12px; padding:4px 10px; }
    .btn.chest { background: #DAA520; border-color: #B8860B; color: #fff; }
    .btn:hover{ filter:brightness(1.1); transform: translateY(-1px); } 
    .btn:active{ transform:translateY(2px); box-shadow:none; }
    .btn.warn { background: var(--danger); border-color: var(--danger); color: #fff; }

    .user-badge { font-size: 12px; font-weight: bold; color: var(--text-light); opacity: 0.8; background: var(--bg); padding: 4px 10px; border-radius: 20px; border: 1px solid var(--tbl-border); display: flex; align-items: center; gap: 6px; cursor: pointer; transition: all .2s; }
    .user-badge:hover { opacity: 1; transform: scale(1.05); border-color: var(--primary); }
    
    .table-wrap{ overflow:auto; border-radius:6px; border:2px solid var(--tbl-border); background:var(--card); }
    table{ width:100%; border-collapse:collapse; font-size:14px; }
    thead th{ position:sticky; top:0; background:var(--tbl-head); text-align:left; padding:10px; border-bottom:2px solid var(--tbl-border); white-space:nowrap; cursor:pointer; }
    tbody td{ padding:10px; border-bottom:1px solid var(--tbl-border); }
    tbody tr:hover{ background:var(--tbl-hover); }
    
    .grid{ display:grid; gap:10px; grid-template-columns:repeat(auto-fill, minmax(calc(var(--seat) + 70px), 1fr)); background:var(--bg); border:2px solid var(--tbl-border); border-radius:var(--radius); padding:10px; }
    .seatItem{ display:flex; align-items:center; gap:8px; }
    .seatItem.not-assigned { opacity: 0.35; filter: grayscale(80%); pointer-events: none; }
    .seat{ width:var(--seat); height:var(--seat); border-radius:12px; display:grid; place-items:center; font-weight:900; font-size:var(--seat-font); border:2px solid #5D4037; cursor:pointer; box-shadow:var(--shadow); transition:transform .06s; }
    .seat:active{ transform:scale(.95); }
    html[data-theme='dark'] .seat { border-color: var(--tbl-border); }
    .s0{ background:#d6d3d1; color:#44403c; } 
    .s1{ background:#fef9c3; color:#713f12; } 
    .s2{ background:#fdba74; color:#9a3412; } 
    .s3{ background:#86efac; color:#14532d; } 
    .seatName{ flex:1; font-weight:800; font-size:13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    progress { -webkit-appearance: none; width: 100%; height: 10px; border-radius: 4px; overflow: hidden; background: var(--bg); border: 1px solid var(--text-light); }
    progress::-webkit-progress-value { background-color: var(--progress-bar); }
    .pill{ display:inline-flex; gap:6px; align-items:center; padding:4px 8px; border-radius:4px; font-weight:800; }
    .p-gray{ background:#e2e8f0; color:#475569; } .p-yellow{ background:#fefce8; color:#854d0e; }
    .p-orange{ background:#fff7ed; color:#9a3412; } .p-green{ background:#f0fdf4; color:#166534; }

    .custom-tooltip { position: fixed; background: #3E2723; color: #FDF5E6; padding: 10px 14px; border-radius: 6px; font-size: 18px; font-weight: 900; pointer-events: none; z-index: 10002; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.5); border: 2px solid #CD853F; font-family: "Courier New", monospace; line-height: 1.5; white-space: pre-line; }
    .custom-tooltip.show { display: block; animation: fadeIn .1s ease-out; }

    #statusPicker { display: none; position: absolute; background: var(--card); border: 3px solid var(--primary); border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); padding: 10px; z-index: 10000; width: 160px; flex-direction: column; gap: 8px; }
    #statusPicker.show { display: flex; }
    .status-option-btn { border: 1px solid rgba(0,0,0,0.1); border-radius: 6px; padding: 12px; text-align: left; font-weight: 900; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 15px; color: #3e2723; }
    .sp-1 { background: #fef9c3; color: #713f12; } .sp-2 { background: #fdba74; color: #9a3412; } .sp-3 { background: #86efac; color: #14532d; }

    .numpad-container { display: none; position: absolute; top: 100%; right: 0; width: 300px; z-index: 100; background: var(--card); border: 2px solid var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.3); border-radius: 8px; padding: 16px; padding-top: 36px; margin-top: 8px; }
    .numpad-container.show { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    .numpad-close { position: absolute; top: 2px; right: 4px; background: none; border: none; color: var(--danger); font-size: 24px; cursor: pointer; transition: transform 0.2s; }
    .numpad-close:hover { transform: scale(1.2); }
    .num-key { padding: 12px 0; font-size: 20px; font-weight: bold; background: var(--bg); border: 1px solid var(--tbl-border); cursor: pointer; border-radius: 6px; color: var(--text-main); font-family: monospace; }
    .num-key.action-key { background: var(--tbl-head); color: var(--primary); }

    #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 20000; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 20px; }
    #loginBox { background: var(--card); padding: 40px; border-radius: 16px; box-shadow: var(--shadow); text-align: center; border: 3px double var(--primary); max-width: 90%; width: 400px; }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: center; }
    .modal-overlay.show { display: flex; }
    .modal-content { background: var(--card); padding: 20px; border-radius: var(--radius); width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; border: 3px double var(--primary); position: relative; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; border-bottom: 2px dashed var(--primary); padding-bottom: 10px; }
    .modal-footer { display: flex; justify-content: flex-end; gap: 8px; margin-top: 16px; }
    .modal-close-btn { background: var(--danger); color: #fff; border: 2px solid #8B0000; width: 32px; height: 32px; border-radius: 50%; font-size: 20px; line-height: 1; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); transition: transform 0.2s; }
    .modal-close-btn:hover { transform: scale(1.1) rotate(90deg); }

    .theme-options { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 8px; }
    .theme-option { width: 40px; height: 40px; border-radius: 8px; border: 2px solid var(--tbl-border); cursor: pointer; transition: transform .1s, border-color .1s; }
    .theme-option:hover { transform: scale(1.1); }
    .theme-option.active { border-color: var(--primary); box-shadow: 0 0 0 3px var(--ring); }
    /* Colors */
    .theme-option[data-theme="guild"] { background: linear-gradient(135deg, #8B4513, #CD853F); }
    .theme-option[data-theme="christmas"] { background: linear-gradient(135deg, #d32f2f, #2e7d32); }
    .theme-option[data-theme="blue"] { background: linear-gradient(135deg, #2563eb, #1d4ed8); }
    .theme-option[data-theme="orange"] { background: linear-gradient(135deg, #f97316, #ea580c); }
    .theme-option[data-theme="green"] { background: linear-gradient(135deg, #2e7d32, #66bb6a); }
    
    .dark-mode-toggle { display: flex; align-items: center; justify-content: space-between; background-color: var(--bg); padding: 12px; border-radius: 8px; border: 2px solid var(--tbl-border); margin-top: 20px; }
    .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--primary); }
    input:checked + .slider:before { transform: translateX(22px); }

    .accordion-item { border: 1px solid var(--tbl-border); border-radius: 6px; margin-bottom: 8px; overflow: hidden; background: var(--bg); }
    .accordion-header { padding: 12px; background: var(--tbl-head); font-weight: bold; cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none; transition: background .2s; }
    .accordion-header:hover { background: var(--tbl-hover); }
    .accordion-body { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; background: var(--card); }
    .accordion-item.active .accordion-body { max-height: 500px; overflow-y: auto; border-top: 1px solid var(--tbl-border); }
    .accordion-item.active .accordion-header { color: var(--primary); }
    .task-list { padding: 8px; display: flex; flex-wrap: wrap; gap: 6px; }
    .task-tag { display: inline-flex; align-items: center; background: var(--bg); border: 1px solid var(--tbl-border); padding: 6px 10px; border-radius: 20px; font-size: 13px; font-weight: bold; }
    .task-tag i { margin-left: 6px; cursor: pointer; color: var(--danger); opacity: 0.6; }
    .task-tag i:hover { opacity: 1; }

    .roster-tabs { display: flex; gap: 4px; margin-bottom: 0; }
    .tab-btn { flex: 1; padding: 12px; border: none; background: transparent; font-weight: 800; cursor: pointer; color: var(--text-light); border-radius: 8px 8px 0 0; border-bottom: 3px solid transparent; transition: all .2s; }
    .tab-btn:hover { background: var(--tbl-hover); }
    .tab-btn.active { background: var(--card); color: var(--primary); border-bottom-color: var(--primary); }
    .roster-content { display: none; background: var(--card); padding: 16px; border-radius: 0 0 8px 8px; border: 1px solid var(--tbl-border); border-top: none; }
    .roster-content.show { display: block; }
    .roster-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 8px; max-height: 50vh; overflow-y: auto; }
    .roster-item, .teacher-item { display: flex; align-items: center; gap: 8px; padding: 4px; border-bottom: 1px dashed var(--tbl-border); }
    .roster-no-input { flex: 0 0 60px; min-width: 0; }
    .roster-name-input, .teacher-name-input { flex: 1; min-width: 0; }

    .student-status-list { list-style: none; padding: 0; }
    .student-status-list li { padding: 8px; border-bottom: 1px dashed var(--tbl-border); display: flex; justify-content: space-between; cursor: pointer; }
    .student-status-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(210px, 1fr)); gap: 12px; align-items: start; }
    .student-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .student-card-header h2 { margin: 0; font-size: 18px; font-weight: bold;}
    .batch-export-checkbox { width: 18px !important; height: 18px !important; margin-right: 8px; accent-color: var(--primary); display: none !important; }
    .batch-mode .batch-export-checkbox { display: inline-block !important; }

    .assign-student-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 8px; margin-bottom: 12px; max-height: 400px; overflow-y: auto; }
    .assign-student-item { display: flex; align-items: center; gap: 8px; padding: 8px; border: 1px solid var(--tbl-border); border-radius: 6px; cursor: pointer; background: var(--bg); transition: background .2s; }
    .assign-student-item:hover { background: var(--tbl-hover); }

    /* New Footer Style */
    .app-footer { text-align: center; padding: 20px; color: var(--muted); font-size: 12px; font-weight: bold; margin-top: auto; border-top: 1px dashed var(--tbl-border); width: 100%; }

    /* ============================================================
       ğŸš¨ å„ªåŒ–ï¼šæ–°ç‰ˆå·¥å…·ç®±æ¨£å¼ (æ‡¸æµ®é¸å–® + ç¨ç«‹è¦–çª—)
       ============================================================ */
    .toolbox-container { position: fixed; bottom: 30px; right: 30px; z-index: 5000; display: flex; flex-direction: column; align-items: flex-end; gap: 12px; }
    
    /* ä¸»é–‹é—œæŒ‰éˆ• */
    .toolbox-toggle { width: 64px; height: 64px; border-radius: 50%; background: var(--primary); color: #fff; font-size: 28px; display: grid; place-items: center; cursor: pointer; box-shadow: 0 6px 16px rgba(0,0,0,0.3); border: 3px solid #fff; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 5002; }
    .toolbox-toggle:hover { transform: scale(1.1); }
    .toolbox-toggle.active { transform: rotate(45deg); background: var(--danger); border-color: #ffcccc; }

    /* æ‡¸æµ®é¸å–® (Speed Dial) */
    .toolbox-menu { display: flex; flex-direction: column; gap: 10px; align-items: center; margin-bottom: 5px; opacity: 0; visibility: hidden; transform: translateY(20px); transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: none; }
    .toolbox-menu.show { opacity: 1; visibility: visible; transform: translateY(0); pointer-events: auto; }
    
    .fab-btn { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--tbl-border); background: var(--card); color: var(--primary); display: grid; place-items: center; font-size: 20px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: transform 0.2s; position: relative; }
    .fab-btn:hover { transform: scale(1.15); color: #fff; background: var(--primary); border-color: #fff; }
    .fab-btn::after { content: attr(title); position: absolute; right: 60px; background: var(--text-main); color: #fff; padding: 4px 8px; border-radius: 6px; font-size: 12px; white-space: nowrap; opacity: 0; transition: opacity 0.2s; pointer-events: none; font-weight: bold; }
    .fab-btn:hover::after { opacity: 1; }

    /* ç¨ç«‹å·¥å…·è¦–çª— (Pop-up Panels) */
    .tool-window { position: absolute; bottom: 85px; right: 80px; width: 300px; background: var(--card); border: 3px solid var(--primary); border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.4); display: none; flex-direction: column; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 5001; }
    .tool-window.show { display: flex; }
    @keyframes popIn { from { opacity: 0; transform: scale(0.8) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
    
    .tool-header { background: var(--primary); color: #fff; padding: 10px 14px; border-radius: 8px 8px 0 0; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
    .tool-close { background: none; border: none; color: #fff; font-size: 20px; cursor: pointer; opacity: 0.8; transition: opacity 0.2s; line-height: 1; }
    .tool-close:hover { opacity: 1; transform: scale(1.2); }
    .tool-body { padding: 16px; display: flex; flex-direction: column; gap: 12px; }

    .tb-clock { font-family: monospace; font-size: 32px; font-weight: bold; text-align: center; color: var(--primary); letter-spacing: 2px; text-shadow: 1px 1px 0px var(--tbl-head); }
    .timer-controls { display: flex; gap: 8px; align-items: center; }
    #timerDisplay { font-family: monospace; font-size: 28px; font-weight: bold; flex: 1; text-align: center; color: var(--text-main); }
    #luckyDrawResult { font-size: 24px; font-weight: 900; text-align: center; color: var(--danger); min-height: 60px; display: grid; place-items: center; margin-bottom: 4px; border: 2px dashed var(--accent); border-radius: 8px; background: var(--bg); }
    
    .tb-control-row { display: flex; gap: 8px; align-items: center; }
    .timer-presets { display: flex; gap: 6px; }
    .timer-presets button { flex: 1; padding: 6px 0; justify-content: center; font-size: 13px; }

    /* ============================================================
       ğŸš¨ æ–°å¢ï¼šåˆªé™¤é¸é …æ¨¡æ…‹è¦–çª—å°ˆç”¨æ¨£å¼
       ============================================================ */
    .delete-choice-card {
        text-align: center;
        display: flex;
        flex-direction: column;
        gap: 16px;
    }
    .delete-choice-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    .btn-archive {
        background: #607d8b; /* ç°è—è‰²ä»£è¡¨å°å­˜/å€‰åº« */
        border-color: #455a64;
        color: #fff;
    }
    .btn-destroy {
        background: #c62828; /* æ·±ç´…è‰²ä»£è¡¨éŠ·æ¯€ */
        border-color: #b71c1c;
        color: #fff;
    }
    .delete-desc {
        font-size: 14px;
        color: var(--muted);
        line-height: 1.5;
        background: var(--bg);
        padding: 10px;
        border-radius: 6px;
        border: 1px dashed var(--tbl-border);
    }

    /* ============================================================
       ğŸš¨ æ–°å¢ï¼šè·‘é¦¬ç‡ˆæ¨£å¼
       ============================================================ */
    .marquee-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background: rgba(0, 0, 0, 0.85); /* åŠé€æ˜æ·±è‰²èƒŒæ™¯ */
        overflow: hidden;
        z-index: 9999;
        padding: 8px 0;
        pointer-events: none; /* è®“é»æ“Šç©¿é€ */
        border-bottom: 2px solid var(--primary);
        box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    .marquee-content {
        display: inline-block;
        white-space: nowrap;
        font-weight: 900;
        padding-left: 100%; /* å¾è¢å¹•å³å´å¤–é–‹å§‹ */
        animation: marquee-anim linear infinite; /* JS æ§åˆ¶ duration */
        font-family: "Microsoft JhengHei", monospace;
        text-shadow: 2px 2px 0px #000;
    }
    @keyframes marquee-anim {
        0% { transform: translateX(0); }
        100% { transform: translateX(-100%); }
    }

    /* ============================================================
       ğŸš¨ æ–°å¢ï¼šToast èˆ‡ Canvas
       ============================================================ */
    #confettiCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
    
    .toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 6000; display: flex; flex-direction: column; gap: 10px; align-items: center; }
    .toast-msg { background: #333; color: #fff; padding: 12px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); display: flex; align-items: center; gap: 16px; animation: slideUpFade 0.3s ease-out; font-weight: bold; min-width: 300px; justify-content: space-between; }
    .toast-msg button { background: transparent; border: 1px solid #aaa; color: #fff; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; transition: all 0.2s; }
    .toast-msg button:hover { background: #fff; color: #333; }
    @keyframes slideUpFade { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    /* ============================================================
       ğŸš¨ æ–°å¢ï¼šé»åç³»çµ±å°ˆç”¨æ¨£å¼
       ============================================================ */
    .att-card { display: flex; align-items: center; gap: 12px; padding: 12px; border-bottom: 1px dashed var(--tbl-border); background: var(--bg); border-radius: 6px; margin-bottom: 6px; transition: background .2s; }
    .att-card:hover { background: var(--tbl-hover); }
    .att-no { width: 32px; height: 32px; display: grid; place-items: center; background: var(--card); border-radius: 50%; font-weight: bold; font-size: 14px; border: 2px solid var(--tbl-border); }
    .att-name { flex: 1; font-weight: bold; font-size: 16px; }
    .att-status-group { display: flex; gap: 4px; }
    .att-btn { border: 2px solid transparent; border-radius: 20px; padding: 4px 12px; font-size: 13px; font-weight: bold; cursor: pointer; opacity: 0.6; transition: all .2s; background: var(--card); color: var(--text-light); }
    .att-btn:hover { opacity: 0.9; transform: scale(1.05); }
    .att-btn.active { opacity: 1; transform: scale(1.1); box-shadow: 0 2px 5px rgba(0,0,0,0.15); }
    
    /* ç‹€æ…‹é¡è‰²å®šç¾© */
    .att-btn[data-status="0"].active { background: #dcfce7; color: #166534; border-color: #166534; } /* å‡ºå¸­ */
    .att-btn[data-status="1"].active { background: #fef9c3; color: #854d0e; border-color: #854d0e; } /* é²åˆ° */
    .att-btn[data-status="2"].active { background: #dbeafe; color: #1e40af; border-color: #1e40af; } /* æ—©é€€ */
    .att-btn[data-status="3"].active { background: #fee2e2; color: #b91c1c; border-color: #b91c1c; } /* ç—…å‡ */
    .att-btn[data-status="4"].active { background: #f3e8ff; color: #6b21a8; border-color: #6b21a8; } /* å…¬å‡ */
    /* ğŸŒŸ æ–°å¢ï¼šäº‹å‡æ¨£å¼ */
    .att-btn[data-status="5"].active { background: #f3f4f6; color: #4b5563; border-color: #4b5563; } /* äº‹å‡ (ç°è‰²) */

    .att-note { font-size: 12px; color: var(--primary); margin-left: 8px; font-weight: normal; background: rgba(255,255,255,0.5); padding: 2px 6px; border-radius: 4px; display: inline-block; }
    .att-stats-bar { display: flex; gap: 8px; margin-bottom: 16px; background: var(--card); padding: 12px; border-radius: 8px; border: 2px solid var(--tbl-border); flex-wrap: wrap; justify-content: space-around; }
    .att-stat-item { display: flex; flex-direction: column; align-items: center; }
    .att-stat-val { font-size: 20px; font-weight: 900; }
    .att-stat-label { font-size: 12px; color: var(--muted); }
/* ============================================================
   ğŸš¨ æ–°å¢ï¼šçœ‹æ¿é›™æ¬„ä½ˆå±€ (å·¦å´å¿«æ·æ¬„ + å³å´å…§å®¹)
   ============================================================ */
.dashboard-layout {
  display: flex;
  gap: 16px;
  align-items: flex-start; /* è®“å…©é‚Šé«˜åº¦ç¨ç«‹ */
}

/* å·¦å´é‚Šæ¬„ */
.dash-sidebar {
  flex: 0 0 240px; /* å›ºå®šå¯¬åº¦ */
  position: sticky;
  top: 16px; /* æ²å‹•æ™‚æœƒå›ºå®šåœ¨ä¸Šæ–¹ */
  display: flex;
  flex-direction: column;
  gap: 16px;
}

/* å³å´ä¸»å…§å®¹ */
.dash-main {
  flex: 1; /* ä½”æ»¿å‰©é¤˜ç©ºé–“ */
  min-width: 0; /* é˜²æ­¢è¡¨æ ¼æ’ç ´ç‰ˆé¢ */
  display: flex;
  flex-direction: column;
  gap: 16px;
}

/* å¿«æ·ç¯©é¸å€å¡Šæ¨£å¼ */
.filter-group {
  background: var(--bg);
  border: 1px solid var(--tbl-border);
  padding: 10px;
  border-radius: 6px;
  margin-bottom: 8px;
}
.filter-group h4 {
  margin: 0 0 8px 0;
  font-size: 14px;
  color: var(--primary);
  border-bottom: 1px dashed var(--tbl-border);
  padding-bottom: 4px;
}

/* æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼ï¼šå°è¢å¹•è®Šå›ä¸Šä¸‹æ’åˆ— */
@media (max-width: 768px) {
  .dashboard-layout {
    flex-direction: column;
  }
  .dash-sidebar {
    width: 100%;
    position: static; /* å–æ¶ˆå›ºå®š */
    flex: none;
  }
}
    /* ============================================================
   ğŸš¨ æ–°å¢ï¼šå·¦å´æ¸…å–®èˆ‡å³å´è©³æƒ…å°ˆç”¨æ¨£å¼
   ============================================================ */
.side-list-container {
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-height: calc(100vh - 250px); /* è®“æ¸…å–®å¯ä»¥æ²å‹• */
    overflow-y: auto;
}

.side-item {
    background: var(--card);
    border: 2px solid var(--tbl-border);
    border-radius: 6px;
    padding: 12px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}

.side-item:hover {
    border-color: var(--primary);
    transform: translateX(4px);
}

.side-item.active {
    background: var(--primary);
    color: #fff;
    border-color: var(--text-main);
    box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
}

.side-item.active .muted {
    color: rgba(255,255,255,0.8) !important;
}

.side-item-title {
    font-weight: 900;
    font-size: 15px;
    margin-bottom: 4px;
}

.side-item-meta {
    font-size: 12px;
    display: flex;
    justify-content: space-between;
}

/* è®“å³å´è©³æƒ…å€å¡Šé è¨­éš±è—ï¼Œæœ‰é¸ä¸­æ™‚æ‰é¡¯ç¤º */
#dashDetailPanel {
    display: none; 
    background: var(--card);
    border: 2px solid var(--tbl-border);
    border-radius: 8px;
    padding: 16px;
    min-height: 400px;
}
#dashDetailPanel.show {
    display: block;
    animation: fadeIn 0.3s;
}

/* å³å´ç©ºç‹€æ…‹ */
#dashEmptyState {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 400px;
    color: var(--muted);
    border: 2px dashed var(--tbl-border);
    border-radius: 8px;
}

    /* ============================================================
   ğŸš¨ ä¿®æ­£èˆ‡å„ªåŒ–ï¼šé¢æ¿é¡¯ç¤ºèˆ‡ç¯©é¸å™¨
   ============================================================ */
/* è®“æ–°å§”è¨—é¢æ¿è¢« .show è§¸ç™¼æ™‚èƒ½é¡¯ç¤ºå‡ºä¾† */
#newQuestPanel.show {
    display: block !important;
    animation: fadeIn 0.3s;
}

/* å„ªåŒ–ç¯©é¸å™¨æ¨™ç±¤ï¼Œè®“å®ƒçœ‹èµ·ä¾†åƒå¥½æŒ‰çš„æŒ‰éˆ• */
.filter-tag {
    display: flex; 
    align-items: center; 
    justify-content: space-between;
    background: var(--card); 
    border: 1px solid var(--tbl-border);
    padding: 8px; 
    border-radius: 6px; 
    margin-bottom: 6px;
    font-size: 13px;
    font-weight: bold;
    cursor: pointer;
    transition: 0.2s;
}
.filter-tag:hover { border-color: var(--primary); color: var(--primary); }
    /* ğŸ”§ å„ªåŒ–ï¼šç·Šæ¹Šå‹ç¯©é¸å™¨é¢æ¿ */
.filter-panel {
    display: none;
    background: var(--card);
    border: 1px solid var(--tbl-border);
    border-top: none;
    padding: 10px;
    border-radius: 0 0 6px 6px;
    margin-bottom: 12px;
    animation: slideDown 0.2s ease-out;
}
.filter-panel.show { display: block; }

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* èª¿æ•´ç¯©é¸æŒ‰éˆ•æ¨£å¼ */
#btnToggleFilter {
    justify-content: space-between;
    border-radius: 6px;
    border: 1px solid var(--tbl-border);
}
#btnToggleFilter.active {
    background: var(--card);
    border-radius: 6px 6px 0 0;
    border-bottom-color: transparent;
}
    @media print { .no-print, .toolbox-container, .marquee-container, #confettiCanvas { display: none !important; } }
  </style>
</head>
<body>
  
  <div id="topMarquee" class="marquee-container" style="display:none;">
      <div id="marqueeText" class="marquee-content"></div>
  </div>

  <canvas id="confettiCanvas"></canvas>
  <div id="toastContainer" class="toast-container"></div>

  <!-- æ–°å¢ï¼šæ¯æ—¥é»åæé†’ Modal -->
  <div id="attendanceReminderModal" class="modal-overlay">
      <div class="modal-content" style="text-align: center; border: 4px double var(--danger);">
          <div class="modal-header" style="border-bottom: none; justify-content: center;">
              <h2 style="color: var(--danger); font-size: 24px;"><i class="bi bi-exclamation-diamond-fill"></i> ç·Šæ€¥ä»»å‹™</h2>
          </div>
          <p style="font-size: 18px; font-weight: bold; margin-bottom: 20px;">æœ¬æ—¥é»åå°šæœªå®Œæˆï¼<br><span style="font-size: 14px; color: var(--muted);">ç¢ºèªå†’éšªè€…å®‰å±æ˜¯å…¬æœƒé•·çš„é¦–è¦è·è²¬ã€‚</span></p>
          <button class="btn" id="btnGoToAttendance" style="width: 100%; justify-content: center; font-size: 18px;">å‰å¾€é»å</button>
          <button class="btn ghost sm" style="margin-top: 10px; width: 100%; border: none;" onclick="document.getElementById('attendanceReminderModal').classList.remove('show')">ç¨å¾Œå†èªª</button>
      </div>
  </div>

  <div id="loginOverlay">
      <div id="loginBox">
          <div class="logo" style="margin: 0 auto 20px; width: 80px; height: 80px; font-size: 40px;">ğŸ›¡ï¸</div>
          <h1>å†’éšªè€…å…¬æœƒç™»å…¥</h1>
          <p class="muted">è«‹å‡ºç¤ºæ‚¨çš„å…¬æœƒé•·è­‰ä»¶ (Google å¸³è™Ÿ)</p>
          <button id="btnLogin" class="btn" style="font-size: 18px; padding: 12px 24px; width: 100%; justify-content: center;">
              <i class="bi bi-google"></i> ä½¿ç”¨ Google ç™»å…¥
          </button>
      </div>
  </div>

  <div class="wrap no-print" style="display:none;" id="mainApp">
    <header>
      <div class="brand">
        <div class="logo"><i class="bi bi-shield-shaded"></i></div>
        <div>
          <h1>å†’éšªè€…å…¬æœƒ</h1>
          <div class="muted">ç‹€æ…‹å¾ªç’°ï¼šç°ï¼æœªæ¥å– â†’ é»ƒï¼å·²å›å ± â†’ æ©˜ï¼å†æŒ‘æˆ° â†’ ç¶ ï¼è¨ä¼æˆåŠŸ</div>
        </div>
      </div>
      <div class="actions">
        <span id="userEmailDisplay" class="user-badge" title="é»æ“ŠæŸ¥çœ‹åŸ·å‹™å®¤"><i class="bi bi-person-circle"></i> ...</span>
        
        <button class="btn ghost" id="btnRefreshData" title="æ‰‹å‹•é‡æ–°æ•´ç†"><i class="bi bi-arrow-clockwise"></i></button>

        <button class="btn ghost" id="btnNavDashboard"><i class="bi bi-columns-gap"></i> å§”è¨—çœ‹æ¿</button>
        <!-- ç§»é™¤ä¸»ç•«é¢é»åæŒ‰éˆ• -->
        <button class="btn ghost" id="btnNavStudentStatus"><i class="bi bi-backpack4"></i> å†’éšªè€…ç‹€æ…‹</button>
        <button class="btn ghost" id="btnNavRoster"><i class="bi bi-people"></i> å…¬æœƒåå†Š</button>
        <button class="btn ghost" id="btnOpenSettings" title="å¤–è§€è¨­å®š"><i class="bi bi-palette"></i></button>
        <div id="saveStatusIndicator"><i class="bi bi-hourglass"></i></div>
      </div>
    </header>

<section id="view-dashboard" class="view show">
  <div class="dashboard-layout">
    
<aside class="dash-sidebar">
      
      <button class="btn" style="width:100%; margin-bottom:12px; justify-content:center;" onclick="document.getElementById('newQuestPanel').classList.toggle('show')">
          <i class="bi bi-plus-circle-dotted"></i> ç™¼å¸ƒæ–°å§”è¨—
      </button>

      <div id="newQuestPanel" class="card" style="display:none; border:2px dashed var(--primary); padding:10px;">
        <h4 style="margin:0 0 8px 0; font-size:14px; color:var(--primary); border-bottom:1px dashed #ccc; padding-bottom:4px;">å¡«å¯«å§”è¨—å–®</h4>
        <div class="field">
            <label style="font-size:12px;">ç™¼å¸ƒå°å¸«</label>
            <select id="ipTeacherSelect" style="padding:6px;"></select>
            <input id="ipTeacherCustom" type="text" placeholder="è¼¸å…¥å§“å" style="display:none; margin-top:4px;">
        </div>
        <div class="field" style="margin-top:4px;">
            <label style="font-size:12px;">æ—¥æœŸ</label>
            <input id="ipDate" type="date" style="padding:6px;">
        </div>
        <div class="field" style="margin-top:4px;">
             <label style="font-size:12px;">å…§å®¹</label>
             <select id="selSubject" style="padding:6px; margin-bottom:4px;"><option value="">ğŸ“‚ ç§‘ç›®...</option></select>
             <select id="selPresetTask" style="padding:6px; margin-bottom:4px;"><option value="">ğŸ“œ å¸¸ç”¨...</option></select>
             <input id="ipTitle" type="text" placeholder="ä»»å‹™å…§å®¹..." style="padding:6px;" />
        </div>
        <div class="field" style="margin-top:4px;">
             <button class="btn ghost sm" id="btnOpenAssignModal">æŒ‡å®šå°è±¡...</button>
        </div>
        <button class="btn sm" id="btnCreate" style="margin-top:8px; width:100%; justify-content:center;">ç¢ºèªç™¼å¸ƒ</button>
      </div>

      <button id="btnToggleFilter" class="btn ghost" style="width:100%; margin-bottom:0;" onclick="this.classList.toggle('active'); document.getElementById('filterPanel').classList.toggle('show');">
          <span><i class="bi bi-funnel"></i> ç¯©é¸æ¢ä»¶</span>
          <i class="bi bi-chevron-down" style="font-size:12px;"></i>
      </button>

      <div id="filterPanel" class="filter-panel">
          <div style="margin-bottom: 8px;">
              <select id="teacherFilter" style="width:100%; padding:6px;"><option value="all">æ‰€æœ‰å°å¸«</option></select>
          </div>
          <div style="margin-bottom: 8px;">
              <select id="subjectFilter" style="width:100%; padding:6px;"><option value="all">æ‰€æœ‰ç§‘ç›®</option></select>
          </div>
          <button id="btnClearFilter" class="btn sm secondary" style="width:100%; justify-content:center;">
              <i class="bi bi-arrow-counterclockwise"></i> é‡ç½®
          </button>
      </div>

      <div id="sideAssignmentList" class="side-list-container" style="margin-top: 12px;"></div>
    </aside>

    <main class="dash-main">
      
      <div id="dashEmptyState">
          <i class="bi bi-arrow-left-circle" style="font-size: 48px; margin-bottom: 10px;"></i>
          <p style="font-weight:bold;">è«‹å¾å·¦å´é¸æ“‡ä¸€å¼µå§”è¨—</p>
          <p style="font-size:12px;">é»æ“Šã€Œç™¼å¸ƒæ–°å§”è¨—ã€å¯å»ºç«‹æ–°ä»»å‹™</p>
      </div>

      <div id="dashDetailPanel">
         <div class="assignment-bar" style="border-bottom: 2px solid var(--tbl-border); padding-bottom:12px; margin-bottom:12px;">
            <div class="title" id="dashDetailTitle" style="font-size:20px; font-weight:900; color:var(--primary);"></div>
            <div class="actions" style="margin-top:8px; align-items: center; gap: 10px; flex-wrap: wrap;">
                <button class="btn sm ghost" id="btnMarkAllYellow"><i class="bi bi-check-circle-fill"></i> å…¨å“¡å›å ±</button>
                <button class="btn sm ghost" id="btnMarkAllOrange"><i class="bi bi-exclamation-circle-fill"></i> å…¨å“¡å†æˆ°</button>
                <div class="legend" style="font-size:12px;">
                    <span><span class="dot s0"></span>æœªæ¥</span>
                    <span><span class="dot s1"></span>å·²å ±</span>
                    <span><span class="dot s2"></span>å†æˆ°</span>
                    <span><span class="dot s3"></span>æˆåŠŸ</span>
                </div>
                <button class="btn sm warn ghost" id="btnDeleteCurrent" style="margin-left:auto;"><i class="bi bi-trash3"></i> åˆªé™¤</button>
            </div>
        </div>
        <div id="dashGridContainer" class="grid"></div>
      </div>

    </main>
  </div>
</section>

    <!-- ğŸŒŸ æ–°å¢ï¼šé»åç³»çµ± View -->
    <section id="view-attendance" class="view">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; flex-wrap:wrap; gap:10px;">
                <h2><i class="bi bi-calendar-check"></i> æ¯æ—¥é»å</h2>
                <div style="display:flex; gap:8px;">
                    <input type="date" id="attDatePicker" style="width: auto;">
                    <button class="btn sm secondary" id="btnExportAttendance"><i class="bi bi-file-earmark-excel"></i> ä¸‹è¼‰å ±è¡¨</button>
                </div>
            </div>
            
            <!-- çµ±è¨ˆå„€è¡¨æ¿ -->
            <div class="att-stats-bar">
                <div class="att-stat-item"><div class="att-stat-val" style="color:var(--success)" id="statPresent">0</div><div class="att-stat-label">å‡ºå¸­</div></div>
                <div class="att-stat-item"><div class="att-stat-val" style="color:#854d0e" id="statLate">0</div><div class="att-stat-label">é²åˆ°</div></div>
                <div class="att-stat-item"><div class="att-stat-val" style="color:#1e40af" id="statEarly">0</div><div class="att-stat-label">æ—©é€€</div></div>
                <div class="att-stat-item"><div class="att-stat-val" style="color:var(--danger)" id="statSick">0</div><div class="att-stat-label">ç—…å‡</div></div>
                <!-- ğŸŒŸ æ–°å¢ï¼šäº‹å‡çµ±è¨ˆ -->
                <div class="att-stat-item"><div class="att-stat-val" style="color:#4b5563" id="statPersonal">0</div><div class="att-stat-label">äº‹å‡</div></div>
                <div class="att-stat-item"><div class="att-stat-val" style="color:#6b21a8" id="statOfficial">0</div><div class="att-stat-label">å…¬å‡</div></div>
            </div>

            <div id="attendanceList"></div>
            <div class="actions" style="justify-content: flex-end; margin-top: 16px;">
                <button class="btn" id="btnSaveAttendance"><i class="bi bi-check-lg"></i> ç¢ºèªé€å‡ºé»åå–®</button>
            </div>
        </div>
    </section>
    
    <!-- (å…¶ä»– View ä¿æŒä¸è®Š) -->
    <section id="view-detail" class="view">
      <!-- ... -->
      <div class="card">
        <div class="assignment-bar">
            <div class="title" id="detailTitle"></div>
            <div class="actions" style="align-items: center; gap: 20px; flex-wrap: wrap;">
                <button class="btn ghost" id="btnMarkAllYellow" style="background-color: #fef9c3; color: #713f12; border-color: #713f12;"><i class="bi bi-check-circle-fill"></i> å…¨å“¡å·²å›å ±</button>
                <button class="btn ghost" id="btnMarkAllOrange" style="background-color: #fdba74; color: #9a3412; border-color: #9a3412;"><i class="bi bi-exclamation-circle-fill"></i> å…¨å“¡å†æŒ‘æˆ°</button>
                <div class="field" style="min-width: 150px; margin-bottom: 0;">
                    <label for="rangeSize" style="margin-bottom: 4px;">åœ°åœ–ç¸®æ”¾</label>
                    <input type="range" id="rangeSize" min="40" max="100" value="56" style="padding: 0;">
                </div>
                <div class="legend">
                    <div><span class="dot s0"></span>æœªæ¥å–</div>
                    <div><span class="dot s1"></span>å·²å›å ±</div>
                    <div><span class="dot s2"></span>å†æŒ‘æˆ°</div>
                    <div><span class="dot s3"></span>è¨ä¼æˆåŠŸ</div>
                </div>
            </div>
        </div>
        <div id="gridContainer" class="grid"></div>
      </div>
    </section>

    <section id="view-roster" class="view">
        <div class="roster-tabs">
            <button id="tabBtnStudents" class="tab-btn active"><i class="bi bi-person-lines-fill"></i> å†’éšªè€…åå†Š</button>
            <button id="tabBtnTeachers" class="tab-btn"><i class="bi bi-person-badge"></i> å…¬æœƒé•·åå†Š</button>
        </div>
        <div id="roster-content-students" class="roster-content show">
            <div class="roster-grid" id="rosterEditor"></div>
            <div class="actions" style="margin-top:16px; justify-content:space-between; border-top:1px dashed var(--tbl-border); padding-top:12px;">
                <button class="btn sm secondary" id="btnAddStudentRow"><i class="bi bi-plus-lg"></i> æ–°å¢ä¸€è¡Œ</button>
                <div style="display:flex; gap:8px;">
                     <details style="display:inline-block;"><summary class="btn sm ghost" style="list-style:none; cursor:pointer;">ğŸ“œ è²¼ä¸Šåå–®</summary>
                        <div style="position:absolute; bottom:60px; right:20px; background:var(--card); padding:10px; border:2px solid var(--primary); border-radius:8px; width:250px; z-index:100;">
                            <textarea id="taRosterPaste" rows="10" style="width:100%;" placeholder="ä¸€è¡Œä¸€å€‹å§“å..."></textarea>
                            <button class="btn sm secondary" id="btnLoadFromPaste" style="width:100%; margin-top:8px;">è¼‰å…¥</button>
                        </div>
                     </details>
                     <button class="btn" id="btnApplyRoster"><i class="bi bi-check-circle"></i> å„²å­˜è®Šæ›´</button>
                </div>
            </div>
        </div>
        <div id="roster-content-teachers" class="roster-content">
            <div class="roster-grid" id="teacherEditor"></div>
            <div class="actions" style="margin-top:16px; justify-content:flex-end;">
                 <button class="btn" id="btnApplyTeachers"><i class="bi bi-check-circle"></i> å„²å­˜è®Šæ›´</button>
            </div>
        </div>
    </section>

    <section id="view-student-status" class="view">
      <!-- ... (å…§å®¹ä¿æŒä¸è®Š) ... -->
      <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center;">
              <h2 id="studentStatusHeaderTitle"><i class="bi bi-clipboard2-check"></i> å†’éšªè€…å¾…è¾¦æ¸…å–®</h2>
              <div class="actions">
                  <button class="btn sm secondary" id="btnToggleBatchMode"><i class="bi bi-check-square"></i> æ‰¹é‡åŒ¯å‡ºå·è»¸</button>
                  <button class="btn sm" id="btnBatchExport" style="display:none;"><i class="bi bi-printer"></i> åŒ¯å‡ºé¸å–é …ç›®</button>
              </div>
          </div>
          <div id="studentStatusContainer"></div>
      </div>
    </section>

    <footer class="app-footer">
        Created by HCSunny & Abby
    </footer>

  </div>

  <!-- è¨­å®š Modal -->
  <div id="settingsModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h2><i class="bi bi-gear-fill"></i> ç³»çµ±è¨­å®š</h2>
            <button class="modal-close-btn">&times;</button>
        </div>
        <div class="field" style="margin-bottom: 20px;">
            <label>é¢¨æ ¼ä¸»é¡Œ</label>
            <div class="theme-options" id="themeOptionsContainer">
                <div class="theme-option" data-theme="guild" title="æ¢éšªå…¬æœƒ (é è¨­)"></div>
                <div class="theme-option" data-theme="christmas" title="è–èª•ç¯€"></div>
                <div class="theme-option" data-theme="blue" title="çš‡å®¶è—"></div>
                <div class="theme-option" data-theme="orange" title="æ´»åŠ›æ©˜"></div>
                <div class="theme-option" data-theme="green" title="è­·çœ¼ç¶ "></div>
            </div>
        </div>
        <div class="field">
            <label>ç’°å¢ƒå…‰ç·š</label>
            <div class="dark-mode-toggle">
                <span style="font-weight: bold;"><i class="bi bi-moon-stars-fill"></i> å¤œé–“ç‡Ÿç«æ¨¡å¼</span>
                <label class="switch">
                    <input type="checkbox" id="darkModeToggle">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>
  </div>
  
  <!-- ä»»å‹™è¨­å®š Modal -->
  <div id="questSettingsModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 500px; height: 80vh; display: flex; flex-direction: column;">
        <div class="modal-header">
            <h2><i class="bi bi-journal-plus"></i> ç·¨è¼¯ä»»å‹™é¸å–®</h2>
            <button class="modal-close-btn">&times;</button>
        </div>
        <div id="questConfigList" style="flex: 1; overflow-y: auto; padding: 4px;"></div>
        <div style="background: var(--bg); padding: 12px; border-radius: 8px; border: 2px dashed var(--primary); margin-top: 10px;">
            <div style="display: flex; gap: 8px;">
                <input type="text" id="ipNewSubject" placeholder="è¼¸å…¥æ–°ç§‘ç›®åç¨±..." style="flex:1;">
                <button class="btn sm" id="btnAddSubject"><i class="bi bi-plus-lg"></i> æ–°å¢ç§‘ç›®</button>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn ghost modal-close-btn">å–æ¶ˆ</button>
            <button class="btn" id="btnSaveQuestSettings"><i class="bi bi-save"></i> å„²å­˜è¨­å®š</button>
        </div>
    </div>
  </div>
  
  <!-- å…¬æœƒé•·åŸ·å‹™å®¤ Modal -->
  <div id="adminProfileModal" class="modal-overlay">
      <div class="modal-content" style="max-width: 600px;">
          <div class="modal-header">
              <h2><i class="bi bi-person-badge-fill"></i> å…¬æœƒé•·åŸ·å‹™å®¤</h2>
              <div style="display: flex; align-items: center; gap: 8px;">
                <!-- ğŸŒŸ é»åæŒ‰éˆ•ç§»å‹•è‡³æ­¤ -->
                <button class="btn sm" id="btnAdminAttendance" title="é»åç°¿"><i class="bi bi-book"></i> é»åç°¿</button>
                <button class="modal-close-btn">&times;</button>
              </div>
          </div>
          <div style="background: var(--bg); padding: 16px; border-radius: 8px; border: 1px solid var(--tbl-border); margin-bottom: 20px;">
              <h3 style="margin:0 0 10px; font-size: 16px; color: var(--primary);">ğŸ“Š å†’éšªè€…æ¬ æ¬¾åå–® (æœªå›å ±/å†æŒ‘æˆ° > 5)</h3>
              <div id="adminDebtList" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
          </div>
          <div style="background: var(--bg); padding: 16px; border-radius: 8px; border: 1px solid var(--tbl-border); margin-bottom: 12px;">
               <h3 style="margin:0 0 10px; font-size: 16px; color: var(--primary);">ğŸ—„ï¸ æ­·å²å°å­˜ç´€éŒ„</h3>
               <p class="muted" style="margin-bottom:8px;">ä¸‹è¼‰æ‰€æœ‰å·²è¢«å°å­˜çš„å§”è¨—ä»»å‹™ (Excel è©¦ç®—è¡¨æ ¼å¼)ã€‚</p>
               <button class="btn sm secondary" id="btnDownloadArchive"><i class="bi bi-file-earmark-spreadsheet"></i> ä¸‹è¼‰å°å­˜ç´€éŒ„ (CSV)</button>
          </div>
          
          <!-- å±éšªå€åŸŸ -->
          <div style="background: #fff0f0; padding: 16px; border-radius: 8px; border: 2px dashed var(--danger); margin-top: 12px;">
                <h3 style="margin:0 0 10px; font-size: 16px; color: var(--danger);">âš ï¸ å±éšªç¦å€</h3>
                <div style="display:flex; flex-direction:column; gap:8px;">
                    <button class="btn ghost warn" id="btnClearAssignments" style="justify-content:center;"><i class="bi bi-fire"></i> éŠ·æ¯€æ‰€æœ‰å¥‘ç´„ (ä¿ç•™åå–®)</button>
                    <button class="btn warn" id="btnResetAll" style="justify-content:center;"><i class="bi bi-radioactive"></i> å¦é—¢æ–°å…¬æœƒ (å…¨éƒ¨é‡ç½®)</button>
                </div>
          </div>

          <div class="modal-footer" style="border-top: 2px dashed var(--tbl-border); padding-top: 16px; margin-top: 20px; justify-content: space-between;">
              <span class="muted" style="align-self: center;">å·¥ä½œè¾›è‹¦äº†ï¼</span>
              <button class="btn ghost" id="btnLogout" style="color: var(--danger); border-color: var(--danger);"><i class="bi bi-box-arrow-right"></i> ç™»å‡ºç³»çµ±</button>
          </div>
      </div>
  </div>

  <div id="assignStudentModal" class="modal-overlay">
      <div class="modal-content">
          <div class="modal-header">
              <h2><i class="bi bi-person-check-fill"></i> æŒ‡æ´¾ä»»å‹™å°è±¡</h2>
              <button class="modal-close-btn">&times;</button>
          </div>
          <div class="actions" style="margin-top: 0; margin-bottom: 12px;">
              <button class="btn sm" id="btnAssignSelectAll">å…¨é¸</button>
              <button class="btn sm ghost" id="btnAssignDeselectAll">å–æ¶ˆ</button>
          </div>
          <div id="assignStudentListContainer" class="assign-student-list"></div>
          <div class="modal-footer">
              <button class="btn ghost modal-close-btn">å–æ¶ˆ</button>
              <button class="btn" id="btnConfirmAssign">ç¢ºèªæŒ‡æ´¾</button>
          </div>
      </div>
  </div>

  <!-- åˆªé™¤/å°å­˜é¸æ“‡è¦–çª— -->
  <div id="deleteChoiceModal" class="modal-overlay">
      <div class="modal-content" style="max-width: 450px;">
          <div class="modal-header">
              <h2 style="color: var(--danger);"><i class="bi bi-exclamation-triangle-fill"></i> è™•ç½®å§”è¨—</h2>
              <button class="modal-close-btn">&times;</button>
          </div>
          <div class="delete-choice-card">
              <p style="font-size: 18px; font-weight: bold; margin: 0;">æ‚¨æ‰“ç®—å¦‚ä½•è™•ç†é€™å¼µå§”è¨—å–®ï¼Ÿ</p>
              <div id="deleteTargetTitle" style="color: var(--primary); font-weight: bold;"></div>
              
              <div class="delete-desc">
                  <strong>ğŸ“¦ å°å°è‡³å€‰åº« (å°å­˜)ï¼š</strong><br>
                  å§”è¨—å°‡å¾çœ‹æ¿ç§»é™¤ï¼Œä½†åœ¨ã€ŒåŸ·å‹™å®¤ã€å¯ä»¥ä¸‹è¼‰ç´€éŒ„ã€‚<br>
                  <span style="color: var(--success); font-size:12px;">(æ¨è–¦ï¼šæœŸæœ«å¯èƒ½éœ€è¦æŸ¥é–±æ™‚ä½¿ç”¨)</span>
              </div>

              <div class="delete-desc">
                  <strong>ğŸ”¥ éŠ·æ¯€å¥‘ç´„ (åˆªé™¤)ï¼š</strong><br>
                  è³‡æ–™å°‡æ°¸ä¹…æ¶ˆå¤±ï¼Œç„¡æ³•å¾©åŸã€‚<br>
                  <span style="color: var(--danger); font-size:12px;">(æ³¨æ„ï¼šç™¼éŒ¯æ–‡æˆ–æ¸¬è©¦æ™‚ä½¿ç”¨)</span>
              </div>

              <div class="delete-choice-actions">
                  <button class="btn btn-archive" id="btnConfirmArchive">
                      <i class="bi bi-archive-fill"></i> å°å°è‡³å€‰åº«
                  </button>
                  <button class="btn btn-destroy" id="btnConfirmDelete">
                      <i class="bi bi-fire"></i> éŠ·æ¯€å¥‘ç´„
                  </button>
              </div>
          </div>
      </div>
  </div>

  <div id="statusPicker">
      <button class="status-option-btn sp-1" data-status="1"><span class="dot s1"></span> å·²å›å ±</button>
      <button class="status-option-btn sp-2" data-status="2"><span class="dot s2"></span> å†æŒ‘æˆ°</button>
      <button class="status-option-btn sp-3" data-status="3"><span class="dot s3"></span> è¨ä¼æˆåŠŸ</button>
  </div>
  <div id="customTooltip" class="custom-tooltip"></div>

  <!-- å·¥å…·ç®±çµæ§‹ -->
  <div class="toolbox-container">
      
      <!-- 1. è·‘é¦¬ç‡ˆè¦–çª— -->
      <div id="panelMarquee" class="tool-window">
          <div class="tool-header">
              <span><i class="bi bi-broadcast"></i> å…¬å‘Šè·‘é¦¬ç‡ˆ</span>
              <button class="tool-close" onclick="closeToolWindow(this)">&times;</button>
          </div>
          <div class="tool-body">
              <input type="text" id="mqTextInput" placeholder="è¼¸å…¥å…¬å‘Šå…§å®¹..." style="margin-bottom:4px;">
              <div class="tb-control-row">
                  <label style="font-size:12px;">é¡è‰²</label>
                  <input type="color" id="mqColorInput" value="#FFD700" style="width:40px;height:36px;padding:0;">
                  <label style="font-size:12px; margin-left:8px;">å¤§å°</label>
                  <input type="range" id="mqSizeInput" min="16" max="60" value="24" style="flex:1">
              </div>
              <div class="tb-control-row">
                  <label style="font-size:12px;">é€Ÿåº¦</label>
                  <input type="range" id="mqSpeedInput" min="1" max="5" step="0.5" value="1" style="flex:1" title="è¶Šå³é‚Šè¶Šå¿«">
              </div>
              <div class="actions sm" style="justify-content: flex-end;">
                  <button class="btn sm" id="btnMqShow"><i class="bi bi-play-fill"></i> æ’­æ”¾</button>
                  <button class="btn sm warn" id="btnMqHide">é—œé–‰</button>
              </div>
          </div>
      </div>

      <!-- 2. è¨ˆæ™‚å™¨è¦–çª— -->
      <div id="panelTimer" class="tool-window">
          <div class="tool-header">
              <span><i class="bi bi-stopwatch"></i> è¨ˆæ™‚å™¨ & æ™‚é˜</span>
              <button class="tool-close" onclick="closeToolWindow(this)">&times;</button>
          </div>
          <div class="tool-body">
               <div id="tbClock" class="tb-clock" style="margin-bottom:8px;">00:00:00</div>
               <div class="timer-presets">
                  <button class="btn sm ghost btn-timer-preset" data-min="1">1åˆ†</button>
                  <button class="btn sm ghost btn-timer-preset" data-min="3">3åˆ†</button>
                  <button class="btn sm ghost btn-timer-preset" data-min="5">5åˆ†</button>
                  <button class="btn sm ghost btn-timer-preset" data-min="10">10åˆ†</button>
               </div>
               <div class="timer-controls">
                   <input type="number" id="timerInput" placeholder="åˆ†" style="width:60px; text-align:center;">
                   <span style="font-weight:bold">:</span>
                   <input type="number" id="timerInputSec" placeholder="ç§’" style="width:60px; text-align:center;">
                   <div id="timerDisplay">00:00</div>
               </div>
               <div class="actions sm" style="justify-content: flex-end;">
                   <button class="btn sm" id="btnTimerStart">é–‹å§‹</button>
                   <button class="btn sm warn" id="btnTimerReset">é‡ç½®</button>
               </div>
          </div>
      </div>

      <!-- 3. å¹¸é‹æŠ½ç±¤è¦–çª— -->
      <div id="panelDraw" class="tool-window">
          <div class="tool-header">
              <span><i class="bi bi-gift"></i> å¹¸é‹æŠ½ç±¤</span>
              <button class="tool-close" onclick="closeToolWindow(this)">&times;</button>
          </div>
          <div class="tool-body">
              <div id="luckyDrawResult">???</div>
              <button class="btn chest" id="btnLuckyDraw" style="width:100%">æŠ½å‡ºä¸€ä½å†’éšªè€…</button>
          </div>
      </div>

      <!-- æ‡¸æµ®é¸å–® -->
      <div class="toolbox-menu" id="toolboxMenu">
          <button class="fab-btn" id="btnOpenMarquee" title="è·‘é¦¬ç‡ˆ"><i class="bi bi-broadcast"></i></button>
          <button class="fab-btn" id="btnOpenTimer" title="è¨ˆæ™‚å™¨"><i class="bi bi-stopwatch"></i></button>
          <button class="fab-btn" id="btnOpenDraw" title="æŠ½ç±¤"><i class="bi bi-gift"></i></button>
      </div>

      <!-- ä¸»é–‹é—œæŒ‰éˆ• -->
      <div class="toolbox-toggle" id="btnToggleToolbox" title="ç™¾å¯¶ç®±">
          <i class="bi bi-box-seam-fill"></i>
      </div>
  </div>



  
  <script type="module">

    // ğŸ‡¹ğŸ‡¼ å°ˆç”¨ï¼šå–å¾—å°åŒ—æ™‚é–“çš„ YYYY-MM-DD å­—ä¸²
    function getTaipeiDateString() {
        const d = new Date();
        // å¼·åˆ¶è½‰æ›ç‚ºå°åŒ—æ™‚é–“
        return d.toLocaleDateString('zh-TW', {
            timeZone: 'Asia/Taipei',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        }).replace(/\//g, '-'); // å°‡ 2023/12/24 è½‰ç‚º 2023-12-24
    }

    // ğŸ‡¹ğŸ‡¼ å°ˆç”¨ï¼šå–å¾—å°åŒ—æ™‚é–“çš„ HH:mm å­—ä¸²
    function getTaipeiTimeString() {
        const d = new Date();
        return d.toLocaleTimeString('zh-TW', {
            timeZone: 'Asia/Taipei',
            hour12: false,
            hour: '2-digit',
            minute: '2-digit'
        });
    }
    
const firebaseConfig = {
  apiKey: "AIzaSyDlVtBkmo7pmrxQKXKUzQqIK8LIGW59Dyw",
  authDomain: "hwcheck-8888.firebaseapp.com",
  projectId: "hwcheck-8888",
  storageBucket: "hwcheck-8888.firebasestorage.app",
  messagingSenderId: "661808262560",
  appId: "1:661808262560:web:413e036d53b19ea3c108c5",
  measurementId: "G-FR4LMZ630Q"
};

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"; 
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    let app, db, auth;
    try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
    } catch (e) {
        console.error("Firebase Init Error", e);
        alert("Firebase è¨­å®šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ Configã€‚");
    }

    let currentUser = null;
    let data = { roster: [], assignments: [], teachers: [], questSettings: {}, attendance: {} }; 
    let lastDeletedItem = null; 
    
    const defaultData = {
        roster: [ { no: 1, name: "å‹‡è€…A" }, { no: 2, name: "æ³•å¸«B" }, { no: 3, name: "å¼“æ‰‹C" } ],
        assignments: [],
        teachers: ["å…¬æœƒé•·"],
        questSettings: {
            "åœ‹èª": ["åœ‹èªç¿’ä½œ", "åœ‹èªä½œæ¥­ç°¿", "åœˆè©", "ç”Ÿå­—ç°¿", "é–±è®€æ¸¬é©—", "åœ‹èªè€ƒå·"],
            "æ•¸å­¸": ["æ•¸å­¸ç¿’ä½œ", "æ•¸å­¸ä½œæ¥­ç°¿", "æ•¸å­¸è€ƒå·è¨‚æ­£", "æ•¸èª²ç·´ç¿’é¡Œ", "è¨ˆç®—ç·´ç¿’"],
            "ç”Ÿæ´»": ["ç”Ÿæ´»ç¿’ä½œ", "ç¹ªåœ–æ—¥è¨˜", "è§€å¯Ÿç´€éŒ„", "å­¸ç¿’å–®"],
            "è‹±æ–‡": ["è‹±æ–‡ç¿’ä½œ", "å­—æ¯ç·´ç¿’", "å–®å­—æŠ„å¯«", "è½åŠ›ç·´ç¿’"]
        },
        attendance: {} 
    };

    const loginOverlay = document.getElementById('loginOverlay');
    const mainApp = document.getElementById('mainApp');
    const btnLogin = document.getElementById('btnLogin');
    
    btnLogin.addEventListener('click', () => {
        const provider = new GoogleAuthProvider();
        signInWithPopup(auth, provider).catch(error => alert("ç™»å…¥å¤±æ•—ï¼š" + error.message));
    });

    document.getElementById('btnLogout').addEventListener('click', () => {
        if(confirm("ç¢ºå®šè¦ç™»å‡ºç³»çµ±å—ï¼Ÿ")) signOut(auth).then(() => window.location.reload());
    });

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            loginOverlay.style.display = 'none';
            mainApp.style.display = 'flex';
            mainApp.style.flexDirection = 'column';
            const userName = user.email.split('@')[0];
            document.getElementById('userEmailDisplay').innerHTML = `<i class="bi bi-person-circle"></i> ${userName}`;
            initApp();
        } else {
            loginOverlay.style.display = 'flex';
            mainApp.style.display = 'none';
        }
    });

async function loadDataFromFirebase() {
        if (!currentUser) return;
        updateSaveStatus('saving', 'è®€å–ä¸­...');
        
        try {
            const docRef = doc(db, "users", currentUser.uid, "data", "guildData");
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                data = docSnap.data();
                if(!data.questSettings) data.questSettings = JSON.parse(JSON.stringify(defaultData.questSettings));
                if(!data.attendance) data.attendance = {};
            } else {
                data = JSON.parse(JSON.stringify(defaultData));
                await setDoc(docRef, data);
            }
            onDataLoaded(); // æˆåŠŸæ™‚åŸ·è¡Œ
            updateSaveStatus('success', 'è®€å–å®Œæˆ');
            checkAttendanceReminder();
        } catch (error) {
            console.error("Load Error:", error);
            // ğŸš¨ ä¿®æ­£é‡é»ï¼šå¤±æ•—æ™‚ä¹Ÿè¦åŸ·è¡Œåˆå§‹åŒ–ï¼Œé€™æ¨£æŒ‰éˆ•æ‰æœƒæœ‰åæ‡‰ï¼
            console.log("åˆ‡æ›è‡³é›¢ç·š/æœ¬åœ°æ¨¡å¼");
            if(data.roster.length === 0) data = JSON.parse(JSON.stringify(defaultData)); // è‹¥ç„¡è³‡æ–™å‰‡è¼‰å…¥é è¨­
            onDataLoaded(); // å¼·åˆ¶åŸ·è¡Œåˆå§‹åŒ–
            updateSaveStatus('error', 'é€£ç·šå¤±æ•—(é›¢ç·šæ¨¡å¼)');
        }
    }

    const saveStatusIndicator = document.getElementById('saveStatusIndicator');
    let saveTimeout = null;

    async function saveDataToFirebase() {
        if (!currentUser) return;
        updateSaveStatus('saving');
        try {
            const docRef = doc(db, "users", currentUser.uid, "data", "guildData");
            await setDoc(docRef, data);
            updateSaveStatus('success');
        } catch (e) {
            console.error("Save Error:", e);
            updateSaveStatus('error', 'å„²å­˜å¤±æ•—');
        }
    }

    function triggerAutoSave() {
        clearTimeout(saveTimeout);
        updateSaveStatus('pending');
        saveTimeout = setTimeout(saveDataToFirebase, 1500); 
    }

    function updateSaveStatus(status, message = '') {
        let html = '';
        if (status === 'pending') html = `<span style="color:var(--primary)"><i class="bi bi-pencil"></i> ç´€éŒ„ä¸­...</span>`;
        else if (status === 'saving') html = `<span style="color:var(--text-light)"><i class="bi bi-cloud-upload"></i> åŒæ­¥ä¸­...</span>`;
        else if (status === 'success') html = `<span style="color:var(--success)"><i class="bi bi-cloud-check"></i> ${message || 'å·²åŒæ­¥'}</span>`;
        else html = `<span style="color:var(--danger)"><i class="bi bi-exclamation-triangle"></i> ${message}</span>`;
        saveStatusIndicator.innerHTML = html;
    }

    let currentAssignmentId = null;
    let sortState = { key: 'date', direction: 'desc' };
    let currentFilter = { teacher: 'all', subject: 'all', date: '' }; 
    let newAssignmentAssignedIndices = []; 
    let isBatchMode = false;
    let tempQuestSettings = {};
    
    // ğŸŒŸ é»åç³»çµ±è®Šæ•¸ï¼šé¿å…ç›´æ¥æ±™æŸ“ data.attendance
    let tempAttendanceData = []; 

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function playSuccessSound() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(1046.5, audioCtx.currentTime + 0.1);
        gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.start();
        oscillator.stop(audioCtx.currentTime + 0.5);
    }

    function playAlarmSound() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const now = audioCtx.currentTime;
        const notes = [523.25, 659.25, 783.99, 1046.50, 783.99, 659.25, 523.25];
        notes.forEach((freq, i) => {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(freq, now + i * 0.4);
            gain.gain.setValueAtTime(0.2, now + i * 0.4);
            gain.gain.exponentialRampToValueAtTime(0.01, now + i * 0.4 + 0.3);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(now + i * 0.4);
            osc.stop(now + i * 0.4 + 0.4);
        });
        
        setTimeout(() => {
             notes.forEach((freq, i) => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime + i * 0.4);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime + i * 0.4);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + i * 0.4 + 0.3);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(audioCtx.currentTime + i * 0.4);
                osc.stop(audioCtx.currentTime + i * 0.4 + 0.4);
            });
        }, 3000);
    }

    function playTickSound() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'square';
        osc.frequency.setValueAtTime(800, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.05);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.05);
    }

    function confetti() {
        const canvas = document.getElementById('confettiCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        const pieces = [];
        const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50', '#8bc34a', '#cddc39', '#ffeb3b', '#ffc107', '#ff9800', '#ff5722'];
        
        for (let i = 0; i < 300; i++) {
            pieces.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height - canvas.height,
                w: Math.random() * 10 + 5,
                h: Math.random() * 10 + 5,
                c: colors[Math.floor(Math.random() * colors.length)],
                v: Math.random() * 5 + 2,
                r: Math.random() * 360
            });
        }
        
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            let active = false;
            pieces.forEach(p => {
                p.y += p.v;
                p.r += p.v;
                if (p.y < canvas.height) active = true;
                
                ctx.save();
                ctx.translate(p.x + p.w / 2, p.y + p.h / 2);
                ctx.rotate(p.r * Math.PI / 180);
                ctx.fillStyle = p.c;
                ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
                ctx.restore();
            });
            if (active) requestAnimationFrame(draw);
            else ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        draw();
    }

    function showToast(message, actionText, actionCallback) {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = 'toast-msg';
        
        let html = `<span>${message}</span>`;
        if (actionText && actionCallback) {
            html += `<button id="toastActionBtn">${actionText}</button>`;
        }
        toast.innerHTML = html;
        container.appendChild(toast);
        
        let timeout;
        
        if (actionText && actionCallback) {
            const btn = toast.querySelector('#toastActionBtn');
            btn.addEventListener('click', () => {
                actionCallback();
                clearTimeout(timeout);
                toast.remove();
            });
            timeout = setTimeout(() => { toast.remove(); }, 5500); 
        } else {
            timeout = setTimeout(() => { toast.remove(); }, 3000);
        }
    }

    const views = document.querySelectorAll('.view');
    const statusPicker = document.getElementById('statusPicker');
    let statusPickerTarget = { index: null, assignmentId: null, source: null };
    const customTooltip = document.getElementById('customTooltip'); 

function initApp() {
        const savedTheme = localStorage.getItem('homeworkSystemTheme') || 'light';
        const savedColorTheme = localStorage.getItem('homeworkSystemColorTheme') || 'guild';
        document.documentElement.setAttribute('data-theme', savedTheme);
        document.documentElement.setAttribute('data-color-theme', savedColorTheme);
        document.getElementById('darkModeToggle').checked = savedTheme === 'dark';
        
        document.querySelectorAll('.theme-option').forEach(el => {
            el.classList.toggle('active', el.dataset.theme === savedColorTheme);
        });
        
        switchView('view-dashboard');
        loadDataFromFirebase();
        
        // ğŸ•’ ä¿®æ­£ï¼šæ™‚é˜æ”¹ç”¨å°åŒ—æ™‚å€
        setInterval(() => {
            const nowTime = new Date().toLocaleTimeString('zh-TW', { 
                timeZone: 'Asia/Taipei', 
                hour12: false 
            });
            document.getElementById('tbClock').innerText = nowTime;
        }, 1000);
        
        // ğŸ“… ä¿®æ­£ï¼šé»åæ—¥æœŸé è¨­ç‚ºå°åŒ—æ™‚é–“
        document.getElementById('attDatePicker').value = getTaipeiDateString();
    }

    function checkAttendanceReminder() {
        const today = new Date().toISOString().split('T')[0];
        if (!data.attendance[today]) {
            setTimeout(() => {
                document.getElementById('attendanceReminderModal').classList.add('show');
            }, 1000); 
        }
    }

    document.getElementById('btnGoToAttendance').addEventListener('click', () => {
        document.getElementById('attendanceReminderModal').classList.remove('show');
        // åˆ‡æ›ä¸¦è¼‰å…¥ç•¶æ—¥
        document.getElementById('adminProfileModal').classList.add('show');
    });

    function onDataLoaded() {
        populateTeacherDropdowns();
        updateSubjectDropdown();
        resetNewAssignmentState();
        renderAll();
    }

    function renderAll() {
        const currentView = document.querySelector('.view.show');
        const viewId = currentView ? currentView.id : 'view-dashboard';
        if (viewId === 'view-dashboard') renderDashboard();
        else if (viewId === 'view-detail') renderDetail(currentAssignmentId);
        else if (viewId === 'view-roster') { renderRosterEditor(); renderTeacherEditor(); }
        else if (viewId === 'view-student-status') renderStudentStatus();
        else if (viewId === 'view-attendance') initAttendanceView(); // ğŸŒŸ æ”¹ç”¨ init
    }

    function switchView(targetId) {
        views.forEach(view => {
             if(view.id === targetId) view.classList.add('show');
             else view.classList.remove('show');
        });
        if (targetId === 'view-dashboard') renderDashboard(); 
        if (targetId === 'view-roster') { renderRosterEditor(); renderTeacherEditor(); }
        if (targetId === 'view-student-status') renderStudentStatus();
        if (targetId === 'view-attendance') initAttendanceView(); // ğŸŒŸ æ”¹ç”¨ init
    }

    function populateTeacherDropdowns() {
        const teachers = data.teachers || [];
        const ipSelect = document.getElementById('ipTeacherSelect');
        const filter = document.getElementById('teacherFilter');
        ipSelect.innerHTML = teachers.map(t => `<option value="${t}">${t}</option>`).join('') + '<option value="custom">è‡ªè¡Œè¼¸å…¥...</option>';
        filter.innerHTML = '<option value="all">æ‰€æœ‰å…¬æœƒé•·</option>' + teachers.map(t => `<option value="${t}">${t}</option>`).join('');
        filter.value = currentFilter.teacher;

        if(ipSelect.value === 'custom') {
            document.getElementById('ipTeacherCustom').style.display = 'block';
        } else {
            document.getElementById('ipTeacherCustom').style.display = 'none';
        }
    }
    
        function resetNewAssignmentState() {
        document.getElementById('ipTitle').value = '';
        document.getElementById('selSubject').value = '';
        document.getElementById('selPresetTask').innerHTML = '<option value="">ğŸ“œ å¸¸ç”¨ä»»å‹™...</option>';
        
        // ğŸ“… ä¿®æ­£ï¼šç™¼å¸ƒæ—¥æœŸé è¨­ç‚ºå°åŒ—æ™‚é–“
        document.getElementById('ipDate').value = getTaipeiDateString();
        
        newAssignmentAssignedIndices = [];
        document.getElementById('assignStatusText').innerText = "å…¨é«”å†’éšªè€…";
        
        const ipSelect = document.getElementById('ipTeacherSelect');
        if(data.teachers && data.teachers.length > 0) {
            ipSelect.value = data.teachers[0];
            document.getElementById('ipTeacherCustom').style.display = 'none';
        } else {
            ipSelect.value = 'custom';
            document.getElementById('ipTeacherCustom').style.display = 'block';
        }
    }

    function updateSubjectDropdown() {
        const db = data.questSettings || defaultData.questSettings;
        const selSubject = document.getElementById('selSubject');
        const subjectFilter = document.getElementById('subjectFilter');

        selSubject.innerHTML = '<option value="">ğŸ“‚ ç§‘ç›®...</option>';
        subjectFilter.innerHTML = '<option value="all">ğŸ“š æ‰€æœ‰ç§‘ç›®</option>';
        if(db) {
            Object.keys(db).forEach(s => {
                selSubject.add(new Option(s, s));
                subjectFilter.add(new Option(s, s));
            });
        }
    }

function filterAssignments(assignments) {
        return assignments.filter(a => {
            if (a.archived) return false;
            const matchTeacher = currentFilter.teacher === 'all' || a.teacher === currentFilter.teacher;
            const matchSubject = currentFilter.subject === 'all' || 
                                 (a.subject ? a.subject === currentFilter.subject : a.title.includes(currentFilter.subject));
            // ğŸš¨ ä¿®æ­£ï¼šç§»é™¤ matchDate é‚è¼¯
            return matchTeacher && matchSubject;
        });
    }

// ğŸ¨ æ¸²æŸ“ä¸»çœ‹æ¿
    function renderDashboard() {
        const listContainer = document.getElementById('sideAssignmentList');
        const emptyState = document.getElementById('dashEmptyState');
        const detailPanel = document.getElementById('dashDetailPanel');

        let assignmentsToRender = filterAssignments([...data.assignments]);
        
        // æ›´æ–°å·¦å´æ•¸å­—
        const countEl = document.getElementById('dashTotalCount');
        if(countEl) countEl.innerText = assignmentsToRender.length;

        assignmentsToRender.sort((a, b) => {
            if (a.date < b.date) return 1;
            if (a.date > b.date) return -1;
            return 0;
        });

        listContainer.innerHTML = '';

        if (assignmentsToRender.length === 0) {
            listContainer.innerHTML = '<div style="text-align:center; padding:20px; color:var(--muted); font-size:13px;">æ²’æœ‰ç¬¦åˆçš„å§”è¨—</div>';
            emptyState.style.display = 'flex';
            detailPanel.classList.remove('show');
            return;
        }

        assignmentsToRender.forEach(a => {
            const el = document.createElement('div');
            el.className = 'side-item';
            if (currentAssignmentId === a.id) el.classList.add('active'); 
            
            // è¨ˆç®—é€²åº¦
            const indices = a.assignedIndices || 'all';
            const total = indices === 'all' ? data.roster.length : indices.length;
            const completed = (a.statuses || []).filter((s, i) => s === 3 && (indices === 'all' || indices.includes(i))).length;
            const progress = total > 0 ? Math.round((completed / total) * 100) : 0;

            let progressColor = 'var(--primary)';
            if(progress === 100) progressColor = 'var(--success)';

            el.innerHTML = `
                <div class="side-item-title">${a.title}</div>
                <div class="side-item-meta muted">
                    <span>${a.date}</span>
                    <span>${a.teacher}</span>
                </div>
                <div style="margin-top:6px; display:flex; align-items:center; gap:6px; font-size:12px;">
                    <div style="flex:1; height:6px; background:rgba(0,0,0,0.1); border-radius:3px; overflow:hidden;">
                        <div style="width:${progress}%; height:100%; background:${progressColor}; transition: width 0.5s;"></div>
                    </div>
                    <span style="min-width: 40px; text-align: right;">${completed}/${total}</span>
                </div>
            `;
            
            el.addEventListener('click', () => selectAssignment(a.id));
            listContainer.appendChild(el);
        });

        if (currentAssignmentId) {
             renderDashboardDetail(currentAssignmentId);
        } else {
             emptyState.style.display = 'flex';
             detailPanel.classList.remove('show');
        }
    }
    // ğŸ¯ é¸æ“‡å§”è¨— (åˆ‡æ›å³å´è©³æƒ…)
    function selectAssignment(id) {
        currentAssignmentId = id;
        renderDashboard(); // é‡ç¹ªå·¦å´ (æ›´æ–° active class)
        renderDashboardDetail(id); // é¡¯ç¤ºå³å´
    }

    // ğŸ“ æ¸²æŸ“å³å´è©³æƒ… (å–ä»£åŸæœ¬çš„ renderDetail)
    function renderDashboardDetail(id) {
        const a = data.assignments.find(x => x.id == id);
        if (!a) return;

        // åˆ‡æ›é¡¯ç¤ºç‹€æ…‹
        document.getElementById('dashEmptyState').style.display = 'none';
        const panel = document.getElementById('dashDetailPanel');
        panel.classList.add('show');

        // å¡«å¯«æ¨™é¡Œ
        document.getElementById('dashDetailTitle').innerHTML = 
            `<span class="badge" style="background:var(--primary); color:#fff; font-size:14px; padding:2px 8px; border-radius:4px;">${a.subject || 'ä¸€èˆ¬'}</span> ${a.title}`;

        // å¡«å¯«æ ¼å­
        const grid = document.getElementById('dashGridContainer');
        grid.innerHTML = '';
        const indices = a.assignedIndices || 'all';
        
        data.roster.forEach((s, i) => {
            const isAssigned = indices === 'all' || indices.includes(i);
            const status = (a.statuses || [])[i] || 0;
            const div = document.createElement('div');
            div.className = `seatItem ${!isAssigned ? 'not-assigned' : ''}`;
            
            // æ³¨æ„ï¼šé€™è£¡ç›´æ¥ç¶å®š click äº‹ä»¶ï¼Œä¸å†ç”¨å…¨åŸŸç›£è½ï¼Œé¿å…è¡çª
            div.innerHTML = `<div class="seat s${status}">${s.no}</div><div class="seatName">${s.name}</div>`;
            
            // æ ¼å­é»æ“Šé‚è¼¯
            if(isAssigned) {
                const seatBtn = div.querySelector('.seat');
                seatBtn.onclick = () => toggleStatus(id, i);
            }
            
            grid.appendChild(div);
        });
        
        // ç¶å®šåˆªé™¤æŒ‰éˆ•
        const btnDel = document.getElementById('btnDeleteCurrent');
        btnDel.onclick = () => {
            targetAssignmentIdToDelete = id;
            document.getElementById('deleteTargetTitle').innerText = a.title;
            document.getElementById('deleteChoiceModal').classList.add('show');
        };
    }

    // ğŸ”„ åˆ‡æ›ç‹€æ…‹å°å‡½å¼ (ç¨ç«‹å‡ºä¾†æ¯”è¼ƒä¹¾æ·¨)
    function toggleStatus(assignmentId, studentIndex) {
        const a = data.assignments.find(x => x.id == assignmentId);
        if(!a) return;
        
        let s = (a.statuses || [])[studentIndex] || 0;
        s = (s + 1) % 4;
        if(!a.statuses) a.statuses = Array(data.roster.length).fill(0);
        a.statuses[studentIndex] = s;
        
        if(s === 3) playSuccessSound(); // æ’­æ”¾éŸ³æ•ˆ
        
        // æª¢æŸ¥æ˜¯å¦å…¨éƒ¨å®Œæˆ
        const indices = a.assignedIndices || 'all';
        let allCompleted = true;
        for(let i=0; i<data.roster.length; i++) {
             if(indices === 'all' || indices.includes(i)) {
                 if(a.statuses[i] !== 3) allCompleted = false;
             }
        }
        if(allCompleted) confetti();

        triggerAutoSave();
        renderDashboardDetail(assignmentId); // åªæ›´æ–°å³å´
        
        // ç¨å¾®å»¶é²æ›´æ–°å·¦å´é€²åº¦æ¢ï¼Œé¿å…é »ç¹é–ƒçˆ
        setTimeout(() => {
             // æ‰¾åˆ°å·¦å´å°æ‡‰çš„é …ç›®æ›´æ–°é€²åº¦æ¢å³å¯ï¼Œä½†ç‚ºäº†ç°¡å–®ï¼Œæˆ‘å€‘é€™è£¡ä¸ç‰¹åˆ¥å„ªåŒ– DOMï¼Œç›´æ¥ä¿ç•™ç¾ç‹€
             // è‹¥è¦å®Œç¾ï¼Œå¯ä»¥åªæ›´æ–° DOMï¼Œä¸éé€™è£¡é‡æ–° renderDashboard ä»£åƒ¹ä¸å¤§
             renderDashboard();
        }, 500);
    }

    function checkCompletionAndCelebrate(assignmentId) {
        const a = data.assignments.find(i => i.id == assignmentId);
        if(!a) return;
        const indices = a.assignedIndices || 'all';
        const total = indices === 'all' ? data.roster.length : indices.length;
        const completed = a.statuses.filter((s, i) => s === 3 && (indices === 'all' || indices.includes(i))).length;
        
        if (total > 0 && completed === total) {
            confetti({
                particleCount: 150,
                spread: 70,
                origin: { y: 0.6 }
            });
            playAlarmSound(); 
        }
    }

    // ğŸŒŸ é»åç³»çµ±ï¼šè¼‰å…¥è³‡æ–™ (åªåœ¨åˆ‡æ›æ—¥æœŸæ™‚åŸ·è¡Œ)
    function initAttendanceView() {
        const dateInput = document.getElementById('attDatePicker');
        const selectedDate = dateInput.value;
        const btnSave = document.getElementById('btnSaveAttendance');
        
        if (data.attendance[selectedDate]) {
            tempAttendanceData = JSON.parse(JSON.stringify(data.attendance[selectedDate]));
            btnSave.innerHTML = `<i class="bi bi-arrow-repeat"></i> æ›´æ–°é»åç´€éŒ„`; // è‹¥å·²å­˜åœ¨æ”¹ç‚ºæ›´æ–°
        } else {
            tempAttendanceData = data.roster.map(() => ({ status: 0, note: '' }));
            btnSave.innerHTML = `<i class="bi bi-check-lg"></i> ç¢ºèªé€å‡ºé»åå–®`;
        }
        
        renderAttendanceUI();
    }

    // ğŸŒŸ é»åç³»çµ±ï¼šæ¸²æŸ“ UI (ä¸è®€å– DBï¼Œåªæ ¹æ“š tempAttendanceData)
    function renderAttendanceUI() {
        const listDiv = document.getElementById('attendanceList');
        
        // ğŸŒŸ æ›´æ–°çµ±è¨ˆï¼š0:å‡ºå¸­, 1:é²åˆ°, 2:æ—©é€€, 3:ç—…å‡, 4:å…¬å‡, 5:äº‹å‡
        const stats = [0,0,0,0,0,0]; 
        tempAttendanceData.forEach(d => { if(d.status >=0 && d.status <=5) stats[d.status]++; });
        document.getElementById('statPresent').innerText = stats[0];
        document.getElementById('statLate').innerText = stats[1];
        document.getElementById('statEarly').innerText = stats[2];
        document.getElementById('statSick').innerText = stats[3];
        document.getElementById('statOfficial').innerText = stats[4];
        document.getElementById('statPersonal').innerText = stats[5]; // ğŸŒŸ

        listDiv.innerHTML = '';
        data.roster.forEach((student, index) => {
            const record = tempAttendanceData[index];
            const div = document.createElement('div');
            div.className = 'att-card';
            
            let btnsHtml = '';
            // ğŸŒŸ æ–°å¢äº‹å‡æŒ‰éˆ•
            const statuses = [
                {id:0, label:'å‡ºå¸­'}, {id:1, label:'é²åˆ°'}, {id:2, label:'æ—©é€€'}, {id:3, label:'ç—…å‡'}, {id:5, label:'äº‹å‡'}, {id:4, label:'å…¬å‡'}
            ];
            
            statuses.forEach(s => {
                const isActive = record.status === s.id ? 'active' : '';
                btnsHtml += `<button class="att-btn ${isActive}" data-status="${s.id}" data-idx="${index}">${s.label}</button>`;
            });

            const noteHtml = record.note ? `<span class="att-note">${record.note}</span>` : '';

            div.innerHTML = `
                <div class="att-no">${student.no}</div>
                <div class="att-name">${student.name} ${noteHtml}</div>
                <div class="att-status-group" style="flex-wrap:wrap;">${btnsHtml}</div>
            `;
            listDiv.appendChild(div);
        });
    }

    // ğŸŒŸ é»åäº’å‹•äº‹ä»¶ (åªæ›´æ–° tempAttendanceData ä¸¦é‡ç¹ª)
    document.getElementById('attendanceList').addEventListener('click', (e) => {
        if(e.target.classList.contains('att-btn')) {
            const idx = parseInt(e.target.dataset.idx);
            const status = parseInt(e.target.dataset.status);
            
            // å¦‚æœæ˜¯æ—©é€€ï¼Œè©¢å•æ™‚é–“
            let note = tempAttendanceData[idx].note; // ä¿ç•™åŸå‚™è¨»
            if (status === 2) { 
                // ğŸ•’ å„ªåŒ–ï¼šé è¨­æ™‚é–“é¡¯ç¤ºç•¶ä¸‹å°åŒ—æ™‚é–“
                const defaultTime = getTaipeiTimeString();
                const time = prompt("è«‹è¼¸å…¥æ—©é€€æ™‚é–“ (ä¾‹å¦‚ 14:00)ï¼š", defaultTime);
                if (time) note = `æ—©é€€ ${time}`;
            } else {
                note = ''; // åˆ‡æ›åˆ°å…¶ä»–ç‹€æ…‹æ¸…ç©ºå‚™è¨»
            }

            tempAttendanceData[idx] = { status, note };
            renderAttendanceUI(); // âš¡ åªé‡ç¹ªï¼Œä¸é‡è®€
        }
    });

    // æ—¥æœŸæ”¹è®Š -> é‡æ–°è¼‰å…¥è³‡æ–™
    document.getElementById('attDatePicker').addEventListener('change', initAttendanceView);

    // å„²å­˜æŒ‰éˆ•
    document.getElementById('btnSaveAttendance').addEventListener('click', () => {
        const date = document.getElementById('attDatePicker').value;
        data.attendance[date] = tempAttendanceData;
        triggerAutoSave();
        alert(`å·²å„²å­˜ ${date} çš„é»åç´€éŒ„ï¼`);
        initAttendanceView(); // é‡æ–°æ•´ç†æŒ‰éˆ•ç‹€æ…‹
    });

  // ğŸŒŸ åŒ¯å‡ºé»åå ±è¡¨ (ä¿®æ­£ç‰ˆï¼šé²åˆ°æ—©é€€ç®—å…¥å‡ºå¸­)
    document.getElementById('btnExportAttendance').addEventListener('click', () => {
        let csvContent = "\uFEFF";
        const dates = Object.keys(data.attendance).sort();
        if (dates.length === 0) { alert("ç›®å‰æ²’æœ‰ä»»ä½•é»åç´€éŒ„ï¼"); return; }

        // æ¨™é¡Œåˆ—
        csvContent += "åº§è™Ÿ,å§“å,å‡ºå¸­ç¸½è¨ˆ(å«é²/æ—©),é²åˆ°æ¬¡æ•¸,æ—©é€€æ¬¡æ•¸,ç—…å‡ç¸½è¨ˆ,äº‹å‡ç¸½è¨ˆ,å…¬å‡ç¸½è¨ˆ,ç¼ºå¸­ç¸½è¨ˆ(å«å‡)," + dates.join(",") + "\n";
        
        // ç‹€æ…‹æ–‡å­—å°ç…§
        const statusMap = { 0:"âœ”ï¸", 1:"é²", 2:"æ—©", 3:"ç—…", 4:"å…¬", 5:"äº‹" };

        data.roster.forEach((student, idx) => {
            let row = `${student.no},${student.name}`;
            
            // çµ±è¨ˆæ­¸é›¶
            let counts = { 0:0, 1:0, 2:0, 3:0, 4:0, 5:0 };
            
            const dateStatuses = dates.map(d => {
                const record = data.attendance[d][idx];
                if (!record) return "-";
                
                // ç´¯è¨ˆå„ç‹€æ…‹
                if (counts[record.status] !== undefined) counts[record.status]++;
                
                let cell = statusMap[record.status] || "?";
                if (record.status === 2 && record.note) cell += `(${record.note})`;
                return cell;
            });

            // ğŸŒŸ ä¿®æ­£é‡é»ï¼šå¯¦éš›å‡ºå¸­ = æº–æ™‚(0) + é²åˆ°(1) + æ—©é€€(2)
            const realPresentCount = counts[0] + counts[1] + counts[2];

            // è¨ˆç®—ç¸½ç¼ºå¸­ (ç—…å‡+äº‹å‡+å…¬å‡)
            const totalAbsent = counts[3] + counts[4] + counts[5];

            // å¡«å…¥ä¿®æ­£å¾Œçš„çµ±è¨ˆæ•¸æ“š (ç¬¬ä¸€æ¬„ä½¿ç”¨ realPresentCount)
            row += `,${realPresentCount},${counts[1]},${counts[2]},${counts[3]},${counts[5]},${counts[4]},${totalAbsent},` + dateStatuses.join(",");
            csvContent += row + "\n";
        });

        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", `å…¬æœƒé»åå ±è¡¨_${new Date().toISOString().slice(0,10)}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    });

    // ğŸŒŸ æ–°å¢ï¼šå…¬æœƒé•·åŸ·å‹™å®¤é–‹å•Ÿé»åæŒ‰éˆ•
    document.getElementById('btnAdminAttendance').addEventListener('click', () => {
        document.getElementById('adminProfileModal').classList.remove('show');
        switchView('view-attendance');
    });

    // --- (å…¶ä»–åŸæœ‰ç¨‹å¼ç¢¼) ---
    function renderStudentStatus() {
        const container = document.getElementById('studentStatusContainer');
        const headerTitle = document.getElementById('studentStatusHeaderTitle');
        const btnToggle = document.getElementById('btnToggleBatchMode');
        
        container.innerHTML = '';
        if(isBatchMode) { 
            container.classList.add('batch-mode'); 
            btnToggle.classList.add('warn'); 
            btnToggle.innerHTML = `<i class="bi bi-x-square"></i> å–æ¶ˆæ‰¹é‡æ¨¡å¼`;
            document.getElementById('btnBatchExport').style.display='inline-flex';
            headerTitle.innerHTML = `<i class="bi bi-check2-square"></i> è«‹å‹¾é¸è¦åŒ¯å‡ºçš„å°è±¡`;
        } else { 
            container.classList.remove('batch-mode'); 
            btnToggle.classList.remove('warn'); 
            btnToggle.innerHTML = `<i class="bi bi-check-square"></i> æ‰¹é‡åŒ¯å‡ºå·è»¸`;
            document.getElementById('btnBatchExport').style.display='none'; 
            headerTitle.innerHTML = `<i class="bi bi-clipboard2-check"></i> å†’éšªè€…å¾…è¾¦æ¸…å–®`;
        }

        if (data.roster.length === 0) { container.innerHTML = '<p>ç„¡å†’éšªè€…è³‡æ–™ã€‚</p>'; return; }

        const pendingList = [], healingList = [], allClearList = [];
        data.roster.forEach((s, idx) => {
            let pCount = 0, tasks = [];
            data.assignments.forEach(a => {
                if(a.archived) return;
                const indices = a.assignedIndices || 'all';
                if ((indices === 'all' || indices.includes(idx))) {
                    const status = (a.statuses || [])[idx] || 0;
                    if (status === 0 || status === 2) {
                        pCount++;
                        tasks.push({ id: a.id, title: a.title, status: status });
                    }
                }
            });
            if (pCount > 0) pendingList.push({ idx, tasks });
            else allClearList.push(s); 
            if (pCount >= 5) healingList.push(s);
        });

        const summaryDiv = document.createElement('div');
        summaryDiv.style.display='flex'; summaryDiv.style.gap='12px'; summaryDiv.style.flexWrap='wrap'; summaryDiv.style.marginBottom='20px';
        
        const successCard = document.createElement('div');
        successCard.className = 'card'; successCard.style.flex='1'; successCard.style.backgroundColor='#f0fdf4'; successCard.style.border='2px dashed var(--success)';
        let successHTML = `<h2 style="color:var(--success);"><i class="bi bi-trophy-fill"></i> è¨ä¼æˆå°±</h2>`;
        if (allClearList.length > 0) {
            successHTML += `<div style="display:flex;gap:8px;flex-wrap:wrap;">` + allClearList.map(s => `<div class="seat s3" style="width:40px;height:40px;font-size:14px;cursor:help;" title="${s.name}">${s.no}</div>`).join('') + `</div>`;
        } else { successHTML += `<p style="color:var(--muted);font-weight:bold;">ç›®å‰ç„¡äººé”æˆå…¨æ¸…ç©º...</p>`; }
        successCard.innerHTML = successHTML;
        summaryDiv.appendChild(successCard);

        const healCard = document.createElement('div');
        healCard.className = 'card'; healCard.style.flex='1'; healCard.style.backgroundColor='#fff0f0'; healCard.style.border='2px dashed var(--danger)';
        let healHTML = `<h2 style="color:var(--danger);"><i class="bi bi-heart-pulse"></i> éœ€è£œè¡€æˆå“¡</h2>`;
        if (healingList.length > 0) {
            healHTML += `<div style="display:flex;gap:8px;flex-wrap:wrap;">` + healingList.map(s => `<div class="seat" style="background:#fee2e2;color:#b91c1c;border-color:#fca5a5;width:40px;height:40px;font-size:14px;cursor:help;" title="${s.name}">${s.no}</div>`).join('') + `</div>`;
        } else { healHTML += `<p style="color:var(--success);font-weight:bold;">ç›®å‰æ²’æœ‰æˆå“¡éœ€è¦æ€¥æ•‘ï¼</p>`; }
        healCard.innerHTML = healHTML;
        summaryDiv.appendChild(healCard);
        
        container.appendChild(summaryDiv);

        if (pendingList.length > 0) {
            const grid = document.createElement('div'); grid.className = 'student-status-grid';
            pendingList.forEach(item => {
                const s = data.roster[item.idx];
                const card = document.createElement('div'); card.className = 'card';
                let listHTML = `<ul class="student-status-list">`;
                item.tasks.forEach(t => {
                    const stText = t.status === 0 ? 'æœªå›å ±' : 'å†æŒ‘æˆ°';
                    const stClass = t.status === 0 ? 'p-gray' : 'p-orange';
                    listHTML += `<li data-aid="${t.id}" data-sidx="${item.idx}">${t.title} <span class="pill ${stClass}">${stText}</span></li>`;
                });
                listHTML += `</ul>`;
                const checkboxHTML = isBatchMode 
                    ? `<input type="checkbox" class="batch-export-checkbox" data-sidx="${item.idx}"> ` 
                    : '';
                
                card.innerHTML = `<div class="student-card-header">
                    <h2>
                        ${checkboxHTML}
                        <i class="bi bi-person"></i> <span style="color:var(--danger);">${s.no}.</span> ${s.name}
                    </h2>
                    <button class="btn sm ghost btn-print-single" data-sidx="${item.idx}" title="åŒ¯å‡ºæ­¤ç´€éŒ„"><i class="bi bi-printer"></i></button>
                </div>${listHTML}`;
                grid.appendChild(card);
            });
            container.appendChild(grid);
        } else {
            container.innerHTML += `<div style="text-align:center;font-size:20px;margin-top:40px;">ğŸ‰ å‚³èªªèª•ç”Ÿï¼å…¨é«”å†’éšªè€…éƒ½è¨ä¼æˆåŠŸäº†ï¼ ğŸ‰</div>`;
        }
    }

    function renderRosterEditor() {
        const div = document.getElementById('rosterEditor');
        div.innerHTML = '';
        data.roster.forEach(s => {
            const item = document.createElement('div'); item.className = 'roster-item';
            item.innerHTML = `<input type="number" value="${s.no}" class="roster-no-input" style="width:60px;"><input type="text" value="${s.name}" class="roster-name-input" style="flex:1;">`;
            div.appendChild(item);
        });
    }
    
    function renderTeacherEditor() {
        const div = document.getElementById('teacherEditor');
        div.innerHTML = '';
        data.teachers.forEach(t => {
            const item = document.createElement('div'); item.className = 'teacher-item';
            item.innerHTML = `<input type="text" value="${t}" class="teacher-name-input" style="flex:1;"><button class="btn warn sm btn-del-teacher" data-name="${t}"><i class="bi bi-trash3"></i></button>`;
            div.appendChild(item);
        });
    }

    // (å…¶é¤˜ Event Handlers ä¿æŒåŸæ¨£ï¼Œåƒ…å¢åŠ  Nav Button Event)
    ['btnNavDashboard','btnNavStudentStatus','btnNavRoster'].forEach(id => {
        document.getElementById(id).addEventListener('click', (e) => {
            const viewMap = {
                'btnNavDashboard':'view-dashboard', 
                'btnNavStudentStatus':'view-student-status', 
                'btnNavRoster':'view-roster'
            };
            switchView(viewMap[e.currentTarget.id]);
        });
    });

    document.getElementById('btnRefreshData').addEventListener('click', () => {
        if(confirm("ç¢ºå®šè¦é‡æ–°è®€å–è³‡æ–™å—ï¼Ÿæœªå„²å­˜çš„è®Šæ›´å°‡æœƒéºå¤±ã€‚")) {
            loadDataFromFirebase();
        }
    });

    document.getElementById('tabBtnStudents').addEventListener('click', () => {
        document.getElementById('tabBtnStudents').classList.add('active');
        document.getElementById('tabBtnTeachers').classList.remove('active');
        document.getElementById('roster-content-students').classList.add('show');
        document.getElementById('roster-content-teachers').classList.remove('show');
    });
    
    document.getElementById('tabBtnTeachers').addEventListener('click', () => {
        document.getElementById('tabBtnTeachers').classList.add('active');
        document.getElementById('tabBtnStudents').classList.remove('active');
        document.getElementById('roster-content-teachers').classList.add('show');
        document.getElementById('roster-content-students').classList.remove('show');
    });

    document.getElementById('btnOpenSettings').addEventListener('click', () => document.getElementById('settingsModal').classList.add('show'));
    document.querySelectorAll('.modal-close-btn').forEach(b => b.addEventListener('click', (e) => e.target.closest('.modal-overlay').classList.remove('show')));

    document.getElementById('ipTeacherSelect').addEventListener('change', (e) => { document.getElementById('ipTeacherCustom').style.display = e.target.value === 'custom' ? 'block' : 'none'; });
    document.getElementById('selSubject').addEventListener('change', (e) => {
        const selTask = document.getElementById('selPresetTask'); selTask.innerHTML = '<option value="">ğŸ“œ å¸¸ç”¨ä»»å‹™...</option>';
        const db = data.questSettings || defaultData.questSettings;
        if(e.target.value && db[e.target.value]) db[e.target.value].forEach(t => selTask.add(new Option(t, t)));
    });
    document.getElementById('selPresetTask').addEventListener('change', (e) => { if(e.target.value) document.getElementById('ipTitle').value = e.target.value; });

    document.getElementById('btnCreate').addEventListener('click', () => {
        let teacher = document.getElementById('ipTeacherSelect').value;
        if(teacher === 'custom') teacher = document.getElementById('ipTeacherCustom').value.trim();
        const title = document.getElementById('ipTitle').value.trim();
        const subject = document.getElementById('selSubject').value;
        const date = document.getElementById('ipDate').value;
        if(!teacher || !title || !date) { alert("è«‹å¡«å¯«å®Œæ•´ï¼"); return; }
        
        if(!data.teachers.includes(teacher)) data.teachers.push(teacher);
        const isAll = newAssignmentAssignedIndices.length === data.roster.length || newAssignmentAssignedIndices.length === 0;
        
        const newA = { 
            id: Date.now(), 
            teacher, 
            title, 
            subject,
            date, 
            assignedIndices: isAll ? 'all' : newAssignmentAssignedIndices, 
            statuses: Array(data.roster.length).fill(0) 
        };
        data.assignments.push(newA);
        triggerAutoSave(); 
        
        resetNewAssignmentState();
        renderAll();
    });

    document.getElementById('btnMarkAllYellow').addEventListener('click', () => {
        const a = data.assignments.find(i => i.id == currentAssignmentId);
        if(!a) return;
        if(confirm("ç¢ºå®šå…¨é«”æ¨™è¨˜ç‚ºå·²å›å ±ï¼Ÿ")) {
            const indices = a.assignedIndices || 'all';
            for(let i=0; i<data.roster.length; i++) {
                if(indices === 'all' || indices.includes(i)) a.statuses[i] = 1;
            }
            triggerAutoSave();
            renderDetail(currentAssignmentId);
        }
    });

    document.getElementById('btnMarkAllOrange').addEventListener('click', () => {
        const a = data.assignments.find(i => i.id == currentAssignmentId);
        if(!a) return;
        if(confirm("ç¢ºå®šå…¨é«”æ¨™è¨˜ç‚ºå†æŒ‘æˆ°ï¼Ÿ")) {
            const indices = a.assignedIndices || 'all';
            for(let i=0; i<data.roster.length; i++) {
                if(indices === 'all' || indices.includes(i)) a.statuses[i] = 2;
            }
            triggerAutoSave();
            renderDetail(currentAssignmentId);
        }
    });
    
    document.getElementById('rangeSize').addEventListener('input', (e) => {
        const sz = e.target.value;
        document.documentElement.style.setProperty('--seat', `${sz}px`);
        document.documentElement.style.setProperty('--seat-font', `${Math.max(10, Math.floor(sz * 0.3))}px`);
    });

    document.getElementById('gridContainer').addEventListener('click', (e) => {
        const seat = e.target.closest('.seat');
        if(!seat) return;
        const idx = parseInt(seat.dataset.index);
        const a = data.assignments.find(i => i.id == currentAssignmentId);
        if(!a) return;
        let s = (a.statuses || [])[idx] || 0;
        s = (s + 1) % 4;
        if(!a.statuses) a.statuses = Array(data.roster.length).fill(0);
        a.statuses[idx] = s;
        if(s === 3) playSuccessSound();
        
        const indices = a.assignedIndices || 'all';
        let allCompleted = true;
        for(let i=0; i<data.roster.length; i++) {
            if(indices === 'all' || indices.includes(i)) {
                if (a.statuses[i] !== 3) allCompleted = false;
            }
        }
        if (allCompleted) confetti();

        triggerAutoSave();
        renderDetail(currentAssignmentId);
        renderDashboard();
    });

    document.getElementById('studentStatusContainer').addEventListener('click', (e) => {
        if(e.target.closest('.btn-print-single') || e.target.classList.contains('batch-export-checkbox')) return;
        const li = e.target.closest('li');
        if(!li) return;
        
        const aid = li.dataset.aid;
        const sidx = parseInt(li.dataset.sidx);
        const a = data.assignments.find(i => i.id == aid);
        const currentStatus = (a.statuses[sidx] || 0);

        if(currentStatus === 0) {
            statusPickerTarget = { index: sidx, assignmentId: aid, source: 'list' };
            document.querySelectorAll('.status-option-btn').forEach(btn => btn.style.display = 'flex');
            const rect = li.getBoundingClientRect();
            statusPicker.style.top = (rect.top + window.scrollY) + 'px';
            statusPicker.style.left = (rect.right + window.scrollX - 160) + 'px';
            statusPicker.classList.add('show');
            
            const closePicker = (evt) => { if(!statusPicker.contains(evt.target) && !li.contains(evt.target)) { statusPicker.classList.remove('show'); document.removeEventListener('click', closePicker); } };
            setTimeout(() => document.addEventListener('click', closePicker), 50);
        } else {
            if(confirm("æ¨™è¨˜ç‚ºè¨ä¼æˆåŠŸï¼Ÿ")) { a.statuses[sidx] = 3; playSuccessSound(); triggerAutoSave(); renderStudentStatus(); renderDashboard(); }
        }
    });

// ============================================================
    // âœ‚ï¸ è«‹å¾é€™è£¡é–‹å§‹å–ä»£ (åŒ…å«é€™è¡Œèˆ‡ä¸‹é¢æ‰€æœ‰ç¨‹å¼ç¢¼)
    // ============================================================

    // 1. ç‹€æ…‹é¸å–®é»æ“Šäº‹ä»¶
    document.querySelectorAll('.status-option-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const s = parseInt(btn.dataset.status);
            const { index, assignmentId } = statusPickerTarget;
            const a = data.assignments.find(i => i.id == assignmentId);
            if(a) {
                a.statuses[index] = s;
                if(s === 3) playSuccessSound();
                
                // æª¢æŸ¥æ˜¯å¦å…¨é«”å®Œæˆ
                const indices = a.assignedIndices || 'all';
                let allCompleted = true;
                for(let i=0; i<data.roster.length; i++) {
                    if(indices === 'all' || indices.includes(i)) {
                        if ((a.statuses[i]||0) !== 3) allCompleted = false;
                    }
                }
                if (allCompleted) confetti();

                triggerAutoSave();
                renderStudentStatus();
                renderDashboard();
            }
            statusPicker.classList.remove('show');
        });
    });

    let targetAssignmentIdToDelete = null; 

    // âš ï¸ é€™è£¡å·²ç¶“ç§»é™¤äº†èˆŠç‰ˆ assignmentList çš„éŒ¯èª¤ç¨‹å¼ç¢¼ï¼Œç¢ºä¿æŒ‰éˆ•åŠŸèƒ½æ­£å¸¸

    // 2. åˆ—è¡¨é»æ“Š (å§”è¨—çœ‹æ¿çš„æ¸…å–®èˆ‡è¡¨æ ¼)
    // é˜²æ­¢èˆŠä»£ç¢¼æ®˜ç•™ï¼Œåªç›£è½ç¾åœ¨å­˜åœ¨çš„ sideAssignmentList
    const sideListEl = document.getElementById('sideAssignmentList');
    if(sideListEl) {
        sideListEl.addEventListener('click', (e) => {
            // é€™è£¡ä¸éœ€è¦åšä»€éº¼ï¼Œå› ç‚ºæ¯å€‹ item éƒ½æœ‰è‡ªå·±çš„ click listener
        });
    }

    // 3. å°å­˜èˆ‡åˆªé™¤æŒ‰éˆ•
    document.getElementById('btnConfirmArchive').addEventListener('click', () => {
        if (!targetAssignmentIdToDelete) return;
        const a = data.assignments.find(x => x.id == targetAssignmentIdToDelete);
        if(a) {
            a.archived = true;
            triggerAutoSave();
            renderDashboard();
            updateSaveStatus('success', 'å·²å°å­˜');
        }
        document.getElementById('deleteChoiceModal').classList.remove('show');
        targetAssignmentIdToDelete = null;
    });

    let undoTimeout = null;
    let deletedAssignmentBackup = null;

    document.getElementById('btnConfirmDelete').addEventListener('click', () => {
        if (!targetAssignmentIdToDelete) return;
        
        const item = data.assignments.find(x => x.id == targetAssignmentIdToDelete);
        if(item) {
            deletedAssignmentBackup = JSON.parse(JSON.stringify(item));
            data.assignments = data.assignments.filter(x => x.id != targetAssignmentIdToDelete);
            triggerAutoSave();
            renderDashboard();
            showToast("å¥‘ç´„å·²éŠ·æ¯€ï¼", "å¾©åŸ (Undo)", () => {
                if (deletedAssignmentBackup) {
                    data.assignments.push(deletedAssignmentBackup);
                    data.assignments.sort((a,b) => b.id - a.id);
                    renderDashboard();
                    clearTimeout(undoTimeout);
                    undoTimeout = null;
                    deletedAssignmentBackup = null;
                    alert("å·²æˆåŠŸå¾©åŸï¼");
                }
            });
        }
        
        document.getElementById('deleteChoiceModal').classList.remove('show');
        targetAssignmentIdToDelete = null;

        if(undoTimeout) clearTimeout(undoTimeout);
        undoTimeout = setTimeout(() => {
            saveDataToFirebase();
            updateSaveStatus('success', 'å·²éŠ·æ¯€');
            deletedAssignmentBackup = null; 
        }, 5000);
    });

    // 4. å±éšªæ“ä½œå€
    document.getElementById('btnClearAssignments').addEventListener('click', () => {
        if(confirm("ğŸ”¥ è­¦å‘Šï¼šé€™å°‡æœƒåˆªé™¤ã€Œæ‰€æœ‰çš„ã€å§”è¨—ä»»å‹™è³‡æ–™ï¼ŒåŒ…å«å·²å°å­˜çš„ç´€éŒ„ï¼\n\nå†’éšªè€…åå–®å°‡æœƒä¿ç•™ã€‚\n\nç¢ºå®šè¦åŸ·è¡Œå—ï¼Ÿ")) {
            if(confirm("å†æ¬¡ç¢ºèªï¼šè³‡æ–™åˆªé™¤å¾Œç„¡æ³•å¾©åŸï¼çœŸçš„è¦éŠ·æ¯€å—ï¼Ÿ")) {
                data.assignments = [];
                triggerAutoSave();
                renderDashboard();
                renderStudentStatus();
                alert("æ‰€æœ‰å¥‘ç´„å·²åŒ–ç‚ºç°ç‡¼ï¼");
                document.getElementById('adminProfileModal').classList.remove('show');
            }
        }
    });

    document.getElementById('btnResetAll').addEventListener('click', () => {
        const promptText = "DESTROY";
        const input = prompt(`â˜¢ï¸ å±éšªï¼šé€™å°‡åˆªé™¤ã€Œæ‰€æœ‰ã€è³‡æ–™ï¼ŒåŒ…å«å†’éšªè€…åå–®ã€è€å¸«åå–®ã€æ‰€æœ‰ä»»å‹™ï¼\n\nè‹¥ç¢ºå®šåŸ·è¡Œï¼Œè«‹è¼¸å…¥ "${promptText}"ï¼š`);
        if(input === promptText) {
            data.roster = [];
            data.assignments = [];
            data.attendance = {}; 
            triggerAutoSave();
            renderAll();
            alert("å…¬æœƒå·²é‡å»ºï¼Œä¸€åˆ‡æ­¸é›¶ï¼");
            document.getElementById('adminProfileModal').classList.remove('show');
        }
    });

    // 5. ç¯©é¸å™¨ (å«é˜²å‘†)
    ['teacherFilter','subjectFilter'].forEach(id => {
        const el = document.getElementById(id);
        if(el) {
            el.addEventListener('change', (e) => {
                currentFilter[id.replace('Filter','')] = e.target.value; 
                renderDashboard();
                // å„ªåŒ–ï¼šé¸æ“‡å¾Œè‡ªå‹•æ”¶èµ·
                const p = document.getElementById('filterPanel');
                if(p) p.classList.remove('show');
                const b = document.getElementById('btnToggleFilter');
                if(b) b.classList.remove('active');
            });
        }
    });

    document.getElementById('btnClearFilter').addEventListener('click', () => { 
        currentFilter = { teacher: 'all', subject: 'all', date: '' }; 
        document.getElementById('teacherFilter').value = 'all'; 
        document.getElementById('subjectFilter').value = 'all'; 
        renderDashboard(); 
        document.getElementById('filterPanel').classList.remove('show');
    });

    // 6. ä»»å‹™è¨­å®š
    document.getElementById('btnOpenQuestSettings').addEventListener('click', () => {
        tempQuestSettings = JSON.parse(JSON.stringify(data.questSettings || defaultData.questSettings));
        renderQuestConfig();
        document.getElementById('questSettingsModal').classList.add('show');
    });
    
    document.getElementById('btnAddSubject').addEventListener('click', () => {
        const val = document.getElementById('ipNewSubject').value.trim();
        if(val) { if(!tempQuestSettings[val]) tempQuestSettings[val] = []; document.getElementById('ipNewSubject').value=''; renderQuestConfig(); }
    });
    
    document.getElementById('btnSaveQuestSettings').addEventListener('click', () => {
        data.questSettings = JSON.parse(JSON.stringify(tempQuestSettings));
        triggerAutoSave();
        updateSubjectDropdown();
        document.getElementById('questSettingsModal').classList.remove('show');
    });

    // 7. å¤–è§€è¨­å®š
    document.getElementById('themeOptionsContainer').addEventListener('click', (e) => {
        const btn = e.target.closest('.theme-option');
        if(btn) { 
            const t = btn.dataset.theme; 
            document.documentElement.setAttribute('data-color-theme', t); 
            localStorage.setItem('homeworkSystemColorTheme', t);
            document.querySelectorAll('.theme-option').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
        }
    });
    
    document.getElementById('darkModeToggle').addEventListener('change', (e) => {
        const t = e.target.checked ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', t);
        localStorage.setItem('homeworkSystemTheme', t);
    });

    // 8. æ•¸å­—éµç›¤ (é˜²å‘†)
    const numpadContainer = document.getElementById('numpadContainer');
    const btnToggleNumpad = document.getElementById('btnToggleNumpad');
    
    if (numpadContainer && btnToggleNumpad) {
        const numKeys = ['1','2','3','BS','4','5','6','-','7','8','9','.','L','P','0','CLR'];
        numKeys.forEach(k => {
            const b = document.createElement('button');
            b.className = `num-key ${['L','P','BS','CLR','-'].includes(k)?'action-key':''}`;
            b.textContent = k==='BS'?'âŒ«':k;
            b.type = "button";
            b.addEventListener('click', (e) => {
                e.stopPropagation();
                const ip = document.getElementById('ipTitle');
                if (ip) {
                    if(k==='BS') ip.value = ip.value.slice(0,-1);
                    else if(k==='CLR') ip.value = '';
                    else ip.value += k;
                    ip.focus();
                }
            });
            numpadContainer.appendChild(b);
        });

        const closeNum = document.createElement('button');
        closeNum.className = 'numpad-close';
        closeNum.innerHTML = '&times;';
        closeNum.type = "button";
        closeNum.addEventListener('click', (e) => { 
            e.stopPropagation(); 
            numpadContainer.classList.remove('show'); 
        });
        numpadContainer.appendChild(closeNum);
        
        btnToggleNumpad.addEventListener('click', (e) => {
            e.stopPropagation();
            numpadContainer.classList.toggle('show');
        });

        document.addEventListener('click', (e) => {
            if (!numpadContainer.contains(e.target) && e.target !== btnToggleNumpad) {
                numpadContainer.classList.remove('show');
            }
        });
    }

    // 9. å†’éšªè€…åå–®ç·¨è¼¯
    document.getElementById('btnAddStudentRow').addEventListener('click', () => {
        const listDiv = document.getElementById('rosterEditor');
        const count = listDiv.querySelectorAll('.roster-item').length + 1;
        const item = document.createElement('div'); item.className = 'roster-item';
        item.innerHTML = `<input type="number" value="${count}" class="roster-no-input" style="width:60px;"><input type="text" value="" placeholder="æ–°å†’éšªè€…" class="roster-name-input" style="flex:1;">`;
        listDiv.appendChild(item);
        listDiv.scrollTop = listDiv.scrollHeight;
    });

    document.getElementById('btnApplyRoster').addEventListener('click', () => {
        if(!confirm("ç¢ºå®šä¿®æ”¹åå–®ï¼Ÿ")) return;
        const newRoster = [];
        document.getElementById('rosterEditor').querySelectorAll('.roster-item').forEach(div => {
            const no = parseInt(div.querySelector('.roster-no-input').value);
            const name = div.querySelector('.roster-name-input').value.trim();
            if(no && name) newRoster.push({no, name});
        });
        data.roster = newRoster;
        triggerAutoSave();
        renderRosterEditor();
        alert("åå–®å·²æ›´æ–°ï¼");
    });
    
    document.getElementById('btnApplyTeachers').addEventListener('click', () => {
        const newTs = [];
        document.querySelectorAll('.teacher-name-input').forEach(i => { if(i.value.trim()) newTs.push(i.value.trim()); });
        data.teachers = [...new Set(newTs)].sort();
        triggerAutoSave();
        renderTeacherEditor();
        alert("å…¬æœƒé•·åå–®å·²æ›´æ–°ï¼");
    });
    
    document.getElementById('teacherEditor').addEventListener('click', (e) => {
        const btn = e.target.closest('.btn-del-teacher');
        if(btn) {
            const t = btn.dataset.name;
            if(confirm(`åˆªé™¤ ${t}?`)) { 
                data.teachers = data.teachers.filter(x => x !== t); 
                triggerAutoSave(); 
                renderTeacherEditor(); 
            }
        }
    });

    // 10. Tooltips
    document.body.addEventListener('mouseover', (e) => {
        const t = e.target.closest('.has-tooltip');
        if(t && t.dataset.tooltip) { customTooltip.innerHTML = t.dataset.tooltip; customTooltip.classList.add('show'); }
    });
    document.body.addEventListener('mousemove', (e) => {
        if(customTooltip.classList.contains('show')) { customTooltip.style.left = (e.clientX + 15) + 'px'; customTooltip.style.top = (e.clientY + 15) + 'px'; }
    });
    document.body.addEventListener('mouseout', () => customTooltip.classList.remove('show'));
    
    // 11. æŒ‡æ´¾å­¸ç”Ÿ Modal
    document.getElementById('btnOpenAssignModal').addEventListener('click', () => {
        const list = document.getElementById('assignStudentListContainer');
        list.innerHTML = '';
        data.roster.forEach((s, i) => {
            const checked = newAssignmentAssignedIndices.length === 0 || newAssignmentAssignedIndices.includes(i);
            const label = document.createElement('label'); label.className = 'assign-student-item';
            label.innerHTML = `<input type="checkbox" data-idx="${i}" ${checked?'checked':''}> <span>${s.no}. ${s.name}</span>`;
            list.appendChild(label);
        });
        document.getElementById('assignStudentModal').classList.add('show');
    });
    document.getElementById('btnConfirmAssign').addEventListener('click', () => {
        const checked = document.querySelectorAll('#assignStudentListContainer input:checked');
        newAssignmentAssignedIndices = [];
        checked.forEach(c => newAssignmentAssignedIndices.push(parseInt(c.dataset.idx)));
        document.getElementById('assignStatusText').innerText = newAssignmentAssignedIndices.length === data.roster.length ? "å…¨é«”å†’éšªè€…" : `å·²é¸ ${newAssignmentAssignedIndices.length} ä½`;
        document.getElementById('assignStudentModal').classList.remove('show');
    });
    document.getElementById('btnAssignSelectAll').addEventListener('click', () => document.querySelectorAll('#assignStudentListContainer input').forEach(c => c.checked = true));
    document.getElementById('btnAssignDeselectAll').addEventListener('click', () => document.querySelectorAll('#assignStudentListContainer input').forEach(c => c.checked = false));

    // 12. ğŸŒŸ å…¬æœƒé•·åŸ·å‹™å®¤æŒ‰éˆ• (ä¿®å¾©é‡é»)
    document.getElementById('userEmailDisplay').addEventListener('click', () => {
        const adminModal = document.getElementById('adminProfileModal');
        const debtList = document.getElementById('adminDebtList');
        debtList.innerHTML = '';

        const debtStudents = [];
        data.roster.forEach((student, idx) => {
            let count = 0;
            data.assignments.forEach(a => {
                if(a.archived) return; 
                const assigned = a.assignedIndices === 'all' || a.assignedIndices.includes(idx);
                // å¢åŠ  statuses é˜²å‘†æª¢æŸ¥
                const statuses = a.statuses || [];
                const s = statuses[idx] || 0;
                if (assigned && (s === 0 || s === 2)) count++;
            });
            if (count >= 5) debtStudents.push({ ...student, count });
        });

        if (debtStudents.length > 0) {
            debtStudents.forEach(s => {
                const tag = document.createElement('span');
                tag.style.cssText = "background:#fee2e2; color:#b91c1c; padding:6px 12px; border-radius:20px; font-weight:bold; font-size:14px; border:1px solid #fca5a5;";
                tag.innerHTML = `${s.name} <small>(${s.count})</small>`;
                debtList.appendChild(tag);
            });
        } else {
            debtList.innerHTML = '<p style="color:var(--success);width:100%;">ç›®å‰ç„¡äººæ¬ æ¬¾è¶…é 5 é …ï¼</p>';
        }
        
        adminModal.classList.add('show');
    });

    // 13. ä¸‹è¼‰å°å­˜
    document.getElementById('btnDownloadArchive').addEventListener('click', () => {
        const archives = data.assignments.filter(a => a.archived);
        if(archives.length === 0) {
            alert("å€‰åº«è£¡ç©ºç©ºå¦‚ä¹Ÿï¼Œæ²’æœ‰ä»»ä½•å°å­˜ç´€éŒ„ï¼");
            return;
        }

        let csvContent = "\uFEFF";
        const studentHeaders = data.roster.map(s => `${s.no}.${s.name}`).join(",");
        csvContent += `ç™¼å¸ƒæ—¥æœŸ,å§”è¨—å…§å®¹,å…¬æœƒé•·,${studentHeaders}\n`;
        const statusText = ["æœªäº¤", "å·²äº¤", "è¨‚æ­£", "å®Œæˆ"];

        archives.forEach(a => {
            let row = `${a.date},"${a.title}",${a.teacher}`;
            const indices = a.assignedIndices || 'all';
            const studentStatuses = data.roster.map((s, i) => {
                if (indices !== 'all' && !indices.includes(i)) return "-";
                const sCode = (a.statuses || [])[i] || 0;
                return statusText[sCode] || "æœªçŸ¥";
            }).join(",");
            row += `,${studentStatuses}`;
            csvContent += row + "\n";
        });

        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", `å…¬æœƒå°å­˜ç´€éŒ„_${new Date().toISOString().slice(0,10)}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    });

    // 14. æ‰¹é‡æ¨¡å¼èˆ‡åˆ—å°
    document.getElementById('btnToggleBatchMode').addEventListener('click', () => {
        isBatchMode = !isBatchMode;
        renderStudentStatus();
    });

    function printContent(contentHTML) {
        const printWindow = window.open('', '', 'width=800,height=600');
        printWindow.document.write(`
            <html>
            <head>
                <title>å†’éšªè€…ä»»å‹™å·è»¸</title>
                <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
                <style>
                    body { font-family: "Microsoft JhengHei", monospace; padding: 20px; }
                    .print-card { border: 2px solid #333; padding: 15px; margin-bottom: 20px; page-break-inside: avoid; border-radius: 8px; }
                    .print-header { font-size: 18px; font-weight: bold; border-bottom: 1px dashed #999; padding-bottom: 8px; margin-bottom: 8px; }
                    ul { padding-left: 20px; margin: 0; }
                    li { margin-bottom: 4px; }
                    .pill { padding: 2px 6px; border-radius: 4px; border: 1px solid #ccc; font-size: 12px; margin-left: 5px; font-weight: bold; }
                    .p-gray { background: #eee; color: #555; }
                    .p-orange { background: #fff7ed; color: #9a3412; border-color: #fdba74; }
                </style>
            </head>
            <body>
                <h1 style="text-align:center; margin-bottom: 20px;">ğŸ›¡ï¸ å†’éšªè€…ä»»å‹™å·è»¸</h1>
                ${contentHTML}
                <script>
                    window.onload = function() { window.print(); window.close(); }
                <\/script>
            </body>
            </html>
        `);
        printWindow.document.close();
    }

    document.getElementById('btnBatchExport').addEventListener('click', () => {
         const checkboxes = document.querySelectorAll('.batch-export-checkbox:checked');
         if(checkboxes.length === 0) { alert("è«‹å…ˆå‹¾é¸å†’éšªè€…ï¼"); return; }
         
         let printHTML = '';
         checkboxes.forEach(cb => {
             const sidx = cb.dataset.sidx;
             const card = cb.closest('.card');
             if(card) {
                 const name = card.querySelector('.student-card-header').innerText.trim();
                 const list = card.querySelector('ul').outerHTML;
                 printHTML += `<div class="print-card"><div class="print-header">${name}</div>${list}</div>`;
             }
         });
         printContent(printHTML);
    });

    document.getElementById('studentStatusContainer').addEventListener('click', (e) => {
        const btn = e.target.closest('.btn-print-single');
        if(btn) {
            e.stopPropagation();
            const card = btn.closest('.card');
            const name = card.querySelector('.student-card-header').innerText.trim();
            const list = card.querySelector('ul').outerHTML;
            printContent(`<div class="print-card"><div class="print-header">${name}</div>${list}</div>`);
        }
    });

    document.getElementById('btnLoadFromPaste').addEventListener('click', () => {
        const txt = document.getElementById('taRosterPaste').value.trim();
        if(!txt) return;
        const lines = txt.split(/\r?\n/).filter(x => x.trim());
        const listDiv = document.getElementById('rosterEditor');
        let count = listDiv.querySelectorAll('.roster-item').length + 1;
        lines.forEach(name => {
            const item = document.createElement('div'); item.className = 'roster-item';
            item.innerHTML = `<input type="number" value="${count}" class="roster-no-input" style="width:60px;"><input type="text" value="${name.trim()}" class="roster-name-input" style="flex:1;">`;
            listDiv.appendChild(item);
            count++;
        });
        document.getElementById('taRosterPaste').value = '';
        alert(`å·²è¼‰å…¥ ${lines.length} ä½å†’éšªè€…ï¼Œè«‹è¨˜å¾—æŒ‰ã€Œå„²å­˜è®Šæ›´ã€ï¼`);
    });

    // 15. å·¥å…·ç®±é‚è¼¯
    document.getElementById('btnToggleToolbox').addEventListener('click', (e) => {
        const menu = document.getElementById('toolboxMenu');
        const btn = e.currentTarget; 
        menu.classList.toggle('show'); 
        btn.classList.toggle('active');
    });

    function openToolWindow(panelId) {
        document.querySelectorAll('.tool-window').forEach(el => el.classList.remove('show'));
        document.getElementById(panelId).classList.add('show');
        document.getElementById('toolboxMenu').classList.remove('show');
        document.getElementById('btnToggleToolbox').classList.remove('active');
    }

    document.getElementById('btnOpenMarquee').addEventListener('click', () => openToolWindow('panelMarquee'));
    document.getElementById('btnOpenTimer').addEventListener('click', () => openToolWindow('panelTimer'));
    document.getElementById('btnOpenDraw').addEventListener('click', () => openToolWindow('panelDraw'));

    window.closeToolWindow = (btn) => {
        const win = btn.closest('.tool-window');
        if(win) win.classList.remove('show');
    };

    let timerInterval = null;
    let timerSeconds = 0;
    
    function updateTimerDisplay() {
        const m = Math.floor(timerSeconds / 60).toString().padStart(2, '0');
        const s = (timerSeconds % 60).toString().padStart(2, '0');
        document.getElementById('timerDisplay').innerText = `${m}:${s}`;
    }

    document.querySelectorAll('.btn-timer-preset').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const min = parseInt(e.target.dataset.min);
            if(timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
                document.getElementById('btnTimerStart').innerText = "é–‹å§‹";
                document.getElementById('btnTimerStart').classList.remove('warn');
            }
            timerSeconds = min * 60;
            document.getElementById('timerInput').value = min;
            document.getElementById('timerInputSec').value = 0;
            updateTimerDisplay();
        });
    });

    document.getElementById('btnTimerStart').addEventListener('click', (e) => {
        const btn = e.target;
        if(timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
            btn.innerText = "ç¹¼çºŒ";
            btn.classList.remove('warn');
        } else {
            if(timerSeconds === 0) {
               const inputVal = parseInt(document.getElementById('timerInput').value) || 0;
               const inputSec = parseInt(document.getElementById('timerInputSec').value) || 0;
               if(inputVal > 0 || inputSec > 0) timerSeconds = inputVal * 60 + inputSec;
               else if(timerSeconds === 0) return; 
            }
            btn.innerText = "æš«åœ";
            btn.classList.add('warn');
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                if(timerSeconds > 0) {
                    timerSeconds--;
                    updateTimerDisplay();
                } else {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    btn.innerText = "é–‹å§‹";
                    btn.classList.remove('warn');
                    alert("æ™‚é–“åˆ°ï¼");
                    playAlarmSound();
                }
            }, 1000);
        }
    });

    document.getElementById('btnTimerReset').addEventListener('click', () => {
        if(timerInterval) clearInterval(timerInterval);
        timerInterval = null;
        timerSeconds = 0;
        updateTimerDisplay();
        document.getElementById('btnTimerStart').innerText = "é–‹å§‹";
        document.getElementById('btnTimerStart').classList.remove('warn');
        document.getElementById('timerInput').value = '';
        document.getElementById('timerInputSec').value = '';
    });

    document.getElementById('btnLuckyDraw').addEventListener('click', () => {
        const resDiv = document.getElementById('luckyDrawResult');
        if(!data.roster || data.roster.length === 0) {
            resDiv.innerText = "ç„¡äººå¯æŠ½";
            return;
        }
        
        let count = 0;
        const max = 20;
        const interval = setInterval(() => {
            const rand = Math.floor(Math.random() * data.roster.length);
            resDiv.innerText = `${data.roster[rand].no}. ${data.roster[rand].name}`;
            playTickSound();
            count++;
            if(count >= max) {
                clearInterval(interval);
                resDiv.style.color = 'var(--danger)';
                resDiv.style.transform = 'scale(1.2)';
                playSuccessSound(); 
                setTimeout(() => resDiv.style.transform = 'scale(1)', 200);
            } else {
                resDiv.style.color = 'var(--text-light)';
            }
        }, 50);
    });

    const mqSizeInput = document.getElementById('mqSizeInput');
    const mqSpeedInput = document.getElementById('mqSpeedInput'); 
    
    mqSizeInput.addEventListener('input', (e) => {
        const mqText = document.getElementById('marqueeText');
        if(mqText) mqText.style.fontSize = e.target.value + 'px';
    });

    mqSpeedInput.addEventListener('input', (e) => {
        updateMarqueeSpeed();
    });

    function updateMarqueeSpeed() {
        const text = document.getElementById('mqTextInput').value.trim();
        const mqText = document.getElementById('marqueeText');
        if (!text) return;

        const speedFactor = parseFloat(document.getElementById('mqSpeedInput').value); 
        const baseDuration = Math.max(10, text.length * 0.8); 
        const finalDuration = baseDuration / speedFactor; 
        
        mqText.style.animationDuration = finalDuration + 's';
    }
    
    document.getElementById('btnMqShow').addEventListener('click', () => {
        const text = document.getElementById('mqTextInput').value.trim();
        const color = document.getElementById('mqColorInput').value;
        const size = document.getElementById('mqSizeInput').value;
        
        if(!text) { alert("è«‹å…ˆè¼¸å…¥å…¬å‘Šå…§å®¹ï¼"); return; }
        
        const mqContainer = document.getElementById('topMarquee');
        const mqText = document.getElementById('marqueeText');
        
        mqText.innerText = text;
        mqText.style.color = color;
        mqText.style.fontSize = size + 'px';
        
        updateMarqueeSpeed(); 
        
        mqContainer.style.display = 'block';
    });
    
    document.getElementById('btnMqHide').addEventListener('click', () => {
        document.getElementById('topMarquee').style.display = 'none';
    });
  </script>

</body>
</html>
