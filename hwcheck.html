// ============================================================
    // ğŸ–¨ï¸ å„ªåŒ–ç‰ˆ V2ï¼šæ‰¹é‡åŒ¯å‡º (ä¿®å¾©ç©ºç™½ + ä¾ç…§æ¬ ç¼ºæ•¸é‡æ’åº)
    // ============================================================
    document.getElementById('btnBatchExport').addEventListener('click', () => {
        // 1. å–å¾—æ‰€æœ‰è¢«å‹¾é¸çš„ç´¢å¼• (Index)
        const checkedBoxes = document.querySelectorAll('.batch-export-checkbox:checked');
        if(!checkedBoxes.length) { alert("å°šæœªå‹¾é¸ä»»ä½•å†’éšªè€…ï¼"); return; }
        
        const selectedIndices = Array.from(checkedBoxes).map(c => parseInt(c.dataset.sidx));

        // 2. å¾åŸå§‹è³‡æ–™ (data) ä¸­æå–å­¸ç”Ÿè³‡æ–™ï¼Œä¸¦è¨ˆç®—æ¬ ç¼ºæ•¸é‡
        let exportList = selectedIndices.map(sidx => {
            const student = data.roster[sidx];
            
            // æ‰¾å‡ºè©²å­¸ç”Ÿçš„æ‰€æœ‰ç›¸é—œä»»å‹™
            const studentTasks = (data.assignments || []).filter(a => {
                if (a.archived) return false;
                const indices = a.assignedIndices || 'all';
                return (indices === 'all' || indices.includes(sidx));
            }).map(a => {
                const status = (a.statuses || [])[sidx] || 0;
                return { title: a.title, status: status };
            });

            // éæ¿¾å‡ºã€Œå¾…è¾¦ã€é …ç›® (ç‹€æ…‹ 0:æœªå›å ±, 2:å†æŒ‘æˆ°, 1:å·²å›å ±)
            // é€™è£¡æ’é™¤ 3:è¨ä¼æˆåŠŸï¼Œå› ç‚ºé€šå¸¸ä¸éœ€è¦å°å‡ºä¾†ï¼Œè‹¥æ‚¨éœ€è¦å°å…¨éƒ¨å¯æ‹¿æ‰ filter
            const pendingTasks = studentTasks.filter(t => t.status !== 3);

            // è¨ˆç®—ã€Œæ¬ æ¬¾æŒ‡æ•¸ã€ (ç”¨ä¾†æ’åº)ï¼šæœªå›å ±(0) å’Œ å†æŒ‘æˆ°(2) ç®—æ¬ æ¬¾
            const debtCount = studentTasks.filter(t => t.status === 0 || t.status === 2).length;

            return { 
                name: student.name, 
                no: student.no, 
                tasks: pendingTasks, 
                debtCount: debtCount 
            };
        });

        // 3. ğŸ”¥ é—œéµæ’åºï¼šä¾ç…§ã€Œæ¬ æ¬¾æ•¸é‡ã€ç”±å¤§åˆ°å°æ’åº (è‹¥æ•¸é‡ç›¸åŒå‰‡ç…§åº§è™Ÿ)
        exportList.sort((a, b) => {
            if (b.debtCount !== a.debtCount) {
                return b.debtCount - a.debtCount; // æ¬ è¶Šå¤šæ’è¶Šå‰é¢
            }
            return a.no - b.no; // æ¬ ä¸€æ¨£å¤šï¼Œç…§åº§è™Ÿæ’
        });

        // 4. ç”Ÿæˆ HTML
        let cardsHtml = '';
        const printDate = new Date().toLocaleDateString('zh-TW');

        exportList.forEach(student => {
            // å¦‚æœè©²å­¸ç”Ÿæ²’æœ‰å¾…è¾¦äº‹é …ï¼Œæ˜¯å¦è¦ç•¥éï¼Ÿ(ç›®å‰è¨­å®šï¼šç…§å°ï¼Œé¡¯ç¤ºç„¡å¾…è¾¦)
            
            const listItems = student.tasks.length > 0 ? student.tasks.map(t => {
                // å°‡ç‹€æ…‹æ•¸å­—è½‰æ–‡å­—
                let statusText = '';
                if(t.status === 0) statusText = 'æœªå›å ±';
                else if(t.status === 1) statusText = 'å·²å›å ±';
                else if(t.status === 2) statusText = 'å†æŒ‘æˆ°';
                
                return `
                    <li class="print-task-item">
                        <span class="print-checkbox">â˜</span>
                        <span class="print-task-name">${t.title}</span>
                        <span class="print-task-status">(${statusText})</span>
                    </li>`;
            }).join('') : '<li class="print-task-item" style="justify-content:center; color:#888;">ğŸ‰ å¤ªæ£’äº†ï¼ç›®å‰æ²’æœ‰å¾…è¾¦ä»»å‹™ï¼</li>';

            // æ¬ æ¬¾è­¦ç¤ºæ¨£å¼ (å¦‚æœæ¬ å¾ˆå¤šï¼Œæ¨™é¡Œè®Šç´…)
            const titleStyle = student.debtCount >= 5 ? 'color: #c62828;' : 'color: #000;';
            const debtBadge = student.debtCount > 0 ? `<span style="font-size:12px; color:#c62828; border:1px solid #c62828; padding:1px 4px; border-radius:4px; margin-left:6px;">æ¬  ${student.debtCount}</span>` : '';

            cardsHtml += `
                <div class="print-card">
                    <div class="print-header">
                        <div class="print-name" style="${titleStyle}">${student.no}. ${student.name} ${debtBadge}</div>
                        <div class="print-title">ä»»å‹™æ¸…å–®</div>
                    </div>
                    <ul class="print-list">
                        ${listItems}
                    </ul>
                    <div class="print-footer">
                        <div class="print-date">ğŸ“… ${printDate}</div>
                        <div class="print-sign">å®¶é•·ç°½åï¼š________________</div>
                    </div>
                </div>
            `;
        });

        // 5. å»ºç«‹åˆ—å°è¦–çª—
        const w = window.open('', '', 'width=900,height=800');
        w.document.write(`
            <html>
            <head>
                <title>å†’éšªè€…ä»»å‹™å·è»¸åŒ¯å‡º</title>
                <style>
                    body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; background: #fff; }
                    .print-container {
                        display: grid;
                        grid-template-columns: 1fr 1fr; /* å…©æ¬„æ’ç‰ˆçœç´™ */
                        gap: 15px;
                    }
                    .print-card {
                        border: 2px solid #5D4037;
                        border-radius: 8px;
                        padding: 12px;
                        break-inside: avoid;
                        display: flex;
                        flex-direction: column;
                        background: #fff;
                    }
                    .print-header {
                        border-bottom: 2px dashed #8B4513;
                        padding-bottom: 6px;
                        margin-bottom: 6px;
                        display: flex;
                        justify-content: space-between;
                        align-items: baseline;
                    }
                    .print-name { font-size: 20px; font-weight: 900; }
                    .print-title { font-size: 12px; font-weight: bold; color: #666; }
                    .print-list { list-style: none; padding: 0; margin: 0; flex: 1; }
                    .print-task-item {
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        padding: 4px 0;
                        border-bottom: 1px dotted #ccc;
                        font-size: 15px;
                    }
                    .print-checkbox { font-size: 18px; font-weight: bold; line-height: 1; }
                    .print-task-name { font-weight: bold; flex: 1; }
                    .print-task-status { font-size: 12px; color: #888; }
                    .print-footer {
                        margin-top: 10px;
                        padding-top: 8px;
                        border-top: 1px solid #eee;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        font-size: 12px;
                    }
                    .print-sign { font-weight: 900; color: #000; font-size: 14px; }
                    @media print {
                        body { padding: 0; margin: 0; }
                        .print-card { border-width: 1px; }
                        @page { margin: 1cm; }
                    }
                </style>
            </head>
            <body>
                <div class="print-container">
                    ${cardsHtml}
                </div>
                <script>
                    window.onload = () => { setTimeout(() => { window.print(); window.close(); }, 500); };
                <\/script>
            </body>
            </html>
        `);
        w.document.close();
    });
