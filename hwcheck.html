<!DOCTYPE html>
<html lang="zh-Hant-TW" data-theme="light" data-color-theme="guild">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ›¡ï¸ äºŒç”²å†’éšªè€…å…¬æœƒ</title>
  <!-- åœ–ç¤º -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <style>
    /* ============================================================
        ğŸ“œ æ¢éšªå…¬æœƒ (Adventurer's Guild) - ç¶“å…¸ç‰›çš®ç´™é¢¨æ ¼
        ============================================================ */
    :root, html[data-color-theme='guild'] {
      /* æ ¸å¿ƒè‰²èª¿ï¼šç¾Šçš®ç´™ã€çš®é©ã€å¢¨æ°´ */
      --primary: #8B4513;       /* çš®é©æ£• */
      --accent: #CD853F;        /* ç§˜éŠ€/éŠ…è‰² */
      --ring: rgba(139, 69, 19, 0.3);
      --bg: #F4E4BC;            /* æ·ºç¾Šçš®ç´™è‰² */
      --card: #FDF5E6;          /* èˆŠç´™å¼µè‰² */
      --tbl-head: #E6D2B5;      /* èˆŠåœ°åœ–é»ƒ */
      --tbl-alt: #FAF0E6;       /* äºéº»è‰² */
      --tbl-hover: #DEB887;     /* äº®ç¾Šçš®ç´™ */
      --tbl-border: #D2B48C;    /* æ›¬ç—•è‰² */
      --text-main: #3E2723;     /* æ·±è¤è‰²å¢¨æ°´ */
      --text-light: #5D4037;    /* æ·ºè¤è‰²å¢¨æ°´ */
      --muted: #8D6E63;
      --success: #556B2F;       /* æ£®æ—ç¶  */
      --danger: #8B0000;        /* é¾è¡€ç´… */
      --shadow: 3px 3px 0px rgba(93, 64, 55, 0.2);
      --radius: 4px;
      --seat: 56px; 
      --seat-font: 16px; 
    }

    html[data-color-theme='guild'] body {
      font-family: "Courier New", Courier, "Microsoft JhengHei", monospace;
      background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%238b4513' fill-opacity='0.03' fill-rule='evenodd'/%3E%3C/svg%3E");
    }

    html[data-color-theme='guild'] .btn {
        border: 2px solid #5D4037;
        box-shadow: 2px 2px 0px #5D4037;
    }
    html[data-color-theme='guild'] .btn:active {
        box-shadow: none;
        transform: translate(2px, 2px);
    }
    html[data-color-theme='guild'] .card::before { content: ""; position: absolute; top: -5px; left: 50%; transform: translateX(-50%); width: 100px; height: 10px; background: rgba(0,0,0,0.1); border-radius: 50%; filter: blur(2px); z-index: -1; }
    
    html[data-theme='dark'] {
      --primary: #D2691E; --bg: #2C1810; --card: #3E2723; --text-main: #E6D2B5; --tbl-head: #4E342E; --tbl-alt: #3E2723; --tbl-hover: #5D4037; --tbl-border: #5D4037;
    }

    /* ============================================================
        ğŸ„ è–èª•ç¯€ (Christmas)
        ============================================================ */
    html[data-color-theme='christmas'] {
      --primary: #d32f2f; --accent: #2e7d32; --ring: rgba(211, 47, 47, 0.3); --bg: #fffbf7; --card: rgba(255, 255, 255, 0.95);
      --tbl-head: #e8f5e9; --tbl-alt: #fff; --tbl-hover: #ffebee; --tbl-border: #c8e6c9;
      --text-main: #1e293b; --text-light: #475569; --muted:#64748b; --shadow:0 8px 30px rgba(211,47,47,.1); --radius:16px; --success:#2e7d32; --danger:#d32f2f;
      --seat: 56px; --seat-font: 16px; 
    }
    html[data-color-theme='christmas'] body {
        background-image: url("data:image/svg+xml,%3Csvg width='200' height='200' viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M40 160 L60 120 L50 120 L70 90 L60 90 L80 60 L100 90 L90 90 L110 120 L100 120 L120 160 Z' fill='%232e7d32' opacity='0.15'/%3E%3Crect x='75' y='160' width='10' height='20' fill='%23795548' opacity='0.15'/%3E%3Ccircle cx='150' cy='150' r='25' fill='%23b0bec5' opacity='0.15'/%3E%3Ccircle cx='150' cy='110' r='18' fill='%23b0bec5' opacity='0.15'/%3E%3C/svg%3E");
    }
    html[data-color-theme='christmas'] .logo {
        background: linear-gradient(135deg, #d32f2f, #2e7d32);
        box-shadow: 0 4px 15px rgba(211, 47, 47, 0.4);
    }

    /* é€šç”¨æ¨£å¼ */
    *{ box-sizing:border-box; }
    html, body{ height:100%; margin:0; font-family:"Microsoft JhengHei", sans-serif; transition: background-color .3s, color .3s; background: var(--bg); color: var(--text-main); }
    .wrap{ max-width:1200px; margin:0 auto; padding:16px 12px 96px; }
    header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; flex-wrap: wrap; }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo{ width:48px; height:48px; border-radius:12px; display:grid; place-items:center; color:#fff; font-size:24px; background: var(--primary); box-shadow:var(--shadow); }
    h1{ margin:0; font-size:clamp(18px,2.2vw,24px); font-weight:800; }
    .muted{ color:var(--muted); font-size:12px; }
    
    .card{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; margin-bottom:16px; border:1px solid var(--tbl-border); position: relative; }
    .card h2{ margin:0 0 12px; font-size:18px; color: var(--primary); border-bottom: 1px solid var(--tbl-border); padding-bottom: 8px; display:flex; align-items:center; gap:8px;}
    
    .row{ display:grid; gap:12px; grid-template-columns:repeat(12, 1fr); }
    .field{ grid-column:span 12; display:flex; flex-direction:column; gap:4px; }
    @media (min-width:720px){ .sm-6{ grid-column:span 6; } .sm-5{ grid-column:span 5; } .sm-4{ grid-column:span 4; } .sm-3{ grid-column:span 3; } .sm-2{ grid-column:span 2; } }
    label{ font-weight:800; font-size:13px; color: var(--text-light); }
    input, select, textarea { background:var(--bg); color: var(--text-main); border:2px solid var(--tbl-border); border-radius:4px; padding:10px; font-size:14px; outline:none; width: 100%; font-weight: bold; }
    input:focus, select:focus{ border-color:var(--primary); }
    
    .actions{ display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; }
    .btn{ border:2px solid var(--text-light); border-radius:6px; padding:8px 16px; font-weight:800; cursor:pointer; display:inline-flex; align-items:center; gap:6px; background:var(--primary); color:#fff; font-size:14px; }
    .btn.ghost{ background:var(--card); color:var(--text-light); border:2px dashed var(--tbl-border); }
    .btn.sm{ font-size:12px; padding:4px 10px; }
    .btn.chest { background: #DAA520; border-color: #B8860B; color: #fff; }
    
    .view{ display:none; } .view.show{ display:block; animation:fadeIn .3s ease; }
    @keyframes fadeIn{ from{ opacity:0; transform:translateY(10px); } to{ opacity:1; transform:translateY(0); } }

    /* è¡¨æ ¼ */
    .table-wrap{ overflow:auto; border-radius:6px; border:2px solid var(--tbl-border); background:var(--card); }
    table{ width:100%; border-collapse:collapse; font-size:14px; }
    thead th{ position:sticky; top:0; background:var(--tbl-head); text-align:left; padding:10px; border-bottom:2px solid var(--tbl-border); white-space:nowrap; cursor:pointer; }
    tbody td{ padding:10px; border-bottom:1px solid var(--tbl-border); }
    tbody tr:hover{ background:var(--tbl-hover); }
    
    /* åº§ä½è¡¨ */
    .grid{ display:grid; gap:10px; grid-template-columns:repeat(auto-fill, minmax(calc(var(--seat) + 70px), 1fr)); background:var(--bg); border:2px solid var(--tbl-border); border-radius:var(--radius); padding:10px; }
    .seatItem{ display:flex; align-items:center; gap:8px; }
    .seatItem.not-assigned { opacity: 0.35; filter: grayscale(80%); pointer-events: none; }
    .seat{ width:var(--seat); height:var(--seat); border-radius:12px; display:grid; place-items:center; font-weight:900; font-size:var(--seat-font); border:2px solid #5D4037; cursor:pointer; box-shadow:var(--shadow); }
    html[data-theme='dark'] .seat { border-color: var(--tbl-border); }
    .s0{ background:#d6d3d1; color:#44403c; } 
    .s1{ background:#fef9c3; color:#713f12; } 
    .s2{ background:#fdba74; color:#9a3412; } 
    .s3{ background:#86efac; color:#14532d; } 
    .seatName{ flex:1; font-weight:800; font-size:13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    /* é€²åº¦æ¢ */
    progress { -webkit-appearance: none; width: 100%; height: 10px; border-radius: 4px; overflow: hidden; background: var(--bg); border: 1px solid var(--text-light); }
    progress::-webkit-progress-value { background-color: var(--success); }
    
    /* Tooltip */
    .custom-tooltip { position: fixed; background: #3E2723; color: #FDF5E6; padding: 10px 14px; border-radius: 6px; font-size: 18px; font-weight: 900; pointer-events: none; z-index: 10002; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.5); border: 2px solid #CD853F; font-family: "Courier New", monospace; }
    .custom-tooltip.show { display: block; animation: fadeIn .1s ease-out; }

    /* Status Picker */
    #statusPicker { display: none; position: absolute; background: var(--card); border: 3px solid var(--primary); border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); padding: 10px; z-index: 10000; width: 160px; flex-direction: column; gap: 8px; }
    #statusPicker.show { display: flex; }
    .status-option-btn { border: 1px solid rgba(0,0,0,0.1); border-radius: 6px; padding: 12px; text-align: left; font-weight: 900; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 15px; color: #3e2723; }
    .sp-1 { background: #fef9c3; color: #713f12; } .sp-2 { background: #fdba74; color: #9a3412; } .sp-3 { background: #86efac; color: #14532d; }

    /* Numpad */
    .numpad-container { display: none; position: absolute; top: 100%; right: 0; width: 300px; z-index: 100; background: var(--card); border: 2px solid var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.3); border-radius: 8px; padding: 16px; padding-top: 36px; margin-top: 8px; }
    .numpad-container.show { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    .numpad-close { position: absolute; top: 2px; right: 4px; background: none; border: none; color: var(--danger); font-size: 24px; cursor: pointer; }
    .num-key { padding: 12px 0; font-size: 20px; font-weight: bold; background: var(--bg); border: 1px solid var(--tbl-border); cursor: pointer; border-radius: 6px; color: var(--text-main); font-family: monospace; }
    .num-key.action-key { background: var(--tbl-head); color: var(--primary); }

    /* Login Overlay */
    #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 20000; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 20px; }
    #loginBox { background: var(--card); padding: 40px; border-radius: 16px; box-shadow: var(--shadow); text-align: center; border: 3px double var(--primary); max-width: 90%; width: 400px; }

    /* Student Status List */
    .student-status-list { list-style: none; padding: 0; }
    .student-status-list li { padding: 8px; border-bottom: 1px dashed var(--tbl-border); display: flex; justify-content: space-between; cursor: pointer; }
    .student-status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; align-items: start; }

    /* Modal */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: center; }
    .modal-overlay.show { display: flex; }
    .modal-content { background: var(--card); padding: 20px; border-radius: var(--radius); width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; border: 3px double var(--primary); }
    
    @media print { .no-print { display: none !important; } }
  </style>
</head>
<body>

  <!-- Login Screen -->
  <div id="loginOverlay">
      <div id="loginBox">
          <div class="logo" style="margin: 0 auto 20px; width: 80px; height: 80px; font-size: 40px;">ğŸ›¡ï¸</div>
          <h1>å†’éšªè€…å…¬æœƒç™»å…¥</h1>
          <p class="muted">è«‹å‡ºç¤ºæ‚¨çš„å…¬æœƒé•·è­‰ä»¶ (Google å¸³è™Ÿ)</p>
          <button id="btnLogin" class="btn" style="font-size: 18px; padding: 12px 24px; width: 100%; justify-content: center;">
              <i class="bi bi-google"></i> ä½¿ç”¨ Google ç™»å…¥
          </button>
      </div>
  </div>

  <div class="wrap no-print" style="display:none;" id="mainApp">
    <header>
      <div class="brand">
        <div class="logo"><i class="bi bi-shield-shaded"></i></div>
        <div>
          <h1>äºŒç”²å†’éšªè€…å…¬æœƒ</h1>
          <div class="muted">ç‹€æ…‹å¾ªç’°ï¼šç°ï¼æœªæ¥å– â†’ é»ƒï¼å·²å›å ± â†’ æ©˜ï¼éœ€å†æŒ‘æˆ° â†’ ç¶ ï¼è¨ä¼æˆåŠŸ</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn ghost" id="btnNavDashboard"><i class="bi bi-map"></i> å§”è¨—çœ‹æ¿</button>
        <button class="btn ghost" id="btnNavStudentStatus"><i class="bi bi-backpack4"></i> å†’éšªè€…ç‹€æ…‹</button>
        <button class="btn ghost" id="btnNavRoster"><i class="bi bi-people"></i> å…¬æœƒåå†Š</button>
        <button class="btn ghost" id="btnOpenSettings" title="å¤–è§€è¨­å®š"><i class="bi bi-palette"></i></button>
        <button class="btn ghost" id="btnLogout" title="ç™»å‡º"><i class="bi bi-box-arrow-right"></i></button>
        <div id="saveStatusIndicator"><i class="bi bi-hourglass"></i> è¼‰å…¥ä¸­...</div>
      </div>
    </header>

    <!-- VIEWS -->
    <section id="view-dashboard" class="view show">
      <div class="card">
        <h2><i class="bi bi-scroll"></i> ç™¼å¸ƒæ–°å§”è¨—</h2>
        <div class="row">
          <div class="field sm-4">
            <label>ç™¼å¸ƒäºº (å…¬æœƒé•·)</label>
            <select id="ipTeacherSelect"></select>
            <input id="ipTeacherCustom" type="text" placeholder="è«‹è¼¸å…¥å§“å" style="display: none; margin-top: 8px;">
          </div>
          
          <div class="field sm-5">
            <label>å§”è¨—å…§å®¹ (ä½œæ¥­åç¨±)</label>
            <div style="display:flex; gap:8px; margin-bottom:4px; align-items: center;">
                <select id="selSubject" style="width:40%; padding:6px; font-size:12px;">
                    <option value="">ğŸ“‚ ç§‘ç›®...</option>
                </select>
                <button id="btnOpenQuestSettings" class="btn sm ghost" style="padding: 4px 8px;" title="ç·¨è¼¯ç§‘ç›®èˆ‡ä»»å‹™"><i class="bi bi-gear-fill"></i></button>
                <select id="selPresetTask" style="width:50%; padding:6px; font-size:12px; flex-grow: 1;">
                    <option value="">ğŸ“œ å¸¸ç”¨ä»»å‹™...</option>
                </select>
            </div>
            <div style="position: relative;">
                <input id="ipTitle" type="text" placeholder="æˆ–æ˜¯æ‰‹å‹•è¼¸å…¥..." />
                <button id="btnToggleNumpad" class="btn sm ghost" style="position: absolute; right: 4px; top: 4px; padding: 4px 8px;" title="é–‹å•Ÿæ•¸å­—éµç›¤"><i class="bi bi-grid-3x3"></i></button>
                <div id="numpadContainer" class="numpad-container"></div>
            </div>
          </div>

          <div class="field sm-3"><label>ç™¼å¸ƒæ—¥æœŸ</label><input id="ipDate" type="date" /></div>
        </div>
        <div class="field" style="margin-top: 8px;">
            <label>æŒ‡å®šå†’éšªè€…</label>
            <button class="btn ghost" id="btnOpenAssignModal" style="justify-content: flex-start; text-align: left; width: 100%;">
                <i class="bi bi-people-fill"></i>
                <span id="assignStatusText">å…¨é«”å†’éšªè€…</span>
            </button>
        </div>
        <div class="actions">
            <button class="btn" id="btnCreate"><i class="bi bi-quill-pen"></i> ç™¼å¸ƒå§”è¨—</button>
            <button class="btn ghost" id="btnExport"><i class="bi bi-download"></i> å‚™ä»½è³‡æ–™ (JSON)</button>
            <label class="btn ghost" for="fileImport" style="cursor:pointer;"><i class="bi bi-upload"></i> é‚„åŸè³‡æ–™</label>
            <input id="fileImport" type="file" accept="application/json" hidden />
        </div>
      </div>
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; flex-wrap: wrap; gap: 8px;">
            <h2><i class="bi bi-list-check"></i> å§”è¨—æ¸…å–®</h2>
            <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                <div class="field" style="max-width:140px; margin: 0;"><select id="teacherFilter"></select></div>
                <div class="field" style="max-width:140px; margin: 0;"><select id="subjectFilter"><option value="all">ğŸ“š æ‰€æœ‰ç§‘ç›®</option></select></div>
                <div class="field" style="max-width:140px; margin: 0;"><input type="date" id="dateFilter"></div>
                <button id="btnClearFilter" class="btn sm ghost" title="æ¸…é™¤ç¯©é¸"><i class="bi bi-x-lg"></i></button>
            </div>
        </div>
        <div class="table-wrap">
          <table id="assignmentTable">
            <thead><tr><th data-sort="date">ç™¼å¸ƒæ—¥æœŸ <i class="bi"></i></th><th data-sort="title">å§”è¨—å…§å®¹ <i class="bi"></i></th><th data-sort="teacher">å…¬æœƒé•· <i class="bi"></i></th><th>å›å ±é€²åº¦</th><th>è¨ä¼é€²åº¦</th><th></th></tr></thead>
            <tbody id="assignmentList"></tbody>
          </table>
        </div>
      </div>
    </section>
    
    <section id="view-detail" class="view">
      <div class="card">
        <div class="assignment-bar">
            <div class="title" id="detailTitle"></div>
            <div class="actions" style="align-items: center; gap: 20px; flex-wrap: wrap;">
                <button class="btn ghost" id="btnMarkAllYellow" style="background-color: #fef9c3; color: #713f12; border-color: #713f12;"><i class="bi bi-check-circle-fill"></i> å…¨å“¡å·²å›å ±</button>
                <button class="btn ghost" id="btnMarkAllOrange" style="background-color: #fdba74; color: #9a3412; border-color: #9a3412;"><i class="bi bi-exclamation-circle-fill"></i> å…¨å“¡éœ€å†æŒ‘æˆ°</button>
                <div class="field" style="min-width: 150px; margin-bottom: 0;">
                    <label for="rangeSize" style="margin-bottom: 4px;">åœ°åœ–ç¸®æ”¾</label>
                    <input type="range" id="rangeSize" min="40" max="100" value="56" style="padding: 0;">
                </div>
                <div class="legend">
                    <div><span class="dot s0"></span>æœªæ¥å–</div>
                    <div><span class="dot s1"></span>å·²å›å ±</div>
                    <div><span class="dot s2"></span>éœ€å†æŒ‘æˆ°</div>
                    <div><span class="dot s3"></span>è¨ä¼æˆåŠŸ</div>
                </div>
            </div>
        </div>
        <div id="gridContainer" class="grid"></div>
      </div>
    </section>

    <section id="view-roster" class="view">
        <div class="card" style="padding:8px">
            <div class="roster-tabs">
                <button id="tabBtnStudents" class="tab-btn active"><i class="bi bi-person-lines-fill"></i> å†’éšªè€…åå†Š</button>
                <button id="tabBtnTeachers" class="tab-btn"><i class="bi bi-person-badge"></i> å…¬æœƒé•·åå†Š</button>
            </div>
        </div>
        <div id="roster-content-students" class="roster-content show">
            <div class="card">
                <h2><i class="bi bi-person-lines-fill"></i> ç·¨è¼¯å†’éšªè€…åå–®</h2>
                <div class="roster-wrapper"><div class="roster-grid" id="rosterEditor"></div></div>
                <details><summary>ğŸ“œ å¾ç¾Šçš®ç´™è²¼ä¸Š (ä¸€è¡Œä¸€å€‹å§“å)</summary><textarea id="taRosterPaste" rows="10" style="width:100%; margin-top:10px;" placeholder="S.Coups&#10;æ·¨æ¼¢..."></textarea><div class="actions" style="justify-content: flex-end;"><button class="btn secondary sm" id="btnLoadFromPaste"><i class="bi bi-upload"></i> é‚„åŸè³‡æ–™</button></div></details>
                <div class="actions"><button class="btn" id="btnApplyRoster"><i class="bi bi-check-circle"></i> å„²å­˜åå†Šè®Šæ›´</button></div>
            </div>
        </div>
        <div id="roster-content-teachers" class="roster-content">
            <div class="card">
                <h2><i class="bi bi-person-badge"></i> ç·¨è¼¯å…¬æœƒé•·åå–®</h2>
                <p class="muted" style="margin-top:-8px; margin-bottom:12px;">ä¿®æ”¹å§“åå°‡åŒæ­¥æ›´æ–°ç›¸é—œå§”è¨—ã€‚</p>
                <div class="roster-wrapper"><div class="roster-grid" id="teacherEditor"></div></div>
                <div class="actions"><button class="btn" id="btnApplyTeachers"><i class="bi bi-check-circle"></i> å„²å­˜å§“åè®Šæ›´</button></div>
            </div>
        </div>
    </section>

    <section id="view-student-status" class="view">
      <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center;">
              <h2><i class="bi bi-clipboard2-check"></i> å†’éšªè€…å¾…è¾¦æ¸…å–®</h2>
              <div class="actions">
                  <button class="btn sm secondary" id="btnToggleBatchMode"><i class="bi bi-check-square"></i> æ‰¹é‡åŒ¯å‡ºå·è»¸</button>
                  <button class="btn sm" id="btnBatchExport" style="display:none;"><i class="bi bi-printer"></i> åŒ¯å‡ºé¸å–é …ç›®</button>
              </div>
          </div>
          <div id="studentStatusContainer"></div>
      </div>
    </section>

  </div>

  <!-- å¤–è§€è¨­å®š Modal -->
  <div id="settingsModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h2><i class="bi bi-gear-fill"></i> ç³»çµ±è¨­å®š</h2>
            <button class="modal-close-btn">&times;</button>
        </div>
        <div class="field" style="margin-bottom: 20px;">
            <label>é¢¨æ ¼ä¸»é¡Œ</label>
            <div class="theme-options" id="themeOptionsContainer">
                <button class="theme-option active" data-theme="guild" title="æ¢éšªå…¬æœƒ (é è¨­)"></button>
                <button class="theme-option" data-theme="christmas" title="è–èª•ç¯€"></button>
            </div>
        </div>
        <div class="field">
            <label>ç’°å¢ƒå…‰ç·š</label>
            <div class="dark-mode-toggle">
                <span style="font-weight: bold;"><i class="bi bi-moon-stars-fill"></i> å¤œé–“ç‡Ÿç«æ¨¡å¼</span>
                <label class="switch">
                    <input type="checkbox" id="darkModeToggle">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>
  </div>
  
  <!-- ä»»å‹™é¸å–®è¨­å®š Modal -->
  <div id="questSettingsModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 500px; height: 80vh; display: flex; flex-direction: column;">
        <div class="modal-header">
            <h2><i class="bi bi-journal-plus"></i> ç·¨è¼¯ä»»å‹™é¸å–®</h2>
            <button class="modal-close-btn">&times;</button>
        </div>
        <p class="muted" style="margin-top: -10px;">è‡ªè¨‚æ‚¨çš„ç§‘ç›®èˆ‡å¸¸ç”¨ä»»å‹™ã€‚</p>
        
        <div id="questConfigList" style="flex: 1; overflow-y: auto; border: 2px solid var(--tbl-border); border-radius: 6px; padding: 10px; margin-bottom: 10px;"></div>

        <div style="background: var(--bg); padding: 10px; border-radius: 6px; border: 1px dashed var(--primary);">
            <div style="display: flex; gap: 8px;">
                <input type="text" id="ipNewSubject" placeholder="è¼¸å…¥æ–°ç§‘ç›®åç¨±..." style="flex:1;">
                <button class="btn sm" id="btnAddSubject"><i class="bi bi-plus-lg"></i> æ–°å¢ç§‘ç›®</button>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn ghost modal-close-btn">å–æ¶ˆ</button>
            <button class="btn" id="btnSaveQuestSettings"><i class="bi bi-save"></i> å„²å­˜è¨­å®š</button>
        </div>
    </div>
  </div>

  <!-- æŒ‡æ´¾å­¸ç”Ÿ Modal -->
  <div id="assignStudentModal" class="modal-overlay">
      <div class="modal-content">
          <div class="modal-header">
              <h2><i class="bi bi-person-check-fill"></i> æŒ‡æ´¾ä»»å‹™å°è±¡</h2>
              <button class="modal-close-btn">&times;</button>
          </div>
          <div class="actions" style="margin-top: 0; margin-bottom: 12px;">
              <button class="btn sm" id="btnAssignSelectAll">å…¨é¸</button>
              <button class="btn sm ghost" id="btnAssignDeselectAll">å–æ¶ˆ</button>
          </div>
          <div id="assignStudentListContainer" class="assign-student-list"></div>
          <div class="modal-footer">
              <button class="btn ghost modal-close-btn">å–æ¶ˆ</button>
              <button class="btn" id="btnConfirmAssign">ç¢ºèªæŒ‡æ´¾</button>
          </div>
      </div>
  </div>

  <!-- ç‹€æ…‹é¸æ“‡è½‰ç›¤ -->
  <div id="statusPicker">
      <button class="status-option-btn sp-1" data-status="1"><span class="dot s1"></span> å·²å›å ±</button>
      <button class="status-option-btn sp-2" data-status="2"><span class="dot s2"></span> éœ€å†æŒ‘æˆ°</button>
      <button class="status-option-btn sp-3" data-status="3"><span class="dot s3"></span> è¨ä¼æˆåŠŸ</button>
  </div>
  
  <!-- è‡ªè¨‚æ‡¸æµ®æç¤º -->
  <div id="customTooltip" class="custom-tooltip"></div>

  <!-- Firebase Scripts -->
  <script type="module">
    // ============================================================
    // ğŸ”¥ FIREBASE è¨­å®šå€ (è«‹åœ¨æ­¤è™•å¡«å…¥æ‚¨çš„è³‡æ–™)
    // ============================================================
    const firebaseConfig = {
    apiKey: "AIzaSyDlVtBkmo7pmrxQKXKUzQqIK8LIGW59Dyw",
    authDomain: "hwcheck-8888.firebaseapp.com",
    projectId: "hwcheck-8888",
    storageBucket: "hwcheck-8888.firebasestorage.app",
    messagingSenderId: "661808262560",
    appId: "1:661808262560:web:413e036d53b19ea3c108c5",
    measurementId: "G-FR4LMZ630Q"
    };

    // ============================================================
    // ç¨‹å¼é‚è¼¯ (ä»¥ä¸‹è«‹å‹¿éš¨æ„ä¿®æ”¹ï¼Œé™¤éæ‚¨çŸ¥é“æ‚¨åœ¨åšä»€éº¼)
    // ============================================================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // åˆå§‹åŒ– Firebase
    let app, db, auth;
    try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
    } catch (e) {
        console.error("Firebase åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ configã€‚", e);
        alert("ç³»çµ±é€£ç·šè¨­å®šéŒ¯èª¤ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡ã€‚(Firebase Config Error)");
    }

    let currentUser = null;
    let data = { roster: [], assignments: [], teachers: [], questSettings: {} };
    
    // é è¨­è³‡æ–™ (è‹¥è³‡æ–™åº«å…¨ç©ºæ™‚ä½¿ç”¨)
    const defaultData = {
        roster: [
            { no: 1, name: "å‹‡è€…A" }, { no: 2, name: "æ³•å¸«B" }, { no: 3, name: "å¼“æ‰‹C" }
        ],
        assignments: [],
        teachers: ["å…¬æœƒé•·"],
        questSettings: {
            "åœ‹èª": ["åœ‹èªç¿’ä½œ", "åœ‹èªä½œæ¥­ç°¿", "åœˆè©", "ç”Ÿå­—ç°¿", "é–±è®€æ¸¬é©—", "åœ‹èªè€ƒå·"],
            "æ•¸å­¸": ["æ•¸å­¸ç¿’ä½œ", "æ•¸å­¸ä½œæ¥­ç°¿", "æ•¸å­¸è€ƒå·è¨‚æ­£", "æ•¸èª²ç·´ç¿’é¡Œ", "è¨ˆç®—ç·´ç¿’"],
            "ç”Ÿæ´»": ["ç”Ÿæ´»ç¿’ä½œ", "ç¹ªåœ–æ—¥è¨˜", "è§€å¯Ÿç´€éŒ„", "å­¸ç¿’å–®"],
            "è‹±æ–‡": ["è‹±æ–‡ç¿’ä½œ", "å­—æ¯ç·´ç¿’", "å–®å­—æŠ„å¯«", "è½åŠ›ç·´ç¿’"]
        }
    };

    // ============================================================
    // ç™»å…¥é‚è¼¯
    // ============================================================
    const loginOverlay = document.getElementById('loginOverlay');
    const mainApp = document.getElementById('mainApp');
    const btnLogin = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');

    btnLogin.addEventListener('click', () => {
        const provider = new GoogleAuthProvider();
        signInWithPopup(auth, provider)
            .then((result) => {
                // ç™»å…¥æˆåŠŸï¼ŒonAuthStateChanged æœƒè™•ç†å¾ŒçºŒ
            }).catch((error) => {
                alert("ç™»å…¥å¤±æ•—ï¼š" + error.message);
            });
    });

    btnLogout.addEventListener('click', () => {
        if(confirm("ç¢ºå®šè¦ç™»å‡ºå…¬æœƒç³»çµ±å—ï¼Ÿ")) {
            signOut(auth).then(() => {
                window.location.reload();
            });
        }
    });

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            loginOverlay.style.display = 'none';
            mainApp.style.display = 'block';
            console.log("Logged in as:", user.email);
            initApp();
        } else {
            loginOverlay.style.display = 'flex';
            mainApp.style.display = 'none';
        }
    });

    // ============================================================
    // è³‡æ–™å­˜å– (å–ä»£åŸæœ¬çš„ Google Script Run)
    // ============================================================
    const saveStatusIndicator = document.getElementById('saveStatusIndicator');
    let saveTimeout = null;

    async function loadDataFromFirebase() {
        updateSaveStatus('pending');
        try {
            const docRef = doc(db, "users", currentUser.uid, "data", "guildData");
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                data = docSnap.data();
                // åˆä½µé è¨­è¨­å®šï¼Œé¿å…èˆŠè³‡æ–™ç¼ºå°‘æ¬„ä½
                if (!data.questSettings) data.questSettings = JSON.parse(JSON.stringify(defaultData.questSettings));
            } else {
                // æ–°ä½¿ç”¨è€…ï¼Œå¯«å…¥é è¨­è³‡æ–™
                data = JSON.parse(JSON.stringify(defaultData));
                await setDoc(docRef, data);
            }
            updateSaveStatus('success');
            onDataLoaded();
        } catch (e) {
            console.error("Load Error:", e);
            updateSaveStatus('error', 'è®€å–å¤±æ•—');
            alert("è³‡æ–™è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚");
        }
    }

    async function saveDataToFirebase() {
        if (!currentUser) return;
        updateSaveStatus('saving');
        try {
            const docRef = doc(db, "users", currentUser.uid, "data", "guildData");
            await setDoc(docRef, data); // è¦†è“‹å¯«å…¥ (ç‚ºäº†ç°¡å–®èµ·è¦‹ç¶­æŒåŸæœ¬é‚è¼¯)
            updateSaveStatus('success');
        } catch (e) {
            console.error("Save Error:", e);
            updateSaveStatus('error', 'å„²å­˜å¤±æ•—');
        }
    }

    function triggerAutoSave() {
        clearTimeout(saveTimeout);
        updateSaveStatus('pending');
        saveTimeout = setTimeout(() => {
            saveDataToFirebase();
        }, 1500); 
    }

    function updateSaveStatus(status, message = '') {
        switch (status) {
            case 'pending': saveStatusIndicator.innerHTML = `<i class="bi bi-pencil"></i> ç´€éŒ„ä¸­...`; saveStatusIndicator.style.color = 'var(--primary)'; break;
            case 'saving': saveStatusIndicator.innerHTML = `<i class="bi bi-hourglass-split spin"></i> å­˜æª”ä¸­...`; saveStatusIndicator.style.color = 'var(--text-light)'; break;
            case 'success': saveStatusIndicator.innerHTML = `<i class="bi bi-check-all"></i> é€²åº¦å·²ä¿å­˜`; saveStatusIndicator.style.color = 'var(--success)'; break;
            case 'error': saveStatusIndicator.innerHTML = `<i class="bi bi-x-circle"></i> ${message}`; saveStatusIndicator.style.color = 'var(--danger)'; break;
        }
    }

    // ============================================================
    // æ‡‰ç”¨ç¨‹å¼é‚è¼¯ (UI æ“ä½œ)
    // ============================================================
    // å…¨åŸŸè®Šæ•¸
    let currentAssignmentId = null;
    let sortState = { key: 'date', direction: 'desc' };
    let currentFilter = { teacher: 'all', subject: 'all', date: '' }; 
    let newAssignmentAssignedIndices = []; 
    let isBatchMode = false;
    let tempQuestSettings = {};
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    // éŸ³æ•ˆ
    function playSuccessSound() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(1046.5, audioCtx.currentTime + 0.1);
        gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.start();
        oscillator.stop(audioCtx.currentTime + 0.5);
    }

    // å…ƒç´ 
    const views = document.querySelectorAll('.view');
    const statusPicker = document.getElementById('statusPicker');
    let statusPickerTarget = { index: null, assignmentId: null, source: null };
    const customTooltip = document.getElementById('customTooltip'); 

    // åˆå§‹åŒ–èˆ‡è³‡æ–™è™•ç†
    function initApp() {
        const savedTheme = localStorage.getItem('homeworkSystemTheme') || 'light';
        const savedColorTheme = localStorage.getItem('homeworkSystemColorTheme') || 'guild';
        document.documentElement.setAttribute('data-theme', savedTheme);
        document.documentElement.setAttribute('data-color-theme', savedColorTheme);
        
        document.getElementById('darkModeToggle').checked = savedTheme === 'dark';
        
        loadDataFromFirebase();
    }

    function onDataLoaded() {
        populateTeacherDropdowns();
        updateSubjectDropdown();
        resetNewAssignmentState();
        renderAll();
    }

    // æ¸²æŸ“ç›¸é—œ
    function renderAll() {
        const currentView = document.querySelector('.view.show');
        const viewId = currentView ? currentView.id : 'view-dashboard';
        
        if (viewId === 'view-dashboard') {
            populateTeacherDropdowns();
            renderDashboard();
        } else if (viewId === 'view-detail') {
            renderDetail(currentAssignmentId);
        } else if (viewId === 'view-roster') {
            renderRosterEditor();
            renderTeacherEditor();
        } else if (viewId === 'view-student-status') {
            renderStudentStatus();
        }
    }

    function switchView(targetId) {
        views.forEach(view => view.classList.toggle('show', view.id === targetId));
        if (targetId === 'view-dashboard') renderDashboard(); 
    }

    // --- Dashboard & Filter ---
    function populateTeacherDropdowns() {
        const teachers = data.teachers || [];
        const ipTeacherSelect = document.getElementById('ipTeacherSelect');
        const teacherFilter = document.getElementById('teacherFilter');
        
        ipTeacherSelect.innerHTML = teachers.map(t => `<option value="${t}">${t}</option>`).join('') + '<option value="custom">è‡ªè¡Œè¼¸å…¥...</option>';
        teacherFilter.innerHTML = '<option value="all">æ‰€æœ‰å…¬æœƒé•·</option>' + teachers.map(t => `<option value="${t}">${t}</option>`).join('');
        teacherFilter.value = currentFilter.teacher;
    }

    function updateSubjectDropdown() {
        const db = data.questSettings || defaultData.questSettings;
        const selSubject = document.getElementById('selSubject');
        const subjectFilter = document.getElementById('subjectFilter');

        selSubject.innerHTML = '<option value="">ğŸ“‚ ç§‘ç›®...</option>';
        subjectFilter.innerHTML = '<option value="all">ğŸ“š æ‰€æœ‰ç§‘ç›®</option>';
        
        if(db) {
            Object.keys(db).forEach(s => {
                selSubject.add(new Option(s, s));
                subjectFilter.add(new Option(s, s));
            });
        }
    }

    function filterAssignments(assignments) {
        return assignments.filter(a => {
            const matchTeacher = currentFilter.teacher === 'all' || a.teacher === currentFilter.teacher;
            const matchSubject = currentFilter.subject === 'all' || a.title.includes(currentFilter.subject);
            const matchDate = !currentFilter.date || a.date === currentFilter.date;
            return matchTeacher && matchSubject && matchDate;
        });
    }

    function renderDashboard() {
        const list = document.getElementById('assignmentList');
        let assignmentsToRender = filterAssignments([...data.assignments]);
        
        assignmentsToRender.sort((a, b) => {
            const aVal = a[sortState.key]; const bVal = b[sortState.key];
            if (aVal < bVal) return sortState.direction === 'asc' ? -1 : 1;
            if (aVal > bVal) return sortState.direction === 'asc' ? 1 : -1;
            return 0;
        });

        // Update sort icons
        document.querySelectorAll('#assignmentTable thead th[data-sort]').forEach(th => {
            const icon = th.querySelector('i');
            th.style.color = 'var(--text-main)'; icon.style.opacity = '0.3';
            if (th.dataset.sort === sortState.key) {
                icon.className = sortState.direction === 'asc' ? 'bi bi-sort-up' : 'bi bi-sort-down';
                th.style.color = 'var(--primary)'; icon.style.opacity = '1';
            } else { icon.className = 'bi bi-arrow-down-up'; }
        });

        list.innerHTML = '';
        if (assignmentsToRender.length === 0) {
            list.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:var(--muted);">ç›®å‰æ²’æœ‰å§”è¨—ç´€éŒ„ã€‚</td></tr>';
            return;
        }

        assignmentsToRender.forEach(a => {
            const assignedIndices = a.assignedIndices || 'all';
            const totalCount = assignedIndices === 'all' ? data.roster.length : assignedIndices.length;
            const statuses = a.statuses || [];
            const submittedCount = statuses.filter((s, i) => s >= 1 && (assignedIndices === 'all' || assignedIndices.includes(i))).length;
            const completedCount = statuses.filter((s, i) => s === 3 && (assignedIndices === 'all' || assignedIndices.includes(i))).length;
            const progress = totalCount > 0 ? (completedCount / totalCount) * 100 : 0;
            
            // Tooltip logic
            const pendingStudents = [];
            data.roster.forEach((student, i) => {
                if ((assignedIndices === 'all' || assignedIndices.includes(i)) && (statuses[i] === 0 || statuses[i] === 2)) {
                    pendingStudents.push(student.no);
                }
            });
            const tooltipText = pendingStudents.length > 0 ? `å¾…: ${pendingStudents.join(', ')}` : 'ğŸ‰ å…¨å“¡å®Œæˆ';

            const tr = document.createElement('tr');
            tr.dataset.id = a.id;
            tr.innerHTML = `
                <td>${a.date}</td>
                <td>${a.title}</td>
                <td>${a.teacher}</td>
                <td class="has-tooltip" data-tooltip="${tooltipText}" style="cursor:help;">${submittedCount}/${totalCount}</td>
                <td>
                    <div class="has-tooltip" data-tooltip="${tooltipText}" style="display:flex; align-items:center; gap:8px;">
                        <progress class="progress-success" value="${progress}" max="100"></progress>
                        <span>${completedCount}/${totalCount}</span>
                    </div>
                </td>
                <td><button class="btn chest sm btn-delete" data-id="${a.id}"><i class="bi bi-box-seam-fill"></i></button></td>
            `;
            list.appendChild(tr);
        });
    }

    // --- Detail View ---
    function renderDetail(id) {
        const assignment = data.assignments.find(a => a.id == id);
        if (!assignment) { switchView('view-dashboard'); return; }
        
        currentAssignmentId = id;
        document.getElementById('detailTitle').innerHTML = `<i class="bi bi-scroll-fill"></i> ${assignment.title} <span class="badge">${assignment.date}</span> <span class="badge">${assignment.teacher}</span>`;
        
        const grid = document.getElementById('gridContainer');
        grid.innerHTML = '';
        const assignedIndices = assignment.assignedIndices || 'all';
        
        data.roster.forEach((student, index) => {
            const isAssigned = assignedIndices === 'all' || assignedIndices.includes(index);
            const status = (assignment.statuses || [])[index] || 0;
            const div = document.createElement('div');
            div.className = `seatItem ${!isAssigned ? 'not-assigned' : ''}`;
            div.innerHTML = `<div class="seat s${status}" data-index="${index}">${student.no}</div><div class="seatName"><span class="seatNo">${student.no}.</span> ${student.name}</div>`;
            grid.appendChild(div);
        });
    }

    // --- Student Status ---
    function renderStudentStatus() {
        const container = document.getElementById('studentStatusContainer');
        container.innerHTML = '';
        
        // Batch mode handling
        const btnToggleBatch = document.getElementById('btnToggleBatchMode');
        const btnBatchExport = document.getElementById('btnBatchExport');
        if (isBatchMode) {
            container.classList.add('batch-mode');
            btnToggleBatch.classList.add('warn'); btnToggleBatch.innerHTML = '<i class="bi bi-x-square"></i> å–æ¶ˆæ‰¹é‡';
            btnBatchExport.style.display = 'inline-flex';
        } else {
            container.classList.remove('batch-mode');
            btnToggleBatch.classList.remove('warn'); btnToggleBatch.innerHTML = '<i class="bi bi-check-square"></i> æ‰¹é‡åŒ¯å‡º';
            btnBatchExport.style.display = 'none';
        }

        if (data.roster.length === 0) { container.innerHTML = '<p>ç„¡å†’éšªè€…è³‡æ–™ã€‚</p>'; return; }

        const pendingList = [];
        const completedList = [];
        const healingList = [];

        data.roster.forEach((student, idx) => {
            let pendingCount = 0;
            const tasks = [];
            
            data.assignments.forEach(a => {
                const assignedIndices = a.assignedIndices || 'all';
                if ((assignedIndices === 'all' || assignedIndices.includes(idx))) {
                    const s = (a.statuses || [])[idx] || 0;
                    if (s === 0 || s === 2) {
                        pendingCount++;
                        tasks.push({ id: a.id, title: a.title, status: s });
                    }
                }
            });

            if (pendingCount > 0) pendingList.push({ idx, tasks });
            else completedList.push(student.no);
            
            if (pendingCount >= 5) healingList.push(student);
        });

        // Summary
        const summaryDiv = document.createElement('div');
        summaryDiv.style.display = 'flex'; summaryDiv.style.gap = '12px'; summaryDiv.style.marginBottom = '20px'; summaryDiv.style.flexWrap = 'wrap';
        
        // Trophy Card
        const trophyCard = document.createElement('div');
        trophyCard.className = 'card'; trophyCard.style.flex = '1'; trophyCard.style.minWidth = '300px';
        trophyCard.innerHTML = `<h2><i class="bi bi-trophy"></i> è¨ä¼æˆå°±</h2>` + 
            (completedList.length > 0 ? `<p style="color:var(--success);font-weight:bold;">å®Œæˆæ‰€æœ‰å§”è¨—åº§è™Ÿï¼š${completedList.join('ã€')}</p>` : `<p>ç›®å‰ç„¡äººå®Œå…¨å®Œæˆã€‚</p>`);
        summaryDiv.appendChild(trophyCard);

        // Healing Card
        const healingCard = document.createElement('div');
        healingCard.className = 'card'; healingCard.style.flex = '1'; healingCard.style.minWidth = '300px';
        healingCard.style.backgroundColor = '#fff0f0'; healingCard.style.border = '2px dashed var(--danger)';
        let healingHTML = `<h2 style="color:var(--danger);"><i class="bi bi-heart-pulse"></i> éœ€è£œè¡€æˆå“¡</h2>`;
        if (healingList.length > 0) {
            healingHTML += `<div style="display:flex;gap:8px;flex-wrap:wrap;">` + 
                healingList.map(s => `<span style="font-weight:bold;color:#b91c1c;background:#fee2e2;padding:6px 12px;border-radius:20px;font-size:14px;">${s.name}</span>`).join('') + `</div>`;
        } else {
            healingHTML += `<p style="color:var(--success);font-weight:bold;">ç›®å‰æ²’æœ‰æˆå“¡éœ€è¦æ€¥æ•‘ï¼</p>`;
        }
        healingCard.innerHTML = healingHTML;
        summaryDiv.appendChild(healingCard);
        
        container.appendChild(summaryDiv);

        // Individual Cards
        if (pendingList.length > 0) {
            const grid = document.createElement('div');
            grid.className = 'student-status-grid';
            pendingList.forEach(item => {
                const s = data.roster[item.idx];
                const card = document.createElement('div');
                card.className = 'card';
                let listHTML = `<ul class="student-status-list">`;
                item.tasks.forEach(t => {
                    const stText = t.status === 0 ? 'æœªå›å ±' : 'éœ€å†æŒ‘æˆ°';
                    const stClass = t.status === 0 ? 'p-gray' : 'p-orange';
                    listHTML += `<li data-aid="${t.id}" data-sidx="${item.idx}">${t.title} <span class="pill ${stClass}">${stText}</span></li>`;
                });
                listHTML += `</ul>`;
                
                card.innerHTML = `
                    <div class="student-card-header">
                        <h2>
                            <input type="checkbox" class="batch-export-checkbox" data-sidx="${item.idx}">
                            <i class="bi bi-person"></i> <span style="color:var(--danger);">${s.no}.</span> ${s.name}
                        </h2>
                        <button class="btn sm btn-export-report" data-sidx="${item.idx}"><i class="bi bi-printer"></i></button>
                    </div>
                    ${listHTML}
                `;
                grid.appendChild(card);
            });
            container.appendChild(grid);
        } else if (data.roster.length > 0) {
            container.innerHTML += `<div style="text-align:center;font-size:20px;margin-top:40px;">ğŸ‰ å‚³èªªèª•ç”Ÿï¼å…¨é«”å†’éšªè€…éƒ½è¨ä¼æˆåŠŸäº†ï¼ ğŸ‰</div>`;
        }
    }

    function renderRosterEditor() {
        const div = document.getElementById('rosterEditor');
        div.innerHTML = '';
        data.roster.forEach(s => {
            const item = document.createElement('div'); item.className = 'roster-item';
            item.innerHTML = `<input type="number" value="${s.no}" class="roster-no-input" style="width:60px;"><input type="text" value="${s.name}" class="roster-name-input" style="flex:1;">`;
            div.appendChild(item);
        });
    }
    
    function renderTeacherEditor() {
        const div = document.getElementById('teacherEditor');
        div.innerHTML = '';
        data.teachers.forEach(t => {
            const item = document.createElement('div'); item.className = 'roster-item';
            item.innerHTML = `<input type="text" value="${t}" class="teacher-name-input" style="flex:1;"><button class="btn warn sm btn-del-teacher" data-name="${t}"><i class="bi bi-trash3"></i></button>`;
            div.appendChild(item);
        });
    }

    // ============================================================
    // äº‹ä»¶ç›£è½ (Event Listeners)
    // ============================================================
    // Navigation
    ['btnNavDashboard','btnNavStudentStatus','btnNavRoster'].forEach(id => {
        document.getElementById(id).addEventListener('click', (e) => {
            const viewMap = {'btnNavDashboard':'view-dashboard', 'btnNavStudentStatus':'view-student-status', 'btnNavRoster':'view-roster'};
            switchView(viewMap[e.currentTarget.id]);
        });
    });
    
    document.getElementById('btnOpenSettings').addEventListener('click', () => document.getElementById('settingsModal').classList.add('show'));
    document.querySelectorAll('.modal-close-btn').forEach(b => b.addEventListener('click', (e) => e.target.closest('.modal-overlay').classList.remove('show')));

    // Dashboard Actions
    document.getElementById('ipTeacherSelect').addEventListener('change', (e) => {
        document.getElementById('ipTeacherCustom').style.display = e.target.value === 'custom' ? 'block' : 'none';
    });
    
    document.getElementById('selPresetTask').addEventListener('change', (e) => {
        if(e.target.value) document.getElementById('ipTitle').value = e.target.value;
    });
    
    document.getElementById('selSubject').addEventListener('change', (e) => {
        const db = data.questSettings || defaultData.questSettings;
        const selTask = document.getElementById('selPresetTask');
        selTask.innerHTML = '<option value="">ğŸ“œ å¸¸ç”¨ä»»å‹™...</option>';
        if(e.target.value && db[e.target.value]) {
            db[e.target.value].forEach(t => selTask.add(new Option(t, t)));
        }
    });
    
    // Create Assignment
    document.getElementById('btnCreate').addEventListener('click', () => {
        let teacher = document.getElementById('ipTeacherSelect').value;
        if(teacher === 'custom') teacher = document.getElementById('ipTeacherCustom').value.trim();
        const title = document.getElementById('ipTitle').value.trim();
        const date = document.getElementById('ipDate').value;
        
        if(!teacher || !title || !date) { alert("è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ï¼"); return; }
        
        if(!data.teachers.includes(teacher)) data.teachers.push(teacher);
        
        const isAll = newAssignmentAssignedIndices.length === data.roster.length || newAssignmentAssignedIndices.length === 0;
        
        const newA = {
            id: Date.now(),
            teacher, title, date,
            assignedIndices: isAll ? 'all' : newAssignmentAssignedIndices,
            statuses: Array(data.roster.length).fill(0)
        };
        data.assignments.push(newA);
        saveDataToFirebase();
        resetNewAssignmentState();
        renderAll();
    });
    
    function resetNewAssignmentState() {
        document.getElementById('ipTitle').value = '';
        document.getElementById('selSubject').value = '';
        document.getElementById('ipDate').value = new Date().toISOString().slice(0, 10);
        newAssignmentAssignedIndices = [];
        document.getElementById('assignStatusText').innerText = "å…¨é«”å†’éšªè€…";
    }

    // Grid Interaction (å¿«é€Ÿæ‰¹æ”¹ï¼šå¾ªç’°)
    document.getElementById('gridContainer').addEventListener('click', (e) => {
        const seat = e.target.closest('.seat');
        if(!seat) return;
        const idx = parseInt(seat.dataset.index);
        const a = data.assignments.find(i => i.id == currentAssignmentId);
        if(!a) return;
        
        let s = (a.statuses || [])[idx] || 0;
        s = (s + 1) % 4;
        if(!a.statuses) a.statuses = Array(data.roster.length).fill(0);
        a.statuses[idx] = s;
        if(s === 3) playSuccessSound();
        triggerAutoSave();
        renderDetail(currentAssignmentId);
        renderDashboard(); // update list view
    });

    // Student Status Interaction (è£œæ•‘æ•™å­¸ï¼šè·³è½‰ç›¤)
    document.getElementById('studentStatusContainer').addEventListener('click', (e) => {
        if(e.target.closest('.btn-export-report')) {
            // ... export logic (can be added later if needed)
            return;
        }
        const li = e.target.closest('li');
        if(!li) return;
        
        const aid = li.dataset.aid;
        const sidx = parseInt(li.dataset.sidx);
        const a = data.assignments.find(i => i.id == aid);
        
        if((a.statuses[sidx] || 0) === 0) {
            // Show Status Picker
            statusPickerTarget = { index: sidx, assignmentId: aid, source: 'list' };
            const rect = li.getBoundingClientRect();
            statusPicker.style.top = (rect.top + window.scrollY) + 'px';
            statusPicker.style.left = (rect.right + window.scrollX - 160) + 'px';
            statusPicker.classList.add('show');
            
            const closePicker = (evt) => {
                if(!statusPicker.contains(evt.target) && !li.contains(evt.target)) {
                    statusPicker.classList.remove('show');
                    document.removeEventListener('click', closePicker);
                }
            };
            setTimeout(() => document.addEventListener('click', closePicker), 50);
        } else {
             if(confirm(`å°‡æ­¤å§”è¨—æ¨™è¨˜ç‚ºã€Œè¨ä¼æˆåŠŸã€ï¼Ÿ`)) {
                 a.statuses[sidx] = 3;
                 playSuccessSound();
                 triggerAutoSave();
                 renderStudentStatus();
                 renderDashboard();
             }
        }
    });

    // Status Picker Buttons
    document.querySelectorAll('.status-option-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const s = parseInt(btn.dataset.status);
            const { index, assignmentId, source } = statusPickerTarget;
            const a = data.assignments.find(i => i.id == assignmentId);
            a.statuses[index] = s;
            if(s === 3) playSuccessSound();
            triggerAutoSave();
            if(source === 'list') renderStudentStatus();
            statusPicker.classList.remove('show');
            renderDashboard();
        });
    });

    // Assignment List Actions
    document.getElementById('assignmentList').addEventListener('click', (e) => {
        const btnDel = e.target.closest('.btn-delete');
        if(btnDel) {
            e.stopPropagation();
            if(confirm("ç¢ºå®šè¦å°å­˜(åˆªé™¤)æ­¤å§”è¨—å—ï¼Ÿ")) {
                data.assignments = data.assignments.filter(a => a.id != btnDel.dataset.id);
                saveDataToFirebase();
                renderDashboard();
            }
            return;
        }
        const tr = e.target.closest('tr');
        if(tr) switchView('view-detail'); renderDetail(tr.dataset.id);
    });

    // Tooltip
    document.body.addEventListener('mouseover', (e) => {
      const target = e.target.closest('.has-tooltip');
      if (target && target.dataset.tooltip) {
          customTooltip.textContent = target.dataset.tooltip;
          customTooltip.classList.add('show');
      }
    });
    document.body.addEventListener('mousemove', (e) => {
      if (customTooltip.classList.contains('show')) {
          customTooltip.style.left = (e.clientX + 15) + 'px';
          customTooltip.style.top = (e.clientY + 15) + 'px';
      }
    });
    document.body.addEventListener('mouseout', (e) => customTooltip.classList.remove('show'));
    
    // Settings & Filters
    document.getElementById('teacherFilter').addEventListener('change', (e) => { currentFilter.teacher = e.target.value; renderDashboard(); });
    document.getElementById('subjectFilter').addEventListener('change', (e) => { currentFilter.subject = e.target.value; renderDashboard(); });
    document.getElementById('dateFilter').addEventListener('change', (e) => { currentFilter.date = e.target.value; renderDashboard(); });
    document.getElementById('btnClearFilter').addEventListener('click', () => { 
        currentFilter = { teacher: 'all', subject: 'all', date: '' }; 
        document.getElementById('teacherFilter').value = 'all';
        document.getElementById('subjectFilter').value = 'all';
        document.getElementById('dateFilter').value = '';
        renderDashboard(); 
    });

    document.getElementById('themeOptionsContainer').addEventListener('click', (e) => {
        const btn = e.target.closest('.theme-option');
        if(btn) {
            const theme = btn.dataset.theme;
            document.documentElement.setAttribute('data-color-theme', theme);
            localStorage.setItem('homeworkSystemColorTheme', theme);
        }
    });

    document.getElementById('darkModeToggle').addEventListener('change', (e) => {
        const theme = e.target.checked ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('homeworkSystemTheme', theme);
    });
    
    // Numpad
    const numpadContainer = document.getElementById('numpadContainer');
    const numKeys = ['1','2','3','BS','4','5','6','-','7','8','9','.','L','P','0','CLR'];
    numKeys.forEach(k => {
        const b = document.createElement('button'); b.className = `num-key ${['L','P','BS','CLR','-'].includes(k)?'action-key':''}`; b.textContent = k==='BS'?'âŒ«':k;
        b.addEventListener('click', () => {
            const ip = document.getElementById('ipTitle');
            if(k==='BS') ip.value = ip.value.slice(0,-1);
            else if(k==='CLR') ip.value = '';
            else ip.value += k;
        });
        numpadContainer.appendChild(b);
    });
    const closeNum = document.createElement('button'); closeNum.className='numpad-close'; closeNum.innerHTML='&times;';
    closeNum.addEventListener('click', (e) => { e.stopPropagation(); numpadContainer.classList.remove('show'); });
    numpadContainer.appendChild(closeNum);
    
    document.getElementById('btnToggleNumpad').addEventListener('click', () => numpadContainer.classList.toggle('show'));

    // Roster Management
    document.getElementById('btnApplyRoster').addEventListener('click', () => {
        if(!confirm("ç¢ºå®šè¦ä¿®æ”¹å­¸ç”Ÿåå–®å—ï¼Ÿé †åºè®Šæ›´å¯èƒ½æœƒå½±éŸ¿ç¾æœ‰ä½œæ¥­ç´€éŒ„ã€‚")) return;
        const newRoster = [];
        document.querySelectorAll('.roster-item').forEach(div => {
            const no = parseInt(div.querySelector('.roster-no-input').value);
            const name = div.querySelector('.roster-name-input').value.trim();
            if(no && name) newRoster.push({no, name});
        });
        data.roster = newRoster;
        saveDataToFirebase();
        renderRosterEditor();
        alert("åå–®å·²æ›´æ–°ï¼");
    });
    
    document.getElementById('teacherEditor').addEventListener('click', (e) => {
        const btn = e.target.closest('.btn-del-teacher');
        if(btn) {
            const tName = btn.dataset.name;
            if(data.assignments.some(a => a.teacher === tName)) {
                alert("ç„¡æ³•åˆªé™¤ï¼šä»æœ‰å§”è¨—å±¬æ–¼æ­¤å…¬æœƒé•·ã€‚");
                return;
            }
            if(confirm(`åˆªé™¤å…¬æœƒé•· ${tName}?`)) {
                data.teachers = data.teachers.filter(t => t !== tName);
                saveDataToFirebase();
                renderTeacherEditor();
            }
        }
    });
    
    document.getElementById('btnApplyTeachers').addEventListener('click', () => {
        const newTs = [];
        document.querySelectorAll('.teacher-name-input').forEach(i => { if(i.value.trim()) newTs.push(i.value.trim()); });
        data.teachers = [...new Set(newTs)].sort();
        saveDataToFirebase();
        renderTeacherEditor();
        alert("å…¬æœƒé•·åå–®å·²æ›´æ–°ï¼");
    });

    document.getElementById('btnLoadFromPaste').addEventListener('click', () => {
        const txt = document.getElementById('taRosterPaste').value.trim();
        if(!txt) return;
        const names = txt.split('\n').map(n => n.trim()).filter(Boolean);
        const listDiv = document.getElementById('rosterEditor');
        listDiv.innerHTML = '';
        names.forEach((n, i) => {
            const item = document.createElement('div'); item.className = 'roster-item';
            item.innerHTML = `<input type="number" value="${i+1}" class="roster-no-input" style="width:60px;"><input type="text" value="${n}" class="roster-name-input" style="flex:1;">`;
            listDiv.appendChild(item);
        });
    });
    
    // Assign Modal
    document.getElementById('btnOpenAssignModal').addEventListener('click', () => {
        const list = document.getElementById('assignStudentListContainer');
        list.innerHTML = '';
        data.roster.forEach((s, i) => {
            const checked = newAssignmentAssignedIndices.length === 0 || newAssignmentAssignedIndices.includes(i);
            const label = document.createElement('label'); label.className = 'assign-student-item';
            label.innerHTML = `<input type="checkbox" data-idx="${i}" ${checked?'checked':''}> <span>${s.no}. ${s.name}</span>`;
            list.appendChild(label);
        });
        document.getElementById('assignStudentModal').classList.add('show');
    });
    
    document.getElementById('btnAssignSelectAll').addEventListener('click', () => document.querySelectorAll('#assignStudentListContainer input').forEach(c => c.checked = true));
    document.getElementById('btnAssignDeselectAll').addEventListener('click', () => document.querySelectorAll('#assignStudentListContainer input').forEach(c => c.checked = false));
    
    document.getElementById('btnConfirmAssign').addEventListener('click', () => {
        const checked = document.querySelectorAll('#assignStudentListContainer input:checked');
        newAssignmentAssignedIndices = [];
        checked.forEach(c => newAssignmentAssignedIndices.push(parseInt(c.dataset.idx)));
        document.getElementById('assignStatusText').innerText = newAssignmentAssignedIndices.length === data.roster.length ? "å…¨é«”å†’éšªè€…" : `å·²é¸ ${newAssignmentAssignedIndices.length} ä½`;
        document.getElementById('assignStudentModal').classList.remove('show');
    });

  </script>

</body>
</html>
